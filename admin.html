<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; direction: rtl; }
        .container { max-width: 900px; margin: 0 auto; }
        .section { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 20px; }
        h1 { text-align: center; color: #667eea; margin-bottom: 20px; font-size: 28px; }
        h2 { text-align: center; color: #764ba2; margin-bottom: 20px; font-size: 24px; }
        h3 { color: #667eea; margin: 15px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #f0f0f0; }
        .password-container { text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px; margin-bottom: 20px; }
        .password-input { width: 250px; padding: 15px; margin: 15px auto; border: 2px solid #667eea; border-radius: 10px; font-size: 16px; text-align: center; display: block; }
        .unlock-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 40px; border: none; border-radius: 10px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; display: inline-block; transition: all 0.3s; }
        .unlock-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        button { padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 5px; transition: all 0.2s; }
        button:hover { transform: translateY(-2px); }
        .full-width-btn { width: 100%; padding: 18px; font-size: 18px; margin: 15px 0; }
        .committee-item { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 15px; border-right: 5px solid #667eea; }
        .committee-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .committee-header h3 { color: #667eea; margin: 0; font-size: 22px; }
        .delegate-type-section { background: white; padding: 20px; margin: 15px 0; border-radius: 10px; border: 1px solid #ddd; }
        .delegate-type-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .special-delegate { border-right: 4px solid #4CAF50; }
        .general-delegate { border-right: 4px solid #2196F3; }
        .type-badge { padding: 5px 15px; border-radius: 5px; font-size: 14px; font-weight: bold; color: white; }
        .special-badge { background: #4CAF50; }
        .general-badge { background: #2196F3; }
        .add-delegate-btn { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 10px 20px; font-size: 14px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 10px rgba(102,126,234,0.3); }
        .delegate-entry { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 10px; position: relative; border: 1px solid #eee; }
        .remove-delegate-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 10px 20px; font-size: 14px; width: auto; margin-top: 10px; }
        .save-btn { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); font-size: 20px; width: 100%; }
        .home-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-top: 10px; width: 100%; }
        .preview-btn { background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%); margin-top: 10px; width: 100%; }
        .scroll-container { max-height: 60vh; overflow-y: auto; padding: 10px; }
        .scroll-container::-webkit-scrollbar { width: 8px; }
        .scroll-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .scroll-container::-webkit-scrollbar-thumb { background: #667eea; border-radius: 10px; }
        .hidden { display: none !important; }
        .status-message { text-align: center; padding: 15px; margin: 15px 0; border-radius: 10px; font-weight: bold; font-size: 16px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { text-align: center; padding: 30px; color: #667eea; font-size: 18px; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .controls-container { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .control-btn { flex: 1; min-width: 200px; }
        
        /* Ø³ØªØ§ÙŠÙ„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
        .import-section {
            background: #eef2f7;
            padding: 20px;
            border-radius: 15px;
            border: 2px dashed #667eea;
            margin-bottom: 25px;
            text-align: center;
        }
        .import-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        select, .file-input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .section { padding: 20px; }
            h1 { font-size: 22px; }
            h2 { font-size: 20px; }
            .password-input { width: 100%; }
            .committee-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .delegate-type-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .controls-container { flex-direction: column; }
            .control-btn { width: 100%; }
            .import-controls { flex-direction: column; }
            .import-controls input, .import-controls select, .import-controls button { width: 100%; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div id="adminLocked" class="password-container section">
            <h1><i class="fas fa-lock"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h1>
            <p style="margin-bottom: 15px; color: #666; font-size: 16px;">ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
            <input type="password" 
                   id="adminPassword" 
                   class="password-input" 
                   placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                   onkeypress="if(event.key==='Enter') unlockAdmin()">
            <button class="unlock-btn" onclick="unlockAdmin()">
                <i class="fas fa-unlock"></i> ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </button>
            <div style="margin-top: 20px;">
                <a href="index.html" style="color: #667eea; text-decoration: none;">
                    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
                </a>
            </div>
        </div>

        <div id="adminUnlocked" class="hidden">
            <div class="section">
                <h1><i class="fas fa-cogs"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h1>
                
                <div id="statusMessage" class="status-message hidden"></div>
                
                <div class="import-section">
                    <h3><i class="fas fa-file-csv"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù Excel/CSV</h3>
                    <p style="font-size: 14px; color: #555; margin-bottom: 10px;">
                        Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (.csv) ÙˆØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
                    </p>
                    <div class="import-controls">
                        <input type="file" id="csvFileInput" accept=".csv" class="file-input">
                        
                        <select id="importType">
                            <option value="auto">Ø§ÙƒØªØ´Ø§Ù Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</option>
                            <option value="special">Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø®Ø§Øµ (Ø®Ø§Øµ)</option>
                            <option value="general">Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø¹Ø§Ù… (Ø¹Ø§Ù…)</option>
                        </select>
                        
                        <input type="number" id="manualCommittee" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø© (Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·)" style="width: auto; margin:0;" min="1" max="60">
                        
                        <button onclick="handleFileUpload()" style="background: #2196F3; margin:0;">
                            <i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯
                        </button>
                    </div>
                </div>

                <div class="controls-container">
                    <button class="control-btn" onclick="loadData()">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <button class="control-btn preview-btn" onclick="previewData()">
                        <i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <button class="control-btn" onclick="exportData()">
                        <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </div>
                
                <div class="scroll-container" id="adminCommittees">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                    </div>
                </div>
                
                <button class="save-btn full-width-btn" onclick="saveAllData()">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="home-btn full-width-btn" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDSeCdQEQ_GlPh2bHN_g1zY0uT5itZHjxg",
            authDomain: "mandowb-9ce4d.firebaseapp.com",
            projectId: "mandowb-9ce4d",
            storageBucket: "mandowb-9ce4d.firebasestorage.app",
            messagingSenderId: "19347263922",
            appId: "1:19347263922:web:970047c58c5c250f7194ab",
            measurementId: "G-JE6R74Q9Q7"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        let currentData = {};

        // ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        window.unlockAdmin = function() {
            const password = document.getElementById('adminPassword').value;
            if (password === '521988') {
                document.getElementById('adminLocked').classList.add('hidden');
                document.getElementById('adminUnlocked').classList.remove('hidden');
                loadData();
            } else {
                showMessage('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!', 'error');
                document.getElementById('adminPassword').value = '';
            }
        };

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
        function showMessage(text, type) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.textContent = text;
            messageDiv.className = `status-message ${type}`;
            messageDiv.classList.remove('hidden');
            setTimeout(() => { messageDiv.classList.add('hidden'); }, 5000);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        window.loadData = async function() {
            try {
                const container = document.getElementById('adminCommittees');
                container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';
                
                const delegatesRef = ref(database, 'delegates');
                const snapshot = await get(delegatesRef);
                currentData = snapshot.val() || {};
                
                renderCommittees(currentData);
                showMessage('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        };

        // Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø¬Ø§Ù†
        function renderCommittees(committees) {
            const container = document.getElementById('adminCommittees');
            let html = '';
            
            for (let i = 1; i <= 60; i++) {
                const committeeData = committees[i] || { special: [], general: [] };
                const specialDelegates = committeeData.special || [];
                const generalDelegates = committeeData.general || [];
                
                let specialHtml = '';
                specialDelegates.forEach((delegate, index) => {
                    specialHtml += createDelegateHTML(i, 'special', index, delegate);
                });
                
                let generalHtml = '';
                generalDelegates.forEach((delegate, index) => {
                    generalHtml += createDelegateHTML(i, 'general', index, delegate);
                });
                
                html += `
                    <div class="committee-item" id="committee-${i}">
                        <div class="committee-header">
                            <h3><i class="fas fa-users"></i> Ù„Ø¬Ù†Ø© ${i}</h3>
                            <div>
                                <button type="button" class="add-delegate-btn" onclick="addDelegate(${i}, 'special')">
                                    <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø®Ø§Øµ
                                </button>
                                <button type="button" class="add-delegate-btn" onclick="addDelegate(${i}, 'general')">
                                    <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø¹Ø§Ù…
                                </button>
                            </div>
                        </div>
                        <div class="delegate-type-section special-delegate">
                            <div class="delegate-type-header"><h4>Ù…Ù†Ø¯ÙˆØ¨ Ø®Ø§Øµ <span class="type-badge special-badge">Ø®Ø§Øµ</span></h4></div>
                            <div class="delegates-container" id="delegates-special-${i}">${specialHtml}</div>
                        </div>
                        <div class="delegate-type-section general-delegate">
                            <div class="delegate-type-header"><h4>Ù…Ù†Ø¯ÙˆØ¨ Ø¹Ø§Ù… <span class="type-badge general-badge">Ø¹Ø§Ù…</span></h4></div>
                            <div class="delegates-container" id="delegates-general-${i}">${generalHtml}</div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function createDelegateHTML(committee, type, index, delegate) {
            return `
                <div class="delegate-entry ${type}-delegate" id="delegate-${type}-${committee}-${index}">
                    <input type="text" class="delegate-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨" value="${delegate.name || ''}" data-committee="${committee}" data-type="${type}" data-index="${index}">
                    <input type="tel" class="delegate-phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${delegate.phone || ''}" data-committee="${committee}" data-type="${type}" data-index="${index}" pattern="[0-9]{10}" maxlength="11">
                    <button type="button" class="remove-delegate-btn" onclick="removeDelegate(${committee}, '${type}', ${index})">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                    </button>
                </div>
            `;
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ ÙŠØ¯ÙˆÙŠ
        window.addDelegate = function(committeeNum, type) {
            const container = document.getElementById(`delegates-${type}-${committeeNum}`);
            const index = container.children.length;
            const html = createDelegateHTML(committeeNum, type, index, { name: '', phone: '' });
            container.insertAdjacentHTML('beforeend', html);
        };

        window.removeDelegate = function(committeeNum, type, index) {
            const el = document.getElementById(`delegate-${type}-${committeeNum}-${index}`);
            if (el && confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) el.remove();
        };

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (CSV Parsing) ---
        window.handleFileUpload = function() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            const importType = document.getElementById('importType').value;
            const manualCommittee = document.getElementById('manualCommittee').value;

            if (!file) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processImportData(results.data, file.name, importType, manualCommittee);
                },
                error: function(error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                }
            });
        };

        function processImportData(data, fileName, importType, manualCommittee) {
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (Ø®Ø§Øµ/Ø¹Ø§Ù…) Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            let type = 'general'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
            if (importType === 'special') type = 'special';
            else if (importType === 'auto') {
                if (fileName.includes('Ø®Ø§Øµ')) type = 'special';
            }

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            const committeesData = collectData();
            let addedCount = 0;

            data.forEach(row => {
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©)
                const cleanRow = {};
                Object.keys(row).forEach(key => {
                    cleanRow[key.trim()] = row[key];
                });

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù…
                const name = cleanRow['Ø§Ù„Ø§Ø³Ù…'] || cleanRow['Ø§Ø³Ù…'] || '';
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‡Ø§ØªÙ
                let phone = cleanRow['Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†'] || cleanRow['Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†'] || cleanRow['ØªÙ„ÙŠÙÙˆÙ†'] || cleanRow['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || '';
                phone = phone.replace(/\D/g, ''); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‡Ø§ØªÙ

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø©
                let committeeNum = cleanRow['Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø©'] || cleanRow['Ø±Ù‚Ù… Ø§Ù„Ø¬Ù†Ø©'] || cleanRow['Ø§Ù„Ù„Ø¬Ù†Ø©'];
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ø¬Ù†Ø© ÙÙŠ Ø§Ù„Ù…Ù„ÙØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠ
                if (!committeeNum && manualCommittee) {
                    committeeNum = manualCommittee;
                }

                if (name && committeeNum) {
                    // ØªØ­ÙˆÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø© Ù„Ø±Ù‚Ù… ØµØ­ÙŠØ­
                    committeeNum = parseInt(committeeNum);
                    
                    if (committeeNum >= 1 && committeeNum <= 60) {
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ©
                        if (!committeesData[committeeNum]) {
                            committeesData[committeeNum] = { special: [], general: [] };
                        }
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
                        committeesData[committeeNum][type].push({
                            name: name.trim(),
                            phone: phone
                        });
                        addedCount++;
                    }
                }
            });

            if (addedCount > 0) {
                renderCommittees(committeesData);
                showMessage(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${addedCount} Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø¶ØºØ· "Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„ØªØ«Ø¨ÙŠØªÙ‡Ø§.`, 'success');
                // ØªØµÙÙŠØ± Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
                document.getElementById('csvFileInput').value = '';
                document.getElementById('manualCommittee').value = '';
            } else {
                alert('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø¹Ù…Ø¯Ø© "Ø§Ù„Ø§Ø³Ù…" Ùˆ"Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø©" ÙÙŠ Ø§Ù„Ù…Ù„ÙØŒ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©.');
            }
        }

        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØµÙØ­Ø©
        function collectData() {
            const committeesData = {};
            for (let i = 1; i <= 60; i++) {
                const specialContainer = document.getElementById(`delegates-special-${i}`);
                const generalContainer = document.getElementById(`delegates-general-${i}`);
                
                const specialDelegates = [];
                const generalDelegates = [];
                
                if (specialContainer) {
                    const nameInputs = specialContainer.querySelectorAll('.delegate-name-input');
                    const phoneInputs = specialContainer.querySelectorAll('.delegate-phone-input');
                    for (let j = 0; j < nameInputs.length; j++) {
                        if (nameInputs[j].value.trim()) {
                            specialDelegates.push({
                                name: nameInputs[j].value.trim(),
                                phone: phoneInputs[j].value.trim().replace(/\D/g, '')
                            });
                        }
                    }
                }
                
                if (generalContainer) {
                    const nameInputs = generalContainer.querySelectorAll('.delegate-name-input');
                    const phoneInputs = generalContainer.querySelectorAll('.delegate-phone-input');
                    for (let j = 0; j < nameInputs.length; j++) {
                        if (nameInputs[j].value.trim()) {
                            generalDelegates.push({
                                name: nameInputs[j].value.trim(),
                                phone: phoneInputs[j].value.trim().replace(/\D/g, '')
                            });
                        }
                    }
                }
                
                committeesData[i] = { special: specialDelegates, general: generalDelegates };
            }
            return committeesData;
        }

        window.saveAllData = async function() {
            try {
                const committeesData = collectData();
                let total = 0;
                Object.values(committeesData).forEach(c => total += c.special.length + c.general.length);
                
                if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ${total} Ù…Ù†Ø¯ÙˆØ¨ØŸ`)) return;
                
                showMessage('ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', 'success');
                const delegatesRef = ref(database, 'delegates');
                await set(delegatesRef, committeesData);
                showMessage(`âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
            } catch (error) {
                console.error(error);
                showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error');
            }
        };
        
        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (previewData, exportData) ÙƒÙ…Ø§ Ù‡ÙŠ...
        window.previewData = function() {
             const data = collectData();
             let count = 0;
             Object.values(data).forEach(c => count += c.special.length + c.general.length);
             alert(`Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${count}`);
        };
        
        window.exportData = async function() {
            // Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚
            try {
                const delegatesRef = ref(database, 'delegates');
                const snapshot = await get(delegatesRef);
                const dataStr = JSON.stringify(snapshot.val(), null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', 'delegates-backup.json');
                linkElement.click();
            } catch(e) { console.error(e); }
        };

        if (window.location.hash === '#admin') {
            document.getElementById('adminPassword').value = '521988';
            unlockAdmin();
        }
    </script>
</body>
</html>
