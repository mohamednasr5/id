<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إحصائيات الدخول</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap">
  <style>
    :root {
      --primary-color: #0072ff;
      --secondary-color: #00c6ff;
      --bg-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
      --text-color: #2d3436;
      --table-head-bg: rgba(0, 114, 255, 0.1);
      --table-hover: rgba(0, 114, 255, 0.05);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: var(--text-color);
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* كرات الخلفية */
    .circles {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    .circles li {
      position: absolute;
      display: block;
      list-style: none;
      width: 20px; height: 20px;
      background: rgba(255, 255, 255, 0.2);
      animation: animate 25s linear infinite;
      bottom: -150px;
      border-radius: 50%;
    }
    .circles li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
    .circles li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
    .circles li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
    .circles li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
    .circles li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
    @keyframes animate {
      0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; }
      100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; }
    }

    /* الحاوية الرئيسية */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: var(--glass-shadow);
      padding: 30px;
      animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    h2 {
      margin: 0;
      color: var(--primary-color);
      font-weight: 700;
    }

    .btn_back {
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      color: white;
      padding: 10px 25px;
      border-radius: 50px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);
      text-decoration: none;
      display: inline-block;
    }
    .btn_back:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 114, 255, 0.4);
    }

    /* تنسيق الجدول */
    .table-wrapper {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      min-width: 800px; /* لضمان عدم انضغاط الجدول في الموبايل */
    }

    th, td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: var(--table-head-bg);
      color: var(--primary-color);
      font-weight: 700;
      white-space: nowrap;
      position: sticky;
      top: 0;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: var(--table-hover);
    }

    /* تنسيق البيانات داخل الجدول */
    .statok {
      color: #2ecc71;
      font-weight: bold;
      background: rgba(46, 204, 113, 0.1);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.9em;
    }
    
    .statdupl {
      color: #e74c3c;
      font-weight: bold;
    }

    td ul {
      list-style: none;
      padding: 0;
      margin: 0;
      text-align: right;
      display: inline-block;
    }
    
    /* Spinner */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 50px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <ul class="circles">
    <li></li><li></li><li></li><li></li><li></li>
    <li></li><li></li><li></li><li></li><li></li>
  </ul>

  <div class="container">
    <div class="header-row">
      <h2>إحصائيات الدخول</h2>
      <button class="btn_back" onclick="location='DelegateApp_Pro.html'">عودة</button>
    </div>

    <div class="table-wrapper">
      <table id="statTable">
        <thead>
          <tr>
            <th>المكان</th>
            <th>العدد الكلي</th>
            <th>الأشخاص المكررين</th>
            <th>تفاصيل المناديب</th>
            <th>أول إدخال</th>
            <th>آخر إدخال</th>
            <th>المدة المستغرقة</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7"><div class="loader"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Firebase App (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxnIxtFeAOjYjCIrU5cwYVteuQ18K8Kjc",
      authDomain: "idmanazla.firebaseapp.com",
      databaseURL: "https://idmanazla-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "idmanazla",
      storageBucket: "idmanazla.firebasestorage.app",
      messagingSenderId: "408446131276",
      appId: "1:408446131276:web:976ae54181b5398de5a8e9",
      measurementId: "G-9YSW9HNYTG"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const places = [
      "المنزلة الجديدة 1","المنزلة الجديدة 2","بحر البلد شارع الكابتن",
      "مدرسة عبد العال شلبياية","مصنع البصل","الكفر 1","الكفر 2 تحت السكة",
      "سوق الجملة","الفداء","نقطة حمام الكيال","الحمزاوي","الجرن 1","الجرن 2",
      "البر التاني حي السلام","حي الاعجام","العزبة منشية ناصر","الطويل",
      "البر التاني 2 الهاويس","الفقاعي","بحر البلد 2","حي الجبانة",
      "الكفر 3 بجوار ملعب برشلونة","مقهي أبو سليمان","حي الزهراء"
    ];

    (async function(){
      try {
        const snapshot = await get(child(ref(db), 'users'));
        let users = snapshot.exists() ? snapshot.val() : {};
        let perPlace = {};
        
        for (let id in users) {
          let u = users[id];
          const key = u.place;
          if (!perPlace[key]) {
            perPlace[key] = {count:0, duplicates:0, reps:{}, times:[]};
          }
          perPlace[key].count++;
          if (!perPlace[key].reps[u.repName]) perPlace[key].reps[u.repName]=[];
          perPlace[key].reps[u.repName].push(u.time);
          perPlace[key].times.push(u.time);
        }

        // عرض الإحصائيات
        let tbody = '';
        places.forEach((place, i) => {
          let p = perPlace[place] || {count:0, duplicates:0, reps:{}, times:[]};
          let minTime = p.times.length ? new Date(Math.min(...p.times.map(t=>new Date(t)))) : '-';
          let maxTime = p.times.length ? new Date(Math.max(...p.times.map(t=>new Date(t)))) : '-';
          let diff = (minTime!='-' && maxTime!='-') ? ((maxTime-minTime)/60000) : null;
          let duration = (diff!==null)? `${Math.floor(diff/60)} س و ${Math.floor(diff%60).toString().padStart(2,'0')} د`:'-';
          
          let repDetails = Object.entries(p.reps)
            .map(([k,v]) => `<div style="margin-bottom:4px;">${k} <span class="statok">${v.length}</span></div>`)
            .join("");

          tbody += `<tr>
            <td style="font-weight:bold; color:var(--primary-color)">${place}</td>
            <td><span style="font-size:1.1em; font-weight:bold;">${p.count}</span></td>
            <td><span class="statdupl">${p.duplicates||0}</span></td>
            <td style="text-align:right; direction:rtl;">${repDetails||'-'}</td>
            <td dir="ltr">${minTime!='-' ? minTime.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}) : '-'}</td>
            <td dir="ltr">${maxTime!='-' ? maxTime.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}) : '-'}</td>
            <td>${duration}</td>
          </tr>`;
        });
        document.getElementById('tbody').innerHTML = tbody;
      } catch (e) {
        document.getElementById('tbody').innerHTML = `<tr><td colspan="7" style="color:red">حدث خطأ أثناء تحميل البيانات</td></tr>`;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
