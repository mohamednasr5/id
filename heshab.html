<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>المالية الذكية | نظام متكامل</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        :root {
            --primary: #6366f1; --primary-rgb: 99, 102, 241;
            --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --info: #3b82f6;
            --bg: #f8fafc; --surface: #ffffff; --text: #1e293b;
            --radius-sm: 12px; --radius-md: 16px; --radius-lg: 20px;
        }
        [data-theme="dark"] { --bg: #0f172a; --surface: #1e293b; --text: #f8fafc; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 12px; padding-bottom: 100px; min-height: 100vh; transition: 0.3s; }
        .container { max-width: 100%; margin: 0 auto; width: 100%; }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 480px) {
            body { padding: 10px; padding-bottom: 90px; }
            .header { padding: 12px 15px; border-radius: var(--radius-md); }
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .stat-card { padding: 12px 5px; }
            .stat-icon { width: 30px; height: 30px; line-height: 30px; font-size: 1.1rem; }
            .stat-val { font-size: 1.2rem; }
            .toggle-input-btn { padding: 12px; font-size: 1rem; }
            .input-box { padding: 20px; }
            .btn-icon { width: 40px; height: 40px; font-size: 1.1rem; }
            .input-with-mic { padding-left: 50px !important; }
            .field-mic-btn { width: 40px; height: 40px; }
        }
        
        @media (min-width: 768px) {
            .container { max-width: 720px; }
        }
        
        @media (min-width: 1024px) {
            .container { max-width: 900px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* الهيدر - متجاوب */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--surface); 
            padding: 15px 20px; 
            border-radius: var(--radius-lg); 
            margin-bottom: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            flex: 1;
            min-width: 200px;
        }
        .header-right { 
            display: flex; 
            gap: 5px; 
            flex-wrap: wrap;
        }
        .btn-icon { 
            background: transparent; 
            border: none; 
            min-width: 45px; 
            height: 45px; 
            border-radius: var(--radius-sm); 
            font-size: 1.2rem; 
            color: var(--text); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s; 
            flex-shrink: 0;
        }
        .btn-icon:hover { background: rgba(var(--primary-rgb), 0.1); transform: translateY(-2px); }

        /* الإحصائيات - متجاوبة */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        .stat-card { 
            background: var(--surface); 
            padding: 15px 8px; 
            border-radius: var(--radius-md); 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.04); 
            border: 1px solid rgba(0,0,0,0.05);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-icon { 
            font-size: 1.4rem; 
            margin-bottom: 8px; 
            display: inline-block; 
            width: 35px; 
            height: 35px; 
            line-height: 35px; 
            border-radius: 50%; 
        }
        .income .stat-icon { background: rgba(16,185,129,0.1); color: var(--success); }
        .expense .stat-icon { background: rgba(239,68,68,0.1); color: var(--danger); }
        .net .stat-icon { background: rgba(99,102,241,0.1); color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: #64748b; font-weight: 700; margin-bottom: 5px; }
        .stat-val { font-size: 1.4rem; font-weight: 800; font-family: 'Roboto', sans-serif; }
        .stat-val.income { color: var(--success); } 
        .stat-val.expense { color: var(--danger); } 
        .stat-val.net { color: var(--primary); }

        /* النموذج - متجاوب */
        .toggle-input-btn { 
            width: 100%; 
            background: linear-gradient(135deg, var(--primary), #4f46e5); 
            color: white; 
            padding: 15px; 
            border-radius: var(--radius-md); 
            border: none; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 1.1rem; 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            box-shadow: 0 5px 15px rgba(99,102,241,0.3);
            transition: transform 0.2s;
        }
        .toggle-input-btn:hover { transform: translateY(-2px); }
        
        .input-box { 
            background: var(--surface); 
            padding: 25px; 
            border-radius: var(--radius-lg); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
        }
        .input-box.hidden { display: none; }
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            background: var(--bg); 
            padding: 5px; 
            border-radius: var(--radius-md); 
        }
        .tab { 
            flex: 1; 
            padding: 12px; 
            border-radius: var(--radius-sm); 
            font-weight: 700; 
            cursor: pointer; 
            border: none; 
            background: transparent; 
            color: #94a3b8; 
            transition: 0.2s; 
            font-size: 1rem;
        }
        .tab.active { background: var(--surface); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tab.active.inc { color: var(--success); } 
        .tab.active.exp { color: var(--danger); }
        
        .input-group { 
            position: relative; 
            margin-bottom: 15px; 
        }
        .input-group input, 
        .input-group select { 
            width: 100%; 
            padding: 16px 60px 16px 20px; 
            border: 2px solid var(--bg); 
            border-radius: var(--radius-md); 
            font-size: 1.1rem; 
            background: var(--bg); 
            color: var(--text); 
            font-weight: 600; 
            appearance: none;
        }
        .input-group select { cursor: pointer; }
        .input-group .field-icon { 
            position: absolute; 
            right: 20px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #94a3b8; 
            pointer-events: none;
        }
        
        /* أزرار الميكروفون داخل الحقول */
        .field-mic-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s;
            z-index: 10;
        }
        .field-mic-btn:hover {
            background: var(--info);
            transform: translateY(-50%) scale(1.1);
        }
        .field-mic-btn.listening {
            background: var(--success);
            animation: pulse 1.5s infinite;
        }
        .field-mic-btn.income { background: var(--success); }
        .field-mic-btn.expense { background: var(--danger); }
        .input-with-mic {
            padding-left: 60px !important;
        }
        
        .save-btn { 
            width: 100%; 
            padding: 16px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: var(--radius-md); 
            font-size: 1.1rem; 
            font-weight: 800; 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        }
        .save-btn:hover { transform: translateY(-2px); }

        /* القائمة - متجاوبة */
        .filter-btns { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
            overflow-x: auto; 
            padding-bottom: 5px;
            scrollbar-width: none;
        }
        .filter-btns::-webkit-scrollbar { display: none; }
        .filter-btn { 
            padding: 8px 18px; 
            border-radius: 20px; 
            border: 1px solid transparent; 
            background: rgba(148, 163, 184, 0.1); 
            color: var(--text); 
            font-weight: 700; 
            cursor: pointer; 
            white-space: nowrap; 
            transition: 0.2s; 
            font-size: 0.9rem;
        }
        .filter-btn.active { background: var(--text); color: var(--bg); }
        
        .record { 
            background: var(--surface); 
            padding: 15px; 
            border-radius: var(--radius-md); 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            border: 1px solid rgba(0,0,0,0.03); 
            position: relative; 
            overflow: hidden; 
            transition: 0.2s; 
            flex-wrap: wrap;
        }
        .record:hover { transform: translateX(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .record::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 6px; }
        .record.inc::before { background: var(--success); } 
        .record.exp::before { background: var(--danger); }
        .rec-info { flex: 1; min-width: 200px; }
        .rec-info h4 { font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
        .rec-date { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
        .rec-amt { 
            font-weight: 900; 
            font-size: 1.2rem; 
            margin-right: auto; 
            font-family: 'Roboto', sans-serif; 
            white-space: nowrap;
        }

        /* الميكروفون - متجاوب */
        .mic-container { 
            position: fixed; 
            bottom: 20px; 
            left: 0; 
            width: 100%; 
            display: flex; 
            justify-content: center; 
            z-index: 100; 
            pointer-events: none; 
        }
        .mic-btn { 
            pointer-events: auto; 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #f43f5e, #e11d48); 
            color: white; 
            border: none; 
            box-shadow: 0 10px 30px rgba(225, 29, 72, 0.4); 
            font-size: 1.8rem; 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: 0.3s; 
        }
        @media (max-width: 480px) {
            .mic-btn { width: 65px; height: 65px; font-size: 1.6rem; }
        }
        .mic-btn.listening { animation: pulse 1.5s infinite; background: #22c55e; }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 
            70% { box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } 
        }
        
        /* رسالة التعرف */
        .voice-msg { 
            position: fixed; 
            top: 110px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(15,23,42,0.9); 
            backdrop-filter: blur(5px); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            z-index: 999; 
            display: none;
            max-width: 90%;
            text-align: center;
        }
        .voice-msg.active { display: block; animation: slideDown 0.3s; }
        @keyframes slideDown { 
            from { transform: translate(-50%, -20px); opacity: 0; } 
            to { transform: translate(-50%, 0); opacity: 1; } 
        }

        /* نافذة تعديل المعاملة */
        .edit-modal { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .edit-modal.hidden { display: none; }
        .edit-content { 
            background: var(--surface); 
            padding: 25px; 
            border-radius: var(--radius-lg); 
            width: 100%; 
            max-width: 500px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: slideUp 0.3s;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* رسالة لا توجد بيانات */
        .empty-state { 
            text-align: center; 
            padding: 50px 20px; 
            color: #94a3b8;
        }
        .empty-state i { 
            font-size: 4rem; 
            margin-bottom: 15px; 
            opacity: 0.5; 
        }

        /* مؤشر التحميل */
        .loader { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top-color: white; 
            animation: spin 1s ease-in-out infinite; 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        /* شريط تعليمات الميكروفون */
        .mic-instructions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--surface);
            padding: 15px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            border-right: 4px solid var(--primary);
        }
        .mic-instruction-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text);
        }
        .mic-instruction-item i {
            color: var(--primary);
            width: 20px;
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-left">
            <div style="width:45px; height:45px; background:rgba(99,102,241,0.1); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                <i class="fa-solid fa-brain" style="color:var(--primary); font-size:1.4rem;"></i>
            </div>
            <div>
                <h2 style="font-weight:900; font-size:1.2rem; margin-bottom:2px;">المالية الذكية</h2>
                <span style="font-size:0.75rem; color:#64748b; font-weight:600;">مدعوم بالذكاء الاصطناعي</span>
            </div>
        </div>
        <div class="header-right">
            <button class="btn-icon" onclick="exportExcel()" title="تصدير Excel">
                <i class="fa-solid fa-file-excel" style="color:#10b981;"></i>
            </button>
            <button class="btn-icon" onclick="toggleTheme()" title="تبديل المظهر">
                <i class="fa-solid fa-circle-half-stroke" style="color:#6366f1;"></i>
            </button>
            <button class="btn-icon" onclick="showDeleteAllPrompt()" title="حذف الكل">
                <i class="fa-solid fa-trash-can" style="color:#ef4444;"></i>
            </button>
        </div>
    </div>

    <!-- تعليمات الميكروفون -->
    <div class="mic-instructions">
        <div class="mic-instruction-item">
            <i class="fa-solid fa-microphone"></i>
            <span>انقر على الميكروفون بجوار كل حقل ثم تحدث لملء البيانات</span>
        </div>
        <div class="mic-instruction-item">
            <i class="fa-solid fa-lightbulb"></i>
            <span>يمكنك قول: "مليون" أو "ميت الف" أو "خمسين الف" أو "تلت تلاف"</span>
        </div>
    </div>

    <!-- الإحصائيات -->
    <div class="stats-grid">
        <div class="stat-card income">
            <div class="stat-icon"><i class="fa-solid fa-arrow-down"></i></div>
            <div class="stat-label">الدخل</div>
            <div class="stat-val income" id="totalInc">0</div>
        </div>
        <div class="stat-card expense">
            <div class="stat-icon"><i class="fa-solid fa-arrow-up"></i></div>
            <div class="stat-label">المصروفات</div>
            <div class="stat-val expense" id="totalExp">0</div>
        </div>
        <div class="stat-card net">
            <div class="stat-icon"><i class="fa-solid fa-scale-balanced"></i></div>
            <div class="stat-label">الصافي</div>
            <div class="stat-val net" id="netBal">0</div>
        </div>
    </div>

    <!-- زر الإضافة -->
    <button class="toggle-input-btn" onclick="toggleInputForm()">
        <i class="fa-solid fa-plus-circle"></i> تسجيل عملية يدوية
    </button>

    <!-- نموذج الإضافة -->
    <div class="input-box hidden" id="inputBox">
        <div class="tabs">
            <button id="btnInc" class="tab active inc" onclick="setMode('income')">دخل</button>
            <button id="btnExp" class="tab" onclick="setMode('expense')">مصروف</button>
        </div>
        <form onsubmit="saveTx(event)">
            <!-- حقل المبلغ مع ميكروفون -->
            <div class="input-group">
                <button type="button" class="field-mic-btn income" onclick="startFieldMic('amount')" 
                        title="انقر ثم تحدث لتعيين المبلغ" id="amountMic">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <i class="fa-solid fa-coins field-icon"></i>
                <input type="text" id="amount" placeholder="المبلغ (مثال: ١٠٠٠ أو 'الف جنيه')" class="input-with-mic" required>
            </div>
            
            <!-- حقل الوصف مع ميكروفون -->
            <div class="input-group">
                <button type="button" class="field-mic-btn" 
                        onclick="startFieldMic('desc')" 
                        title="انقر ثم تحدث لتعيين الوصف" id="descMic">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <i class="fa-solid fa-pen-nib field-icon"></i>
                <input type="text" id="desc" placeholder="وصف العملية (مثال: 'مرتب شهر يناير')" class="input-with-mic" required>
            </div>
            
            <button type="submit" class="save-btn" id="submitBtn">
                <i class="fa-solid fa-check"></i> حفظ العملية
            </button>
        </form>
    </div>

    <!-- الفلاتر -->
    <div class="filter-btns">
        <button class="filter-btn active" onclick="setFilter('all')" data-filter="all">الكل</button>
        <button class="filter-btn" onclick="setFilter('income')" data-filter="income">الوارد</button>
        <button class="filter-btn" onclick="setFilter('expense')" data-filter="expense">المصروف</button>
    </div>

    <!-- قائمة المعاملات -->
    <div id="list"></div>
</div>

<!-- رسالة الصوت -->
<div class="voice-msg" id="voiceMsg">جاري الاستماع...</div>

<!-- نافذة تعديل المعاملة -->
<div class="edit-modal hidden" id="editModal">
    <div class="edit-content">
        <div class="edit-header">
            <h3><i class="fa-solid fa-pen-to-square"></i> تعديل المعاملة</h3>
            <button class="close-btn" onclick="closeEditModal()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <form id="editForm" onsubmit="updateRecord(event)">
            <!-- حقل النوع -->
            <div class="input-group">
                <i class="fa-solid fa-sack-dollar field-icon"></i>
                <select id="editType" required>
                    <option value="income">وارد</option>
                    <option value="expense">مصروف</option>
                </select>
            </div>
            
            <!-- حقل المبلغ مع ميكروفون -->
            <div class="input-group">
                <button type="button" class="field-mic-btn" 
                        onclick="startEditFieldMic('editAmount')" 
                        title="انقر ثم تحدث لتعيين المبلغ" id="editAmountMic">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <i class="fa-solid fa-coins field-icon"></i>
                <input type="text" id="editAmount" placeholder="المبلغ" class="input-with-mic" required>
            </div>
            
            <!-- حقل الوصف مع ميكروفون -->
            <div class="input-group">
                <button type="button" class="field-mic-btn" 
                        onclick="startEditFieldMic('editDesc')" 
                        title="انقر ثم تحدث لتعيين الوصف" id="editDescMic">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <i class="fa-solid fa-pen-nib field-icon"></i>
                <input type="text" id="editDesc" placeholder="وصف العملية" class="input-with-mic" required>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="save-btn" style="background: var(--success); flex: 2;">
                    <i class="fa-solid fa-floppy-disk"></i> حفظ التعديلات
                </button>
                <button type="button" onclick="deleteCurrentRecord()" class="save-btn" style="background: var(--danger); flex: 1;">
                    <i class="fa-solid fa-trash"></i> حذف
                </button>
            </div>
        </form>
    </div>
</div>

<!-- الميكروفون الرئيسي -->
<div class="mic-container">
    <button class="mic-btn" id="mainMic" onclick="toggleMainMic()">
        <i class="fa-solid fa-microphone"></i>
    </button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
    apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
    authDomain: "nasrapp-7a0fc.firebaseapp.com",
    databaseURL: "https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
    projectId: "nasrapp-7a0fc",
    appId: "1:826970736109:web:c1cc3c3a1008e719b193e4"
});
const db = getDatabase(app);

// =============================================
// إعدادات التطبيق
// =============================================
let mode = "income";
let records = [];
let filter = "all";
let currentEditingRecord = null;

// إعداد المظهر
window.toggleTheme = () => {
    const isDark = document.body.dataset.theme === "dark";
    document.body.dataset.theme = isDark ? "light" : "dark";
    localStorage.setItem("theme", document.body.dataset.theme);
};
if(localStorage.getItem("theme")) document.body.dataset.theme = localStorage.getItem("theme");

// تحديث ألوان أزرار الميكروفون حسب النوع
window.setMode = (m) => {
    mode = m;
    document.getElementById("btnInc").className = `tab ${m==='income'?'active inc':''}`;
    document.getElementById("btnExp").className = `tab ${m==='expense'?'active exp':''}`;
    document.getElementById("submitBtn").style.background = m === "income" ? "var(--success)" : "var(--danger)";
    
    // تحديث لون ميكروفون المبلغ حسب النوع
    const amountMic = document.getElementById('amountMic');
    amountMic.className = `field-mic-btn ${m === 'income' ? 'income' : 'expense'}`;
};

// إعداد الفلتر
window.setFilter = (f) => {
    filter = f;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.toggle("active", b.dataset.filter === f));
    render();
};

// تبديل نموذج الإدخال
window.toggleInputForm = () => {
    document.getElementById("inputBox").classList.toggle("hidden");
};

// =============================================
// Firebase Operations
// =============================================
window.saveTx = async (e, directData = null) => {
    if (e) e.preventDefault();
    let amt, txt, type;
    
    if (directData) {
        amt = directData.amount;
        txt = directData.description;
        type = directData.type;
    } else {
        // تحويل النص إلى رقم باستخدام المحلل
        const amountText = document.getElementById("amount").value.trim();
        const amountResult = parseArabicNumber(amountText);
        
        amt = amountResult || parseFloat(document.getElementById("amount").value.replace(/,/g, ''));
        txt = document.getElementById("desc").value.trim();
        type = mode;
    }

    if (!amt || isNaN(amt) || !txt) {
        Swal.fire({icon: 'warning', title: 'بيانات ناقصة', text: 'الرجاء إدخال المبلغ والوصف بشكل صحيح'});
        return;
    }

    await push(ref(db, type === "income" ? "income" : "expenses"), {
        amount: amt, 
        description: txt, 
        timestamp: Date.now()
    });

    if (!directData) {
        document.getElementById("amount").value = "";
        document.getElementById("desc").value = "";
        document.getElementById("inputBox").classList.add("hidden");
    }

    Swal.fire({
        toast: true, 
        icon: "success", 
        title: "تم الحفظ", 
        text: `${txt} : ${Number(amt).toLocaleString()} جنيه`,
        position: "top", 
        timer: 2000, 
        showConfirmButton: false
    });
};

// قراءة البيانات
onValue(ref(db), (snap) => {
    records = [];
    const d = snap.val();
    if (d) {
        if (d.income) Object.entries(d.income).forEach(([id,v]) => records.push({...v, id, type:"income"}));
        if (d.expenses) Object.entries(d.expenses).forEach(([id,v]) => records.push({...v, id, type:"expense"}));
    }
    records.sort((a,b) => b.timestamp - a.timestamp);
    render();
});

// عرض البيانات
function render() {
    let data = records;
    if (filter !== "all") data = data.filter(r => r.type === filter);

    const inc = records.filter(r => r.type==="income").reduce((s,r)=>s+r.amount,0);
    const exp = records.filter(r => r.type==="expense").reduce((s,r)=>s+r.amount,0);
    const net = inc - exp;

    document.getElementById("totalInc").innerText = inc.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    document.getElementById("totalExp").innerText = exp.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    document.getElementById("netBal").innerText = net.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});

    const list = document.getElementById("list");
    list.innerHTML = "";
    
    if (data.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <i class="fa-solid fa-box-open"></i>
                <p>لا توجد معاملات مالية</p>
                <small style="color:#94a3b8;">استخدم الميكروفون لإضافة معاملة جديدة</small>
            </div>`;
        return;
    }

    data.forEach(r => {
        const div = document.createElement("div");
        div.className = `record ${r.type === 'income' ? 'inc' : 'exp'}`;
        div.onclick = () => openEditModal(r);
        const date = new Date(r.timestamp);
        
        div.innerHTML = `
            <div class="rec-info">
                <h4>${r.description}</h4>
                <div class="rec-date">${date.toLocaleTimeString('ar-EG', {hour:'2-digit',minute:'2-digit'})} • ${date.toLocaleDateString('ar-EG')}</div>
            </div>
            <div class="rec-amt" style="color:${r.type==='income'?'var(--success)':'var(--danger)'}">
                ${r.type==='income'?'+':'-'}${Number(r.amount).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 2})} ج
            </div>
        `;
        list.appendChild(div);
    });
}

// =============================================
// نافذة تعديل المعاملة
// =============================================
window.openEditModal = (record) => {
    currentEditingRecord = record;
    document.getElementById('editType').value = record.type;
    document.getElementById('editAmount').value = record.amount;
    document.getElementById('editDesc').value = record.description;
    document.getElementById('editModal').classList.remove('hidden');
    
    // تحديث ألوان أزرار الميكروفون في النافذة
    const editAmountMic = document.getElementById('editAmountMic');
    editAmountMic.className = `field-mic-btn ${record.type === 'income' ? 'income' : 'expense'}`;
};

window.closeEditModal = () => {
    document.getElementById('editModal').classList.add('hidden');
    currentEditingRecord = null;
};

window.updateRecord = async (e) => {
    e.preventDefault();
    
    const newType = document.getElementById('editType').value;
    const amountText = document.getElementById('editAmount').value.trim();
    const newDesc = document.getElementById('editDesc').value.trim();
    
    // تحويل النص إلى رقم
    const newAmount = parseArabicNumber(amountText) || parseFloat(amountText.replace(/,/g, ''));
    
    if (!newAmount || isNaN(newAmount) || !newDesc) {
        Swal.fire({icon: 'error', title: 'خطأ', text: 'الرجاء ملء جميع الحقول بشكل صحيح'});
        return;
    }
    
    try {
        // حذف السجل القديم
        await remove(ref(db, `${currentEditingRecord.type}/${currentEditingRecord.id}`));
        
        // إضافة السجل الجديد
        await push(ref(db, newType === "income" ? "income" : "expenses"), {
            amount: newAmount, 
            description: newDesc, 
            timestamp: Date.now()
        });
        
        Swal.fire({
            toast: true,
            icon: "success",
            title: "تم التعديل",
            text: `${newDesc} : ${Number(newAmount).toLocaleString()} جنيه`,
            position: "top",
            timer: 2000,
            showConfirmButton: false
        });
        
        closeEditModal();
    } catch (error) {
        Swal.fire({icon: 'error', title: 'خطأ', text: 'فشل في تعديل المعاملة'});
    }
};

window.deleteCurrentRecord = async () => {
    const { isConfirmed } = await Swal.fire({
        title: 'هل أنت متأكد؟',
        text: `سيتم حذف "${currentEditingRecord.description}" نهائياً`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
    });
    
    if (isConfirmed) {
        await remove(ref(db, `${currentEditingRecord.type}/${currentEditingRecord.id}`));
        Swal.fire({toast: true, icon: "success", title: "تم الحذف", timer: 1000});
        closeEditModal();
    }
};

// =============================================
// حذف الكل
// =============================================
window.showDeleteAllPrompt = async () => {
    const { value: password } = await Swal.fire({
        title: 'حذف جميع المعاملات',
        input: 'password',
        inputLabel: 'أدخل كلمة السر للحذف',
        inputPlaceholder: 'أدخل كلمة السر 521988',
        showCancelButton: true,
        confirmButtonText: 'حذف الكل',
        cancelButtonText: 'إلغاء'
    });
    
    if (password === '521988') {
        await deleteAllRecords();
    } else if (password) {
        Swal.fire({icon: 'error', title: 'خطأ', text: 'كلمة السر غير صحيحة'});
    }
};

async function deleteAllRecords() {
    const { isConfirmed } = await Swal.fire({
        title: 'تأكيد نهائي',
        text: 'سيتم حذف جميع المعاملات ولا يمكن التراجع!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف الكل',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#ef4444'
    });
    
    if (isConfirmed) {
        await remove(ref(db, "income"));
        await remove(ref(db, "expenses"));
        Swal.fire({icon: 'success', title: 'تم الحذف', text: 'تم حذف جميع المعاملات'});
    }
}

// =============================================
// نظام تحويل النص العربي إلى أرقام
// =============================================
function parseArabicNumber(text) {
    if (!text) return 0;
    
    // تحويل الأرقام العربية إلى إنجليزية
    let normalized = text
        .replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d))
        .toLowerCase()
        .replace(/[^\u0600-\u06FF0-9\s.,]/g, '')
        .trim();
    
    // التحقق من وجود أرقام مباشرة
    const numMatch = normalized.match(/(\d+(\.\d+)?)/);
    if (numMatch) {
        return parseFloat(numMatch[0].replace(/,/g, ''));
    }
    
    // قاموس الأرقام الكامل
    const numberWords = {
        // الأساسية
        "صفر": 0, "واحد": 1, "اتنين": 2, "تلاتة": 3, "اربعة": 4, "خمسة": 5,
        "ستة": 6, "سبعة": 7, "تمانية": 8, "تسعة": 9, "عشرة": 10,
        "حداشر": 11, "اتناشر": 12, "تلاتاشر": 13, "اربعتاشر": 14, "خمستاشر": 15,
        "ستاشر": 16, "سبعتاشر": 17, "تمنتاشر": 18, "تسعتاشر": 19,
        "عشرين": 20, "تلاتين": 30, "اربعين": 40, "خمسين": 50, "ستين": 60,
        "سبعين": 70, "تمانين": 80, "تسعين": 90,
        
        // المئات
        "مية": 100, "ميه": 100, "ميتين": 200,
        "تلاتمية": 300, "تلاتميه": 300, "تلتوميه": 300, "تلتومية": 300,
        "ربعمية": 400, "ربعميه": 400, "ربعميت": 400,
        "خمسمية": 500, "خمسميه": 500, "خمسميت": 500,
        "ستمية": 600, "ستميه": 600, "ستميت": 600,
        "سبعمية": 700, "سبعميه": 700, "سبعميت": 700,
        "تمنمية": 800, "تمنميه": 800, "تمنميت": 800,
        "تسعمية": 900, "تسعميه": 900, "تسعميت": 900,
        
        // الآلاف
        "الف": 1000, "ألف": 1000, "تلاف": 1000,
        "الفين": 2000, "تلافين": 2000,
        "تلت تلاف": 3000, "تلات الاف": 3000, "تلاتلاف": 3000,
        "اربعة الاف": 4000, "اربعة تلاف": 4000, "اربعتلاف": 4000,
        "خمسة الاف": 5000, "خمس تلاف": 5000, "خمستلاف": 5000,
        "ستة الاف": 6000, "ست تلاف": 6000, "ستتلاف": 6000,
        "سبعة الاف": 7000, "سبع تلاف": 7000, "سبعتلاف": 7000,
        "تمانية الاف": 8000, "تمن تلاف": 8000, "تمنتلاف": 8000,
        "تسعة الاف": 9000, "تسع تلاف": 9000, "تسعتلاف": 9000,
        
        // عشرات الآلاف
        "عشرة الاف": 10000, "عشر تلاف": 10000,
        "عشرين الف": 20000, "عشرين الف": 20000,
        "تلاتين الف": 30000,
        "اربعين الف": 40000,
        "خمسين الف": 50000,
        "ستين الف": 60000,
        "سبعين الف": 70000,
        "تمانين الف": 80000,
        "تسعين الف": 90000,
        
        // مئات الآلاف
        "مية الف": 100000, "ميت الف": 100000,
        "ميتين الف": 200000, "متين الف": 200000,
        "تلاتمية الف": 300000, "تلتميت الف": 300000,
        "ربعمية الف": 400000, "ربعميت الف": 400000,
        "خمسمية الف": 500000, "خمسميت الف": 500000,
        "ستمية الف": 600000, "ستميت الف": 600000,
        "سبعمية الف": 700000, "سبعميت الف": 700000,
        "تمنمية الف": 800000, "تمنميت الف": 800000,
        "تسعمية الف": 900000, "تسعميت الف": 900000,
        
        // الملايين
        "مليون": 1000000
    };
    
    const fractions = {
        "نص": 0.5, "نصف": 0.5,
        "ربع": 0.25, "تلت": 0.333, "ثلث": 0.333
    };
    
    // البحث عن الكلمات مباشرة
    for (const [word, value] of Object.entries(numberWords)) {
        if (normalized.includes(word)) {
            return value;
        }
    }
    
    // البحث عن كسور
    for (const [word, value] of Object.entries(fractions)) {
        if (normalized.includes(word)) {
            return value;
        }
    }
    
    return 0;
}

// =============================================
// نظام الميكروفونات للحقول
// =============================================
let isListening = false;
let currentRecognition = null;
const voiceMsg = document.getElementById("voiceMsg");

// التحقق من دعم المتصفح
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const isSpeechSupported = SpeechRecognition !== undefined;

// تهيئة نظام التعرف على الصوت
function initializeSpeechRecognition() {
    if (!isSpeechSupported) {
        console.warn('Speech recognition not supported');
        return null;
    }
    
    const recognition = new SpeechRecognition();
    recognition.lang = 'ar-EG';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    return recognition;
}

// بدء الميكروفون للحقل
window.startFieldMic = async (fieldId) => {
    if (!isSpeechSupported) {
        Swal.fire({
            icon: 'warning',
            title: 'الميزة غير مدعومة',
            text: 'المتصفح الحالي لا يدعم التعرف على الصوت. الرجاء استخدام Chrome أو Edge.'
        });
        return;
    }
    
    const micBtn = document.getElementById(fieldId + 'Mic');
    const inputField = document.getElementById(fieldId);
    
    if (!inputField) return;
    
    // طلب إذن الميكروفون
    try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'صلاحية الميكروفون مرفوضة',
            text: 'الرجاء منح الإذن لاستخدام الميكروفون في إعدادات المتصفح.'
        });
        return;
    }
    
    // إيقاف أي تسجيل جاري
    if (isListening && currentRecognition) {
        currentRecognition.stop();
    }
    
    // إنشاء نظام تعرف جديد
    currentRecognition = initializeSpeechRecognition();
    if (!currentRecognition) return;
    
    // تحديث واجهة المستخدم
    micBtn.classList.add('listening');
    voiceMsg.innerText = "جاري الاستماع...";
    voiceMsg.classList.add("active");
    isListening = true;
    
    // إعداد الأحداث
    currentRecognition.onstart = () => {
        micBtn.classList.add('listening');
        voiceMsg.innerText = "استمع إليك...";
    };
    
    currentRecognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        voiceMsg.innerText = `"${transcript}"`;
        
        // إذا كان حقل المبلغ، نحاول تحويل النص إلى رقم
        if (fieldId === 'amount' || fieldId === 'editAmount') {
            const amount = parseArabicNumber(transcript);
            if (amount > 0) {
                inputField.value = amount;
                voiceMsg.innerText = `المبلغ: ${amount.toLocaleString()} جنيه`;
            } else {
                inputField.value = transcript;
            }
        } else {
            inputField.value = transcript;
        }
        
        // إظهار تأكيد
        Swal.fire({
            toast: true,
            position: 'top',
            icon: 'success',
            title: 'تم تعبئة الحقل',
            timer: 1500,
            showConfirmButton: false
        });
    };
    
    currentRecognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        micBtn.classList.remove('listening');
        voiceMsg.classList.remove('active');
        isListening = false;
        
        if (event.error === 'no-speech') {
            Swal.fire({
                toast: true,
                icon: 'info',
                title: 'لم يتم الكشف عن صوت',
                timer: 2000
            });
        } else if (event.error === 'audio-capture') {
            Swal.fire({
                icon: 'error',
                title: 'مشكلة في الميكروفون',
                text: 'تأكد من توصيل الميكروفون ومنح الإذن.'
            });
        }
    };
    
    currentRecognition.onend = () => {
        micBtn.classList.remove('listening');
        setTimeout(() => {
            voiceMsg.classList.remove('active');
        }, 1000);
        isListening = false;
        currentRecognition = null;
    };
    
    // بدء التعرف على الصوت
    currentRecognition.start();
};

// للميكروفونات في نافذة التعديل
window.startEditFieldMic = (fieldId) => {
    startFieldMic(fieldId.replace('edit', ''));
};

// =============================================
// الميكروفون الرئيسي
// =============================================
window.toggleMainMic = async () => {
    if (!isSpeechSupported) {
        Swal.fire({
            icon: 'warning',
            title: 'الميزة غير مدعومة',
            text: 'المتصفح الحالي لا يدعم التعرف على الصوت. الرجاء استخدام Chrome أو Edge.'
        });
        return;
    }
    
    // طلب إذن الميكروفون
    try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'صلاحية الميكروفون مرفوضة',
            text: 'الرجاء منح الإذن لاستخدام الميكروفون في إعدادات المتصفح.'
        });
        return;
    }
    
    // إيقاف أي تسجيل جاري
    if (isListening && currentRecognition) {
        currentRecognition.stop();
        return;
    }
    
    // إنشاء نظام تعرف جديد
    currentRecognition = initializeSpeechRecognition();
    if (!currentRecognition) return;
    
    const mainMic = document.getElementById('mainMic');
    
    // تحديث واجهة المستخدم
    mainMic.classList.add('listening');
    voiceMsg.innerText = "جاري الاستماع للمعاملة...";
    voiceMsg.classList.add("active");
    isListening = true;
    
    // إعداد الأحداث
    currentRecognition.onstart = () => {
        mainMic.classList.add('listening');
        voiceMsg.innerText = "استمع إليك...";
    };
    
    currentRecognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        voiceMsg.innerText = `"${transcript}"`;
        
        // تحليل النص
        const result = analyzeSpeech(transcript);
        
        if (result) {
            if (result.action === 'deleteAll') {
                // طلب حذف الكل
                const { value: password } = await Swal.fire({
                    title: 'حذف جميع المعاملات',
                    text: 'لحذف جميع المعاملات، أدخل كلمة السر:',
                    input: 'password',
                    inputPlaceholder: 'أدخل 521988',
                    showCancelButton: true,
                    confirmButtonText: 'حذف',
                    cancelButtonText: 'إلغاء'
                });
                
                if (password === '521988') {
                    await deleteAllRecords();
                } else if (password) {
                    Swal.fire({icon: 'error', title: 'خطأ', text: 'كلمة السر غير صحيحة'});
                }
            } else {
                // معاملة عادية
                await saveTx(null, result);
                voiceMsg.innerText = `تم حفظ: ${result.description}`;
            }
        } else {
            Swal.fire({
                toast: true,
                icon: "warning",
                title: "لم أتعرف على المعاملة",
                text: "الرجاء إدخالها يدوياً أو استخدام ميكروفونات الحقول",
                timer: 3000
            });
        }
    };
    
    currentRecognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        mainMic.classList.remove('listening');
        voiceMsg.classList.remove('active');
        isListening = false;
        
        if (event.error === 'no-speech') {
            Swal.fire({
                toast: true,
                icon: 'info',
                title: 'لم يتم الكشف عن صوت',
                timer: 2000
            });
        }
    };
    
    currentRecognition.onend = () => {
        mainMic.classList.remove('listening');
        setTimeout(() => {
            voiceMsg.classList.remove('active');
        }, 1000);
        isListening = false;
        currentRecognition = null;
    };
    
    // بدء التعرف على الصوت
    currentRecognition.start();
};

// =============================================
// محلل الكلام
// =============================================
function analyzeSpeech(text) {
    const normalized = text.toLowerCase();
    
    // كلمات حذف الكل
    const deleteAllPhrases = [
        "حذف الكل", "احذف الكل", "مسح الكل", "امسح الكل", "شيل الكل",
        "حذف كل", "احذف كل", "مسح كل", "امسح كل", "شيل كل",
        "حذف جميع", "احذف جميع", "مسح جميع", "امسح جميع",
        "مسح البيانات", "حذف البيانات", "امسح البيانات",
        "تفريغ", "تفريغ الكل", "تفريغ كل", "صفر الكل", "صفر كل"
    ];
    
    // التحقق من أمر حذف الكل
    for (const phrase of deleteAllPhrases) {
        if (normalized.includes(phrase)) {
            return { action: 'deleteAll', text: text };
        }
    }
    
    // استخراج المبلغ
    const amount = parseArabicNumber(text);
    if (amount === 0) return null;
    
    // تحديد النوع (دخل/مصروف)
    const incomeWords = ["قبضت", "قبض", "خدت", "جالي", "وصلني", "استلمت", "مرتب", "راتب", "دخل", "وارد"];
    const expenseWords = ["صرفت", "صرف", "دفعت", "دفع", "اشتريت", "شراء", "فاتورة", "ايجار", "مصروف"];
    
    let incomeScore = incomeWords.filter(word => normalized.includes(word)).length;
    let expenseScore = expenseWords.filter(word => normalized.includes(word)).length;
    
    let type = expenseScore > incomeScore ? "expense" : "income";
    
    // استخراج الوصف
    let description = normalized
        .replace(/(\d+(\.\d+)?)/g, '')
        .replace(/(جنيه|جنية|ريال|دولار|يورو|ج|قرش)/g, '');
    
    const allWords = [...incomeWords, ...expenseWords];
    allWords.forEach(word => {
        description = description.replace(new RegExp(word, 'gi'), '');
    });
    
    const stopWords = ["على", "من", "في", "الي", "الى", "ل", "لي", "يا", "انا", "حوالي", "تقريبا"];
    stopWords.forEach(word => description = description.replace(new RegExp(word, 'gi'), ''));
    
    description = description.replace(/\s+/g, ' ').trim();
    
    if (description.length < 2) {
        description = type === "income" ? "وارد" : "مصروف";
    }
    
    return { amount, description, type };
}

// =============================================
// تصدير Excel
// =============================================
window.exportExcel = () => {
    if (records.length === 0) {
        Swal.fire({icon: 'info', title: 'لا توجد بيانات', text: 'لا توجد معاملات لتصديرها'});
        return;
    }

    const wb = XLSX.utils.book_new();
    
    // ورقة الدخل
    const incData = records.filter(r => r.type === "income");
    const incRows = [["الوصف", "المبلغ", "التاريخ", "الوقت"]];
    incData.forEach(r => {
        const date = new Date(r.timestamp);
        incRows.push([
            r.description,
            r.amount,
            date.toLocaleDateString('ar-EG'),
            date.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'})
        ]);
    });
    
    // إضافة المجموع
    const incTotal = incData.reduce((s, r) => s + r.amount, 0);
    incRows.push(["المجموع", incTotal, "", ""]);
    
    const incWs = XLSX.utils.aoa_to_sheet(incRows);
    
    // تنسيق
    incWs['!cols'] = [{wch: 40}, {wch: 15}, {wch: 15}, {wch: 10}];
    XLSX.utils.book_append_sheet(wb, incWs, "الوارد");
    
    // ورقة المصروفات
    const expData = records.filter(r => r.type === "expense");
    const expRows = [["الوصف", "المبلغ", "التاريخ", "الوقت"]];
    expData.forEach(r => {
        const date = new Date(r.timestamp);
        expRows.push([
            r.description,
            r.amount,
            date.toLocaleDateString('ar-EG'),
            date.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'})
        ]);
    });
    
    const expTotal = expData.reduce((s, r) => s + r.amount, 0);
    expRows.push(["المجموع", expTotal, "", ""]);
    
    const expWs = XLSX.utils.aoa_to_sheet(expRows);
    expWs['!cols'] = [{wch: 40}, {wch: 15}, {wch: 15}, {wch: 10}];
    XLSX.utils.book_append_sheet(wb, expWs, "المصروف");
    
    // ورقة الملخص
    const summaryRows = [
        ["الإجمالي", "المبلغ"],
        ["إجمالي الدخل", incTotal],
        ["إجمالي المصروفات", expTotal],
        ["الصافي", incTotal - expTotal]
    ];
    
    const summaryWs = XLSX.utils.aoa_to_sheet(summaryRows);
    summaryWs['!cols'] = [{wch: 25}, {wch: 15}];
    XLSX.utils.book_append_sheet(wb, summaryWs, "الملخص");
    
    // حفظ الملف
    const dateStr = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `المالية_الذكية_${dateStr}.xlsx`);
};

// =============================================
// التحقق من دعم الميكروفون عند التحميل
// =============================================
document.addEventListener('DOMContentLoaded', () => {
    if (!isSpeechSupported) {
        // إخفاء جميع أزرار الميكروفون إذا غير مدعوم
        document.querySelectorAll('.field-mic-btn').forEach(btn => {
            btn.style.display = 'none';
        });
        document.getElementById('mainMic').style.display = 'none';
        
        // إظهار تحذير
        Swal.fire({
            icon: 'warning',
            title: 'الميزة غير مدعومة',
            text: 'المتصفح الحالي لا يدعم التعرف على الصوت. الرجاء استخدام Chrome أو Edge للإستفادة من ميزات الصوت.',
            timer: 5000
        });
    }
});
</script>
</body>
</html>
