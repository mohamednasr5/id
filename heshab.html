<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مصاريفي | إهداء للحاج أحمد شطا</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{--primary:#6366f1;--primary-dark:#4f46e5;--success:#10b981;--danger:#ef4444;--bg:#f8fafc;--surface:#fff;--text:#0f172a;--border:#e2e8f0;}
[data-theme="dark"]{--bg:#0f172a;--surface:#1e293b;--text:#f1f5f9;--border:#334155;}
body{background:var(--bg);color:var(--text);font-family:'Cairo',sans-serif;padding:15px;padding-bottom:120px;transition:.3s;}
.container{max-width:600px;margin:auto;}
.header{display:flex;justify-content:space-between;align-items:center;background:var(--surface);padding:16px;border-radius:20px;margin-bottom:20px;border:1px solid var(--border);box-shadow:0 3px 8px rgba(0,0,0,.1);}
.action-btn{width:42px;height:42px;border:none;border-radius:12px;background:var(--bg);cursor:pointer;}
.type-toggle{display:flex;background:var(--bg);padding:5px;border-radius:16px;margin-bottom:15px;}
.toggle-btn{flex:1;border:none;padding:12px;border-radius:12px;font-weight:700;cursor:pointer;color:#64748b;}
.toggle-btn.active.inc{background:var(--surface);color:var(--success);}
.toggle-btn.active.exp{background:var(--surface);color:var(--danger);}
.input-card{background:var(--surface);padding:20px;border-radius:20px;border:1px solid var(--border);margin-bottom:25px;}
.input-group{position:relative;margin-bottom:12px;}
.input-group input{width:100%;padding:16px 50px 16px 20px;border:2px solid var(--border);border-radius:16px;background:var(--bg);font-weight:700;}
.tx-list{display:flex;flex-direction:column;gap:12px;}
.tx-item{background:var(--surface);padding:16px;border-radius:18px;display:flex;align-items:center;gap:15px;border:1px solid var(--border);}
.mic-wrapper{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);}
.mic-btn{width:75px;height:75px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;font-size:1.8rem;cursor:pointer;}
.voice-hud{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,.9);display:none;align-items:center;justify-content:center;flex-direction:column;color:#fff;z-index:500;}
.voice-hud.active{display:flex;}
</style>
</head>

<body>
<div class="container">

<header class="header">
<div style="display:flex;align-items:center;gap:10px;">
<i class="fa-solid fa-wallet" style="color:var(--primary);font-size:1.7rem"></i>
<h2 style="margin:0;font-weight:800;">مصاريفي</h2>
</div>
<div style="display:flex;gap:8px;">
<button class="action-btn" onclick="exportExcel()"><i class="fa-solid fa-file-excel" style="color:#10b981"></i></button>
<button class="action-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
</div>
</header>

<div class="stats-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;">
<div class="stat-card" style="background:var(--surface);padding:16px;border-radius:18px;border:1px solid var(--border);text-align:center;">
<div style="color:#64748b;font-weight:700">وارد</div>
<div id="valInc" style="font-size:1.3rem;font-weight:900;color:var(--success)">0</div>
</div>

<div class="stat-card" style="background:var(--surface);padding:16px;border-radius:18px;border:1px solid var(--border);text-align:center;">
<div style="color:#64748b;font-weight:700">مصروف</div>
<div id="valExp" style="font-size:1.3rem;font-weight:900;color:var(--danger)">0</div>
</div>

<div class="stat-card" style="background:var(--surface);padding:16px;border-radius:18px;border:1px solid var(--border);text-align:center;">
<div style="color:#64748b;font-weight:700">الصافي</div>
<div id="valBal" style="font-size:1.3rem;font-weight:900;color:var(--primary)">0</div>
</div>
</div>

<div class="input-card">
<div class="type-toggle">
<button id="btnInc" class="toggle-btn" onclick="setMode('income')">دخل</button>
<button id="btnExp" class="toggle-btn active exp" onclick="setMode('expense')">صرف</button>
</div>

<form onsubmit="saveTransaction(event)">
<div class="input-group">
<input id="inpAmount" type="number" required placeholder="المبلغ">
</div>
<div class="input-group">
<input id="inpDesc" required placeholder="الوصف">
</div>
<button id="btnSubmit" style="width:100%;padding:16px;border:none;border-radius:12px;background:var(--danger);color:#fff;font-weight:800;">
تسجيل العملية
</button>
</form>
</div>

<div id="txList" class="tx-list"></div>

</div>

<div class="mic-wrapper">
<button class="mic-btn" id="micBtn" onclick="toggleVoice()">
<i class="fa-solid fa-microphone"></i>
</button>
</div>

<div class="voice-hud" id="voiceHud">
<h2 id="hudText">سامعك…</h2>
<p id="hudSub" style="color:#ddd;margin-top:10px;">قول "صرفت 50 مواصلات"</p>
</div>

<script type="module">

/* =========================================================
   Firebase
========================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
 apiKey:"AIzaSyDJH...",authDomain:"nasrapp-7a0fc.firebaseapp.com",
 databaseURL:"https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
 projectId:"nasrapp-7a0fc",appId:"1:826970736109:web:c1cc3c3a1008e719b193e4"
});
const db = getDatabase(app);

/* =========================================================
   القواميس الأساسية
========================================================= */
const EG_DICT = {
 numbers:{
   "نص":0.5,"ربع":0.25,"واحد":1,"اتنين":2,"تلاتة":3,"خمسة":5,
   "عشرة":10,"عشرين":20,"خمسين":50,"مية":100,"الف":1000
 },
 income:[
    "جالي","جتلي","اديوني","اداني","جابلي","استلمت","وقعتلي فلوس","رزق جه",
    "حد اداني","واحد جابلي","دخل","وارد","حول","جه رزق","جالي فلوس",
    "خدت","اخدت","جالي حساب","حد جاب فلوس","رزق من ربنا"
],

expense: [
    // الصرف والكلام الشعبي
    "صرفت","دفعت","جبت","اشتريت","دفعت للدكتور","جبت هدوم","جبت جزمة",
    "مشاوير","مواصلات","اكل","شرب","الحساب ولّع",
    "العربية طلبت","البيت طلب","العيال عايزة","جبت حاجات البيت",

    // الأخطاء الإملائية
    "خت","خدت","اخت","اخدت","اقبت","جاليي",
    "صرقت","صرف","دفعتت","دفعة","دفعه",
    "جبتت","جبتا","اشترت","اكلت","كلت",
    "شربت","مصريف","حسااب","مواصلاط",
    "يجار","ايجر","اجار"
]
};

/* =========================================================
   Auto-Learning
========================================================= */
let learned = JSON.parse(localStorage.getItem("learnedWords")||"{}");
function saveLearned(){localStorage.setItem("learnedWords",JSON.stringify(learned));}
function learnWord(word,type){
 if(!word || word.length<2) return;
 if(!learned[type]) learned[type]=[];
 if(!learned[type].includes(word)){learned[type].push(word);saveLearned();}
}

/* =========================================================
   Fuzzy Matching (40%)
========================================================= */
function fuzzy(a,b){
 let mismatches=0;
 for(let i=0;i<Math.min(a.length,b.length);i++){
   if(a[i]!==b[i]) mismatches++;
 }
 return 1-(mismatches/Math.max(a.length,b.length));
}

/* =========================================================
   Intent AI — تحليل الجملة
========================================================= */
function analyze(text){
 const original=text;
 let amount=0, desc=text, type="expense";

 // استخراج رقم
 const n=text.match(/(\d+(\.\d+)?)/);
 if(n){amount=parseFloat(n[0]);desc=desc.replace(n[0],"");}

 // استخراج رقم بالكلمة
 if(!amount){
   for(const[w,v] of Object.entries(EG_DICT.numbers)){
     if(text.includes(w)){amount=v;desc=desc.replace(w,"");break;}
   }
 }

 // تحديد النوع
 let incScore=0, expScore=0;

 [...EG_DICT.income, ...(learned.income||[])].forEach(w=>{
   if(text.includes(w)) incScore++;
   else if(fuzzy(word(text),word(w)) > 0.4) incScore+=0.5;
 });

 [...EG_DICT.expense, ...(learned.expense||[])].forEach(w=>{
   if(text.includes(w)) expScore++;
   else if(fuzzy(word(text),word(w)) > 0.4) expScore+=0.5;
 });

 function word(t){return t.trim().split(" ")[0]||"";}

 type = incScore>expScore ? "income":"expense";

 // auto-learn
 desc.split(" ").forEach(w=>learnWord(w,type));

 desc = desc.trim() || (type==="income"?"وارد":"مصروف");
 return {amount,desc,type};
}

/* =========================================================
   حفظ المعاملة
========================================================= */
async function saveDirect(a,d,t){
 return await push(ref(db,t==='income'?'income':'expenses'),{
   amount:a,description:d,timestamp:Date.now()
 });
}

/* =========================================================
   Voice Processing
========================================================= */
async function processVoice(t){
 const {amount,desc,type}=analyze(t);
 if(!amount){hudText.innerText="مش سامع رقم واضح…";return;}

 document.getElementById("inpAmount").value=amount;
 document.getElementById("inpDesc").value=desc;
 setMode(type);

 await saveDirect(amount,desc,type);
 finishVoice("✔ تمت الإضافة");
}

function finishVoice(msg){
 hudText.innerText=msg;
 setTimeout(()=>{voiceHud.classList.remove("active");micBtn.classList.remove("listening");},1500);
}

/* =========================================================
   Speech Recognition
========================================================= */
const micBtn=document.getElementById("micBtn");
const voiceHud=document.getElementById("voiceHud");
const hudText=document.getElementById("hudText");

if(window.webkitSpeechRecognition){
 const R=new webkitSpeechRecognition();
 R.lang="ar-EG";R.continuous=false;

 R.onstart=()=>{micBtn.classList.add("listening");voiceHud.classList.add("active");hudText.innerText="سامعك…";};
 R.onresult=e=>processVoice(e.results[0][0].transcript);
 R.onerror=()=>finishVoice("❌ المايك مش شغال!");
 R.onend=()=>{};
 window.toggleVoice=()=>{micBtn.classList.contains("listening")?R.stop():R.start();}
}else{
 micBtn.style.display="none";
}

/* =========================================================
   UI + Firebase Sync
========================================================= */
window.setMode=m=>{
 currentMode=m;
 btnInc.classList.remove("active");btnExp.classList.remove("active");
 (m==="income"?btnInc:btnExp).classList.add("active");
 btnSubmit.style.background=m==="income"?"var(--success)":"var(--danger)";
};

window.saveTransaction=async e=>{
 e.preventDefault();
 const a=+inpAmount.value, d=inpDesc.value.trim();
 if(!a||!d)return;
 await saveDirect(a,d,currentMode);
 inpAmount.value="";inpDesc.value="";
};

onValue(ref(db),(s)=>{
 const data=s.val()||{};
 transactions=[];
 if(data.income)Object.entries(data.income).forEach(([k,v])=>transactions.push({...v,id:k,type:"income"}));
 if(data.expenses)Object.entries(data.expenses).forEach(([k,v])=>transactions.push({...v,id:k,type:"expense"}));
 transactions.sort((a,b)=>b.timestamp-a.timestamp);
 render();
});

function render(){
 const inc=transactions.filter(t=>t.type==="income").reduce((a,b)=>a+b.amount,0);
 const exp=transactions.filter(t=>t.type==="expense").reduce((a,b)=>a+b.amount,0);
 valInc.innerText=inc.toLocaleString();
 valExp.innerText=exp.toLocaleString();
 valBal.innerText=(inc-exp).toLocaleString();

 txList.innerHTML=transactions.map(t=>`
 <div class="tx-item">
 <div style="width:45px;height:45px;border-radius:12px;display:flex;align-items:center;justify-content:center;
 background:${t.type==='income'?'#dcfce7':'#fee2e2'};color:${t.type==='income'?'var(--success)':'var(--danger)'}">
 <i class="fa-solid ${t.type==='income'?'fa-arrow-down':'fa-arrow-up'}"></i>
 </div>
 <div style="flex:1">
 <div style="font-weight:700">${t.description}</div>
 <div style="font-size:.8rem;color:#64748b">${new Date(t.timestamp).toLocaleString('ar-EG')}</div>
 </div>
 <div style="font-weight:900;color:${t.type==='income'?'var(--success)':'var(--danger)'}">${t.amount.toLocaleString()}</div>
 </div>`).join("");
}

window.toggleTheme=()=>document.body.dataset.theme=document.body.dataset.theme==="dark"?"light":"dark";

window.exportExcel=()=>{
 const wb=XLSX.utils.book_new();
 const ws=XLSX.utils.json_to_sheet(transactions);
 XLSX.utils.book_append_sheet(wb,ws,"Data");
 XLSX.writeFile(wb,"Finance.xlsx");
};

</script>
</body>
</html>
