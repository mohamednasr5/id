<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at top left, #4f46e5 0%, #0f172a 40%, #020617 100%);
            min-height: 100vh;
            padding: 20px;
            color: #0f172a;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #0f172a, #020617);
            padding: 25px;
            border-radius: 18px;
            box-shadow: 0 20px 50px rgba(15,23,42,0.9);
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            perspective: 1200px;
        }

        .header::before {
            content: "";
            position: absolute;
            width: 260px;
            height: 260px;
            background: radial-gradient(circle at center, rgba(96,165,250,0.45), transparent 70%);
            top: -90px;
            left: -90px;
            filter: blur(4px);
            transform: translateZ(-1px);
            opacity: 0.9;
        }

        .header::after {
            content: "";
            position: absolute;
            width: 220px;
            height: 220px;
            background: radial-gradient(circle at center, rgba(251,191,36,0.35), transparent 70%);
            bottom: -80px;
            right: -80px;
            filter: blur(5px);
            transform: translateZ(-1px);
        }

        .header h1 {
            color: #e5e7eb;
            font-size: 2.4em;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header p {
            color: #9ca3af;
            font-size: 1.05em;
            position: relative;
            z-index: 1;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: radial-gradient(circle at top, #1e293b 0%, #020617 65%);
            padding: 22px;
            border-radius: 18px;
            box-shadow: 0 18px 45px rgba(15,23,42,0.85);
            text-align: center;
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            color: #e5e7eb;
            border: 1px solid rgba(148,163,184,0.45);
        }

        .stat-card::before {
            content: "";
            position: absolute;
            width: 160px;
            height: 160px;
            background: radial-gradient(circle at center, rgba(59,130,246,0.30), transparent 70%);
            top: -70px;
            right: -60px;
            opacity: 0.7;
            transform: translateZ(-1px);
        }

        .stat-card:hover {
            transform: translateY(-6px) translateZ(20px) scale(1.01);
            box-shadow: 0 24px 60px rgba(15,23,42,0.95);
        }

        .stat-card h3 {
            color: #9ca3af;
            font-size: 1.05em;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 2.1em;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-card.income .stat-value {
            color: #22c55e;
        }

        .stat-card.expense .stat-value {
            color: #f97373;
        }

        .stat-card.balance .stat-value {
            color: #60a5fa;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(430px, 1fr));
            gap: 26px;
            margin-bottom: 30px;
        }

        .form-card,
        .search-section,
        .records-section,
        .export-section {
            background: radial-gradient(circle at top, #0b1120 0%, #020617 60%);
            padding: 26px;
            border-radius: 18px;
            box-shadow: 0 18px 45px rgba(15,23,42,0.9);
            border: 1px solid rgba(148,163,184,0.5);
            color: #e5e7eb;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .form-card::before,
        .search-section::before,
        .records-section::before,
        .export-section::before {
            content: "";
            position: absolute;
            width: 180px;
            height: 180px;
            background: radial-gradient(circle at center, rgba(59,130,246,0.25), transparent 70%);
            top: -80px;
            left: -80px;
            filter: blur(4px);
            transform: translateZ(-1px);
        }

        .form-card h2,
        .search-section h2,
        .records-section h2,
        .export-section h2 {
            color: #e5e7eb;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 2px solid rgba(129,140,248,0.9);
            font-size: 1.4em;
            position: relative;
            z-index: 1;
        }

        .form-group {
            margin-bottom: 18px;
            position: relative;
            z-index: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #cbd5f5;
            font-weight: 600;
            font-size: 0.95em;
        }

        .input-with-mic {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .input-with-mic input,
        .input-with-mic textarea {
            flex: 1;
            padding: 11px 14px;
            border: 1px solid #1f2937;
            border-radius: 10px;
            font-size: 0.95em;
            transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
            font-family: inherit;
            background: #020617;
            color: #e5e7eb;
        }

        .input-with-mic input:focus,
        .input-with-mic textarea:focus,
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99,102,241,0.6);
            background: #020617;
        }

        .input-with-mic textarea {
            resize: vertical;
            min-height: 100px;
        }

        .mic-btn {
            width: 46px;
            height: 46px;
            border: none;
            border-radius: 12px;
            background: radial-gradient(circle at top, #22c55e, #16a34a);
            color: white;
            font-size: 1.15em;
            cursor: pointer;
            transition: all 0.25s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 12px 28px rgba(34,197,94,0.55);
        }

        .mic-btn:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 16px 40px rgba(34,197,94,0.7);
            filter: brightness(1.05);
        }

        .mic-btn.recording {
            background: radial-gradient(circle at top, #ef4444, #b91c1c);
            animation: pulse 1.5s infinite;
            box-shadow: 0 16px 40px rgba(239,68,68,0.7);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 12px rgba(239, 68, 68, 0);
            }
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid #1f2937;
            border-radius: 10px;
            font-size: 0.95em;
            transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
            font-family: inherit;
            background: #020617;
            color: #e5e7eb;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 90px;
        }

        .readonly-field {
            background-color: #020617;
            cursor: not-allowed;
            color: #9ca3af;
        }

        .btn {
            width: 100%;
            padding: 13px;
            border: none;
            border-radius: 12px;
            font-size: 1.01em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn span.icon {
            font-size: 1.15em;
        }

        .btn-income {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 12px 26px rgba(34,197,94,0.6);
        }

        .btn-income:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            transform: translateY(-2px);
            box-shadow: 0 18px 38px rgba(34,197,94,0.8);
        }

        .btn-expense {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            box-shadow: 0 12px 26px rgba(239,68,68,0.6);
        }

        .btn-expense:hover {
            background: linear-gradient(135deg, #b91c1c, #7f1d1d);
            transform: translateY(-2px);
            box-shadow: 0 18px 38px rgba(239,68,68,0.8);
        }

        .search-section {
            margin-bottom: 26px;
        }

        .search-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 14px;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .search-input {
            padding: 11px 14px;
            border: 1px solid #1f2937;
            border-radius: 10px;
            font-size: 0.95em;
            background: #020617;
            color: #e5e7eb;
        }

        .search-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99,102,241,0.7);
        }

        .btn-search {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            padding: 11px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.25s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 10px 26px rgba(99,102,241,0.7);
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 34px rgba(99,102,241,0.9);
        }

        .export-section {
            margin-bottom: 26px;
        }

        .btn-export {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 11px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.25s;
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 10px 26px rgba(245,158,11,0.65);
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 34px rgba(245,158,11,0.85);
        }

        .export-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .btn-delete-all {
            background: linear-gradient(135deg, #b91c1c, #7f1d1d);
            color: #fff;
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 10px 30px rgba(185,28,28,0.7);
            transition: transform .22s, box-shadow .22s, filter .22s;
        }

        .btn-delete-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(185,28,28,0.9);
            filter: brightness(1.05);
        }

        .records-section h2 {
            margin-bottom: 14px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .tab {
            padding: 9px 20px;
            border: none;
            background: #111827;
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.25s;
            color: #9ca3af;
            border: 1px solid rgba(55,65,81,0.9);
        }

        .tab.active {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            box-shadow: 0 10px 24px rgba(99,102,241,0.8);
        }

        .records-list {
            max-height: 620px;
            overflow-y: auto;
            padding-right: 4px;
            position: relative;
            z-index: 1;
        }

        .record-item {
            background: #020617;
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 10px;
            border-right: 5px solid #6366f1;
            transition: all 0.22s;
            cursor: pointer;
            display: block;
        }

        .record-item:hover {
            background: #0b1120;
            transform: translateX(-5px) translateY(-2px);
            box-shadow: 0 14px 32px rgba(15,23,42,0.85);
        }

        .record-item.income {
            border-right-color: #22c55e;
        }

        .record-item.expense {
            border-right-color: #ef4444;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .record-amount {
            font-size: 1.35em;
            font-weight: 800;
        }

        .record-amount.income {
            color: #22c55e;
        }

        .record-amount.expense {
            color: #f97373;
        }

        .record-date {
            color: #9ca3af;
            font-size: 0.85em;
        }

        .record-details {
            color: #d1d5db;
            margin-top: 8px;
            line-height: 1.6;
            font-size: 0.93em;
        }

        .record-person {
            display: inline-block;
            background: rgba(37,99,235,0.16);
            color: #bfdbfe;
            padding: 5px 14px;
            border-radius: 999px;
            font-size: 0.85em;
            margin-top: 6px;
            border: 1px solid rgba(59,130,246,0.6);
        }

        .delete-btn {
            background: #b91c1c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.25s;
        }

        .delete-btn:hover {
            background: #7f1d1d;
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #60a5fa;
            font-size: 1.05em;
        }

        .empty-state {
            text-align: center;
            padding: 46px 20px;
            color: #9ca3af;
        }

        .voice-status {
            font-size: 0.8em;
            color: #60a5fa;
            margin-top: 4px;
            min-height: 18px;
            font-weight: 500;
        }

        .voice-status.listening {
            color: #f97373;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .search-results-info {
            background: rgba(15,23,42,0.9);
            padding: 10px 14px;
            border-radius: 10px;
            margin-top: 12px;
            border-right: 4px solid #6366f1;
            color: #cbd5f5;
            font-size: 0.92em;
        }

        .search-results-info strong {
            color: #e5e7eb;
        }

        .search-result-item {
            padding: 8px 10px;
            border-radius: 10px;
            background: #020617;
            margin-top: 6px;
            cursor: pointer;
            border-right: 3px solid #6366f1;
            transition: background .2s, transform .2s, box-shadow .2s;
        }

        .search-result-item:hover {
            background: #0b1120;
            transform: translateX(-3px);
            box-shadow: 0 10px 24px rgba(15,23,42,0.9);
        }

        .search-extra-row {
            margin-top: 8px;
            font-size: 0.86em;
            color: #9ca3af;
        }

        .search-voice-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .hint-text {
            margin-top: 8px;
            color: #9ca3af;
            font-size: 0.85em;
        }

        /* Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø© (Modal) Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: #020617;
            color: #e5e7eb;
            width: min(480px, 95vw);
            border-radius: 18px;
            padding: 20px 22px;
            box-shadow: 0 28px 80px rgba(0,0,0,0.85);
            transform: translateY(28px) scale(0.96);
            opacity: 0;
            transition: transform 0.25s ease, opacity 0.25s ease;
            border: 1px solid rgba(148,163,184,0.65);
        }

        .modal-backdrop.active .modal {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .modal-title {
            font-size: 1.15em;
            font-weight: 700;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 1.45em;
            cursor: pointer;
        }

        .modal-body .form-group label {
            color: #e5e7eb;
        }

        .modal-body input,
        .modal-body textarea,
        .modal-body select {
            background: #020617;
            color: #e5e7eb;
            border-color: #1f2937;
        }

        .modal-actions {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            flex-wrap: wrap;
        }

        .btn-save-edit {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
            border: none;
            padding: 9px 18px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-save-edit:hover {
            filter: brightness(1.05);
        }

        .btn-cancel-edit {
            background: #4b5563;
            color: #e5e7eb;
            border: none;
            padding: 9px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .stat-value {
                font-size: 1.7em;
            }

            .export-controls {
                flex-direction: column;
            }

            .btn-export,
            .btn-search,
            .btn-delete-all {
                width: 100%;
            }
        }

        .currency {
            font-size: 0.7em;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
            <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card income">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
                <div class="stat-value" id="totalIncome">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
                <div style="color: #9ca3af; margin-top: 4px;" id="incomeCount">0 Ø¹Ù…Ù„ÙŠØ©</div>
            </div>
            <div class="stat-card expense">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                <div class="stat-value" id="totalExpense">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
                <div style="color: #9ca3af; margin-top: 4px;" id="expenseCount">0 Ø¹Ù…Ù„ÙŠØ©</div>
            </div>
            <div class="stat-card balance">
                <h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                <div class="stat-value" id="balance">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
                <div style="color: #9ca3af; margin-top: 4px;">Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙ</div>
            </div>
        </div>

        <!-- Forms -->
        <div class="main-content">
            <!-- Income Form -->
            <div class="form-card">
                <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯</h2>
                <form id="incomeForm">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                        <div class="input-with-mic">
                            <input type="number" id="incomeAmount" step="0.01" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                            <button type="button" class="mic-btn" id="micIncomeAmount">ğŸ¤</button>
                        </div>
                        <div class="voice-status" id="statusIncomeAmount"></div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³Ù„Ù… *</label>
                        <div class="input-with-mic">
                            <input type="text" id="incomePerson" required placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                            <button type="button" class="mic-btn" id="micIncomePerson">ğŸ¤</button>
                        </div>
                        <div class="voice-status" id="statusIncomePerson"></div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
                        <input type="text" id="incomeDateTime" class="readonly-field" readonly>
                    </div>
                    <button type="submit" class="btn btn-income">
                        <span class="icon">ğŸ’°</span>
                        <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯</span>
                    </button>
                </form>
            </div>

            <!-- Expense Form -->
            <div class="form-card">
                <h2>â– Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h2>
                <form id="expenseForm">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                        <div class="input-with-mic">
                            <input type="number" id="expenseAmount" step="0.01" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                            <button type="button" class="mic-btn" id="micExpenseAmount">ğŸ¤</button>
                        </div>
                        <div class="voice-status" id="statusExpenseAmount"></div>
                    </div>
                    <div class="form-group">
                        <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ *</label>
                        <div class="input-with-mic">
                            <textarea id="expenseDetails" required placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†..."></textarea>
                            <button type="button" class="mic-btn" id="micExpenseDetails">ğŸ¤</button>
                        </div>
                        <div class="voice-status" id="statusExpenseDetails"></div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
                        <input type="text" id="expenseDateTime" class="readonly-field" readonly>
                    </div>
                    <button type="submit" class="btn btn-expense">
                        <span class="icon">ğŸ’¸</span>
                        <span>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</h2>
            <div class="search-controls">
                <input type="number" id="searchAmount" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù„Øº...">
                <input type="text" id="searchPerson" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ...">
                <input type="text" id="searchDetails" class="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ...">
                <input type="date" id="searchDate" class="search-input">
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 4px;">
                <button class="btn-search" onclick="performSearch()">
                    <span class="icon">ğŸ”</span>
                    <span>Ø¨Ø­Ø«</span>
                </button>
                <button class="btn-search" onclick="clearSearch()" style="background: linear-gradient(135deg, #6b7280, #4b5563); box-shadow: 0 10px 24px rgba(75,85,99,0.7);">
                    <span class="icon">ğŸ”„</span>
                    <span>Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</span>
                </button>
            </div>
            <div class="search-voice-row">
                <button class="btn-search" id="voiceSearchBtn" style="margin-top: 8px; background: linear-gradient(135deg,#22c55e,#16a34a); box-shadow: 0 10px 24px rgba(34,197,94,0.7);">
                    <span class="icon">ğŸ¤</span>
                    <span>Ø¨Ø­Ø« ØµÙˆØªÙŠ</span>
                </button>
            </div>
            <div id="voiceSearchStatus" class="voice-status"></div>
            <div id="searchResultsInfo" style="display: none; margin-top: 10px;"></div>
            <div id="searchClickHint" class="hint-text">
                Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø©.
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <h2>ğŸ“¥ Ø§Ù„ØªØµØ¯ÙŠØ±</h2>
            <div class="export-controls">
                <button class="btn-export" onclick="exportToExcel('all')">
                    <span class="icon">ğŸ“Š</span>
                    <span>ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                </button>
                <button class="btn-export" onclick="exportToExcel('income')" style="background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 10px 26px rgba(34,197,94,0.65);">
                    <span class="icon">ğŸ“ˆ</span>
                    <span>ØªØµØ¯ÙŠØ± Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª</span>
                </button>
                <button class="btn-export" onclick="exportToExcel('expense')" style="background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 10px 26px rgba(239,68,68,0.65);">
                    <span class="icon">ğŸ“‰</span>
                    <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span>
                </button>
                <button class="btn-export" onclick="exportSearchResults()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); box-shadow: 0 10px 26px rgba(139,92,246,0.7);">
                    <span class="icon">ğŸ“‘</span>
                    <span>ØªØµØ¯ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</span>
                </button>
                <button class="btn-delete-all" onclick="deleteAllRecords()">
                    <span class="icon">ğŸ§¨</span>
                    <span>Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„</span>
                </button>
            </div>
        </div>

        <!-- Records Section -->
        <div class="records-section">
            <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <div class="tabs">
                <button class="tab active" data-tab="all">Ø§Ù„ÙƒÙ„</button>
                <button class="tab" data-tab="income">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</button>
                <button class="tab" data-tab="expense">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
            </div>
            <div class="records-list" id="recordsList">
                <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø© Ù„ØªÙØ§ØµÙŠÙ„/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© -->
    <div class="modal-backdrop" id="recordModalBackdrop">
        <div class="modal" id="recordModal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</div>
                <button class="modal-close" id="modalCloseBtn">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalRecordId">
                <input type="hidden" id="modalRecordCollection">
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
                    <select id="modalType">
                        <option value="income">Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯</option>
                        <option value="expense">Ù…ØµØ±ÙˆÙ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input type="number" id="modalAmount" step="0.01">
                </div>
                <div class="form-group" id="modalPersonGroup">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ</label>
                    <input type="text" id="modalPerson">
                </div>
                <div class="form-group" id="modalDetailsGroup">
                    <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                    <textarea id="modalDetails"></textarea>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª (Ø¹Ø±Ø¶ ÙÙ‚Ø·)</label>
                    <input type="text" id="modalDateTime" readonly class="readonly-field">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-save-edit" id="modalSaveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button class="btn-cancel-edit" id="modalCancelBtn">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            deleteDoc,
            doc,
            query,
            orderBy,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
            authDomain: "nasrapp-7a0fc.firebaseapp.com",
            projectId: "nasrapp-7a0fc",
            storageBucket: "nasrapp-7a0fc.firebasestorage.app",
            messagingSenderId: "826970736109",
            appId: "1:826970736109:web:c1cc3c3a1008e719b193e4",
            measurementId: "G-BHP6J4K9VN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Collections
        const incomeCollection = collection(db, 'income');
        const expenseCollection = collection(db, 'expenses');

        // Global Variables
        let currentTab = 'all';
        let allRecords = [];
        let searchResults = [];
        let isSearching = false;

        // Voice Recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ar-EG';
            recognition.continuous = false;
            recognition.interimResults = false;
        }

        function startVoiceInput(inputId, statusId, isNumber = false) {
            if (!recognition) {
                alert('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø£Ùˆ Edge');
                return;
            }

            const inputElement = document.getElementById(inputId);
            const statusElement = document.getElementById(statusId);
            const micBtn = document.getElementById('mic' + inputId.charAt(0).toUpperCase() + inputId.slice(1));

            recognition.lang = 'ar-EG';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.start();
            micBtn.classList.add('recording');
            statusElement.textContent = 'ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†';
            statusElement.classList.add('listening');

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;

                if (isNumber) {
                    const convertedNumber = convertArabicToEnglishNumbers(transcript);
                    const numberValue = extractNumber(convertedNumber);
                    if (numberValue) {
                        inputElement.value = numberValue;
                        statusElement.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: ' + numberValue;
                    } else {
                        inputElement.value = transcript;
                        statusElement.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: ' + transcript;
                    }
                } else {
                    inputElement.value = transcript;
                    statusElement.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­';
                }

                setTimeout(() => {
                    statusElement.textContent = '';
                    statusElement.classList.remove('listening');
                }, 3000);
            };

            recognition.onerror = (event) => {
                micBtn.classList.remove('recording');
                statusElement.classList.remove('listening');

                if (event.error === 'no-speech') {
                    statusElement.textContent = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ØµÙˆØª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                } else if (event.error === 'not-allowed') {
                    statusElement.textContent = 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†';
                } else {
                    statusElement.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª';
                }

                setTimeout(() => {
                    statusElement.textContent = '';
                }, 3000);
            };

            recognition.onend = () => {
                micBtn.classList.remove('recording');
                statusElement.classList.remove('listening');
            };
        }

        // Convert Arabic numbers to English
        function convertArabicToEnglishNumbers(str) {
            const arabicNumbers = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

            let result = str;
            for (let i = 0; i < 10; i++) {
                result = result.replace(new RegExp(arabicNumbers[i], 'g'), englishNumbers[i]);
            }
            return result;
        }

        // Extract number from text
        function extractNumber(text) {
            const numberMatch = text.match(/[\d.]+/);
            if (numberMatch) {
                return numberMatch[0];
            }

            const wordNumbers = {
                'ØµÙØ±': '0', 'ÙˆØ§Ø­Ø¯': '1', 'Ø§Ø«Ù†ÙŠÙ†': '2', 'Ø§ØªÙ†ÙŠÙ†': '2', 'Ø«Ù„Ø§Ø«Ø©': '3', 'ØªÙ„Ø§ØªØ©': '3',
                'Ø£Ø±Ø¨Ø¹Ø©': '4', 'Ø§Ø±Ø¨Ø¹Ø©': '4', 'Ø®Ù…Ø³Ø©': '5', 'Ø³ØªØ©': '6', 'Ø³Ø¨Ø¹Ø©': '7',
                'Ø«Ù…Ø§Ù†ÙŠØ©': '8', 'ØªØ³Ø¹Ø©': '9', 'Ø¹Ø´Ø±Ø©': '10', 'Ø¹Ø´Ø±': '10',
                'Ø¹Ø´Ø±ÙŠÙ†': '20', 'Ø«Ù„Ø§Ø«ÙŠÙ†': '30', 'Ø£Ø±Ø¨Ø¹ÙŠÙ†': '40', 'Ø§Ø±Ø¨Ø¹ÙŠÙ†': '40',
                'Ø®Ù…Ø³ÙŠÙ†': '50', 'Ø³ØªÙŠÙ†': '60', 'Ø³Ø¨Ø¹ÙŠÙ†': '70', 'Ø«Ù…Ø§Ù†ÙŠÙ†': '80', 'ØªØ³Ø¹ÙŠÙ†': '90',
                'Ù…ÙŠØ©': '100', 'Ù…Ø§Ø¦Ø©': '100', 'Ù…ÙŠØªÙŠÙ†': '200', 'Ù…Ø¦ØªÙŠÙ†': '200',
                'ØªÙ„ØªÙ…ÙŠØ©': '300', 'Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©': '300', 'Ø§Ø±Ø¨Ø¹Ù…ÙŠØ©': '400', 'Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©': '400',
                'Ø®Ù…Ø³Ù…ÙŠØ©': '500', 'Ø®Ù…Ø³Ù…Ø§Ø¦Ø©': '500', 'Ø³ØªÙ…ÙŠØ©': '600', 'Ø³ØªÙ…Ø§Ø¦Ø©': '600',
                'Ø³Ø¨Ø¹Ù…ÙŠØ©': '700', 'Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©': '700', 'ØªÙ…Ù†Ù…ÙŠØ©': '800', 'Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©': '800',
                'ØªØ³Ø¹Ù…ÙŠØ©': '900', 'ØªØ³Ø¹Ù…Ø§Ø¦Ø©': '900', 'Ø£Ù„Ù': '1000', 'Ø§Ù„Ù': '1000'
            };

            for (const [word, number] of Object.entries(wordNumbers)) {
                if (text.includes(word)) {
                    return number;
                }
            }

            return null;
        }

        // Mic Button Event Listeners
        document.getElementById('micIncomeAmount').addEventListener('click', () => {
            startVoiceInput('incomeAmount', 'statusIncomeAmount', true);
        });

        document.getElementById('micIncomePerson').addEventListener('click', () => {
            startVoiceInput('incomePerson', 'statusIncomePerson', false);
        });

        document.getElementById('micExpenseAmount').addEventListener('click', () => {
            startVoiceInput('expenseAmount', 'statusExpenseAmount', true);
        });

        document.getElementById('micExpenseDetails').addEventListener('click', () => {
            startVoiceInput('expenseDetails', 'statusExpenseDetails', false);
        });

        // Voice Search
        const voiceSearchBtn = document.getElementById('voiceSearchBtn');
        const voiceSearchStatus = document.getElementById('voiceSearchStatus');

        if (voiceSearchBtn && recognition) {
            voiceSearchBtn.addEventListener('click', () => {
                recognition.lang = 'ar-EG';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.start();
                voiceSearchStatus.textContent = 'ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ù…Ø± Ø§Ù„Ø¨Ø­Ø«...';
                voiceSearchStatus.classList.add('listening');

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    voiceSearchStatus.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: ' + transcript;

                    const num = extractNumber(convertArabicToEnglishNumbers(transcript));
                    document.getElementById('searchAmount').value = '';
                    document.getElementById('searchPerson').value = '';
                    document.getElementById('searchDetails').value = '';

                    if (num) {
                        document.getElementById('searchAmount').value = num;
                    } else if (transcript.includes('Ø­Ø³Ø§Ø¨') || transcript.includes('Ø¹Ù†Ø¯')) {
                        const name = transcript.replace('Ø­Ø³Ø§Ø¨', '').replace('Ø¹Ù†Ø¯', '').trim();
                        document.getElementById('searchPerson').value = name;
                    } else {
                        document.getElementById('searchDetails').value = transcript;
                    }

                    setTimeout(() => {
                        voiceSearchStatus.textContent = '';
                        voiceSearchStatus.classList.remove('listening');
                    }, 2500);

                    window.performSearch();
                };

                recognition.onerror = () => {
                    voiceSearchStatus.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ';
                    voiceSearchStatus.classList.remove('listening');
                };

                recognition.onend = () => {
                    voiceSearchStatus.classList.remove('listening');
                };
            });
        }

        // Format Date and Time
        function formatDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            return now.toLocaleDateString('ar-EG', options);
        }

        function updateDateTimeFields() {
            const dateTime = formatDateTime();
            document.getElementById('incomeDateTime').value = dateTime;
            document.getElementById('expenseDateTime').value = dateTime;
        }

        setInterval(updateDateTimeFields, 1000);
        updateDateTimeFields();

        // Add Income
        document.getElementById('incomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const person = document.getElementById('incomePerson').value.trim();
            const dateTime = document.getElementById('incomeDateTime').value;

            try {
                await addDoc(incomeCollection, {
                    amount: amount,
                    person: person,
                    dateTime: dateTime,
                    timestamp: new Date().getTime(),
                    type: 'income'
                });

                document.getElementById('incomeForm').reset();
                updateDateTimeFields();

                const btn = e.target.querySelector('.btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!';
                btn.style.background = '#22c55e';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (error) {
                console.error('Error adding income:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº');
            }
        });

        // Add Expense
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const details = document.getElementById('expenseDetails').value.trim();
            const dateTime = document.getElementById('expenseDateTime').value;

            try {
                await addDoc(expenseCollection, {
                    amount: amount,
                    details: details,
                    dateTime: dateTime,
                    timestamp: new Date().getTime(),
                    type: 'expense'
                });

                document.getElementById('expenseForm').reset();
                updateDateTimeFields();

                const btn = e.target.querySelector('.btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!';
                btn.style.background = '#22c55e';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (error) {
                console.error('Error adding expense:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ');
            }
        });

        // Load and Display Records
        async function loadRecords() {
            try {
                const incomeSnapshot = await getDocs(query(incomeCollection, orderBy('timestamp', 'desc')));
                const expenseSnapshot = await getDocs(query(expenseCollection, orderBy('timestamp', 'desc')));

                allRecords = [];

                incomeSnapshot.forEach((d) => {
                    allRecords.push({
                        id: d.id,
                        ...d.data(),
                        collectionType: 'income'
                    });
                });

                expenseSnapshot.forEach((d) => {
                    allRecords.push({
                        id: d.id,
                        ...d.data(),
                        collectionType: 'expense'
                    });
                });

                allRecords.sort((a, b) => b.timestamp - a.timestamp);

                displayRecords();
                updateStatistics();
            } catch (error) {
                console.error('Error loading records:', error);
            }
        }

        // Perform Search
        window.performSearch = function () {
            const searchAmount = document.getElementById('searchAmount').value;
            const searchPerson = document.getElementById('searchPerson').value.toLowerCase().trim();
            const searchDetails = document.getElementById('searchDetails').value.toLowerCase().trim();
            const searchDate = document.getElementById('searchDate').value;

            searchResults = allRecords.filter(record => {
                let matches = true;

                if (searchAmount) {
                    matches = matches && record.amount === parseFloat(searchAmount);
                }

                if (searchPerson) {
                    const person = record.person || '';
                    matches = matches && person.toLowerCase().includes(searchPerson);
                }

                if (searchDetails) {
                    const details = record.details || '';
                    matches = matches && details.toLowerCase().includes(searchDetails);
                }

                if (searchDate) {
                    const recordDate = record.dateTime.split(' ')[0];
                    matches = matches && recordDate.includes(searchDate);
                }

                return matches;
            });

            isSearching = true;
            displayRecords();

            const resultsInfo = document.getElementById('searchResultsInfo');
            resultsInfo.style.display = 'block';
            resultsInfo.innerHTML = `<div class="search-results-info"><strong>âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${searchResults.length} Ù†ØªÙŠØ¬Ø©</strong></div>`;
        };

        // Clear Search
        window.clearSearch = function () {
            document.getElementById('searchAmount').value = '';
            document.getElementById('searchPerson').value = '';
            document.getElementById('searchDetails').value = '';
            document.getElementById('searchDate').value = '';
            document.getElementById('searchResultsInfo').style.display = 'none';
            isSearching = false;
            displayRecords();
        };

        // Display Records
        function displayRecords() {
            const recordsList = document.getElementById('recordsList');

            let filteredRecords = isSearching ? searchResults : allRecords;
            if (!isSearching && currentTab !== 'all') {
                filteredRecords = allRecords.filter(r => r.type === currentTab);
            }

            if (filteredRecords.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <h3 style="margin-bottom: 6px;">${isSearching ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø«' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯'}</h3>
                        <p>${isSearching ? 'Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ø£Ø®Ø±Ù‰' : 'Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯ Ø£Ùˆ Ù…ØµØ±ÙˆÙ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰'}</p>
                    </div>
                `;
                return;
            }

            recordsList.innerHTML = filteredRecords.map(record => {
                const dataAttr = `data-id="${record.id}" data-collection="${record.collectionType}"`;
                if (record.type === 'income') {
                    return `
                        <div class="record-item income" ${dataAttr} onclick="openRecordModal('${record.id}','${record.collectionType}')">
                            <div class="record-header">
                                <div class="record-amount income">+${Number(record.amount).toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡</div>
                                <div style="text-align:left; min-width:160px;">
                                    <div class="record-date">ğŸ“… ${record.dateTime}</div>
                                    <button class="delete-btn" onclick="event.stopPropagation(); deleteRecord('${record.id}', 'income')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                                </div>
                            </div>
                            <div class="record-person">ğŸ‘¤ ${record.person}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="record-item expense" ${dataAttr} onclick="openRecordModal('${record.id}','${record.collectionType}')">
                            <div class="record-header">
                                <div class="record-amount expense">-${Number(record.amount).toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡</div>
                                <div style="text-align:left; min-width:160px;">
                                    <div class="record-date">ğŸ“… ${record.dateTime}</div>
                                    <button class="delete-btn" onclick="event.stopPropagation(); deleteRecord('${record.id}', 'expense')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                                </div>
                            </div>
                            <div class="record-details">ğŸ“ ${record.details || ''}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Update Statistics
        function updateStatistics() {
            const incomeRecords = allRecords.filter(r => r.type === 'income');
            const expenseRecords = allRecords.filter(r => r.type === 'expense');

            const totalIncome = incomeRecords.reduce((sum, r) => sum + Number(r.amount), 0);
            const totalExpense = expenseRecords.reduce((sum, r) => sum + Number(r.amount), 0);
            const balance = totalIncome - totalExpense;

            document.getElementById('totalIncome').innerHTML = `${totalIncome.toLocaleString('ar-EG', { maximumFractionDigits: 0 })} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;
            document.getElementById('totalExpense').innerHTML = `${totalExpense.toLocaleString('ar-EG', { maximumFractionDigits: 0 })} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;
            document.getElementById('balance').innerHTML = `${balance.toLocaleString('ar-EG', { maximumFractionDigits: 0 })} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;

            document.getElementById('incomeCount').textContent = `${incomeRecords.length} Ø¹Ù…Ù„ÙŠØ©`;
            document.getElementById('expenseCount').textContent = `${expenseRecords.length} Ø¹Ù…Ù„ÙŠØ©`;
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.getAttribute('data-tab');
                displayRecords();
            });
        });

        // Delete Record
        window.deleteRecord = async function (recordId, type) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) {
                return;
            }

            try {
                const collectionRef = type === 'income' ? incomeCollection : expenseCollection;
                await deleteDoc(doc(collectionRef, recordId));
                await loadRecords();
            } catch (error) {
                console.error('Error deleting record:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
            }
        };

        // Delete All (with password)
        window.deleteAllRecords = async function () {
            const pass = prompt('Ù„Ø£Ù…Ø§Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„:');
            if (pass !== '521988') {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…Ø³Ø­');
                return;
            }

            if (!confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (ÙˆØ§Ø±Ø¯ + Ù…ØµØ±ÙˆÙ) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

            try {
                const incomeSnap = await getDocs(incomeCollection);
                const expenseSnap = await getDocs(expenseCollection);

                const batchDeletes = [];
                incomeSnap.forEach((d) => batchDeletes.push(deleteDoc(doc(incomeCollection, d.id))));
                expenseSnap.forEach((d) => batchDeletes.push(deleteDoc(doc(expenseCollection, d.id))));

                await Promise.all(batchDeletes);
                await loadRecords();
                alert('ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (err) {
                console.error(err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„');
            }
        };

        // Modal Logic
        window.openRecordModal = function (id, collectionType) {
            const record = allRecords.find(r => r.id === id && r.collectionType === collectionType);
            if (!record) return;

            document.getElementById('modalRecordId').value = record.id;
            document.getElementById('modalRecordCollection').value = collectionType;
            document.getElementById('modalAmount').value = record.amount;
            document.getElementById('modalDateTime').value = record.dateTime;

            const modalType = document.getElementById('modalType');
            const personGroup = document.getElementById('modalPersonGroup');
            const detailsGroup = document.getElementById('modalDetailsGroup');
            const modalPerson = document.getElementById('modalPerson');
            const modalDetails = document.getElementById('modalDetails');

            modalType.value = record.type;

            if (record.type === 'income') {
                personGroup.style.display = 'block';
                detailsGroup.style.display = 'none';
                modalPerson.value = record.person || '';
                modalDetails.value = '';
            } else {
                personGroup.style.display = 'none';
                detailsGroup.style.display = 'block';
                modalPerson.value = '';
                modalDetails.value = record.details || '';
            }

            document.getElementById('recordModalBackdrop').classList.add('active');
            document.getElementById('modalTitle').textContent = 'ØªÙØ§ØµÙŠÙ„/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
        };

        document.getElementById('modalType').addEventListener('change', (e) => {
            const type = e.target.value;
            const personGroup = document.getElementById('modalPersonGroup');
            const detailsGroup = document.getElementById('modalDetailsGroup');

            if (type === 'income') {
                personGroup.style.display = 'block';
                detailsGroup.style.display = 'none';
            } else {
                personGroup.style.display = 'none';
                detailsGroup.style.display = 'block';
            }
        });

        function closeRecordModal() {
            document.getElementById('recordModalBackdrop').classList.remove('active');
        }

        document.getElementById('modalCloseBtn').addEventListener('click', closeRecordModal);
        document.getElementById('modalCancelBtn').addEventListener('click', closeRecordModal);
        document.getElementById('recordModalBackdrop').addEventListener('click', (e) => {
            if (e.target.id === 'recordModalBackdrop') closeRecordModal();
        });

        document.getElementById('modalSaveBtn').addEventListener('click', async () => {
            const id = document.getElementById('modalRecordId').value;
            const collectionType = document.getElementById('modalRecordCollection').value;
            const newType = document.getElementById('modalType').value;
            const amount = parseFloat(document.getElementById('modalAmount').value) || 0;
            const person = document.getElementById('modalPerson').value.trim();
            const details = document.getElementById('modalDetails').value.trim();

            if (!amount) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }

            try {
                const oldCollectionRef = collectionType === 'income' ? incomeCollection : expenseCollection;
                const recRef = doc(oldCollectionRef, id);

                if (collectionType !== newType) {
                    const oldRecord = allRecords.find(r => r.id === id && r.collectionType === collectionType);
                    if (!oldRecord) return;

                    await deleteDoc(recRef);

                    if (newType === 'income') {
                        await addDoc(incomeCollection, {
                            amount,
                            person: person || (oldRecord.person || ''),
                            dateTime: oldRecord.dateTime,
                            timestamp: oldRecord.timestamp || new Date().getTime(),
                            type: 'income'
                        });
                    } else {
                        await addDoc(expenseCollection, {
                            amount,
                            details: details || (oldRecord.details || ''),
                            dateTime: oldRecord.dateTime,
                            timestamp: oldRecord.timestamp || new Date().getTime(),
                            type: 'expense'
                        });
                    }
                } else {
                    const updates = { amount, type: newType };
                    if (newType === 'income') {
                        updates.person = person;
                    } else {
                        updates.details = details;
                    }
                    await updateDoc(recRef, updates);
                }

                closeRecordModal();
                await loadRecords();
            } catch (err) {
                console.error(err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
            }
        });

        // Export to Excel helper (styling)
        function styleWorksheet(ws, wsData, headerRowsCount) {
            if (!ws['!ref']) return;
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const isHeader = R < headerRowsCount;
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (!ws[cell_ref]) continue;

                    const rowData = wsData[R] || [];
                    const typeCell = rowData[3];
                    let fillColor = '020617';

                    if (isHeader) {
                        fillColor = '1d4ed8'; // Ø£Ø²Ø±Ù‚ Ù„Ù„Ù‡ÙŠØ¯Ø±
                    } else if (typeCell === 'Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯') {
                        fillColor = 'd1fae5'; // Ø£Ø®Ø¶Ø± ÙØ§ØªØ­
                    } else if (typeCell === 'Ù…ØµØ±ÙˆÙ') {
                        fillColor = 'fee2e2'; // Ø£Ø­Ù…Ø± ÙØ§ØªØ­
                    } else if (R % 2 === 0) {
                        fillColor = 'f3f4f6'; // ØµÙÙˆÙ Ù…ØªØ¨Ø§Ø¯Ù„Ø©
                    }

                    ws[cell_ref].s = {
                        font: {
                            bold: isHeader,
                            color: { rgb: isHeader ? 'ffffff' : '000000' }
                        },
                        fill: {
                            fgColor: { rgb: fillColor }
                        },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: {
                            top: { style: 'medium', color: { rgb: '000000' } },
                            bottom: { style: 'medium', color: { rgb: '000000' } },
                            left: { style: 'medium', color: { rgb: '000000' } },
                            right: { style: 'medium', color: { rgb: '000000' } }
                        },
                        numFmt: (C === 2 && !isHeader ? "0" : undefined)
                    };
                }
            }
        }

        // Export to Excel
        window.exportToExcel = function (type) {
            let recordsToExport = allRecords;

            if (type === 'income') {
                recordsToExport = allRecords.filter(r => r.type === 'income');
            } else if (type === 'expense') {
                recordsToExport = allRecords.filter(r => r.type === 'expense');
            }

            if (recordsToExport.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const wb = XLSX.utils.book_new();

            const wsData = [];

            wsData.push(['Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª - ØªÙ‚Ø±ÙŠØ± ' + (type === 'income' ? 'Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©' : type === 'expense' ? 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' : 'ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª')]);
            wsData.push([]);

            wsData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ / Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„Ù†ÙˆØ¹']);

            const incomeRows = recordsToExport.filter(r => r.type === 'income');
            const expenseRows = recordsToExport.filter(r => r.type === 'expense');

            incomeRows.forEach(record => {
                wsData.push([record.dateTime, record.person || '', Number(record.amount), 'Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯']);
            });

            expenseRows.forEach(record => {
                wsData.push([record.dateTime, record.details || '', Number(record.amount), 'Ù…ØµØ±ÙˆÙ']);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            styleWorksheet(ws, wsData, 3);

            XLSX.utils.book_append_sheet(wb, ws, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');

            const fileName =
                type === 'income'
                    ? 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø¨Ø§Ù„Øº_Ø§Ù„ÙˆØ§Ø±Ø¯Ø©.xlsx'
                    : type === 'expense'
                    ? 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.xlsx'
                    : 'ØªÙ‚Ø±ÙŠØ±_ÙƒÙ„_Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.xlsx';

            XLSX.writeFile(wb, fileName);
        };

        // Export Search Results
        window.exportSearchResults = function () {
            if (!isSearching || searchResults.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
                return;
            }

            const wb = XLSX.utils.book_new();
            const wsData = [];

            wsData.push(['Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª - ØªÙ‚Ø±ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«']);
            wsData.push([]);
            wsData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ / Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„Ù†ÙˆØ¹']);

            searchResults.forEach(record => {
                const isIncome = record.type === 'income';
                wsData.push([
                    record.dateTime,
                    isIncome ? (record.person || '') : (record.details || ''),
                    Number(record.amount),
                    isIncome ? 'Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯' : 'Ù…ØµØ±ÙˆÙ'
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            styleWorksheet(ws, wsData, 3);

            XLSX.utils.book_append_sheet(wb, ws, 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«');
            XLSX.writeFile(wb, 'ØªÙ‚Ø±ÙŠØ±_Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø¨Ø­Ø«.xlsx');
        };

        // Initial load
        loadRecords();
    </script>
</body>
</html>
