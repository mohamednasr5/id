<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            background:radial-gradient(circle at top left,#4f46e5 0%,#0f172a 40%,#020617 100%);
            min-height:100vh;
            padding:20px;
            color:#0f172a
        }
        .container{max-width:1400px;margin:0 auto}
        .header{
            background:linear-gradient(135deg,#0f172a,#020617);
            padding:25px;border-radius:18px;
            box-shadow:0 20px 50px rgba(15,23,42,.9);
            text-align:center;margin-bottom:30px;
            position:relative;overflow:hidden;
            transform-style:preserve-3d;perspective:1200px
        }
        .header::before{
            content:"";position:absolute;width:260px;height:260px;
            background:radial-gradient(circle at center,rgba(96,165,250,.45),transparent 70%);
            top:-90px;left:-90px;filter:blur(4px);transform:translateZ(-1px);opacity:.9
        }
        .header::after{
            content:"";position:absolute;width:220px;height:220px;
            background:radial-gradient(circle at center,rgba(251,191,36,.35),transparent 70%);
            bottom:-80px;right:-80px;filter:blur(5px);transform:translateZ(-1px)
        }
        .header h1{color:#e5e7eb;font-size:2.4em;margin-bottom:8px;position:relative;z-index:1}
        .header p{color:#9ca3af;font-size:1.05em;position:relative;z-index:1}

        .stats-container{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
            gap:20px;margin-bottom:30px
        }
        .stat-card{
            background:radial-gradient(circle at top,#1e293b 0%,#020617 65%);
            padding:22px;border-radius:18px;
            box-shadow:0 18px 45px rgba(15,23,42,.85);
            text-align:center;transition:.25s;
            position:relative;overflow:hidden;
            transform-style:preserve-3d;
            color:#e5e7eb;
            border:1px solid rgba(148,163,184,.45)
        }
        .stat-card::before{
            content:"";position:absolute;width:160px;height:160px;
            background:radial-gradient(circle at center,rgba(59,130,246,.3),transparent 70%);
            top:-70px;right:-60px;opacity:.7;transform:translateZ(-1px)
        }
        .stat-card:hover{transform:translateY(-6px) translateZ(20px) scale(1.01);box-shadow:0 24px 60px rgba(15,23,42,.95)}
        .stat-card h3{color:#9ca3af;font-size:1.05em;margin-bottom:12px}
        .stat-value{font-size:2.1em;font-weight:800;margin-bottom:4px}
        .stat-card.income .stat-value{color:#22c55e}
        .stat-card.expense .stat-value{color:#f97373}
        .stat-card.balance .stat-value{color:#60a5fa}

        .main-content{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(430px,1fr));
            gap:26px;margin-bottom:30px
        }
        .form-card,.search-section,.records-section,.export-section{
            background:radial-gradient(circle at top,#0b1120 0%,#020617 60%);
            padding:26px;border-radius:18px;
            box-shadow:0 18px 45px rgba(15,23,42,.9);
            border:1px solid rgba(148,163,184,.5);
            color:#e5e7eb;position:relative;overflow:hidden;
        }
        .form-card::before,.search-section::before,.records-section::before,.export-section::before{
            content:"";position:absolute;width:180px;height:180px;
            background:radial-gradient(circle at center,rgba(59,130,246,.25),transparent 70%);
            top:-80px;left:-80px;filter:blur(4px);transform:translateZ(-1px)
        }
        .form-card h2,.search-section h2,.records-section h2,.export-section h2{
            color:#e5e7eb;margin-bottom:18px;
            padding-bottom:14px;border-bottom:2px solid rgba(129,140,248,.9);
            font-size:1.4em;position:relative;z-index:1
        }
        .form-group{margin-bottom:18px;position:relative;z-index:1}
        .form-group label{display:block;margin-bottom:6px;color:#cbd5f5;font-weight:600;font-size:.95em}

        .input-with-mic{position:relative;display:flex;gap:10px;align-items:stretch}
        .input-with-mic input,.input-with-mic textarea{
            flex:1;padding:11px 14px;border:1px solid #1f2937;
            border-radius:10px;font-size:.95em;
            transition:.3s;font-family:inherit;
            background:#020617;color:#e5e7eb
        }
        .input-with-mic textarea{resize:vertical;min-height:100px}
        .form-group input,.form-group textarea,.form-group select{
            width:100%;padding:11px 14px;border:1px solid #1f2937;
            border-radius:10px;font-size:.95em;
            transition:.3s;font-family:inherit;
            background:#020617;color:#e5e7eb
        }
        .input-with-mic input:focus,.input-with-mic textarea:focus,
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{
            outline:none;border-color:#6366f1;
            box-shadow:0 0 0 1px rgba(99,102,241,.6);
            background:#020617
        }
        .readonly-field{background:#020617;cursor:not-allowed;color:#9ca3af}

        .mic-btn{
            width:46px;height:46px;border:none;border-radius:12px;
            background:radial-gradient(circle at top,#22c55e,#16a34a);
            color:#fff;font-size:1.15em;cursor:pointer;
            transition:.25s;display:flex;align-items:center;justify-content:center;
            flex-shrink:0;box-shadow:0 12px 28px rgba(34,197,94,.55)
        }
        .mic-btn:hover{transform:translateY(-2px) scale(1.03);box-shadow:0 16px 40px rgba(34,197,94,.7);filter:brightness(1.05)}
        .mic-btn.recording{
            background:radial-gradient(circle at top,#ef4444,#b91c1c);
            animation:pulse 1.5s infinite;
            box-shadow:0 16px 40px rgba(239,68,68,.7)
        }
        @keyframes pulse{
            0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(239,68,68,.7)}
            50%{transform:scale(1.05);box-shadow:0 0 0 12px rgba(239,68,68,0)}
        }

        .btn{
            width:100%;padding:13px;border:none;border-radius:12px;
            font-size:1.01em;font-weight:700;cursor:pointer;
            transition:.25s;color:#fff;
            display:inline-flex;align-items:center;justify-content:center;gap:8px
        }
        .btn span.icon{font-size:1.15em}
        .btn-income{
            background:linear-gradient(135deg,#22c55e,#16a34a);
            box-shadow:0 12px 26px rgba(34,197,94,.6)
        }
        .btn-income:hover{background:linear-gradient(135deg,#16a34a,#15803d);transform:translateY(-2px);box-shadow:0 18px 38px rgba(34,197,94,.8)}
        .btn-expense{
            background:linear-gradient(135deg,#ef4444,#b91c1c);
            box-shadow:0 12px 26px rgba(239,68,68,.6)
        }
        .btn-expense:hover{background:linear-gradient(135deg,#b91c1c,#7f1d1d);transform:translateY(-2px);box-shadow:0 18px 38px rgba(239,68,68,.8)}

        .search-section{margin-bottom:26px}
        .search-controls{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
            gap:14px;margin-bottom:12px;position:relative;z-index:1
        }
        .search-input{
            padding:11px 14px;border:1px solid #1f2937;border-radius:10px;
            font-size:.95em;background:#020617;color:#e5e7eb
        }
        .search-input:focus{
            outline:none;border-color:#6366f1;
            box-shadow:0 0 0 1px rgba(99,102,241,.7)
        }
        .btn-search{
            background:linear-gradient(135deg,#6366f1,#4f46e5);
            color:#fff;padding:11px 20px;border:none;border-radius:10px;
            cursor:pointer;font-weight:700;transition:.25s;
            display:inline-flex;align-items:center;justify-content:center;gap:6px;
            box-shadow:0 10px 26px rgba(99,102,241,.7)
        }
        .btn-search:hover{transform:translateY(-2px);box-shadow:0 16px 34px rgba(99,102,241,.9)}

        .export-section{margin-bottom:26px}
        .btn-export{
            background:linear-gradient(135deg,#f59e0b,#d97706);
            color:#fff;padding:11px 20px;border:none;border-radius:10px;
            cursor:pointer;font-weight:700;transition:.25s;
            margin-right:6px;display:inline-flex;align-items:center;justify-content:center;gap:6px;
            box-shadow:0 10px 26px rgba(245,158,11,.65)
        }
        .btn-export:hover{transform:translateY(-2px);box-shadow:0 16px 34px rgba(245,158,11,.85)}
        .export-controls{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;position:relative;z-index:1}

        .btn-delete-all{
            background:linear-gradient(135deg,#b91c1c,#7f1d1d);
            color:#fff;padding:10px 18px;border-radius:10px;border:none;
            cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:6px;
            box-shadow:0 10px 30px rgba(185,28,28,.7);
            transition:.22s
        }
        .btn-delete-all:hover{transform:translateY(-2px);box-shadow:0 16px 40px rgba(185,28,28,.9);filter:brightness(1.05)}

        .records-section h2{margin-bottom:14px}
        .tabs{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;position:relative;z-index:1}
        .tab{
            padding:9px 20px;border:none;background:#111827;border-radius:999px;
            cursor:pointer;font-size:.95em;font-weight:600;transition:.25s;
            color:#9ca3af;border:1px solid rgba(55,65,81,.9)
        }
        .tab.active{
            background:linear-gradient(135deg,#6366f1,#4f46e5);
            color:#fff;box-shadow:0 10px 24px rgba(99,102,241,.8)
        }

        .records-list{max-height:620px;overflow-y:auto;padding-right:4px;position:relative;z-index:1}
        .record-item{
            background:#020617;padding:16px;border-radius:14px;
            margin-bottom:10px;border-right:5px solid #6366f1;
            transition:.22s;cursor:pointer;display:block
        }
        .record-item:hover{
            background:#0b1120;transform:translateX(-5px) translateY(-2px);
            box-shadow:0 14px 32px rgba(15,23,42,.85)
        }
        .record-item.income{border-right-color:#22c55e}
        .record-item.expense{border-right-color:#ef4444}
        .record-header{
            display:flex;justify-content:space-between;align-items:center;
            margin-bottom:8px;flex-wrap:wrap;gap:8px
        }
        .record-amount{font-size:1.35em;font-weight:800}
        .record-amount.income{color:#22c55e}
        .record-amount.expense{color:#f97373}
        .record-date{color:#9ca3af;font-size:.85em}
        .record-details{color:#d1d5db;margin-top:8px;line-height:1.6;font-size:.93em}
        .record-person{
            display:inline-block;background:rgba(37,99,235,.16);
            color:#bfdbfe;padding:5px 14px;border-radius:999px;
            font-size:.85em;margin-top:6px;
            border:1px solid rgba(59,130,246,.6)
        }
        .delete-btn{
            background:#b91c1c;color:#fff;border:none;padding:6px 12px;
            border-radius:10px;cursor:pointer;font-size:.8em;transition:.25s
        }
        .delete-btn:hover{background:#7f1d1d;transform:translateY(-1px)}

        .loading{text-align:center;padding:40px;color:#60a5fa;font-size:1.05em}
        .empty-state{text-align:center;padding:46px 20px;color:#9ca3af}

        .voice-status{
            font-size:.8em;color:#60a5fa;margin-top:4px;
            min-height:18px;font-weight:500
        }
        .voice-status.listening{color:#f97373;animation:blink 1s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}

        .search-results-info{
            background:rgba(15,23,42,.9);
            padding:10px 14px;border-radius:10px;margin-top:12px;
            border-right:4px solid #6366f1;color:#cbd5f5;font-size:.92em
        }
        .search-results-info strong{color:#e5e7eb}
        .search-voice-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
        .hint-text{margin-top:8px;color:#9ca3af;font-size:.85em}

        .modal-backdrop{
            position:fixed;inset:0;background:rgba(15,23,42,.7);
            display:none;align-items:center;justify-content:center;z-index:9999
        }
        .modal-backdrop.active{display:flex}
        .modal{
            background:#020617;color:#e5e7eb;
            width:min(480px,95vw);border-radius:18px;
            padding:20px 22px;box-shadow:0 28px 80px rgba(0,0,0,.85);
            transform:translateY(28px) scale(.96);opacity:0;
            transition:.25s;border:1px solid rgba(148,163,184,.65)
        }
        .modal-backdrop.active .modal{transform:translateY(0) scale(1);opacity:1}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
        .modal-title{font-size:1.15em;font-weight:700}
        .modal-close{background:transparent;border:none;color:#9ca3af;font-size:1.45em;cursor:pointer}
        .modal-actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
        .btn-save-edit{
            background:linear-gradient(135deg,#22c55e,#16a34a);
            color:#fff;border:none;padding:9px 18px;
            border-radius:10px;font-weight:700;cursor:pointer;
            display:inline-flex;align-items:center;gap:6px
        }
        .btn-cancel-edit{
            background:#4b5563;color:#e5e7eb;border:none;
            padding:9px 16px;border-radius:10px;cursor:pointer;font-weight:600
        }

        @media(max-width:768px){
            .main-content{grid-template-columns:1fr}
            .header h1{font-size:1.8em}
            .stat-value{font-size:1.7em}
            .export-controls{flex-direction:column}
            .btn-export,.btn-search,.btn-delete-all{width:100%}
        }
        .currency{font-size:.7em;color:#9ca3af}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
        <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
    </div>

    <div class="stats-container">
        <div class="stat-card income">
            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <div class="stat-value" id="totalIncome">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
            <div style="color:#9ca3af;margin-top:4px" id="incomeCount">0 Ø¹Ù…Ù„ÙŠØ©</div>
        </div>
        <div class="stat-card expense">
            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
            <div class="stat-value" id="totalExpense">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
            <div style="color:#9ca3af;margin-top:4px" id="expenseCount">0 Ø¹Ù…Ù„ÙŠØ©</div>
        </div>
        <div class="stat-card balance">
            <h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <div class="stat-value" id="balance">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
            <div style="color:#9ca3af;margin-top:4px">Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙ</div>
        </div>
    </div>

    <div class="main-content">
        <div class="form-card">
            <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯</h2>
            <form id="incomeForm">
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                    <div class="input-with-mic">
                        <input type="number" id="incomeAmount" step="0.01" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                        <button type="button" class="mic-btn" id="micIncomeAmount">ğŸ¤</button>
                    </div>
                    <div class="voice-status" id="statusIncomeAmount"></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³Ù„Ù… *</label>
                    <div class="input-with-mic">
                        <input type="text" id="incomePerson" required placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                        <button type="button" class="mic-btn" id="micIncomePerson">ğŸ¤</button>
                    </div>
                    <div class="voice-status" id="statusIncomePerson"></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
                    <input type="text" id="incomeDateTime" class="readonly-field" readonly>
                </div>
                <button type="submit" class="btn btn-income">
                    <span class="icon">ğŸ’°</span><span>Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯</span>
                </button>
            </form>
        </div>

        <div class="form-card">
            <h2>â– Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h2>
            <form id="expenseForm">
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                    <div class="input-with-mic">
                        <input type="number" id="expenseAmount" step="0.01" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                        <button type="button" class="mic-btn" id="micExpenseAmount">ğŸ¤</button>
                    </div>
                    <div class="voice-status" id="statusExpenseAmount"></div>
                </div>
                <div class="form-group">
                    <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ *</label>
                    <div class="input-with-mic">
                        <textarea id="expenseDetails" required placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†..."></textarea>
                        <button type="button" class="mic-btn" id="micExpenseDetails">ğŸ¤</button>
                    </div>
                    <div class="voice-status" id="statusExpenseDetails"></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
                    <input type="text" id="expenseDateTime" class="readonly-field" readonly>
                </div>
                <button type="submit" class="btn btn-expense">
                    <span class="icon">ğŸ’¸</span><span>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</span>
                </button>
            </form>
        </div>
    </div>

    <div class="search-section">
        <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</h2>
        <div class="search-controls">
            <input type="number" id="searchAmount" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù„Øº...">
            <input type="text" id="searchPerson" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ...">
            <input type="text" id="searchDetails" class="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ø§Ù„ÙˆØµÙ...">
            <input type="date" id="searchDate" class="search-input">
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:4px">
            <button class="btn-search" onclick="performSearch()"><span class="icon">ğŸ”</span><span>Ø¨Ø­Ø«</span></button>
            <button class="btn-search" onclick="clearSearch()" style="background:linear-gradient(135deg,#6b7280,#4b5563);box-shadow:0 10px 24px rgba(75,85,99,.7);"><span class="icon">ğŸ”„</span><span>Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</span></button>
        </div>
        <div class="search-voice-row">
            <button class="btn-search" id="voiceSearchBtn" style="margin-top:8px;background:linear-gradient(135deg,#22c55e,#16a34a);box-shadow:0 10px 24px rgba(34,197,94,.7);"><span class="icon">ğŸ¤</span><span>Ø¨Ø­Ø« ØµÙˆØªÙŠ</span></button>
        </div>
        <div id="voiceSearchStatus" class="voice-status"></div>
        <div id="searchResultsInfo" style="display:none;margin-top:10px"></div>
        <div id="searchClickHint" class="hint-text">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø©.</div>
    </div>

    <div class="export-section">
        <h2>ğŸ“¥ Ø§Ù„ØªØµØ¯ÙŠØ±</h2>
        <div class="export-controls">
            <button class="btn-export" onclick="exportToExcel('all')"><span class="icon">ğŸ“Š</span><span>ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span></button>
            <button class="btn-export" onclick="exportToExcel('income')" style="background:linear-gradient(135deg,#22c55e,#16a34a);box-shadow:0 10px 26px rgba(34,197,94,.65);"><span class="icon">ğŸ“ˆ</span><span>ØªØµØ¯ÙŠØ± Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª</span></button>
            <button class="btn-export" onclick="exportToExcel('expense')" style="background:linear-gradient(135deg,#ef4444,#b91c1c);box-shadow:0 10px 26px rgba(239,68,68,.65);"><span class="icon">ğŸ“‰</span><span>ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span></button>
            <button class="btn-export" onclick="exportSearchResults()" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);box-shadow:0 10px 26px rgba(139,92,246,.7);"><span class="icon">ğŸ“‘</span><span>ØªØµØ¯ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</span></button>
            <button class="btn-delete-all" onclick="deleteAllRecords()"><span class="icon">ğŸ§¨</span><span>Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„</span></button>
        </div>
    </div>

    <div class="records-section">
        <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
        <div class="tabs">
            <button class="tab active" data-tab="all">Ø§Ù„ÙƒÙ„</button>
            <button class="tab" data-tab="income">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</button>
            <button class="tab" data-tab="expense">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
        </div>
        <div class="records-list" id="recordsList">
            <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="recordModalBackdrop">
    <div class="modal" id="recordModal">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</div>
            <button class="modal-close" id="modalCloseBtn">Ã—</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="modalRecordId">
            <input type="hidden" id="modalRecordCollection">
            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
                <select id="modalType">
                    <option value="income">Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯</option>
                    <option value="expense">Ù…ØµØ±ÙˆÙ</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="modalAmount" step="0.01">
            </div>
            <div class="form-group" id="modalPersonGroup">
                <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ</label>
                <input type="text" id="modalPerson">
            </div>
            <div class="form-group" id="modalDetailsGroup">
                <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                <textarea id="modalDetails"></textarea>
            </div>
            <div class="form-group">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª (Ø¹Ø±Ø¶ ÙÙ‚Ø·)</label>
                <input type="text" id="modalDateTime" readonly class="readonly-field">
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-save-edit" id="modalSaveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            <button class="btn-cancel-edit" id="modalCancelBtn">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  query,
  orderBy,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
  authDomain: "nasrapp-7a0fc.firebaseapp.com",
  projectId: "nasrapp-7a0fc",
  storageBucket: "nasrapp-7a0fc.firebasestorage.app",
  messagingSenderId: "826970736109",
  appId: "1:826970736109:web:c1cc3c3a1008e719b193e4",
  measurementId: "G-BHP6J4K9VN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const incomeCollection = collection(db, "income");
const expenseCollection = collection(db, "expenses");

let currentTab = "all";
let allRecords = [];
let searchResults = [];
let isSearching = false;

/*************************************
 * Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© / Ø§Ù„ÙƒÙ„Ù…Ø§Øª
 *************************************/
const numberWords = {
 "ØµÙØ±":0,"ÙˆØ§Ø­Ø¯":1,"Ø§ØªÙ†ÙŠÙ†":2,"ØªÙ„Ø§ØªØ©":3,"Ø§Ø±Ø¨Ø¹Ø©":4,"Ø®Ù…Ø³Ø©":5,"Ø³ØªØ©":6,"Ø³Ø¨Ø¹Ø©":7,"ØªÙ…Ø§Ù†ÙŠØ©":8,"ØªØ³Ø¹Ø©":9,
 "Ø¹Ø´Ø±Ø©":10,"Ø­Ø¯Ø§Ø´Ø±":11,"Ø§ØªÙ†Ø§Ø´Ø±":12,"ØªÙ„Ø§ØªØ§Ø´Ø±":13,"Ø§Ø±Ø¨Ø¹ØªØ§Ø´Ø±":14,"Ø®Ù…Ø³ØªØ§Ø´Ø±":15,"Ø³ØªØ§Ø´Ø±":16,"Ø³Ø¨Ø¹ØªØ§Ø´Ø±":17,
 "ØªÙ…Ù†ØªØ§Ø´Ø±":18,"ØªØ³Ø¹ØªØ§Ø´Ø±":19,
 "Ø¹Ø´Ø±ÙŠÙ†":20,"ØªÙ„Ø§ØªÙŠÙ†":30,"Ø§Ø±Ø¨Ø¹ÙŠÙ†":40,"Ø®Ù…Ø³ÙŠÙ†":50,"Ø³ØªÙŠÙ†":60,"Ø³Ø¨Ø¹ÙŠÙ†":70,"ØªÙ…Ø§Ù†ÙŠÙ†":80,"ØªØ³Ø¹ÙŠÙ†":90,
 "Ù…ÙŠØ©":100,"Ù…ÙŠÙ‡":100,"Ù…ÙŠØªÙŠÙ†":200,
 "ØªÙ„Ø§ØªÙ…ÙŠØ©":300,"ØªÙ„Ø§ØªÙ…ÙŠÙ‡":300,"ØªÙ„ØªÙˆÙ…ÙŠÙ‡":300,"ØªÙ„ØªÙˆÙ…ÙŠØ©":300,
 "Ø±Ø¨Ø¹Ù…ÙŠØ©":400,"Ø±Ø¨Ø¹Ù…ÙŠÙ‡":400,"Ø±Ø¨Ø¹Ù…ÙŠØª":400,
 "Ø®Ù…Ø³Ù…ÙŠØ©":500,"Ø®Ù…Ø³Ù…ÙŠÙ‡":500,"Ø®Ù…Ø³Ù…ÙŠØª":500,
 "Ø³ØªÙ…ÙŠØ©":600,"Ø³ØªÙ…ÙŠÙ‡":600,"Ø³ØªÙ…ÙŠØª":600,
 "Ø³Ø¨Ø¹Ù…ÙŠØ©":700,"Ø³Ø¨Ø¹Ù…ÙŠÙ‡":700,"Ø³Ø¨Ø¹Ù…ÙŠØª":700,
 "ØªÙ…Ù†Ù…ÙŠØ©":800,"ØªÙ…Ù†Ù…ÙŠÙ‡":800,"ØªÙ…Ù†Ù…ÙŠØª":800,
 "ØªØ³Ø¹Ù…ÙŠØ©":900,"ØªØ³Ø¹Ù…ÙŠÙ‡":900,"ØªØ³Ø¹Ù…ÙŠØª":900,
 "Ø§Ù„Ù":1000,"Ø£Ù„Ù":1000,"ØªÙ„Ø§Ù":1000,
 "Ø§Ù„ÙÙŠÙ†":2000,"ØªÙ„Ø§ÙÙŠÙ†":2000,
 "ØªÙ„Øª ØªÙ„Ø§Ù":3000,"ØªÙ„Ø§Øª Ø§Ù„Ø§Ù":3000,"ØªÙ„Ø§ØªÙ„Ø§Ù":3000,
 "Ø§Ø±Ø¨Ø¹Ø© Ø§Ù„Ø§Ù":4000,"Ø§Ø±Ø¨Ø¹Ø© ØªÙ„Ø§Ù":4000,"Ø§Ø±Ø¨Ø¹ØªÙ„Ø§Ù":4000,
 "Ø®Ù…Ø³Ø© Ø§Ù„Ø§Ù":5000,"Ø®Ù…Ø³ ØªÙ„Ø§Ù":5000,"Ø®Ù…Ø³ØªÙ„Ø§Ù":5000,
 "Ø³ØªØ© Ø§Ù„Ø§Ù":6000,"Ø³Øª ØªÙ„Ø§Ù":6000,"Ø³ØªØªÙ„Ø§Ù":6000,
 "Ø³Ø¨Ø¹Ø© Ø§Ù„Ø§Ù":7000,"Ø³Ø¨Ø¹ ØªÙ„Ø§Ù":7000,"Ø³Ø¨Ø¹ØªÙ„Ø§Ù":7000,
 "ØªÙ…Ø§Ù†ÙŠØ© Ø§Ù„Ø§Ù":8000,"ØªÙ…Ù† ØªÙ„Ø§Ù":8000,"ØªÙ…Ù†ØªÙ„Ø§Ù":8000,
 "ØªØ³Ø¹Ø© Ø§Ù„Ø§Ù":9000,"ØªØ³Ø¹ ØªÙ„Ø§Ù":9000,"ØªØ³Ø¹ØªÙ„Ø§Ù":9000,
 "Ø¹Ø´Ø±Ø© Ø§Ù„Ø§Ù":10000,"Ø¹Ø´Ø± ØªÙ„Ø§Ù":10000,
 "Ø¹Ø´Ø±ÙŠÙ† Ø§Ù„Ù":20000,"ØªÙ„Ø§ØªÙŠÙ† Ø§Ù„Ù":30000,"Ø§Ø±Ø¨Ø¹ÙŠÙ† Ø§Ù„Ù":40000,"Ø®Ù…Ø³ÙŠÙ† Ø§Ù„Ù":50000,
 "Ø³ØªÙŠÙ† Ø§Ù„Ù":60000,"Ø³Ø¨Ø¹ÙŠÙ† Ø§Ù„Ù":70000,"ØªÙ…Ø§Ù†ÙŠÙ† Ø§Ù„Ù":80000,"ØªØ³Ø¹ÙŠÙ† Ø§Ù„Ù":90000,
 "Ù…ÙŠØ© Ø§Ù„Ù":100000,"Ù…ÙŠØª Ø§Ù„Ù":100000,
 "Ù…ÙŠØªÙŠÙ† Ø§Ù„Ù":200000,"Ù…ØªÙŠÙ† Ø§Ù„Ù":200000,
 "ØªÙ„Ø§ØªÙ…ÙŠØ© Ø§Ù„Ù":300000,"ØªÙ„ØªÙ…ÙŠØª Ø§Ù„Ù":300000,
 "Ø±Ø¨Ø¹Ù…ÙŠØ© Ø§Ù„Ù":400000,"Ø±Ø¨Ø¹Ù…ÙŠØª Ø§Ù„Ù":400000,
 "Ø®Ù…Ø³Ù…ÙŠØ© Ø§Ù„Ù":500000,"Ø®Ù…Ø³Ù…ÙŠØª Ø§Ù„Ù":500000,
 "Ø³ØªÙ…ÙŠØ© Ø§Ù„Ù":600000,"Ø³ØªÙ…ÙŠØª Ø§Ù„Ù":600000,
 "Ø³Ø¨Ø¹Ù…ÙŠØ© Ø§Ù„Ù":700000,"Ø³Ø¨Ø¹Ù…ÙŠØª Ø§Ù„Ù":700000,
 "ØªÙ…Ù†Ù…ÙŠØ© Ø§Ù„Ù":800000,"ØªÙ…Ù†Ù…ÙŠØª Ø§Ù„Ù":800000,
 "ØªØ³Ø¹Ù…ÙŠØ© Ø§Ù„Ù":900000,"ØªØ³Ø¹Ù…ÙŠØª Ø§Ù„Ù":900000,
 "Ù…Ù„ÙŠÙˆÙ†":1000000
};

function convertArabicToEnglishNumbers(str) {
  const ar = ["Ù ","Ù¡","Ù¢","Ù£","Ù¤","Ù¥","Ù¦","Ù§","Ù¨","Ù©"];
  const en = ["0","1","2","3","4","5","6","7","8","9"];
  let res = str;
  for (let i = 0; i < 10; i++) {
    res = res.replace(new RegExp(ar[i], "g"), en[i]);
  }
  return res;
}

function extractNumber(text) {
  const digitMatch = text.match(/[\d.]+/);
  if (digitMatch) return digitMatch[0];

  let normalized = text.replace(/\s+/g, " ").trim();
  if (numberWords.hasOwnProperty(normalized)) {
    return numberWords[normalized].toString();
  }
  const words = normalized.split(" ");
  let total = 0, current = 0;
  for (let i = 0; i < words.length; i++) {
    const w = words[i];
    if (numberWords.hasOwnProperty(w)) {
      current += numberWords[w];
    } else if (w === "Ø§Ù„Ù" || w === "Ø£Ù„Ù") {
      if (current === 0) current = 1;
      current *= 1000; total += current; current = 0;
    } else if (w === "Ù…Ù„ÙŠÙˆÙ†") {
      if (current === 0) current = 1;
      current *= 1000000; total += current; current = 0;
    }
  }
  total += current;
  if (total > 0) return total.toString();
  return null;
}

/*************************************
 * SpeechRecognition
 *************************************/
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.lang = "ar-EG";
  recognition.continuous = false;
  recognition.interimResults = false;
}

function startVoiceInput(inputId, statusId, isNumber = false) {
  if (!recognition) {
    alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø£Ùˆ Edge");
    return;
  }
  const inputElement  = document.getElementById(inputId);
  const statusElement = document.getElementById(statusId);
  const micBtn        = document.getElementById("mic" + inputId.charAt(0).toUpperCase() + inputId.slice(1));

  recognition.lang = "ar-EG";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.start();
  micBtn.classList.add("recording");
  statusElement.textContent = "ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†";
  statusElement.classList.add("listening");

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    if (isNumber) {
      const converted = convertArabicToEnglishNumbers(transcript);
      const num = extractNumber(converted.toLowerCase());
      if (num) {
        inputElement.value = num;
        statusElement.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: " + num;
      } else {
        inputElement.value = transcript;
        statusElement.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: " + transcript;
      }
    } else {
      inputElement.value = transcript;
      statusElement.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­";
    }
    setTimeout(() => {
      statusElement.textContent = "";
      statusElement.classList.remove("listening");
    }, 3000);
  };
  recognition.onerror = (event) => {
    micBtn.classList.remove("recording");
    statusElement.classList.remove("listening");
    if (event.error === "no-speech") statusElement.textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ØµÙˆØª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
    else if (event.error === "not-allowed") statusElement.textContent = "âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
    else statusElement.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª";
    setTimeout(() => { statusElement.textContent = ""; }, 3000);
  };
  recognition.onend = () => {
    micBtn.classList.remove("recording");
    statusElement.classList.remove("listening");
  };
}

document.getElementById("micIncomeAmount").addEventListener("click", () => startVoiceInput("incomeAmount", "statusIncomeAmount", true));
document.getElementById("micIncomePerson").addEventListener("click", () => startVoiceInput("incomePerson", "statusIncomePerson", false));
document.getElementById("micExpenseAmount").addEventListener("click", () => startVoiceInput("expenseAmount", "statusExpenseAmount", true));
document.getElementById("micExpenseDetails").addEventListener("click", () => startVoiceInput("expenseDetails", "statusExpenseDetails", false));

/*************************************
 * Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ (Ø§Ø³Ù… Ø£Ùˆ ÙˆØµÙ Ø£Ùˆ Ù…Ø¨Ù„Øº)
 *************************************/
const voiceSearchBtn    = document.getElementById("voiceSearchBtn");
const voiceSearchStatus = document.getElementById("voiceSearchStatus");

if (voiceSearchBtn && recognition) {
  voiceSearchBtn.addEventListener("click", () => {
    recognition.lang = "ar-EG";
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.start();
    voiceSearchStatus.textContent = "ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ù…Ø± Ø§Ù„Ø¨Ø­Ø«...";
    voiceSearchStatus.classList.add("listening");

    recognition.onresult = (event) => {
      let transcript = event.results[0][0].transcript.toLowerCase().trim();
      voiceSearchStatus.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: " + transcript;

      const amountInput  = document.getElementById("searchAmount");
      const personInput  = document.getElementById("searchPerson");
      const detailsInput = document.getElementById("searchDetails");

      amountInput.value  = "";
      personInput.value  = "";
      detailsInput.value = "";

      const num = extractNumber(convertArabicToEnglishNumbers(transcript));
      if (num) {
        // Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø¨Ù„Øº
        amountInput.value = num;
      } else if (transcript.includes("Ø­Ø³Ø§Ø¨") || transcript.includes("Ø¹Ù†Ø¯")) {
        // Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø´Ø®Øµ
        transcript = transcript.replace("Ø­Ø³Ø§Ø¨", "").replace("Ø¹Ù†Ø¯", "").trim();
        personInput.value = transcript;
      } else {
        // Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØµÙ Ù…Ø¹Ù‹Ø§
        detailsInput.value = transcript;
      }

      setTimeout(() => {
        voiceSearchStatus.textContent = "";
        voiceSearchStatus.classList.remove("listening");
      }, 2500);

      window.performSearch();
    };
    recognition.onerror = () => {
      voiceSearchStatus.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ";
      voiceSearchStatus.classList.remove("listening");
    };
    recognition.onend = () => {
      voiceSearchStatus.classList.remove("listening");
    };
  });
}

/*************************************
 * Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
 *************************************/
function formatDateTime() {
  const now = new Date();
  const options = {
    year:"numeric", month:"long", day:"numeric",
    hour:"2-digit", minute:"2-digit", second:"2-digit",
    hour12:true
  };
  return now.toLocaleDateString("ar-EG", options);
}
function updateDateTimeFields() {
  const dt = formatDateTime();
  document.getElementById("incomeDateTime").value  = dt;
  document.getElementById("expenseDateTime").value = dt;
}
setInterval(updateDateTimeFields, 1000);
updateDateTimeFields();

/*************************************
 * Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø±Ø¯ / Ù…ØµØ±ÙˆÙ (Firestore)
 *************************************/
document.getElementById("incomeForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  try {
    const amountField = document.getElementById("incomeAmount");
    const personField = document.getElementById("incomePerson");
    const amount  = parseFloat(amountField.value);
    const person  = personField.value.trim();
    const dateTime = document.getElementById("incomeDateTime").value;
    if (!amount || !person) {
      alert("Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ÙˆØ§Ø³Ù… Ø´Ø®Øµ ØµØ­ÙŠØ­ÙŠÙ†");
      return;
    }
    await addDoc(incomeCollection, { amount, person, dateTime, timestamp: Date.now(), type: "income" });
    e.target.reset();
    updateDateTimeFields();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    btn.textContent = "âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!";
    btn.style.background = "#22c55e";
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = "";
    }, 2000);
    await loadRecords();
  } catch (err) {
    console.error("income error => ", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº");
  }
});

document.getElementById("expenseForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  try {
    const amountField  = document.getElementById("expenseAmount");
    const detailsField = document.getElementById("expenseDetails");
    const amount  = parseFloat(amountField.value);
    const details = detailsField.value.trim();
    const dateTime = document.getElementById("expenseDateTime").value;
    if (!amount || !details) {
      alert("Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ÙˆØªÙØ§ØµÙŠÙ„ ØµØ­ÙŠØ­Ø©");
      return;
    }
    await addDoc(expenseCollection, { amount, details, dateTime, timestamp: Date.now(), type: "expense" });
    e.target.reset();
    updateDateTimeFields();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    btn.textContent = "âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!";
    btn.style.background = "#22c55e";
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = "";
    }, 2000);
    await loadRecords();
  } catch (err) {
    console.error("expense error => ", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ");
  }
});

/*************************************
 * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore
 *************************************/
async function loadRecords() {
  try {
    const incomeSnap  = await getDocs(query(incomeCollection,  orderBy("timestamp", "desc")));
    const expenseSnap = await getDocs(query(expenseCollection, orderBy("timestamp", "desc")));
    allRecords = [];
    incomeSnap.forEach((d)  => allRecords.push({ id: d.id, ...d.data(), collectionType: "income"  }));
    expenseSnap.forEach((d) => allRecords.push({ id: d.id, ...d.data(), collectionType: "expense" }));
    allRecords.sort((a, b) => b.timestamp - a.timestamp);
    displayRecords();
    updateStatistics();
  } catch (err) {
    console.error(err);
  }
}

/*************************************
 * Ø§Ù„Ø¨Ø­Ø« (Ø§Ø³Ù… / ÙˆØµÙ / Ù…Ø¨Ù„Øº / ØªØ§Ø±ÙŠØ®)
 *************************************/
window.performSearch = function () {
  const searchAmount  = document.getElementById("searchAmount").value;
  const searchPerson  = document.getElementById("searchPerson").value.toLowerCase().trim();
  const searchDetails = document.getElementById("searchDetails").value.toLowerCase().trim();
  const searchDate    = document.getElementById("searchDate").value;

  searchResults = allRecords.filter((r) => {
    let m = true;

    if (searchAmount) {
      m = m && Number(r.amount) === parseFloat(searchAmount);
    }

    if (searchPerson) {
      const p = (r.person  || "").toLowerCase();
      const d = (r.details || "").toLowerCase();
      m = m && (p.includes(searchPerson) || d.includes(searchPerson));
    }

    if (searchDetails) {
      const p = (r.person  || "").toLowerCase();
      const d = (r.details || "").toLowerCase();
      m = m && (p.includes(searchDetails) || d.includes(searchDetails));
    }

    if (searchDate) {
      const rd = r.dateTime.split(" ")[0];
      m = m && rd.includes(searchDate);
    }

    return m;
  });

  isSearching = true;
  displayRecords();
  const info = document.getElementById("searchResultsInfo");
  info.style.display = "block";
  info.innerHTML = `<div class="search-results-info"><strong>âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${searchResults.length} Ù†ØªÙŠØ¬Ø©</strong></div>`;
};

window.clearSearch = function () {
  document.getElementById("searchAmount").value  = "";
  document.getElementById("searchPerson").value  = "";
  document.getElementById("searchDetails").value = "";
  document.getElementById("searchDate").value    = "";
  document.getElementById("searchResultsInfo").style.display = "none";
  isSearching = false;
  displayRecords();
};

/*************************************
 * Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ + Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
 *************************************/
function displayRecords() {
  const list = document.getElementById("recordsList");
  let records = isSearching ? searchResults : allRecords;
  if (!isSearching && currentTab !== "all") {
    records = allRecords.filter((r) => r.type === currentTab);
  }
  if (records.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <h3 style="margin-bottom:6px;">${isSearching ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø«" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯"}</h3>
      <p>${isSearching ? "Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ø£Ø®Ø±Ù‰" : "Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯ Ø£Ùˆ Ù…ØµØ±ÙˆÙ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰"}</p>
    </div>`;
    return;
  }
  list.innerHTML = records
    .map((r) => {
      const dataAttr = `data-id="${r.id}" data-collection="${r.collectionType}"`;
      if (r.type === "income") {
        return `<div class="record-item income" ${dataAttr} onclick="openRecordModal('${r.id}','${r.collectionType}')">
          <div class="record-header">
            <div class="record-amount income">+${Number(r.amount).toLocaleString("ar-EG")} Ø¬Ù†ÙŠÙ‡</div>
            <div style="text-align:left;min-width:160px;">
              <div class="record-date">ğŸ“… ${r.dateTime}</div>
              <button class="delete-btn" onclick="event.stopPropagation();deleteRecord('${r.id}','income')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
          </div>
          <div class="record-person">ğŸ‘¤ ${r.person}</div>
        </div>`;
      } else {
        return `<div class="record-item expense" ${dataAttr} onclick="openRecordModal('${r.id}','${r.collectionType}')">
          <div class="record-header">
            <div class="record-amount expense">-${Number(r.amount).toLocaleString("ar-EG")} Ø¬Ù†ÙŠÙ‡</div>
            <div style="text-align:left;min-width:160px;">
              <div class="record-date">ğŸ“… ${r.dateTime}</div>
              <button class="delete-btn" onclick="event.stopPropagation();deleteRecord('${r.id}','expense')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
          </div>
          <div class="record-details">ğŸ“ ${r.details || ""}</div>
        </div>`;
      }
    })
    .join("");
}

function updateStatistics() {
  const incomeRecs  = allRecords.filter((r) => r.type === "income");
  const expenseRecs = allRecords.filter((r) => r.type === "expense");
  const totalIncome  = incomeRecs.reduce((s, r) => s + Number(r.amount), 0);
  const totalExpense = expenseRecs.reduce((s, r) => s + Number(r.amount), 0);
  const balance = totalIncome - totalExpense;
  document.getElementById("totalIncome").innerHTML =
    `${totalIncome.toLocaleString("ar-EG", { maximumFractionDigits: 0 })} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;
  document.getElementById("totalExpense").innerHTML =
    `${totalExpense.toLocaleString("ar-EG", { maximumFractionDigits: 0 })} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;
  document.getElementById("balance").innerHTML =
    `${balance.toLocaleString("ar-EG", { maximumFractionDigits: 0 })} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;
  document.getElementById("incomeCount").textContent  = `${incomeRecs.length} Ø¹Ù…Ù„ÙŠØ©`;
  document.getElementById("expenseCount").textContent = `${expenseRecs.length} Ø¹Ù…Ù„ÙŠØ©`;
}

/*************************************
 * ØªØ¨ÙˆÙŠØ¨ (Ø§Ù„ÙƒÙ„ / ÙˆØ§Ø±Ø¯ / Ù…ØµØ±ÙˆÙ)
 *************************************/
document.querySelectorAll(".tab").forEach((tab) => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
    tab.classList.add("active");
    currentTab = tab.getAttribute("data-tab");
    displayRecords();
  });
});

/*************************************
 * ÙØªØ­ / Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ + Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
 *************************************/
const modalBackdrop  = document.getElementById("recordModalBackdrop");
const modalCloseBtn  = document.getElementById("modalCloseBtn");
const modalCancelBtn = document.getElementById("modalCancelBtn");
const modalSaveBtn   = document.getElementById("modalSaveBtn");

window.openRecordModal = function (id, collectionType) {
  const rec = allRecords.find((r) => r.id === id && r.collectionType === collectionType);
  if (!rec) return;
  document.getElementById("modalRecordId").value          = rec.id;
  document.getElementById("modalRecordCollection").value  = collectionType;
  document.getElementById("modalType").value              = rec.type;
  document.getElementById("modalAmount").value            = rec.amount;
  document.getElementById("modalDateTime").value          = rec.dateTime;

  if (rec.type === "income") {
    document.getElementById("modalPersonGroup").style.display  = "block";
    document.getElementById("modalDetailsGroup").style.display = "none";
    document.getElementById("modalPerson").value  = rec.person || "";
    document.getElementById("modalDetails").value = "";
  } else {
    document.getElementById("modalPersonGroup").style.display  = "none";
    document.getElementById("modalDetailsGroup").style.display = "block";
    document.getElementById("modalPerson").value  = "";
    document.getElementById("modalDetails").value = rec.details || "";
  }

  modalBackdrop.classList.add("active");
};

function closeModal() {
  modalBackdrop.classList.remove("active");
}
modalCloseBtn.addEventListener("click", closeModal);
modalCancelBtn.addEventListener("click", closeModal);

modalSaveBtn.addEventListener("click", async () => {
  const id             = document.getElementById("modalRecordId").value;
  const collectionType = document.getElementById("modalRecordCollection").value;
  const type           = document.getElementById("modalType").value;
  const amount         = parseFloat(document.getElementById("modalAmount").value);
  const person         = document.getElementById("modalPerson").value.trim();
  const details        = document.getElementById("modalDetails").value.trim();

  if (!amount) {
    alert("Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
    return;
  }
  if (type === "income" && !person) {
    alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ");
    return;
  }
  if (type === "expense" && !details) {
    alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ");
    return;
  }

  try {
    const col = collectionType === "income" ? incomeCollection : expenseCollection;
    const ref = doc(col, id);
    const payload = {
      amount,
      type,
      timestamp: Date.now()
    };
    if (type === "income") {
      payload.person = person;
      payload.details = "";
    } else {
      payload.details = details;
      payload.person  = "";
    }
    await updateDoc(ref, payload);
    await loadRecords();
    closeModal();
  } catch (err) {
    console.error("update error => ", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
  }
});

/*************************************
 * Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© / Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
 *************************************/
window.deleteRecord = async function (id, collectionType) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;
  try {
    const col = collectionType === "income" ? incomeCollection : expenseCollection;
    await deleteDoc(doc(col, id));
    await loadRecords();
  } catch (err) {
    console.error("delete error => ", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
  }
};

window.deleteAllRecords = async function () {
  if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
  try {
    const incomeSnap  = await getDocs(incomeCollection);
    const expenseSnap = await getDocs(expenseCollection);
    const batchDelete = [];
    incomeSnap.forEach((d)  => batchDelete.push(deleteDoc(doc(incomeCollection,  d.id))));
    expenseSnap.forEach((d) => batchDelete.push(deleteDoc(doc(expenseCollection, d.id))));
    await Promise.all(batchDelete);
    await loadRecords();
    document.getElementById("searchResultsInfo").style.display = "none";
    isSearching = false;
  } catch (err) {
    console.error("delete all error => ", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„");
  }
};
/*************************************
 * Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel (Workbook ÙˆØ§Ø­Ø¯)
 *************************************/
let globalWorkbook = null;

function ensureWorkbook() {
  if (!globalWorkbook) {
    globalWorkbook = XLSX.utils.book_new();
    globalWorkbook.Props = {
      Title: "Ø³Ø¬Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª",
      Author: "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…",
      CreatedDate: new Date()
    };
  }
}

function buildSheetData(type, fromSearch = false) {
  let records = fromSearch ? searchResults : allRecords;
  if (type === "income")  records = records.filter((r) => r.type === "income");
  if (type === "expense") records = records.filter((r) => r.type === "expense");

  const rows = [];
  rows.push(["Ø§Ù„Ù†ÙˆØ¹", "Ø§Ù„Ù…Ø¨Ù„Øº", "Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ÙˆØµÙ", "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª"]);

  records.forEach((r) => {
    const desc = r.type === "income" ? (r.person || "") : (r.details || "");
    rows.push([
      r.type === "income" ? "ÙˆØ§Ø±Ø¯" : "Ù…ØµØ±ÙˆÙ",
      Number(r.amount),
      desc,
      r.dateTime
    ]);
  });

  return rows;
}

function styleWorksheet(ws, range, type) {
  if (!ws["!cols"]) {
    ws["!cols"] = [{ wch: 10 }, { wch: 12 }, { wch: 40 }, { wch: 26 }];
  }

  const headerFill  = { patternType: "solid", fgColor: { rgb: "1f2937" } };
  const incomeFill  = { patternType: "solid", fgColor: { rgb: "064e3b" } };
  const expenseFill = { patternType: "solid", fgColor: { rgb: "7f1d1d" } };

  const border = {
    top:    { style: "thick", color: { rgb: "000000" } },
    bottom: { style: "thick", color: { rgb: "000000" } },
    left:   { style: "thick", color: { rgb: "000000" } },
    right:  { style: "thick", color: { rgb: "000000" } }
  };

  for (let R = range.s.r; R <= range.e.r; ++R) {
    for (let C = range.s.c; C <= range.e.c; ++C) {
      const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
      const cell = ws[cellRef];
      if (!cell) continue;

      const isHeader = R === 0;

      cell.s = cell.s || {};
      cell.s.border    = border;
      cell.s.alignment = { vertical: "center", horizontal: "center", wrapText: true };

      if (isHeader) {
        cell.s.fill = headerFill;
        cell.s.font = { bold: true, color: { rgb: "ffffff" } };
      } else {
        if (type === "income") {
          cell.s.fill = incomeFill;
        } else if (type === "expense") {
          cell.s.fill = expenseFill;
        } else {
          // Ø¹Ù†Ø¯ Ø§Ù„Ù†ÙˆØ¹ "all" Ø£Ùˆ "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«": ØªÙ†Ø§ÙˆØ¨ Ø¨ÙŠÙ† Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙ
          const fillColor = (cell.v === "ÙˆØ§Ø±Ø¯" || cell.v === "Ù…ØµØ±ÙˆÙ")
            ? headerFill
            : (R % 2 === 0 ? incomeFill : expenseFill);
          cell.s.fill = fillColor;
        }
        cell.s.font = { color: { rgb: "ffffff" } };
      }

      // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø±Ù‚Ù… Ø¨Ø¯ÙˆÙ† ÙƒØ³ÙˆØ±
      if (C === 1 && !isHeader) {
        cell.t = "n";
        cell.z = "0";
      }
    }
  }
}

window.exportToExcel = function (type) {
  ensureWorkbook();

  const data = buildSheetData(type, false);
  if (data.length <= 1) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
    return;
  }

  const ws = XLSX.utils.aoa_to_sheet(data);
  const range = XLSX.utils.decode_range(ws["!ref"]);
  styleWorksheet(ws, range, type);

  const sheetName =
    type === "all"     ? "ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" :
    type === "income"  ? "Ø§Ù„ÙˆØ§Ø±Ø¯"      :
    type === "expense" ? "Ø§Ù„Ù…ØµØ±ÙˆÙ"     : "Ø¨ÙŠØ§Ù†Ø§Øª";

  XLSX.utils.book_append_sheet(globalWorkbook, ws, sheetName);
  XLSX.writeFile(globalWorkbook, "Ø³Ø¬Ù„_Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.xlsx");
};

window.exportSearchResults = function () {
  ensureWorkbook();

  const data = buildSheetData("all", true);
  if (data.length <= 1) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ù„Ù„ØªØµØ¯ÙŠØ±");
    return;
  }

  const ws = XLSX.utils.aoa_to_sheet(data);
  const range = XLSX.utils.decode_range(ws["!ref"]);
  styleWorksheet(ws, range, "all");

  XLSX.utils.book_append_sheet(globalWorkbook, ws, "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«");
  XLSX.writeFile(globalWorkbook, "Ø³Ø¬Ù„_Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.xlsx");
};

/*************************************
 * ØªØ´ØºÙŠÙ„ Ù…Ø¨Ø¯Ø¦ÙŠ
 *************************************/
loadRecords();
</script>
</body>
</html>
