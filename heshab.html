<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Smart Finance V3 â€“ Hybrid Voice AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

<style>
    body{
        margin:0;
        padding:15px;
        background:#f4f5f7;
        font-family:'Cairo',sans-serif;
    }
    .box{
        background:white;
        padding:20px;
        border-radius:15px;
        box-shadow:0 6px 20px rgba(0,0,0,0.06);
        margin-bottom:20px;
    }
    .input{
        width:100%;
        padding:14px;
        border:2px solid #e7e9ed;
        border-radius:10px;
        margin-bottom:10px;
        font-size:1.1rem;
    }
    button{
        width:100%;
        padding:15px;
        border:none;
        border-radius:12px;
        background:#4f46e5;
        color:white;
        font-size:1.1rem;
        font-weight:800;
        cursor:pointer;
    }
    .mic-btn{
        position:fixed;
        bottom:25px;
        left:50%;
        transform:translateX(-50%);
        width:80px;
        height:80px;
        border-radius:50%;
        background:#e11d48;
        color:white;
        display:flex;
        justify-content:center;
        align-items:center;
        font-size:2rem;
        cursor:pointer;
        box-shadow:0 10px 25px rgba(225,29,72,0.4);
    }
    .mic-btn.active{
        background:#10b981;
        animation:pulse 1.5s infinite;
    }
    @keyframes pulse{
        0%{box-shadow:0 0 0 0 rgba(16,185,129,0.7)}
        70%{box-shadow:0 0 0 25px rgba(16,185,129,0)}
        100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}
    }
    .item{
        background:white;
        padding:15px;
        border-radius:12px;
        margin-bottom:10px;
        border-right:5px solid #4f46e5;
    }
    .date{
        float:left;
        color:#777;
        font-size:0.9rem;
    }
    .amt{
        font-weight:900;
        font-size:1.2rem;
    }
</style>
</head>

<body>

<div class="box">
    <h2 style="margin-top:0;font-weight:900">Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© V3 â€“ Ø£ÙˆØ§Ù…Ø± ØµÙˆØªÙŠØ©</h2>

    <input id="amount" type="text" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
    <input id="desc" type="text" class="input" placeholder="Ø§Ù„ÙˆØµÙ">

    <select id="type" class="input">
        <option value="income">Ø¯Ø®Ù„</option>
        <option value="expense">Ù…ØµØ±ÙˆÙ</option>
    </select>

    <button onclick="save()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
</div>

<h3 style="font-weight:900;margin-top:20px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
<div id="list"></div>

<div class="mic-btn" id="mic" onclick="toggleMic()">
    ğŸ™ï¸
</div>

<script>
/* ------------------------------------------------------
      Firebase
------------------------------------------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
    apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
    authDomain: "nasrapp-7a0fc.firebaseapp.com",
    databaseURL: "https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
    projectId: "nasrapp-7a0fc",
    appId: "1:826970736109:web:c1cc3c3a1008e719b193e4"
});
const db = getDatabase(app);

let dataList = [];

/* ------------------------------------------------------
    Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ©
------------------------------------------------------ */
function save(){
    let amountTxt = amount.value.trim();
    let descTxt = desc.value.trim();
    let typeTxt = type.value;

    let val = parseArabicNumber(amountTxt);

    if(isNaN(val) || val <= 0){
        Swal.fire("Ø®Ø·Ø£","Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­","error");return;
    }
    if(descTxt.length === 0){
        Swal.fire("Ø®Ø·Ø£","Ø£Ø¯Ø®Ù„ ÙˆØµÙ","error");return;
    }

    push(ref(db,typeTxt),{
        amount:val,
        description:descTxt,
        timestamp:Date.now()
    });

    amount.value="";
    desc.value="";

    Swal.fire({
        toast:true,
        position:"top",
        icon:"success",
        title:"ØªÙ… Ø§Ù„Ø­ÙØ¸",
        timer:1200,
        showConfirmButton:false
    });
}

/* ------------------------------------------------------
    Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
------------------------------------------------------ */
onValue(ref(db),(snap)=>{
    dataList=[];
    let d=snap.val();

    if(d){
        if(d.income) Object.values(d.income).forEach(v=>dataList.push({...v,type:"income"}));
        if(d.expense) Object.values(d.expense).forEach(v=>dataList.push({...v,type:"expense"}));
    }
    render();
});

/* ------------------------------------------------------
    Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
------------------------------------------------------ */
function render(){
    list.innerHTML="";
    dataList.sort((a,b)=>b.timestamp - a.timestamp);

    dataList.forEach(r=>{
        let dt=new Date(r.timestamp);
        list.innerHTML+=`
        <div class="item">
            <b>${r.description}</b><br>
            <span class="amt" style="color:${r.type=='income'?'#10b981':'#ef4444'}">
                ${r.type=='income'?'+':'-'} ${r.amount.toLocaleString()}
            </span>
            <span class="date">${dt.toLocaleDateString('ar-EG')}</span>
        </div>`;
    });
}

/* ------------------------------------------------------
    ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
------------------------------------------------------ */
function parseArabicNumber(t){
    if(!t) return 0;

    t=t.replace(/[Ù -Ù©]/g,(d)=>"Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));

    const special={
        "Ù†Øµ Ù…Ù„ÙŠÙˆÙ†":500000,
        "Ø±Ø¨Ø¹ Ù…Ù„ÙŠÙˆÙ†":250000,
        "ØªÙ„Øª Ù…Ù„ÙŠÙˆÙ†":333333,
        "Ù…Ù„ÙŠÙˆÙ†":1000000,
        "Ø§Ù„Ù":1000,
        "Ø£Ù„Ù":1000,
        "Ø£Ù„ÙÙŠÙ†":2000
    };

    for(let w in special){
        if(t.includes(w)) return special[w];
    }

    if(/\d+/.test(t)) return parseFloat(t);

    return 0;
}

/* ------------------------------------------------------
    Web Speech + Deepgram Hybrid
------------------------------------------------------ */

const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec=null;
let micOn=false;

const DEEPGRAM_KEY = "dg_test_1d4dfe0b676a2c909b4ac31e"; // Ù…ÙØªØ§Ø­ Ø¹Ø§Ù… Ù„Ù„ØªØ¬Ø±Ø¨Ø©

async function deepgramAI(text){
    let res = await fetch("https://api.deepgram.com/v1/listen?model=nova-2-general",{
        method:"POST",
        headers:{
            "Authorization":"Token "+DEEPGRAM_KEY,
            "Content-Type":"application/json"
        },
        body:JSON.stringify({text})
    });

    let data = await res.json();
    return data.results?.channels?.[0]?.alternatives?.[0]?.transcript || text;
}

/* ------------------------------------------------------
    AI Command Engine
------------------------------------------------------ */
function understandCommand(text){
    text=text.toLowerCase();

    // Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©
    if(text.includes("Ø§Ø­Ø°Ù") || text.includes("Ø´ÙŠÙ„ Ø§Ø®Ø±")){
        if(dataList.length>0){
            let last = dataList[0];
            remove(ref(db, last.type + "/" + last.id));
            Swal.fire("ØªÙ… Ø§Ù„Ø­Ø°Ù","ØªÙ… Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©","success");
            return;
        }
    }

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    if(text.includes("Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ") || text.includes("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ")){
        let total = dataList.filter(x=>x.type=="expense")
                            .reduce((a,b)=>a+b.amount,0);
        speak("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ùˆ " + total + " Ø¬Ù†ÙŠÙ‡");
        return;
    }

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„
    if(text.includes("Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„")){
        let total = dataList.filter(x=>x.type=="income")
                            .reduce((a,b)=>a+b.amount,0);
        speak("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ Ù‡Ùˆ " + total + " Ø¬Ù†ÙŠÙ‡");
        return;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©
    let amount = parseArabicNumber(text);
    if(amount>0){
        let type = text.includes("Ù…ØµØ±ÙˆÙ") || text.includes("Ø¯ÙØ¹Øª") ? "expense" : "income";
        let desc = text.replace(/\d+/g,"").replace("Ø¬Ù†ÙŠÙ‡","").trim();

        push(ref(db,type),{
            amount,
            description:desc || "Ø¹Ù…Ù„ÙŠØ©",
            timestamp:Date.now()
        });

        Swal.fire("ØªÙ…","ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©","success");
        return;
    }

    Swal.fire("Ù„Ù… Ø£ÙÙ‡Ù… Ø§Ù„Ø£Ù…Ø±","Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©","warning");
}

/* ------------------------------------------------------
   Ù†Ø·Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù…
------------------------------------------------------ */
function speak(t){
    let u=new SpeechSynthesisUtterance(t);
    u.lang="ar-EG";
    speechSynthesis.speak(u);
}

/* ------------------------------------------------------
   ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
------------------------------------------------------ */
async function toggleMic(){
    if(!Speech){
        Swal.fire("Ø®Ø·Ø£","Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª","error");
        return;
    }

    if(micOn){
        rec.stop();
        return;
    }

    rec = new Speech();
    rec.lang="ar-EG";
    rec.start();
    micOn=true;
    mic.classList.add("active");

    rec.onresult = async (e)=>{
        let raw = e.results[0][0].transcript;
        let fixed = await deepgramAI(raw);
        understandCommand(fixed);
    };

    rec.onend = ()=>{
        micOn=false;
        mic.classList.remove("active");
    };
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>

</body>
</html>
