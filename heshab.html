<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>النظام المالي | الذكاء الاصطناعي المتقدم</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        :root {
            --primary: #6366f1; --primary-rgb: 99, 102, 241;
            --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --info: #3b82f6;
            --bg: #f8fafc; --surface: #ffffff; --text: #1e293b;
        }
        [data-theme="dark"] { --bg: #0f172a; --surface: #1e293b; --text: #f8fafc; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; padding-bottom: 120px; min-height: 100vh; transition: 0.3s; }
        .container { max-width: 600px; margin: 0 auto; }

        /* الهيدر */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 15px 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .btn-icon { background: transparent; border: none; width: 45px; height: 45px; border-radius: 12px; font-size: 1.3rem; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .btn-icon:hover { background: rgba(var(--primary-rgb), 0.1); transform: translateY(-2px); }

        /* الإحصائيات */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); padding: 15px 5px; border-radius: 18px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); }
        .stat-icon { font-size: 1.4rem; margin-bottom: 8px; display: inline-block; width: 35px; height: 35px; line-height: 35px; border-radius: 50%; }
        .income .stat-icon { background: rgba(16,185,129,0.1); color: var(--success); }
        .expense .stat-icon { background: rgba(239,68,68,0.1); color: var(--danger); }
        .net .stat-icon { background: rgba(99,102,241,0.1); color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: #64748b; font-weight: 700; }
        .stat-val { font-size: 1.4rem; font-weight: 800; font-family: 'Roboto', sans-serif; }
        .stat-val.income { color: var(--success); } .stat-val.expense { color: var(--danger); } .stat-val.net { color: var(--primary); }

        /* النموذج */
        .toggle-input-btn { width: 100%; background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; padding: 15px; border-radius: 16px; border: none; cursor: pointer; font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(99,102,241,0.3); }
        .input-box { background: var(--surface); padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-box.hidden { display: none; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg); padding: 5px; border-radius: 16px; }
        .tab { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; background: transparent; color: #94a3b8; transition: 0.2s; }
        .tab.active { background: var(--surface); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tab.active.inc { color: var(--success); } .tab.active.exp { color: var(--danger); }
        
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 16px 50px 16px 20px; border: 2px solid var(--bg); border-radius: 16px; font-size: 1.1rem; background: var(--bg); color: var(--text); font-weight: 600; }
        .input-group i { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .save-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .save-btn:hover { transform: translateY(-2px); }

        /* القائمة */
        .filter-btns { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid transparent; background: rgba(148, 163, 184, 0.1); color: var(--text); font-weight: 700; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .filter-btn.active { background: var(--text); color: var(--bg); }
        
        .record { background: var(--surface); padding: 15px; border-radius: 16px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; cursor: pointer; border: 1px solid rgba(0,0,0,0.03); position: relative; overflow: hidden; transition: 0.2s; }
        .record:hover { transform: translateX(-5px); }
        .record::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 6px; }
        .record.inc::before { background: var(--success); } .record.exp::before { background: var(--danger); }
        .rec-info h4 { font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
        .rec-date { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
        .rec-amt { font-weight: 900; font-size: 1.2rem; margin-right: auto; font-family: 'Roboto', sans-serif; }

        /* الميكروفون */
        .mic-container { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .mic-btn { pointer-events: auto; width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #f43f5e, #e11d48); color: white; border: none; box-shadow: 0 10px 30px rgba(225, 29, 72, 0.4); font-size: 1.8rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .mic-btn.listening { animation: pulse 1.5s infinite; background: #22c55e; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        
        /* رسالة التعرف */
        .voice-msg { position: fixed; top: 110px; left: 50%; transform: translateX(-50%); background: rgba(15,23,42,0.9); backdrop-filter: blur(5px); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; z-index: 999; display: none; }
        .voice-msg.active { display: block; animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* إعدادات ال API */
        .api-settings { background: var(--surface); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .api-settings h3 { margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .api-settings.hidden { display: none; }
        .api-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .api-btn { flex: 1; padding: 12px; border-radius: 12px; border: 2px solid var(--bg); background: var(--bg); color: var(--text); font-weight: 700; cursor: pointer; transition: 0.2s; }
        .api-btn.active { border-color: var(--primary); background: rgba(var(--primary-rgb), 0.1); color: var(--primary); }
        .api-info { padding: 15px; background: var(--bg); border-radius: 12px; font-size: 0.85rem; line-height: 1.5; margin-top: 10px; display: none; }
        .api-info.active { display: block; }

        /* شريط الحالة */
        .status-bar { position: fixed; top: 0; left: 0; right: 0; background: var(--primary); color: white; padding: 8px 15px; text-align: center; font-size: 0.8rem; z-index: 1000; display: none; }
        .status-bar.warning { background: var(--warning); }
        .status-bar.error { background: var(--danger); }

    </style>
</head>
<body>

<!-- شريط الحالة -->
<div class="status-bar" id="statusBar">
    <i class="fa-solid fa-triangle-exclamation"></i> 
    <span id="statusText">تحذير: مفاتيح API غير محمية!</span>
</div>

<div class="container">
    <div class="header">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="width:45px; height:45px; background:rgba(99,102,241,0.1); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                <i class="fa-solid fa-brain" style="color:var(--primary); font-size:1.4rem;"></i>
            </div>
            <div>
                <h2 style="font-weight:900; font-size:1.2rem; margin-bottom:2px;">المالية الذكية</h2>
                <span style="font-size:0.75rem; color:#64748b; font-weight:600;">مدعوم بالذكاء الاصطناعي الآمن</span>
            </div>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="btn-icon" onclick="toggleApiSettings()" title="إعدادات ال API">
                <i class="fa-solid fa-api" style="color:#8b5cf6;"></i>
            </button>
            <button class="btn-icon" onclick="exportExcel()" title="تصدير Excel">
                <i class="fa-solid fa-file-excel" style="color:#10b981;"></i>
            </button>
            <button class="btn-icon" onclick="toggleTheme()" title="تبديل المظهر">
                <i class="fa-solid fa-circle-half-stroke" style="color:#6366f1;"></i>
            </button>
            <button class="btn-icon" onclick="deleteAllRecordsPrompt()" title="حذف الكل">
                <i class="fa-solid fa-trash-can" style="color:#ef4444;"></i>
            </button>
        </div>
    </div>

    <!-- إعدادات ال API -->
    <div class="api-settings hidden" id="apiSettings">
        <h3><i class="fa-solid fa-gear"></i> إعدادات الذكاء الاصطناعي الآمنة</h3>
        
        <div class="api-selector">
            <button class="api-btn active" onclick="setApiMode('local')" data-api="local">
                <i class="fa-solid fa-laptop-house"></i> محلي (آمن)
            </button>
            <button class="api-btn" onclick="setApiMode('proxy')" data-api="proxy">
                <i class="fa-solid fa-server"></i> خادم وسيط (مُوصى به)
            </button>
        </div>
        
        <!-- الوضع المحلي -->
        <div class="api-info active" id="localApiInfo">
            <strong><i class="fa-solid fa-shield-halved"></i> النظام المحلي الآمن:</strong>
            <ul style="padding-right:15px; margin-top:5px;">
                <li>✅ يعمل بدون إنترنت</li>
                <li>✅ لا يتطلب مفاتيح API</li>
                <li>✅ حماية كاملة للخصوصية</li>
                <li>✅ يدعم الجمل العربية المعقدة</li>
                <li>✅ مثالي للمستخدمين المحليين</li>
            </ul>
            <div style="margin-top:15px; padding:10px; background:rgba(16,185,129,0.1); border-radius:8px;">
                <strong>نصيحة أمان:</strong> هذا الوضع هو الأكثر أماناً للاستخدام المحلي.
            </div>
        </div>
        
        <!-- الوضع مع خادم وسيط -->
        <div class="api-info" id="proxyApiInfo">
            <strong><i class="fa-solid fa-cloud"></i> الوضع السحابي الآمن:</strong>
            <p style="margin:10px 0;">للاستخدام السحابي، استخدم خادم وسيط لحماية مفاتيح API:</p>
            
            <div style="margin:15px 0;">
                <input type="text" id="proxyUrl" placeholder="https://your-proxy-server.com/api" 
                       style="width:100%; padding:12px; border-radius:8px; border:2px solid var(--primary);">
                <button onclick="testProxyConnection()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; margin-top:10px;">
                    <i class="fa-solid fa-plug"></i> اختبار الاتصال
                </button>
            </div>
            
            <div style="padding:15px; background:rgba(99,102,241,0.1); border-radius:8px; margin-top:15px;">
                <strong><i class="fa-solid fa-lightbulb"></i> كيفية إنشاء خادم وسيط:</strong>
                <ol style="padding-right:20px; margin-top:10px;">
                    <li>أنشئ حساب على <a href="https://vercel.com" target="_blank" style="color:var(--primary);">Vercel</a> (مجاني)</li>
                    <li>انسخ الكود من <a href="#" onclick="showProxyCode()" style="color:var(--primary);">هذا الرابط</a></li>
                    <li>انشره واحصل على رابط API الآمن</li>
                </ol>
            </div>
        </div>
        
        <!-- روابط للحصول على مفاتيح -->
        <div style="margin-top:20px; padding-top:15px; border-top:1px solid #e2e8f0;">
            <small style="color:#64748b; display:block; text-align:center;">
                للحصول على مفاتيح API مجانية:
                <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color:var(--primary); margin:0 5px;">Google Cloud</a> •
                <a href="https://huggingface.co/settings/tokens" target="_blank" style="color:var(--primary); margin:0 5px;">Hugging Face</a>
            </small>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card income">
            <div class="stat-icon"><i class="fa-solid fa-arrow-down"></i></div>
            <div class="stat-label">الدخل</div>
            <div class="stat-val income" id="totalInc">0</div>
        </div>
        <div class="stat-card expense">
            <div class="stat-icon"><i class="fa-solid fa-arrow-up"></i></div>
            <div class="stat-label">المصروفات</div>
            <div class="stat-val expense" id="totalExp">0</div>
        </div>
        <div class="stat-card net">
            <div class="stat-icon"><i class="fa-solid fa-scale-balanced"></i></div>
            <div class="stat-label">الصافي</div>
            <div class="stat-val net" id="netBal">0</div>
        </div>
    </div>

    <button class="toggle-input-btn" onclick="toggleInputForm()">
        <i class="fa-solid fa-plus-circle"></i> تسجيل عملية يدوية
    </button>

    <div class="input-box hidden" id="inputBox">
        <div class="tabs">
            <button id="btnInc" class="tab active inc" onclick="setMode('income')">دخل</button>
            <button id="btnExp" class="tab" onclick="setMode('expense')">مصروف</button>
        </div>
        <form onsubmit="saveTx(event)">
            <div class="input-group">
                <i class="fa-solid fa-coins"></i>
                <input type="number" id="amount" placeholder="المبلغ" step="any" required>
            </div>
            <div class="input-group">
                <i class="fa-solid fa-pen-nib"></i>
                <input type="text" id="desc" placeholder="وصف العملية" required>
            </div>
            <button type="submit" class="save-btn" id="submitBtn">
                <i class="fa-solid fa-check"></i> حفظ العملية
            </button>
        </form>
    </div>

    <div class="filter-btns">
        <button class="filter-btn active" onclick="setFilter('all')" data-filter="all">الكل</button>
        <button class="filter-btn" onclick="setFilter('income')" data-filter="income">الوارد</button>
        <button class="filter-btn" onclick="setFilter('expense')" data-filter="expense">المصروف</button>
    </div>
    <div id="list"></div>
</div>

<div class="voice-msg" id="voiceMsg">جاري التحليل...</div>

<div class="mic-container">
    <button class="mic-btn" id="mic" onclick="toggleMic()"><i class="fa-solid fa-microphone"></i></button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
    apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
    authDomain: "nasrapp-7a0fc.firebaseapp.com",
    databaseURL: "https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
    projectId: "nasrapp-7a0fc",
    appId: "1:826970736109:web:c1cc3c3a1008e719b193e4"
});
const db = getDatabase(app);

// =============================================
// إعدادات التطبيق
// =============================================
let mode = "income";
let records = [];
let filter = "all";
let isListening = false;
let currentApiMode = localStorage.getItem('api_mode') || 'local';
let proxyUrl = localStorage.getItem('proxy_url') || '';

window.toggleTheme = () => {
    const isDark = document.body.dataset.theme === "dark";
    document.body.dataset.theme = isDark ? "light" : "dark";
    localStorage.setItem("theme", document.body.dataset.theme);
};
if(localStorage.getItem("theme")) document.body.dataset.theme = localStorage.getItem("theme");

window.setMode = (m) => {
    mode = m;
    document.getElementById("btnInc").className = `tab ${m==='income'?'active inc':''}`;
    document.getElementById("btnExp").className = `tab ${m==='expense'?'active exp':''}`;
    document.getElementById("submitBtn").style.background = m === "income" ? "var(--success)" : "var(--danger)";
};

window.setFilter = (f) => {
    filter = f;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.toggle("active", b.dataset.filter === f));
    render();
};

window.toggleInputForm = () => {
    document.getElementById("inputBox").classList.toggle("hidden");
};

window.toggleApiSettings = () => {
    document.getElementById('apiSettings').classList.toggle('hidden');
};

window.setApiMode = (mode) => {
    currentApiMode = mode;
    localStorage.setItem('api_mode', mode);
    
    // تحديث الأزرار
    document.querySelectorAll('.api-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.api === mode);
    });
    
    // تحديث المعلومات
    document.querySelectorAll('.api-info').forEach(info => {
        info.classList.remove('active');
    });
    document.getElementById(`${mode}ApiInfo`).classList.add('active');
    
    // تحميل إعدادات الخادم الوسيط
    if(mode === 'proxy') {
        document.getElementById('proxyUrl').value = proxyUrl;
    }
};

window.testProxyConnection = async () => {
    const url = document.getElementById('proxyUrl').value.trim();
    if(!url) {
        Swal.fire({icon: 'error', title: 'خطأ', text: 'الرجاء إدخال رابط الخادم الوسيط'});
        return;
    }
    
    try {
        const response = await fetch(`${url}/test`);
        const data = await response.json();
        
        if(data.status === 'ok') {
            proxyUrl = url;
            localStorage.setItem('proxy_url', url);
            Swal.fire({icon: 'success', title: 'تم', text: 'اتصال ناجح بالخادم الوسيط'});
        }
    } catch (error) {
        Swal.fire({icon: 'error', title: 'خطأ', text: 'فشل الاتصال بالخادم الوسيط'});
    }
};

window.showProxyCode = () => {
    const proxyCode = `
// ملف: api/proxy.js (للاستضافة على Vercel)
const express = require('express');
const axios = require('axios');

const app = express();
app.use(express.json());

// مفاتيح API - ضعها هنا فقط
const GOOGLE_API_KEY = 'AIzaSyBx3b5hNfo8yXTJMRSa4F6PoROkYNNMDac';
const HUGGINGFACE_KEY = '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';

// اختبار الاتصال
app.get('/test', (req, res) => {
    res.json({status: 'ok', message: 'Proxy server is running'});
});

// تحويل الصوت إلى نص (Google Speech-to-Text)
app.post('/speech-to-text', async (req, res) => {
    try {
        const { audio } = req.body;
        const response = await axios.post(
            'https://speech.googleapis.com/v1/speech:recognize',
            {
                config: {
                    encoding: "WEBM_OPUS",
                    sampleRateHertz: 48000,
                    languageCode: "ar-EG",
                },
                audio: { content: audio }
            },
            { params: { key: GOOGLE_API_KEY } }
        );
        res.json(response.data);
    } catch (error) {
        res.status(500).json({error: error.message});
    }
});

// تحليل النص (Hugging Face)
app.post('/analyze-text', async (req, res) => {
    try {
        const { text } = req.body;
        const response = await axios.post(
            'https://api-inference.huggingface.co/models/jonatasgrosman/wav2vec2-large-xlsr-53-arabic',
            { inputs: text },
            { headers: { Authorization: \`Bearer \${HUGGINGFACE_KEY}\` } }
        );
        res.json(response.data);
    } catch (error) {
        res.status(500).json({error: error.message});
    }
});

module.exports = app;
`;
    
    Swal.fire({
        title: 'كود الخادم الوسيط',
        html: `<textarea style="width:100%; height:300px; font-family:monospace; direction:ltr;" readonly>${proxyCode}</textarea>`,
        width: 800,
        confirmButtonText: 'نسخ',
        showCancelButton: true
    }).then(result => {
        if(result.isConfirmed) {
            navigator.clipboard.writeText(proxyCode);
            Swal.fire({icon: 'success', title: 'تم النسخ', timer: 2000});
        }
    });
};

// تهيئة إعدادات ال API عند التحميل
document.addEventListener('DOMContentLoaded', () => {
    setApiMode(currentApiMode);
    
    // التحذير من وضع المفاتيح في GitHub
    if(window.location.href.includes('github') || window.location.href.includes('github.io')) {
        document.getElementById('statusBar').style.display = 'block';
        document.getElementById('statusText').innerHTML = 
            '<i class="fa-solid fa-triangle-exclamation"></i> تحذير: لا تضع مفاتيح API في الكود عند رفعه على GitHub!';
    }
});

// =============================================
// Firebase
// =============================================
window.saveTx = async (e, directData = null) => {
    if (e) e.preventDefault();
    let amt, txt, type;
    
    if (directData) {
        amt = directData.amount;
        txt = directData.description;
        type = directData.type;
    } else {
        amt = parseFloat(document.getElementById("amount").value);
        txt = document.getElementById("desc").value.trim();
        type = mode;
    }

    if (!amt || !txt) return;

    await push(ref(db, type === "income" ? "income" : "expenses"), {
        amount: amt, description: txt, timestamp: Date.now()
    });

    if (!directData) {
        document.getElementById("amount").value = "";
        document.getElementById("desc").value = "";
        document.getElementById("inputBox").classList.add("hidden");
    }

    Swal.fire({
        toast: true, icon: "success", 
        title: "تم الحفظ", 
        text: `${txt} : ${Number(amt).toLocaleString()}`,
        position: "top", timer: 2000, showConfirmButton: false
    });
};

onValue(ref(db), (snap) => {
    records = [];
    const d = snap.val();
    if (d) {
        if (d.income) Object.entries(d.income).forEach(([id,v]) => records.push({...v,id,type:"income"}));
        if (d.expenses) Object.entries(d.expenses).forEach(([id,v]) => records.push({...v,id,type:"expense"}));
    }
    records.sort((a,b) => b.timestamp - a.timestamp);
    render();
});

function render() {
    let data = records;
    if (filter !== "all") data = data.filter(r => r.type === filter);

    const inc = records.filter(r => r.type==="income").reduce((s,r)=>s+r.amount,0);
    const exp = records.filter(r => r.type==="expense").reduce((s,r)=>s+r.amount,0);
    const net = inc - exp;

    document.getElementById("totalInc").innerText = inc.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    document.getElementById("totalExp").innerText = exp.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    document.getElementById("netBal").innerText = net.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});

    const list = document.getElementById("list");
    list.innerHTML = "";
    
    if (data.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;"><i class="fa-solid fa-box-open" style="font-size:3rem; margin-bottom:10px;"></i><p>لا توجد بيانات</p></div>`;
        return;
    }

    data.forEach(r => {
        const div = document.createElement("div");
        div.className = `record ${r.type === 'income' ? 'inc' : 'exp'}`;
        div.onclick = () => manageRecord(r);
        const date = new Date(r.timestamp);
        
        div.innerHTML = `
            <div class="rec-info">
                <h4>${r.description}</h4>
                <div class="rec-date">${date.toLocaleTimeString('ar-EG', {hour:'2-digit',minute:'2-digit'})} • ${date.toLocaleDateString('ar-EG')}</div>
            </div>
            <div class="rec-amt" style="color:${r.type==='income'?'var(--success)':'var(--danger)'}">
                ${r.type==='income'?'+':'-'}${Number(r.amount).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 2})}
            </div>
        `;
        list.appendChild(div);
    });
}

// =============================================
// 1. المحلل المحلي المحسن جداً (الوضع الافتراضي الآمن)
// =============================================
class EnhancedLocalParser {
    constructor() {
        // قاموس موسع للدخل
        this.incomes = [
            "قبضت","قبض","خدت","اخدت","أخدت","جالي","جه","وصلني","وصل",
            "استلمت","استلام","تحويل","وصللي","اداني","ادتهالي","جابلي",
            "جاب لي","جاتلي","جتلي","دهالي","حولي","حولي فلوس",
            "دخل","وارد","ايراد","ارباح","ربح","كسب","كسبت","ربحت",
            "مرتب","جمعية","شغل","عمولة","محصل","محصلة","بيع","بيعت",
            "راتب","مكافأة","علاوة","مكافئة","هبة","هدية","منحة","منحة دراسية",
            "تعويض","تعويضات","تأمين","عائد استثمار","ارباح أسهم","تأجير",
            "قرض","سلفة","رد","استرداد","خصم","كوبون","عرض","خصم خاص",
            "فايدة","فوائد","ربح بنك","مرتبة","استلام نقدي","كاش","نقدي",
            "دفعة","قسط","تسوية","مستحقات","مبلغ مستحق","تحصيل","محصل"
        ];

        // قاموس موسع للمصروفات
        this.expenses = [
            "صرفت","صرف","دفعت","دفع","اشتريت","شراء","جبت","جاب",
            "خرجت","خرج","طلع","خصم","اتخصم","سحب","اتسحب","خصموا",
            "فاتورة","بنزين","مواصلات","اكل","شرب","طارت","راحت","اتسحبت",
            "ايجار","كهرباء","مياه","غاز","نت","رصيد","علاج","دكتور",
            "صيانة","قسط","دين","عزومة","هدايا","لبس","حلاق","خضار",
            "فاكهة","لحمة","فراخ","سمك","عيش","سوبر","ماركت","مدرسة",
            "جامعة","كتب","دروس","تاكسي","اوبر","كريم","دواء","صيدلية",
            "قهوة","مطعم","وجبة","سناك","حلويات","سجائر","شيشة",
            "نادي","جيم","رياضة","ملابس","حذاء","شنطة","اكسسوارات",
            "تلفون","انترنت","نتي","شحن","رحلة","سفر","فندق","سياحة",
            "تأمين","ضرائب","غرامة","مخالفة","خدمات","تنظيف","غسيل",
            "سباكة","كهربائي","نجار","دهان","صيانة سيارة","زيت","إطارات",
            "بوتاجاز","غاز","ميكرويف","ثلاجة","غسالة","تكييف","دفاية",
            "إنترنت","واي فاي","نت","شبكة","أونلاين","نتflix","يوتيوب بريميوم",
            "اشتراك","جريدة","مجلة","كتب","قرطاسية","أقلام","دفاتر",
            "حضانة","روضة","مدرسة خاصة","دروس خصوصية","معاهد","كورسات",
            "طباعة","تصوير","فاكس","بريد","شحن","توصيل","ديليفري",
            "سبورت","ملعب","أدوات رياضية","معدات","أجهزة","أدوات",
            "ترفيه","سينما","مسرح","حفلات","حفلة","سهرة","خروجة",
            "تصليح","إصلاح","ترميم","دهان","تبديل","تغيير","شراء جديد",
            "هدية","كرم","ضيافة","عزومة","وليمة","حفلة شاي","قهوة",
            "تبرع","صدقة","زكاة","خيرية","مساعدة","معونة","إعانة",
            "قرض","دين","سلفة","سداد دين","تسديد قرض","أقساط",
            "تأمين صحي","تأمين على الحياة","تأمين سيارة","تأمين منزلي",
            "استثمار","أسهم","سندات","عملات رقمية","بتكوين","كريبتو",
            "ضرائب","رسوم","غرامات","مخالفات","جزاءات","عقوبات مالية",
            "مصاريف غير متوقعة","طوارئ","حالات طارئة","مفاجآت"
        ];

        // قاموس الأرقام
        this.numberWords = {
            "صفر":0,"واحد":1,"اتنين":2,"تلاتة":3,"اربعة":4,"خمسة":5,
            "ستة":6,"سبعة":7,"تمانية":8,"تسعة":9,"عشرة":10,
            "حداشر":11,"اتناشر":12,"تلاتاشر":13,"اربعتاشر":14,"خمستاشر":15,
            "ستاشر":16,"سبعتاشر":17,"تمنتاشر":18,"تسعتاشر":19,
            "عشرين":20,"واحد وعشرين":21,"اتنين وعشرين":22,"تلاتة وعشرين":23,
            "اربعة وعشرين":24,"خمسة وعشرين":25,"ستة وعشرين":26,
            "سبعة وعشرين":27,"تمانية وعشرين":28,"تسعة وعشرين":29,
            "تلاتين":30,"اربعين":40,"خمسين":50,"ستين":60,"سبعين":70,
            "تمانين":80,"تسعين":90,
            "مية":100,"ميتين":200,"تلاتمية":300,"اربعمية":400,
            "خمسمية":500,"ستمية":600,"سبعمية":700,"تمنمية":800,"تسعمية":900,
            "الف":1000,"ألف":1000,"الفين":2000,"تلات الاف":3000,"اربعة الاف":4000,
            "خمسة الاف":5000,"ستة الاف":6000,"سبعة الاف":7000,"تمانية الاف":8000,
            "تسعة الاف":9000,"عشرة الاف":10000,"عشرين الف":20000,
            "مية الف":100000,"مليون":1000000
        };

        // الكسور
        this.fractions = {
            "نص":0.5,"نصف":0.5,"ربع":0.25,"تلت":0.333,"ثلث":0.333,
            "عشر":0.1,"خمس":0.2,"سدس":0.166,"سبع":0.142,"ثمن":0.125,
            "عشرين":0.05,"خمسين":0.02,"مية":0.01
        };

        // العملات
        this.currencies = ["جنيه","جنية","ريال","دولار","يورو","درهم","ليرة"];
    }

    parse(text) {
        // تنظيف النص
        let normalized = text
            .replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d))
            .replace(/[^\u0600-\u06FF0-9\s\.]/g, '')
            .toLowerCase()
            .replace(/\s+/g, ' ')
            .trim();

        // 1. استخراج المبلغ
        let amount = this.extractAmount(normalized);
        if (amount === 0) return null;

        // 2. تحديد النوع (دخل/مصروف)
        let type = this.determineType(normalized, amount);

        // 3. استخراج الوصف
        let description = this.extractDescription(normalized, type, amount);

        return { amount, description, type };
    }

    extractAmount(text) {
        let amount = 0;
        
        // البحث عن أرقام عربية/إنجليزية
        const numMatch = text.match(/(\d+(\.\d+)?)/);
        if (numMatch) {
            amount = parseFloat(numMatch[0]);
        }
        
        // إذا لم يوجد رقم، بحث عن أرقام كتابية
        if (amount === 0) {
            for (let [word, val] of Object.entries(this.numberWords)) {
                if (text.includes(word)) {
                    amount = val;
                    break;
                }
            }
        }
        
        // البحث عن كسور وتطبيقها
        for (let [word, val] of Object.entries(this.fractions)) {
            if (text.includes(word)) {
                if (amount === 0) amount = val;
                else amount *= val;
                break;
            }
        }
        
        // البحث عن "و" بين الأرقام (مثل: مية وخمسين)
        const andPatterns = [
            /(\d+)\s*و\s*(\d+)/,
            /(مية|الف|مليون)\s*و\s*(\d+)/
        ];
        
        for (let pattern of andPatterns) {
            const match = text.match(pattern);
            if (match) {
                const num1 = this.numberWords[match[1]] || parseInt(match[1]);
                const num2 = this.numberWords[match[2]] || parseInt(match[2]);
                amount = num1 + num2;
                break;
            }
        }
        
        // البحث الأخير عن أي رقم
        if (amount === 0) {
            const lastResort = text.match(/\d+/);
            if (lastResort) amount = parseFloat(lastResort[0]);
        }
        
        return amount;
    }

    determineType(text, amount) {
        let expScore = 0;
        let incScore = 0;
        
        // حساب النقاط للمصروفات
        this.expenses.forEach(word => {
            if (text.includes(word)) expScore += 2;
        });
        
        // حساب النقاط للدخل
        this.incomes.forEach(word => {
            if (text.includes(word)) incScore += 2;
        });
        
        // كلمات حاسمة
        const decisiveWords = {
            income: ["مرتب", "راتب", "بيع", "عمولة", "تأجير", "استرداد"],
            expense: ["فاتورة", "ايجار", "قسط", "دين", "غرامة", "ضرائب"]
        };
        
        decisiveWords.income.forEach(word => {
            if (text.includes(word)) incScore += 5;
        });
        
        decisiveWords.expense.forEach(word => {
            if (text.includes(word)) expScore += 5;
        });
        
        // إذا كانت النقاط متساوية، ننظر إلى السياق
        if (incScore === expScore) {
            // إذا كان المبلغ كبيراً (> 5000) قد يكون مرتب
            if (amount > 5000) return "income";
            // إذا كان المبلغ صغيراً (< 100) قد يكون مصروف يومي
            if (amount < 100) return "expense";
            // الإفتراض الافتراضي
            return "expense";
        }
        
        return incScore > expScore ? "income" : "expense";
    }

    extractDescription(text, type, amount) {
        // إزالة المبلغ
        let clean = text.replace(/(\d+(\.\d+)?)/g, '');
        
        // إزالة كلمات النوع
        const keywords = type === "income" ? this.incomes : this.expenses;
        keywords.forEach(word => {
            clean = clean.replace(new RegExp(word, 'gi'), '');
        });
        
        // إزالة العملات
        this.currencies.forEach(currency => {
            clean = clean.replace(new RegExp(currency, 'gi'), '');
        });
        
        // إزالة حروف الجر والكلمات العامة
        const stopWords = [
            "على", "من", "في", "الي", "الى", "ل", "لك", "ليه", "يا",
            "انا", "هو", "هي", "هم", "انت", "انتي", "احنا", "انتم",
            "كان", "يكون", "صار", "يصير", "بدي", "عايز", "نفسي",
            "هسا", "الحين", "الآن", "امبارح", "بكرة", "النهاردة",
            "شوي", "شوية", "كثير", "كتير", "قليل", "شبه", "مثل",
            "يعني", "مثلا", "اي", "ايه", "شنو", "وش", "ليش", "لأي",
            "علشان", "عشان", "لأن", "لانه", "بس", "لكن", "لاكن",
            "أيضا", "كمان", "برضو", "بعدين", "ثم", "وبعدين"
        ];
        
        stopWords.forEach(word => {
            const regex = new RegExp(`\\b${word}\\b`, 'gi');
            clean = clean.replace(regex, '');
        });
        
        // تنظيف نهائي
        clean = clean
            .replace(/\s+/g, ' ')
            .replace(/^[\s,.\-]+|[\s,.\-]+$/g, '')
            .trim();
        
        // إذا كان الوصف قصيراً
        if (clean.length < 2) {
            const defaults = {
                income: [
                    "وارد", "دخل", "تحويل بنكي", "مرتب", "عمولة",
                    "مبيعات", "إيرادات", "استثمار", "قرض", "هدية"
                ],
                expense: [
                    "مصروف", "مشتريات", "فاتورة", "خدمات", "تسوق",
                    "مواصلات", "طعام", "رعاية صحية", "تعليم", "ترفيه"
                ]
            };
            
            const category = this.categorizeExpense(text, amount);
            clean = category || defaults[type][Math.floor(Math.random() * defaults[type].length)];
        }
        
        // تقطيع إذا كان طويلاً
        return clean.length > 50 ? clean.substring(0, 47) + "..." : clean;
    }

    categorizeExpense(text, amount) {
        const categories = {
            "مواصلات": ["بنزين", "تاكسي", "اوبر", "كريم", "باص", "مترو"],
            "طعام": ["اكل", "شرب", "مطعم", "وجبة", "سناك", "حلويات", "قهوة"],
            "تسوق": ["سوبر", "ماركت", "خضار", "فاكهة", "لحمة", "فراخ"],
            "صحة": ["علاج", "دكتور", "دواء", "صيدلية", "مستشفى"],
            "تعليم": ["مدرسة", "جامعة", "كتب", "دروس", "كورسات"],
            "ترفيه": ["نادي", "جيم", "سينما", "حفلة", "سهرة"],
            "منزل": ["ايجار", "كهرباء", "مياه", "غاز", "نت"],
            "ملابس": ["لبس", "حذاء", "شنطة", "اكسسوارات"]
        };
        
        for (const [category, keywords] of Object.entries(categories)) {
            for (const keyword of keywords) {
                if (text.includes(keyword)) {
                    return category;
                }
            }
        }
        
        return null;
    }
}

// =============================================
// 2. نظام الاتصال بالخادم الوسيط
// =============================================
async function analyzeWithProxy(audioBlob) {
    if (!proxyUrl) {
        throw new Error('لم يتم إعداد خادم وسيط. الرجاء إعداده في الإعدادات.');
    }

    // تحويل الصوت إلى Base64
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64Audio = reader.result.split(',')[1];
            
            try {
                const response = await axios.post(`${proxyUrl}/speech-to-text`, {
                    audio: base64Audio
                });

                if (response.data.results && response.data.results[0]) {
                    const text = response.data.results[0].alternatives[0].transcript;
                    const parser = new EnhancedLocalParser();
                    const result = parser.parse(text);
                    
                    if (result) {
                        resolve(result);
                    } else {
                        // محاولة تحليل النص مع Hugging Face
                        try {
                            const analysis = await axios.post(`${proxyUrl}/analyze-text`, {
                                text: text
                            });
                            // استخدام تحليل Hugging Face لتحسين النتيجة
                            resolve({...result, enhanced: true});
                        } catch (hfError) {
                            reject(new Error('فشل في تحليل النص'));
                        }
                    }
                } else {
                    reject(new Error('لم أتمكن من تحويل الصوت إلى نص'));
                }
            } catch (error) {
                reject(error);
            }
        };
        reader.readAsDataURL(audioBlob);
    });
}

// =============================================
// نظام الصوت الرئيسي
// =============================================
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const voiceMsg = document.getElementById("voiceMsg");

if (SR) {
    const rec = new SR();
    rec.lang = "ar-EG";
    rec.continuous = false;
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    
    let mediaRecorder;
    let audioChunks = [];
    
    rec.onstart = () => { 
        isListening = true; 
        document.getElementById("mic").classList.add("listening"); 
        voiceMsg.innerText = "استمع إليك...";
        voiceMsg.classList.add("active");
    };
    
    rec.onend = () => { 
        isListening = false; 
        document.getElementById("mic").classList.remove("listening"); 
        setTimeout(() => voiceMsg.classList.remove("active"), 1000);
    };

    rec.onresult = async (e) => {
        const text = e.results[0][0].transcript;
        voiceMsg.innerText = `سمعت: "${text}"`;
        
        try {
            let result;
            
            if (currentApiMode === 'proxy' && proxyUrl) {
                // استخدام الخادم الوسيط
                voiceMsg.innerText = "جاري التحليل السحابي الآمن...";
                result = await analyzeWithProxy(await recordAudio());
            } else {
                // الوضع المحلي (الافتراضي الآمن)
                const parser = new EnhancedLocalParser();
                result = parser.parse(text);
            }
            
            if (result) {
                await saveTx(null, result);
                voiceMsg.innerText = `تم حفظ: ${result.description}`;
                
                // عرض إشعار بالنظام المستخدم
                Swal.fire({
                    toast: true,
                    position: 'top',
                    icon: 'success',
                    title: `تم الحفظ (${currentApiMode === 'proxy' ? 'سحابي' : 'محلي'})`,
                    text: `${result.description}: ${result.amount}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    toast: true,
                    icon: "warning",
                    title: "لم أتعرف على المعاملة",
                    text: "يمكنك إدخالها يدوياً",
                    timer: 3000
                });
            }
        } catch (error) {
            console.error("Error:", error);
            
            // المحاولة بالمحلل المحلي كخيار احتياطي
            try {
                const parser = new EnhancedLocalParser();
                const localResult = parser.parse(text);
                if (localResult) {
                    await saveTx(null, localResult);
                    voiceMsg.innerText = "تم الحفظ (بالمحلل المحلي)";
                } else {
                    Swal.fire({
                        toast: true,
                        icon: "error",
                        title: "خطأ في التحليل",
                        text: error.message || "حدث خطأ غير متوقع",
                        timer: 3000
                    });
                }
            } catch (localError) {
                Swal.fire({
                    toast: true,
                    icon: "error",
                    title: "فشل التحليل",
                    text: "الرجاء المحاولة مرة أخرى أو إدخال البيانات يدوياً",
                    timer: 3000
                });
            }
        }
    };

    // دالة لتسجيل الصوت
    async function recordAudio() {
        return new Promise((resolve, reject) => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                reject(new Error('المتصفح لا يدوب تسجيل الصوت'));
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        resolve(audioBlob);
                        // إيقاف جميع المسارات الصوتية
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    setTimeout(() => {
                        if (mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                    }, 3000);
                })
                .catch(err => {
                    reject(new Error('الإذن بتسجيل الصوت مرفوض: ' + err.message));
                });
        });
    }

    window.toggleMic = () => {
        if (isListening) {
            rec.stop();
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        } else {
            rec.start();
        }
    };
} else {
    // إذا كان المتصفح لا يدعم SpeechRecognition
    document.getElementById('mic').style.display = 'none';
    Swal.fire({
        icon: 'warning',
        title: 'ميزة الصوت غير مدعومة',
        text: 'المتصفح الحالي لا يدعم التعرف على الصوت. الرجاء استخدام Chrome أو Edge.',
        timer: 5000
    });
}

// =============================================
// أدوات مساعدة
// =============================================
window.manageRecord = async (r) => {
    const { isDenied, isConfirmed } = await Swal.fire({
        title: r.description, text: `${r.amount} جنيه`,
        showDenyButton: true, showCancel: true,
        confirmButtonText: "تعديل", denyButtonText: "حذف", cancelButtonText: "غلق",
        confirmButtonColor: "var(--primary)", denyButtonColor: "var(--danger)"
    });
    if (isDenied) { 
        await remove(ref(db, `${r.type}s/${r.id}`)); 
        Swal.fire({toast:true, icon:"success", title:"تم الحذف", timer:1000, showConfirmButton:false}); 
    }
    if (isConfirmed) { 
        const { value: val } = await Swal.fire({input:"text", inputValue:r.description}); 
        if(val) await update(ref(db, `${r.type}s/${r.id}`), {description:val}); 
    }
};

window.deleteAllRecordsPrompt = async () => {
    const { value: p } = await Swal.fire({title:"أدخل كود الحذف", input:"password"});
    if(p === "521988") { 
        await remove(ref(db, "income")); 
        await remove(ref(db, "expenses")); 
        Swal.fire({icon:"success", title:"تم الحذف"}); 
    }
};

window.exportExcel = () => {
    const wb = XLSX.utils.book_new();
    const createCell = (v, s) => ({v, t: typeof v==='number'?'n':'s', s});
    const border = { 
        top:{style:"thin", color: {rgb: "000000"}}, 
        bottom:{style:"thin", color: {rgb: "000000"}}, 
        left:{style:"thin", color: {rgb: "000000"}}, 
        right:{style:"thin", color: {rgb: "000000"}} 
    };
    
    const sheet = (data, title, color, lightColor) => {
        const rows = [[
            createCell("الوصف", {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true, size:14}, border, alignment: {horizontal: "center"}}),
            createCell("المبلغ", {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true, size:14}, border, alignment: {horizontal: "center"}}),
            createCell("التاريخ", {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true, size:14}, border, alignment: {horizontal: "center"}}),
            createCell("الوقت", {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true, size:14}, border, alignment: {horizontal: "center"}})
        ]];
        
        data.forEach(r => {
            const date = new Date(r.timestamp);
            rows.push([
                createCell(r.description, {fill:{fgColor:{rgb:lightColor}}, border, font: {size: 12}}),
                createCell(r.amount, {fill:{fgColor:{rgb:lightColor}}, border, font: {size: 12, color: {rgb: r.type === 'income' ? '10B981' : 'EF4444'}}}),
                createCell(date.toLocaleDateString('ar-EG'), {fill:{fgColor:{rgb:lightColor}}, border, font: {size: 12}}),
                createCell(date.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}), {fill:{fgColor:{rgb:lightColor}}, border, font: {size: 12}})
            ]);
        });
        
        // إضافة المجموع
        const total = data.reduce((sum, r) => sum + r.amount, 0);
        rows.push([
            createCell("المجموع", {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true, size:14}, border}),
            createCell(total, {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true, size:14}, border}),
            createCell("", {fill:{fgColor:{rgb:color}}, border}),
            createCell("", {fill:{fgColor:{rgb:color}}, border})
        ]);
        
        const ws = XLSX.utils.aoa_to_sheet([]);
        const range = {s:{c:0,r:0}, e:{c:3,r:rows.length-1}};
        ws['!ref'] = XLSX.utils.encode_range(range);
        ws['!cols'] = [{wch:40}, {wch:15}, {wch:15}, {wch:10}];
        
        rows.forEach((row, r) => {
            row.forEach((cell, c) => {
                ws[XLSX.utils.encode_cell({c,r})] = cell;
            });
        });
        
        XLSX.utils.book_append_sheet(wb, ws, title);
    };

    const inc = records.filter(r=>r.type==="income");
    const exp = records.filter(r=>r.type==="expense");
    
    sheet(inc, "الوارد", "10B981", "ECFDF5");
    sheet(exp, "المصروف", "EF4444", "FEF2F2");
    
    // إضافة ورقة الملخص
    const summaryData = [
        ["الإجمالي", "المبلغ"],
        ["إجمالي الدخل", inc.reduce((s,r)=>s+r.amount,0)],
        ["إجمالي المصروفات", exp.reduce((s,r)=>s+r.amount,0)],
        ["صافي الربح/الخسارة", inc.reduce((s,r)=>s+r.amount,0) - exp.reduce((s,r)=>s+r.amount,0)]
    ];
    
    const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, ws2, "الملخص");
    
    XLSX.writeFile(wb, `التقرير_المالي_${new Date().toISOString().split('T')[0]}.xlsx`);
};
</script>
</body>
</html>
