<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿßŸÑŸä | ÿ•ŸáÿØÿßÿ° ŸÑŸÑÿ≠ÿßÿ¨ ÿ£ÿ≠ŸÖÿØ ÿ¥ÿ∑ÿß</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <!-- ÿßŸÑÿÆÿ∑Ÿàÿ∑ ŸàÿßŸÑÿ£ŸäŸÇŸàŸÜÿßÿ™ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ÿßŸÑŸÖŸÉÿ™ÿ®ÿßÿ™ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ© -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --border: #334155;
            --primary: #818cf8;
            --primary-dark: #6366f1;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { background: var(--bg); color: var(--text); padding: 15px; padding-bottom: 100px; min-height: 100vh; transition: background 0.3s, color 0.3s; }
        .container { max-width: 600px; margin: 0 auto; }

        /* --- Header --- */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 16px; border-radius: 20px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand i { font-size: 1.8rem; color: var(--primary); }
        .brand h1 { font-size: 1.4rem; font-weight: 800; margin: 0; }
        
        .action-btn { width: 42px; height: 42px; border-radius: 12px; border: none; background: var(--bg); color: var(--text); font-size: 1.1rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .action-btn:hover { background: var(--border); transform: translateY(-2px); }

        /* --- Stats --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        .stat-card { background: var(--surface); padding: 16px 10px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; }
        
        .stat-card i.bg-icon { position: absolute; bottom: -10px; right: -10px; font-size: 3.5rem; opacity: 0.05; transform: rotate(-15deg); }
        
        .stat-value { font-size: 1.2rem; font-weight: 900; margin-top: 5px; direction: ltr; font-variant-numeric: tabular-nums; }
        .stat-title { font-size: 0.85rem; color: #64748b; font-weight: 700; }

        /* --- Input Area --- */
        .input-card { background: var(--surface); padding: 20px; border-radius: 24px; box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid var(--border); transition: 0.3s; }
        
        .type-toggle { display: flex; background: var(--bg); padding: 5px; border-radius: 16px; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 12px; font-weight: 700; color: #64748b; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .toggle-btn.active.inc { background: var(--surface); color: var(--success); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .toggle-btn.active.exp { background: var(--surface); color: var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .input-group { margin-bottom: 12px; position: relative; }
        .input-group input { width: 100%; padding: 16px 20px; padding-left: 50px; border: 2px solid var(--border); border-radius: 16px; background: var(--bg); color: var(--text); font-size: 1rem; transition: 0.3s; font-weight: 600; }
        .input-group input:focus { border-color: var(--primary); background: var(--surface); }
        .input-group i { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 1.2rem; }

        .submit-btn { width: 100%; padding: 16px; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 800; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .submit-btn:active { transform: scale(0.98); }

        /* --- List & Search --- */
        .search-bar { display: none; align-items: center; background: #fff7ed; border: 1px solid #fdba74; color: #c2410c; padding: 12px 20px; border-radius: 16px; margin-bottom: 20px; animation: slideDown 0.3s ease; }
        .search-bar.active { display: flex; justify-content: space-between; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        .tx-list { display: flex; flex-direction: column; gap: 12px; }
        .tx-item { background: var(--surface); padding: 16px; border-radius: 18px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .tx-item:active { transform: scale(0.98); background: var(--bg); }
        
        .tx-icon { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; flex-shrink: 0; }
        .tx-content { flex: 1; overflow: hidden; }
        .tx-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tx-meta { font-size: 0.75rem; color: #64748b; display: flex; align-items: center; gap: 6px; }
        .tx-amount { font-weight: 800; font-size: 1.1rem; direction: ltr; }

        /* --- Voice Button --- */
        .mic-wrapper { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .mic-btn { width: 75px; height: 75px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; font-size: 1.8rem; cursor: pointer; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4); display: flex; align-items: center; justify-content: center; transition: 0.3s; position: relative; }
        
        .mic-btn::after { content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; border-radius: 50%; border: 2px solid var(--primary); opacity: 0; animation: pulse 1.5s infinite; }
        .mic-btn.listening { background: var(--danger); box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4); }
        .mic-btn.listening::after { border-color: var(--danger); opacity: 1; }

        @keyframes pulse { 0% {transform: scale(1); opacity: 0.8;} 100% {transform: scale(1.5); opacity: 0;} }

        /* --- Voice HUD --- */
        .voice-hud { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; backdrop-filter: blur(5px); }
        .voice-hud.active { display: flex; }
        .hud-waves { display: flex; gap: 5px; height: 40px; align-items: center; margin-bottom: 20px; }
        .wave { width: 6px; background: var(--success); border-radius: 10px; animation: wave 0.5s infinite ease-in-out alternate; }
        .wave:nth-child(2) { animation-delay: 0.1s; height: 50%; }
        .wave:nth-child(3) { animation-delay: 0.2s; height: 70%; }
        .wave:nth-child(4) { animation-delay: 0.3s; height: 40%; }
        @keyframes wave { 0% {height: 20%;} 100% {height: 100%;} }
        
        .hud-text { color: white; font-size: 1.5rem; font-weight: 700; max-width: 80%; line-height: 1.5; }
        .hud-sub { color: #94a3b8; margin-top: 10px; font-size: 0.9rem; }

    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <i class="fa-solid fa-wallet"></i>
            <h1>ŸÖÿµÿßÿ±ŸäŸÅŸä</h1>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="action-btn" onclick="exportExcel()" title="ÿ™ÿµÿØŸäÿ± ÿ•ŸÉÿ≥ŸäŸÑ"><i class="fa-solid fa-file-excel" style="color:#10b981"></i></button>
            <button class="action-btn" onclick="toggleTheme()" title="ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä"><i class="fa-solid fa-moon"></i></button>
        </div>
    </header>

    <!-- Search Status -->
    <div id="searchBar" class="search-bar">
        <div>
            <i class="fa-solid fa-filter"></i>&nbsp;
            ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ: <b id="searchKeyword"></b>
        </div>
        <i class="fa-solid fa-xmark" onclick="clearSearch()" style="cursor:pointer; font-size:1.2rem;"></i>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fa-solid fa-arrow-trend-up bg-icon" style="color:var(--success)"></i>
            <div class="stat-title">Ÿàÿßÿ±ÿØ</div>
            <div class="stat-value" id="valInc" style="color:var(--success)">0</div>
        </div>
        <div class="stat-card">
            <i class="fa-solid fa-arrow-trend-down bg-icon" style="color:var(--danger)"></i>
            <div class="stat-title">ŸÖÿµÿ±ŸàŸÅ</div>
            <div class="stat-value" id="valExp" style="color:var(--danger)">0</div>
        </div>
        <div class="stat-card">
            <i class="fa-solid fa-scale-balanced bg-icon" style="color:var(--primary)"></i>
            <div class="stat-title">ÿßŸÑÿµÿßŸÅŸä</div>
            <div class="stat-value" id="valBal" style="color:var(--primary)">0</div>
        </div>
    </div>

    <!-- Input Form -->
    <div class="input-card">
        <div class="type-toggle">
            <button id="btnInc" class="toggle-btn" onclick="setMode('income')">
                <i class="fa-solid fa-plus-circle"></i> ÿØÿÆŸÑ
            </button>
            <button id="btnExp" class="toggle-btn active exp" onclick="setMode('expense')">
                <i class="fa-solid fa-minus-circle"></i> ÿµÿ±ŸÅ
            </button>
        </div>

        <form onsubmit="saveTransaction(event)" id="mainForm">
            <div class="input-group">
                <input type="number" id="inpAmount" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ (ŸÉÿßŸÖÿü)" step="any" required>
                <i class="fa-solid fa-coins"></i>
            </div>
            <div class="input-group">
                <input type="text" id="inpDesc" placeholder="ÿßŸÑŸàÿµŸÅ (ÿßŸäŸá / ŸÖŸäŸÜÿü)" required>
                <i class="fa-solid fa-pen"></i>
            </div>
            <button type="submit" class="submit-btn" id="btnSubmit" style="background:var(--danger)">
                <i class="fa-solid fa-check"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©
            </button>
        </form>
    </div>

    <!-- Transactions List -->
    <div class="tx-list" id="txList">
        <!-- Items injected here -->
    </div>
</div>

<!-- Voice Button -->
<div class="mic-wrapper">
    <button class="mic-btn" id="micBtn" onclick="toggleVoice()">
        <i class="fa-solid fa-microphone"></i>
    </button>
</div>

<!-- Voice Overlay HUD -->
<div class="voice-hud" id="voiceHud">
    <div class="hud-waves">
        <div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div>
    </div>
    <div class="hud-text" id="hudText">ÿ≥ÿßŸÖÿπŸÉ...</div>
    <div class="hud-sub" id="hudSub">ŸÇŸàŸÑ "ÿµÿ±ŸÅÿ™ 50 ŸÖŸàÿßÿµŸÑÿßÿ™" ÿ£Ÿà "ÿ≠ÿ≥ÿßÿ® ÿßÿ≠ŸÖÿØ"</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÅÿßŸäÿ±ÿ®Ÿäÿ≥ ---
    const app = initializeApp({
        apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
        authDomain: "nasrapp-7a0fc.firebaseapp.com",
        databaseURL: "https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
        projectId: "nasrapp-7a0fc",
        appId: "1:826970736109:web:c1cc3c3a1008e719b193e4"
    });
    const db = getDatabase(app);

    // --- ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© ---
    let currentMode = 'expense';
    let transactions = [];
    let searchFilter = '';
    let recognition = null;

    // --- ÿπŸÜÿßÿµÿ± ÿßŸÑŸàÿßÿ¨Ÿáÿ© ---
    const UI = {
        incBtn: document.getElementById('btnInc'),
        expBtn: document.getElementById('btnExp'),
        submitBtn: document.getElementById('btnSubmit'),
        amount: document.getElementById('inpAmount'),
        desc: document.getElementById('inpDesc'),
        list: document.getElementById('txList'),
        hud: document.getElementById('voiceHud'),
        hudText: document.getElementById('hudText'),
        hudSub: document.getElementById('hudSub'),
        micBtn: document.getElementById('micBtn')
    };

    // --- ÿßŸÑŸÇÿßŸÖŸàÿ≥ ÿßŸÑŸÖÿµÿ±Ÿä ---
    const EG_DICT = {
        income: ["ÿØÿÆŸÑ", "ŸÇÿ®ÿ∂ÿ™", "ÿ¨ÿßŸÑŸä", "ÿ£ÿÆÿØÿ™", "ÿßÿÆÿØÿ™", "ÿßÿ≥ÿ™ŸÑŸÖÿ™", "ÿ™ÿ≠ŸàŸäŸÑ", "ŸÖŸÉÿ≥ÿ®", "ÿ®Ÿäÿπÿ™"],
        expense: ["ÿµÿ±ŸÅÿ™", "ÿØŸÅÿπÿ™", "ÿßÿ¥ÿ™ÿ±Ÿäÿ™", "ÿ¨ÿ®ÿ™", "ÿ≠ÿ≥ÿßÿ®", "ŸÅÿßÿ™Ÿàÿ±ÿ©", "ÿ®ŸÜÿ≤ŸäŸÜ", "ŸÖŸàÿßÿµŸÑÿßÿ™", "ÿ£ŸÉŸÑ", "ÿ¥ÿ±ÿ®"],
        numbers: {
            "ŸÜÿµ": 0.5, "ÿ±ÿ®ÿπ": 0.25, "Ÿàÿßÿ≠ÿØ": 1, "ÿßÿ™ŸÜŸäŸÜ": 2, "ÿ™ŸÑÿßÿ™ÿ©": 3, "ÿßÿ±ÿ®ÿπÿ©": 4, "ÿÆŸÖÿ≥ÿ©": 5,
            "ÿ≥ÿ™ÿ©": 6, "ÿ≥ÿ®ÿπÿ©": 7, "ÿ™ŸÖÿßŸÜŸäÿ©": 8, "ÿ™ÿ≥ÿπÿ©": 9, "ÿπÿ¥ÿ±ÿ©": 10, "ÿπÿ¥ÿ±ŸäŸÜ": 20, "ÿ™ŸÑÿßÿ™ŸäŸÜ": 30,
            "ÿßÿ±ÿ®ÿπŸäŸÜ": 40, "ÿÆŸÖÿ≥ŸäŸÜ": 50, "ÿ≥ÿ™ŸäŸÜ": 60, "ÿ≥ÿ®ÿπŸäŸÜ": 70, "ÿ™ŸÖÿßŸÜŸäŸÜ": 80, "ÿ™ÿ≥ÿπŸäŸÜ": 90,
            "ŸÖŸäÿ©": 100, "ŸÖŸäÿ™ŸäŸÜ": 200, "ÿ™ŸÑÿ™ŸÖŸäÿ©": 300, "ÿ±ÿ®ÿπŸÖŸäÿ©": 400, "ÿÆŸÖÿ≥ŸÖŸäÿ©": 500, "ÿßŸÑŸÅ": 1000
        }
    };

    // --- ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ---
    window.setMode = (mode) => {
        currentMode = mode;
        if(mode === 'income') {
            UI.incBtn.className = 'toggle-btn active inc';
            UI.expBtn.className = 'toggle-btn';
            UI.submitBtn.style.background = 'var(--success)';
            UI.submitBtn.innerHTML = '<i class="fa-solid fa-plus"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸÑ';
        } else {
            UI.incBtn.className = 'toggle-btn active exp';
            UI.expBtn.className = 'toggle-btn';
            UI.submitBtn.style.background = 'var(--danger)';
            UI.submitBtn.innerHTML = '<i class="fa-solid fa-minus"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿµÿ±ŸàŸÅ';
        }
    };

    // ÿØÿßŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ± (ÿßŸÑÿ¨ŸàŸáÿ±Ÿäÿ©)
    async function saveDataDirectly(amount, description, type) {
        if(!amount || !description) return false;
        
        try {
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏
            if(UI.hud.classList.contains('active')) {
                UI.hudText.innerText = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±...";
            }

            await push(ref(db, type === 'income' ? 'income' : 'expenses'), {
                amount: parseFloat(amount),
                description: description,
                timestamp: Date.now()
            });
            return true;
        } catch(err) {
            console.error(err);
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿÆÿ∑ÿ£ ÿπŸÑŸâ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ
            if(UI.hud.classList.contains('active')) {
                UI.hudText.innerText = "ÿÆÿ∑ÿ£! ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÜÿ™";
                UI.hudText.style.color = "#ef4444";
            }
            return false;
        }
    }

    // ÿØÿßŸÑÿ© ÿßŸÑŸÅŸàÿ±ŸÖ ÿßŸÑÿπÿßÿØŸäÿ©
    window.saveTransaction = async (e) => {
        if(e) e.preventDefault();
        const val = UI.amount.value;
        const txt = UI.desc.value.trim();
        
        if(!val || !txt) {
            return Swal.fire({icon:'warning', title:'ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿßŸÇÿµÿ©', text:'ÿßŸÉÿ™ÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ŸàÿßŸÑŸàÿµŸÅ'});
        }

        const success = await saveDataDirectly(val, txt, currentMode);
        if(success) {
            UI.amount.value = '';
            UI.desc.value = '';
            const toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 2000});
            toast.fire({icon: 'success', title: 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ'});
        } else {
            Swal.fire('ÿÆÿ∑ÿ£', 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ÿå ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™', 'error');
        }
    };

    // --- ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™ (Realtime) ---
    onValue(ref(db), (snapshot) => {
        const data = snapshot.val() || {};
        transactions = [];
        if(data.income) Object.entries(data.income).forEach(([k,v]) => transactions.push({...v, id:k, type:'income'}));
        if(data.expenses) Object.entries(data.expenses).forEach(([k,v]) => transactions.push({...v, id:k, type:'expense'}));
        
        transactions.sort((a,b) => b.timestamp - a.timestamp);
        render();
    });

    function render() {
        let viewData = transactions;
        if(searchFilter) {
            viewData = transactions.filter(t => t.description.includes(searchFilter) || t.amount.toString().includes(searchFilter));
            document.getElementById('searchBar').classList.add('active');
            document.getElementById('searchKeyword').innerText = searchFilter;
        } else {
            document.getElementById('searchBar').classList.remove('active');
        }

        const inc = transactions.filter(t=>t.type==='income').reduce((a,b)=>a+Number(b.amount),0);
        const exp = transactions.filter(t=>t.type==='expense').reduce((a,b)=>a+Number(b.amount),0);
        
        document.getElementById('valInc').innerText = inc.toLocaleString();
        document.getElementById('valExp').innerText = exp.toLocaleString();
        document.getElementById('valBal').innerText = (inc - exp).toLocaleString();

        UI.list.innerHTML = viewData.map(t => `
            <div class="tx-item" onclick="deleteItem('${t.id}', '${t.type}', '${t.description}')">
                <div class="tx-icon" style="background:${t.type==='income'?'#dcfce7':'#fee2e2'}; color:${t.type==='income'?'var(--success)':'var(--danger)'}">
                    <i class="fa-solid ${t.type==='income'?'fa-arrow-down':'fa-arrow-up'}"></i>
                </div>
                <div class="tx-content">
                    <div class="tx-title">${t.description}</div>
                    <div class="tx-meta">
                        <i class="fa-regular fa-clock"></i> ${new Date(t.timestamp).toLocaleTimeString('ar-EG', {hour:'2-digit',minute:'2-digit'})}
                    </div>
                </div>
                <div class="tx-amount" style="color:${t.type==='income'?'var(--success)':'var(--danger)'}">
                    ${Number(t.amount).toLocaleString()}
                </div>
            </div>
        `).join('');
    }

    window.deleteItem = (id, type, name) => {
        Swal.fire({title: `ÿ≠ÿ∞ŸÅ "${name}"ÿü`, icon: 'warning', showCancelButton: true, confirmButtonText: 'ŸÜÿπŸÖ', cancelButtonText: 'ŸÑÿß'}).then((res) => {
            if(res.isConfirmed) remove(ref(db, `${type==='income'?'income':'expenses'}/${id}`));
        });
    };
    
    window.clearSearch = () => { searchFilter = ''; render(); };
    window.exportExcel = () => {
        /* ŸÉŸàÿØ ÿßŸÑÿ™ÿµÿØŸäÿ± ŸÜŸÅÿ≥Ÿá ÿßŸÑÿ≥ÿßÿ®ŸÇ */
        const wb = XLSX.utils.book_new();
        const wsData = [["ÿßŸÑÿ™ÿßÿ±ŸäÿÆ", "ÿßŸÑŸÜŸàÿπ", "ÿßŸÑŸàÿµŸÅ", "ÿßŸÑŸÖÿ®ŸÑÿ∫"], ...transactions.map(t => [new Date(t.timestamp).toLocaleDateString('ar-EG'), t.type==='income'?'Ÿàÿßÿ±ÿØ':'ŸÖÿµÿ±ŸàŸÅ', t.description, t.amount])];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "ÿßŸÑŸÖÿßŸÑŸäÿ©");
        XLSX.writeFile(wb, "Finance_Report.xlsx");
    };
    window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';

    // ===============================================
    // üé§ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸàÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± (Fix Logic)
    // ===============================================
    
    async function processVoiceInput(text) {
        // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
        text = text.replace(/[Ÿ†-Ÿ©]/g, d => "Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©".indexOf(d));
        
        // ÿ£ŸàÿßŸÖÿ± ÿßŸÑŸÖÿ≥ÿ≠
        if(text.includes("ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ")) {
            handleDeleteAll();
            return;
        }

        // ÿ£ŸàÿßŸÖÿ± ÿßŸÑÿ®ÿ≠ÿ´
        if(text.startsWith("ÿßÿ®ÿ≠ÿ´ ÿπŸÜ") || text.startsWith("ÿ¥ŸàŸÅ") || text.startsWith("ÿ≠ÿ≥ÿßÿ®")) {
            searchFilter = text.replace(/ÿßÿ®ÿ≠ÿ´ ÿπŸÜ|ÿ¥ŸàŸÅ|ÿ≠ÿ≥ÿßÿ®/g, "").trim();
            render();
            finishVoice(`ÿ™ŸÖ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ: ${searchFilter}`, false);
            return;
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©
        let amount = 0;
        let desc = text;
        let type = 'expense'; // ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ŸÖÿµÿ±ŸàŸÅ

        // 1. ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ±ŸÇŸÖ ŸÖÿ®ÿßÿ¥ÿ±
        const numMatch = text.match(/(\d+(\.\d+)?)/);
        if(numMatch) {
            amount = parseFloat(numMatch[0]);
            desc = desc.replace(numMatch[0], "");
        } else {
            // 2. ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ±ŸÇŸÖ ŸÖŸÉÿ™Ÿàÿ® (ÿÆŸÖÿ≥ŸäŸÜÿå ŸÖŸäÿ©)
            for(let [word, val] of Object.entries(EG_DICT.numbers)) {
                if(text.includes(word)) {
                    amount = val;
                    desc = desc.replace(word, "");
                    break; // ŸÜÿ£ÿÆÿ∞ ÿ£ŸàŸÑ ÿ±ŸÇŸÖ ŸÜŸÑÿßŸÇŸäŸá ŸÑŸÑÿ™ÿ®ÿ≥Ÿäÿ∑
                }
            }
        }

        // 3. ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÜŸàÿπ
        let incScore = 0;
        let expScore = 0;
        EG_DICT.income.forEach(w => { if(text.includes(w)) incScore++; });
        EG_DICT.expense.forEach(w => { if(text.includes(w)) expScore++; });
        
        if(incScore > expScore) type = 'income';
        if(text.includes("ŸÖŸÜ")) type = 'income'; // ÿ¨ÿßŸÑŸä ŸÅŸÑŸàÿ≥ "ŸÖŸÜ" ŸÅŸÑÿßŸÜ
        if(text.includes("ŸÑŸÄ") || text.includes("ŸÑŸâ")) type = 'expense'; // ÿØŸÅÿπÿ™ "ŸÑŸÄ" ŸÅŸÑÿßŸÜ

        // 4. ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸàÿµŸÅ
        desc = desc.replace(/(ÿ¨ŸÜŸäŸá|ÿ¨ŸÜŸäÿ©|ÿ±ŸäÿßŸÑ|ÿØŸàŸÑÿßÿ±|Ÿäÿß|ÿπŸÖ|ÿ®ŸÇŸàŸÑŸÉ|ÿπÿ¥ÿßŸÜ|ÿßŸÑŸÑŸä|Ÿà|ŸÅŸä|ÿπŸÑŸâ)/g, "").trim();
        if(!desc) desc = type === 'income' ? "Ÿàÿßÿ±ÿØ ÿπÿßŸÖ" : "ŸÖÿµÿ±ŸàŸÅÿßÿ™";

        if(amount > 0) {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸÑŸäÿ±Ÿâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿßÿ∞ÿß ÿ≠ÿØÿ´
            UI.amount.value = amount;
            UI.desc.value = desc;
            setMode(type);

            // ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ± (ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑŸÅŸàÿ±ŸÖ ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ)
            const saved = await saveDataDirectly(amount, desc, type);
            
            if(saved) {
                finishVoice(`üëç ÿ≥ÿ¨ŸÑÿ™ ${amount} ${desc}`, true);
            } else {
                finishVoice(`‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏ÿå ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÜÿ™`, true);
            }
        } else {
            UI.hudText.innerText = "ŸÖÿ¥ ÿ≥ÿßŸÖÿπ ÿ±ŸÇŸÖ.. ŸÇŸàŸÑ ÿ™ÿßŸÜŸäÿü";
        }
    }

    // ÿØÿßŸÑÿ© ŸÑÿ•ŸÜŸáÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸàÿ™ Ÿàÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
    function finishVoice(msg, autoClose) {
        UI.hudText.innerText = msg;
        UI.hudText.style.color = msg.includes("‚ùå") ? "#ef4444" : "#fff";
        
        if(autoClose) {
            setTimeout(() => {
                UI.hud.classList.remove('active');
                UI.micBtn.classList.remove('listening');
                UI.hudText.style.color = "#fff"; // Reset color
            }, 2000);
        }
    }

    async function handleDeleteAll() {
        const {value: pass} = await Swal.fire({title:'ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±', input:'password'});
        if(pass === '521988') {
            await remove(ref(db, 'income'));
            await remove(ref(db, 'expenses'));
            finishVoice("ÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™", true);
        } else {
            finishVoice("ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿ∫ŸÑÿ∑", true);
        }
    }

    // ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ
    if(window.SpeechRecognition || window.webkitSpeechRecognition) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();
        recognition.lang = 'ar-EG';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => {
            UI.micBtn.classList.add('listening');
            UI.hud.classList.add('active');
            UI.hudText.innerText = "ÿ≥ÿßŸÖÿπŸÉ...";
            UI.hudSub.innerText = "ŸÇŸàŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫ ŸàÿßŸÑŸàÿµŸÅ (ŸÖÿ´ŸÑÿßŸã: 50 ŸÖŸàÿßÿµŸÑÿßÿ™)";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            UI.hudText.innerText = transcript;
            processVoiceInput(transcript);
        };

        recognition.onend = () => {
            // ŸÑŸà ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ™ŸÉŸÑŸÖÿ¥ ÿ£Ÿà ÿÆŸÑÿµ ŸÉŸÑÿßŸÖ ŸàŸÖŸÅŸäÿ¥ ÿπŸÖŸÑŸäÿ© ŸÖÿπÿßŸÑÿ¨ÿ© ÿ¥ÿ∫ÿßŸÑÿ©ÿå ŸÜŸÇŸÅŸÑ
            if(UI.hudText.innerText === "ÿ≥ÿßŸÖÿπŸÉ...") {
                UI.hud.classList.remove('active');
                UI.micBtn.classList.remove('listening');
            }
        };
        
        recognition.onerror = () => {
            finishVoice("ÿ≠ÿµŸÑ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿßŸäŸÉ", true);
        };

        window.toggleVoice = () => {
            if(UI.micBtn.classList.contains('listening')) recognition.stop();
            else recognition.start();
        };
    } else {
        UI.micBtn.style.display = 'none';
        alert("ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ£ŸàÿßŸÖÿ± ÿßŸÑÿµŸàÿ™Ÿäÿ©");
    }
</script>

</body>
</html>
