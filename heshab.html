<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card.income .stat-value {
            color: #10b981;
        }

        .stat-card.expense .stat-value {
            color: #ef4444;
        }

        .stat-card.balance .stat-value {
            color: #667eea;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .form-card h2 {
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 1.05em;
        }

        .input-with-mic {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .input-with-mic input,
        .input-with-mic textarea {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .input-with-mic input:focus,
        .input-with-mic textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-with-mic textarea {
            resize: vertical;
            min-height: 100px;
        }

        .mic-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .mic-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .mic-btn.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .readonly-field {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-income {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-income:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-expense {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-expense:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .search-section h2 {
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            font-size: 1.8em;
        }

        .search-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-search {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .export-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .records-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .records-section h2 {
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            font-size: 1.8em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 25px;
            border: none;
            background: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .records-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .record-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-right: 5px solid #667eea;
            transition: all 0.3s;
        }

        .record-item:hover {
            background: #f3f4f6;
            transform: translateX(-5px);
        }

        .record-item.income {
            border-right-color: #10b981;
        }

        .record-item.expense {
            border-right-color: #ef4444;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .record-amount {
            font-size: 1.5em;
            font-weight: bold;
        }

        .record-amount.income {
            color: #10b981;
        }

        .record-amount.expense {
            color: #ef4444;
        }

        .record-date {
            color: #666;
            font-size: 0.95em;
        }

        .record-details {
            color: #555;
            margin-top: 10px;
            line-height: 1.6;
        }

        .record-person {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .voice-status {
            font-size: 0.85em;
            color: #667eea;
            margin-top: 5px;
            min-height: 20px;
            font-weight: 500;
        }

        .voice-status.listening {
            color: #ef4444;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .search-results-info {
            background: #f0f4ff;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .search-results-info strong {
            color: #667eea;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .stat-value {
                font-size: 1.8em;
            }

            .search-controls {
                grid-template-columns: 1fr;
            }

            .export-controls {
                flex-direction: column;
            }

            .btn-export, .btn-search {
                width: 100%;
            }
        }

        .currency {
            font-size: 0.7em;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“Š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
            <p style="color: #666; margin-top: 10px; font-size: 1.1em;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµØ¯ÙŠØ± ğŸ”ğŸ“¥</p>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card income">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
                <div class="stat-value" id="totalIncome">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
                <div style="color: #666; margin-top: 5px;" id="incomeCount">0 Ø¹Ù…Ù„ÙŠØ©</div>
            </div>
            <div class="stat-card expense">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                <div class="stat-value" id="totalExpense">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
                <div style="color: #666; margin-top: 5px;" id="expenseCount">0 Ø¹Ù…Ù„ÙŠØ©</div>
            </div>
            <div class="stat-card balance">
                <h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                <div class="stat-value" id="balance">0 <span class="currency">Ø¬Ù†ÙŠÙ‡</span></div>
                <div style="color: #666; margin-top: 5px;">Ø§Ù„ÙØ±Ù‚</div>
            </div>
        </div>

        <!-- Forms -->
        <div class="main-content">
            <!-- Income Form -->
            <div class="form-card">
                <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯</h2>
                <form id="incomeForm">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                        <div class="input-with-mic">
                            <input type="number" id="incomeAmount" step="0.01" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ø¶ØºØ· Ø§Ù„Ù…ÙŠÙƒØ±ÙÙˆÙ†">
                            <button type="button" class="mic-btn" id="micIncomeAmount">ğŸ¤</button>
                        </div>
                        <div class="voice-status" id="statusIncomeAmount"></div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³Ù„Ù… *</label>
                        <div class="input-with-mic">
                            <input type="text" id="incomePerson" required placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø£Ùˆ Ø§Ø¶ØºØ· Ø§Ù„Ù…ÙŠÙƒØ±ÙÙˆÙ†">
                            <button type="button" class="mic-btn" id="micIncomePerson">ğŸ¤</button>
                        </div>
                        <div class="voice-status" id="statusIncomePerson"></div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
                        <input type="text" id="incomeDateTime" class="readonly-field" readonly>
                    </div>
                    <button type="submit" class="btn btn-income">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯</button>
                </form>
            </div>

            <!-- Expense Form -->
            <div class="form-card">
                <h2>â– Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h2>
                <form id="expenseForm">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                        <div class="input-with-mic">
                            <input type="number" id="expenseAmount" step="0.01" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ø¶ØºØ· Ø§Ù„Ù…ÙŠÙƒØ±ÙÙˆÙ†">
                            <button type="button" class="mic-btn" id="micExpenseAmount">ğŸ¤</button>
                        </div>
                        <div class="voice-status" id="statusExpenseAmount"></div>
                    </div>
                    <div class="form-group">
                        <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ *</label>
                        <div class="input-with-mic">
                            <textarea id="expenseDetails" required placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ø§Ø¶ØºØ· Ø§Ù„Ù…ÙŠÙƒØ±ÙÙˆÙ†..."></textarea>
                            <button type="button" class="mic-btn" id="micExpenseDetails">ğŸ¤</button>
                        </div>
                        <div class="voice-status" id="statusExpenseDetails"></div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
                        <input type="text" id="expenseDateTime" class="readonly-field" readonly>
                    </div>
                    <button type="submit" class="btn btn-expense">ğŸ’¸ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                </form>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</h2>
            <div class="search-controls">
                <input type="number" id="searchAmount" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù„Øº...">
                <input type="text" id="searchPerson" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ...">
                <input type="text" id="searchDetails" class="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„...">
                <input type="date" id="searchDate" class="search-input">
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-search" onclick="performSearch()">ğŸ” Ø¨Ø­Ø«</button>
                <button class="btn-search" onclick="clearSearch()" style="background: linear-gradient(135deg, #6b7280, #4b5563);">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>
            </div>
            <div id="searchResultsInfo" style="display: none; margin-top: 15px;"></div>
        </div>

        <!-- Export Section -->
        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px;">
            <h2 style="color: #333; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; font-size: 1.8em;">ğŸ“¥ Ø§Ù„ØªØµØ¯ÙŠØ±</h2>
            <div class="export-controls">
                <button class="btn-export" onclick="exportToExcel('all')">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ Excel</button>
                <button class="btn-export" onclick="exportToExcel('income')" style="background: linear-gradient(135deg, #10b981, #059669);">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª</button>
                <button class="btn-export" onclick="exportToExcel('expense')" style="background: linear-gradient(135deg, #ef4444, #dc2626);">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                <button class="btn-export" onclick="exportSearchResults()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ“Š ØªØµØ¯ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</button>
            </div>
        </div>

        <!-- Records Section -->
        <div class="records-section">
            <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <div class="tabs">
                <button class="tab active" data-tab="all">Ø§Ù„ÙƒÙ„</button>
                <button class="tab" data-tab="income">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</button>
                <button class="tab" data-tab="expense">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
            </div>
            <div class="records-list" id="recordsList">
                <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
            authDomain: "nasrapp-7a0fc.firebaseapp.com",
            projectId: "nasrapp-7a0fc",
            storageBucket: "nasrapp-7a0fc.firebasestorage.app",
            messagingSenderId: "826970736109",
            appId: "1:826970736109:web:c1cc3c3a1008e719b193e4",
            measurementId: "G-BHP6J4K9VN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Collections
        const incomeCollection = collection(db, 'income');
        const expenseCollection = collection(db, 'expenses');

        // Global Variables
        let currentTab = 'all';
        let allRecords = [];
        let searchResults = [];
        let isSearching = false;

        // Voice Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ar-EG';
            recognition.continuous = false;
            recognition.interimResults = false;
        }

        // Voice Input Function
        function startVoiceInput(inputId, statusId, isNumber = false) {
            if (!recognition) {
                alert('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø£Ùˆ Edge');
                return;
            }

            const inputElement = document.getElementById(inputId);
            const statusElement = document.getElementById(statusId);
            const micBtn = document.getElementById('mic' + inputId.charAt(0).toUpperCase() + inputId.slice(1));

            // Start recognition
            recognition.start();
            micBtn.classList.add('recording');
            statusElement.textContent = 'ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†';
            statusElement.classList.add('listening');

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                
                if (isNumber) {
                    const convertedNumber = convertArabicToEnglishNumbers(transcript);
                    const numberValue = extractNumber(convertedNumber);
                    if (numberValue) {
                        inputElement.value = numberValue;
                        statusElement.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: ' + numberValue;
                    } else {
                        inputElement.value = transcript;
                        statusElement.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: ' + transcript;
                    }
                } else {
                    inputElement.value = transcript;
                    statusElement.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­';
                }
                
                setTimeout(() => {
                    statusElement.textContent = '';
                    statusElement.classList.remove('listening');
                }, 3000);
            };

            recognition.onerror = (event) => {
                micBtn.classList.remove('recording');
                statusElement.classList.remove('listening');
                
                if (event.error === 'no-speech') {
                    statusElement.textContent = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ØµÙˆØª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                } else if (event.error === 'not-allowed') {
                    statusElement.textContent = 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙÙˆÙ†';
                } else {
                    statusElement.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª';
                }
                
                setTimeout(() => {
                    statusElement.textContent = '';
                }, 3000);
            };

            recognition.onend = () => {
                micBtn.classList.remove('recording');
                statusElement.classList.remove('listening');
            };
        }

        // Convert Arabic numbers to English
        function convertArabicToEnglishNumbers(str) {
            const arabicNumbers = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            
            let result = str;
            for (let i = 0; i < 10; i++) {
                result = result.replace(new RegExp(arabicNumbers[i], 'g'), englishNumbers[i]);
            }
            return result;
        }

        // Extract number from text
        function extractNumber(text) {
            const numberMatch = text.match(/[\d.]+/);
            if (numberMatch) {
                return numberMatch[0];
            }
            
            const wordNumbers = {
                'ØµÙØ±': '0', 'ÙˆØ§Ø­Ø¯': '1', 'Ø§Ø«Ù†ÙŠÙ†': '2', 'Ø§ØªÙ†ÙŠÙ†': '2', 'Ø«Ù„Ø§Ø«Ø©': '3', 'ØªÙ„Ø§ØªØ©': '3',
                'Ø£Ø±Ø¨Ø¹Ø©': '4', 'Ø§Ø±Ø¨Ø¹Ø©': '4', 'Ø®Ù…Ø³Ø©': '5', 'Ø³ØªØ©': '6', 'Ø³Ø¨Ø¹Ø©': '7',
                'Ø«Ù…Ø§Ù†ÙŠØ©': '8', 'ØªØ³Ø¹Ø©': '9', 'Ø¹Ø´Ø±Ø©': '10', 'Ø¹Ø´Ø±': '10',
                'Ø¹Ø´Ø±ÙŠÙ†': '20', 'Ø«Ù„Ø§Ø«ÙŠÙ†': '30', 'Ø£Ø±Ø¨Ø¹ÙŠÙ†': '40', 'Ø§Ø±Ø¨Ø¹ÙŠÙ†': '40',
                'Ø®Ù…Ø³ÙŠÙ†': '50', 'Ø³ØªÙŠÙ†': '60', 'Ø³Ø¨Ø¹ÙŠÙ†': '70', 'Ø«Ù…Ø§Ù†ÙŠÙ†': '80', 'ØªØ³Ø¹ÙŠÙ†': '90',
                'Ù…ÙŠØ©': '100', 'Ù…Ø§Ø¦Ø©': '100', 'Ù…ÙŠØªÙŠÙ†': '200', 'Ù…Ø¦ØªÙŠÙ†': '200',
                'ØªÙ„ØªÙ…ÙŠØ©': '300', 'Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©': '300', 'Ø§Ø±Ø¨Ø¹Ù…ÙŠØ©': '400', 'Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©': '400',
                'Ø®Ù…Ø³Ù…ÙŠØ©': '500', 'Ø®Ù…Ø³Ù…Ø§Ø¦Ø©': '500', 'Ø³ØªÙ…ÙŠØ©': '600', 'Ø³ØªÙ…Ø§Ø¦Ø©': '600',
                'Ø³Ø¨Ø¹Ù…ÙŠØ©': '700', 'Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©': '700', 'ØªÙ…Ù†Ù…ÙŠØ©': '800', 'Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©': '800',
                'ØªØ³Ø¹Ù…ÙŠØ©': '900', 'ØªØ³Ø¹Ù…Ø§Ø¦Ø©': '900', 'Ø£Ù„Ù': '1000', 'Ø§Ù„Ù': '1000'
            };
            
            for (const [word, number] of Object.entries(wordNumbers)) {
                if (text.includes(word)) {
                    return number;
                }
            }
            
            return null;
        }

        // Mic Button Event Listeners
        document.getElementById('micIncomeAmount').addEventListener('click', () => {
            startVoiceInput('incomeAmount', 'statusIncomeAmount', true);
        });

        document.getElementById('micIncomePerson').addEventListener('click', () => {
            startVoiceInput('incomePerson', 'statusIncomePerson', false);
        });

        document.getElementById('micExpenseAmount').addEventListener('click', () => {
            startVoiceInput('expenseAmount', 'statusExpenseAmount', true);
        });

        document.getElementById('micExpenseDetails').addEventListener('click', () => {
            startVoiceInput('expenseDetails', 'statusExpenseDetails', false);
        });

        // Format Date and Time
        function formatDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            return now.toLocaleDateString('ar-EG', options);
        }

        // Update DateTime Fields
        function updateDateTimeFields() {
            const dateTime = formatDateTime();
            document.getElementById('incomeDateTime').value = dateTime;
            document.getElementById('expenseDateTime').value = dateTime;
        }

        // Update every second
        setInterval(updateDateTimeFields, 1000);
        updateDateTimeFields();

        // Add Income
        document.getElementById('incomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const person = document.getElementById('incomePerson').value.trim();
            const dateTime = document.getElementById('incomeDateTime').value;
            
            try {
                await addDoc(incomeCollection, {
                    amount: amount,
                    person: person,
                    dateTime: dateTime,
                    timestamp: new Date().getTime(),
                    type: 'income'
                });
                
                document.getElementById('incomeForm').reset();
                updateDateTimeFields();
                
                const btn = e.target.querySelector('.btn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (error) {
                console.error('Error adding income:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº');
            }
        });

        // Add Expense
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const details = document.getElementById('expenseDetails').value.trim();
            const dateTime = document.getElementById('expenseDateTime').value;
            
            try {
                await addDoc(expenseCollection, {
                    amount: amount,
                    details: details,
                    dateTime: dateTime,
                    timestamp: new Date().getTime(),
                    type: 'expense'
                });
                
                document.getElementById('expenseForm').reset();
                updateDateTimeFields();
                
                const btn = e.target.querySelector('.btn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (error) {
                console.error('Error adding expense:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ');
            }
        });

        // Load and Display Records
        async function loadRecords() {
            try {
                const incomeSnapshot = await getDocs(query(incomeCollection, orderBy('timestamp', 'desc')));
                const expenseSnapshot = await getDocs(query(expenseCollection, orderBy('timestamp', 'desc')));
                
                allRecords = [];
                
                incomeSnapshot.forEach((doc) => {
                    allRecords.push({
                        id: doc.id,
                        ...doc.data(),
                        collectionType: 'income'
                    });
                });
                
                expenseSnapshot.forEach((doc) => {
                    allRecords.push({
                        id: doc.id,
                        ...doc.data(),
                        collectionType: 'expense'
                    });
                });
                
                allRecords.sort((a, b) => b.timestamp - a.timestamp);
                
                displayRecords();
                updateStatistics();
            } catch (error) {
                console.error('Error loading records:', error);
            }
        }

        // Perform Search
        window.performSearch = function() {
            const searchAmount = document.getElementById('searchAmount').value;
            const searchPerson = document.getElementById('searchPerson').value.toLowerCase().trim();
            const searchDetails = document.getElementById('searchDetails').value.toLowerCase().trim();
            const searchDate = document.getElementById('searchDate').value;

            searchResults = allRecords.filter(record => {
                let matches = true;

                if (searchAmount) {
                    matches = matches && record.amount === parseFloat(searchAmount);
                }

                if (searchPerson) {
                    const person = record.person || '';
                    matches = matches && person.toLowerCase().includes(searchPerson);
                }

                if (searchDetails) {
                    const details = record.details || '';
                    matches = matches && details.toLowerCase().includes(searchDetails);
                }

                if (searchDate) {
                    const recordDate = record.dateTime.split(' ')[0];
                    matches = matches && recordDate.includes(searchDate);
                }

                return matches;
            });

            isSearching = true;
            displayRecords();

            const resultsInfo = document.getElementById('searchResultsInfo');
            resultsInfo.style.display = 'block';
            resultsInfo.innerHTML = `<strong>âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${searchResults.length} Ù†ØªÙŠØ¬Ø©</strong>`;
        };

        // Clear Search
        window.clearSearch = function() {
            document.getElementById('searchAmount').value = '';
            document.getElementById('searchPerson').value = '';
            document.getElementById('searchDetails').value = '';
            document.getElementById('searchDate').value = '';
            document.getElementById('searchResultsInfo').style.display = 'none';
            isSearching = false;
            displayRecords();
        };

        // Display Records
        function displayRecords() {
            const recordsList = document.getElementById('recordsList');
            
            let filteredRecords = isSearching ? searchResults : allRecords;
            if (!isSearching && currentTab !== 'all') {
                filteredRecords = allRecords.filter(r => r.type === currentTab);
            }
            
            if (filteredRecords.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <h3>${isSearching ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø«' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯'}</h3>
                        <p>${isSearching ? 'Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ø£Ø®Ø±Ù‰' : 'Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯ Ø£Ùˆ Ù…ØµØ±ÙˆÙ'}</p>
                    </div>
                `;
                return;
            }
            
            recordsList.innerHTML = filteredRecords.map(record => {
                if (record.type === 'income') {
                    return `
                        <div class="record-item income">
                            <div class="record-header">
                                <div class="record-amount income">+${record.amount.toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡</div>
                                <div>
                                    <div class="record-date">ğŸ“… ${record.dateTime}</div>
                                    <button class="delete-btn" onclick="deleteRecord('${record.id}', 'income')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                                </div>
                            </div>
                            <div class="record-person">ğŸ‘¤ ${record.person}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="record-item expense">
                            <div class="record-header">
                                <div class="record-amount expense">-${record.amount.toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡</div>
                                <div>
                                    <div class="record-date">ğŸ“… ${record.dateTime}</div>
                                    <button class="delete-btn" onclick="deleteRecord('${record.id}', 'expense')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                                </div>
                            </div>
                            <div class="record-details">ğŸ“ ${record.details}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Update Statistics
        function updateStatistics() {
            const incomeRecords = allRecords.filter(r => r.type === 'income');
            const expenseRecords = allRecords.filter(r => r.type === 'expense');
            
            const totalIncome = incomeRecords.reduce((sum, r) => sum + r.amount, 0);
            const totalExpense = expenseRecords.reduce((sum, r) => sum + r.amount, 0);
            const balance = totalIncome - totalExpense;
            
            document.getElementById('totalIncome').innerHTML = `${totalIncome.toLocaleString('ar-EG')} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;
            document.getElementById('totalExpense').innerHTML = `${totalExpense.toLocaleString('ar-EG')} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;
            document.getElementById('balance').innerHTML = `${balance.toLocaleString('ar-EG')} <span class="currency">Ø¬Ù†ÙŠÙ‡</span>`;
            
            document.getElementById('incomeCount').textContent = `${incomeRecords.length} Ø¹Ù…Ù„ÙŠØ©`;
            document.getElementById('expenseCount').textContent = `${expenseRecords.length} Ø¹Ù…Ù„ÙŠØ©`;
        }

        // Delete Record
        window.deleteRecord = async function(recordId, type) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) {
                return;
            }
            
            try {
                const collectionRef = type === 'income' ? incomeCollection : expenseCollection;
                await deleteDoc(doc(collectionRef, recordId));
                await loadRecords();
            } catch (error) {
                console.error('Error deleting record:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
            }
        };

        // Export to Excel
        window.exportToExcel = function(type) {
            let recordsToExport = allRecords;

            if (type === 'income') {
                recordsToExport = allRecords.filter(r => r.type === 'income');
            } else if (type === 'expense') {
                recordsToExport = allRecords.filter(r => r.type === 'expense');
            }

            if (recordsToExport.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // Prepare data for worksheet
            const wsData = [];
            
            // Add title
            wsData.push(['Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª - ØªÙ‚Ø±ÙŠØ± ' + (type === 'income' ? 'Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©' : type === 'expense' ? 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' : 'Ø§Ù„ÙƒÙ„')]);
            wsData.push([]);
            
            // Add headers
            if (type === 'income' || type === 'all') {
                wsData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„Ù†ÙˆØ¹']);
                recordsToExport.filter(r => r.type === 'income').forEach(record => {
                    wsData.push([record.dateTime, record.person, record.amount, 'Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯']);
                });
                
                // Add totals for income
                if (type === 'income') {
                    const totalIncome = recordsToExport.reduce((sum, r) => sum + r.amount, 0);
                    wsData.push([]);
                    wsData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙˆØ§Ø±Ø¯Ø©', '', totalIncome, '']);
                }
            }
            
            if (type === 'expense' || type === 'all') {
                if (type === 'all' && recordsToExport.filter(r => r.type === 'income').length > 0) {
                    wsData.push([]);
                    wsData.push([]);
                }
                wsData.push(['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„Ù†ÙˆØ¹']);
                recordsToExport.filter(r => r.type === 'expense').forEach(record => {
                    wsData.push([record.dateTime, record.details, record.amount, 'Ù…ØµØ±ÙˆÙ']);
                });
                
                // Add totals for expense
                const totalExpense = recordsToExport.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
                wsData.push([]);
                wsData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', '', totalExpense, '']);
            }
            
            if (type === 'all') {
                const totalIncome = recordsToExport.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0);
                const totalExpense = recordsToExport.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
                const balance = totalIncome - totalExpense;
                wsData.push([]);
                wsData.push(['Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', '', balance, '']);
            }
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Apply styling
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = {c: C, r: R};
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (!ws[cell_ref]) continue;
                    
                    ws[cell_ref].s = {
                        font: { bold: R <= 1 || R === range.e.r, color: { rgb: 'FFFFFF' } },
                        fill: {
                            fgColor: { rgb: R === 0 ? '667eea' : R === 1 ? 'FFFFFF' : (wsData[R] && wsData[R][3] === 'Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯') ? '10b981' : (wsData[R] && wsData[R][3] === 'Ù…ØµØ±ÙˆÙ') ? 'ef4444' : 'f0f0f0' }
                        },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        }
                    };
                }
            }
            
            // Set column widths
            ws['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 15 }, { wch: 15 }];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            XLSX.writeFile(wb, `Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª_${new Date().toLocaleDateString('ar-EG')}.xlsx`);
        };

        // Export Search Results
        window.exportSearchResults = function() {
            if (searchResults.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const wb = XLSX.utils.book_new();
            const wsData = [];
            
            wsData.push(['Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª - Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«']);
            wsData.push([]);
            wsData.push(['Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙƒØ§Ù…Ù„', 'Ø§Ù„ØªÙØ§ØµÙŠÙ„/Ø§Ù„Ø´Ø®Øµ', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„Ù†ÙˆØ¹']);
            
            searchResults.forEach(record => {
                wsData.push([
                    record.dateTime,
                    record.type === 'income' ? record.person : record.details,
                    record.amount,
                    record.type === 'income' ? 'Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯' : 'Ù…ØµØ±ÙˆÙ'
                ]);
            });
            
            wsData.push([]);
            const totalAmount = searchResults.reduce((sum, r) => sum + r.amount, 0);
            wsData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬', '', totalAmount, '']);
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Apply styling
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = {c: C, r: R};
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (!ws[cell_ref]) continue;
                    
                    ws[cell_ref].s = {
                        font: { bold: R <= 1 || R === range.e.r, color: { rgb: 'FFFFFF' } },
                        fill: {
                            fgColor: { rgb: R === 0 ? '8b5cf6' : R === 1 || R === range.e.r ? 'FFFFFF' : (wsData[R] && wsData[R][3] === 'Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯') ? '10b981' : (wsData[R] && wsData[R][3] === 'Ù…ØµØ±ÙˆÙ') ? 'ef4444' : 'f0f0f0' }
                        },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        }
                    };
                }
            }
            
            ws['!cols'] = [{ wch: 25 }, { wch: 25 }, { wch: 15 }, { wch: 15 }];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«');
            XLSX.writeFile(wb, `Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø¨Ø­Ø«_${new Date().toLocaleDateString('ar-EG')}.xlsx`);
        };

        // Tab Switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.getAttribute('data-tab');
                if (!isSearching) {
                    displayRecords();
                }
            });
        });

        // Real-time Updates
        onSnapshot(query(incomeCollection, orderBy('timestamp', 'desc')), () => {
            loadRecords();
        });

        onSnapshot(query(expenseCollection, orderBy('timestamp', 'desc')), () => {
            loadRecords();
        });

        // Initial Load
        loadRecords();
    </script>
</body>
</html>
