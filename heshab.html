<!DOCTYPE html><html lang="ar" dir="rtl"><head>
<meta charset="UTF-8">
<title>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ V4 | Ø­Ø§Ø¬ Ø£Ø­Ù…Ø¯ Ø´Ø·Ø§</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{--p:#6366f1;--s:#10b981;--d:#ef4444;--bg:#f1f5f9;--sf:#fff;--t:#1e293b;}
[data-theme="dark"]{--bg:#0f172a;--sf:#1e293b;--t:#f8fafc;}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif;}
body{background:var(--bg);color:var(--t);padding:15px;min-height:100vh;padding-bottom:110px;}
.container{max-width:600px;margin:auto;}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;background:var(--sf);
padding:15px;border-radius:16px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);animation:fade 0.6s;}
@keyframes fade{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:none;}}
.btn-icon{background:#f1f5f9;border:none;width:40px;height:40px;border-radius:10px;font-size:1.2rem;cursor:pointer;}

/* Stats */
.stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:20px;}
.stat-card{background:var(--sf);padding:15px 5px;border-radius:15px;text-align:center;position:relative;
overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.05);animation:fade 0.6s;}
.stat-bg-icon{position:absolute;bottom:-5px;left:-5px;font-size:3rem;opacity:.1;}
.stat-val{font-size:1.1rem;font-weight:800;direction:ltr;}
.stat-label{font-size:.8rem;color:#64748b;font-weight:700}

/* Inputs */
.input-box{background:var(--sf);padding:20px;border-radius:20px;box-shadow:0 5px 15px rgba(0,0,0,0.05);
margin-bottom:20px;animation:fade 0.6s;}
.tabs{display:flex;gap:10px;margin-bottom:15px;}
.tab{flex:1;padding:12px;border-radius:12px;background:#f8fafc;color:#94a3b8;border:2px solid transparent;
cursor:pointer;display:flex;flex-direction:column;align-items:center;font-weight:800;gap:6px;transition:.2s;}
.tab.active.inc{background:#dcfce7;color:#166534;border-color:#166534;}
.tab.active.exp{background:#fee2e2;color:#991b1b;border-color:#991b1b;}
.input-group{position:relative;margin-bottom:12px;}
.input-group i{position:absolute;right:15px;top:50%;transform:translateY(-50%);color:#94a3b8;}
.input-group input{width:100%;padding:14px 45px 14px 15px;border:2px solid #e2e8f0;border-radius:12px;
background:var(--bg);color:var(--t);}
.input-group input:focus{border-color:var(--p);background:var(--sf);}
.save-btn{width:100%;padding:15px;background:var(--p);border:none;border-radius:12px;color:#fff;font-weight:800;font-size:1.1rem;cursor:pointer}

/* Records */
.record{background:var(--sf);padding:12px;border-radius:14px;display:flex;gap:15px;margin-bottom:10px;
box-shadow:0 2px 4px rgba(0,0,0,0.03);cursor:pointer;animation:fade 0.5s;}
.rec-icon{width:45px;height:45px;border-radius:12px;display:flex;justify-content:center;align-items:center;font-size:1.2rem;}
.rec-icon.inc{background:#dcfce7;color:#166534;}
.rec-icon.exp{background:#fee2e2;color:#991b1b;}
.rec-info{flex:1;}
.rec-info h4{font-size:1rem;margin-bottom:3px;}
.rec-date{font-size:.75rem;color:#64748b;display:flex;gap:4px;}

/* Mic */
.mic-btn{position:fixed;bottom:25px;left:50%;transform:translateX(-50%);width:80px;height:80px;border-radius:50%;
background:linear-gradient(135deg,#f43f5e,#e11d48);color:white;border:6px solid white;box-shadow:0 15px 30px rgba(0,0,0,0.3);
font-size:2rem;cursor:pointer;z-index:100;display:flex;justify-content:center;align-items:center;transition:.3s;}
.mic-btn.listening{background:#10b981;transform:translateX(-50%) scale(1.15);}

.voice-feedback{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);
color:white;padding:25px 40px;border-radius:25px;z-index:1000;display:none;text-align:center;font-size:1.3rem;}
.voice-feedback.active{display:block;}
</style>
</head>

<body>
<div class="container">

<div class="header">
<div style="display:flex;align-items:center;gap:10px;">
<i class="fa-solid fa-sack-dollar" style="color:var(--p);font-size:1.5rem"></i>
<h2 style="font-weight:800;">Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙŠØ§ Ø­Ø§Ø¬ Ø£Ø­Ù…Ø¯</h2>
</div>
<div style="display:flex;gap:5px;">
<button class="btn-icon" onclick="exportExcel()"><i class="fa-solid fa-file-excel" style="color:#10b981"></i></button>
<button class="btn-icon" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
</div>
</div>

<div class="stats-grid">
<div class="stat-card"><i class="fa-solid fa-hand-holding-dollar stat-bg-icon"></i>
<div class="stat-label">ÙˆØ§Ø±Ø¯</div><div id="totalInc" class="stat-val" style="color:var(--s)">0</div></div>
<div class="stat-card"><i class="fa-solid fa-money-bill-transfer stat-bg-icon"></i>
<div class="stat-label">Ù…ØµØ±ÙˆÙ</div><div id="totalExp" class="stat-val" style="color:var(--d)">0</div></div>
<div class="stat-card"><i class="fa-solid fa-scale-balanced stat-bg-icon"></i>
<div class="stat-label">Ø§Ù„ØµØ§ÙÙŠ</div><div id="netBal" class="stat-val" style="color:var(--p)">0</div></div>
</div>

<div class="input-box">
<div class="tabs">
<button id="btnInc" class="tab active inc" onclick="setMode('income')"><i class="fa-solid fa-circle-arrow-down"></i>Ø¯Ø®Ù„</button>
<button id="btnExp" class="tab" onclick="setMode('expense')"><i class="fa-solid fa-circle-arrow-up"></i>Ø®Ø±Ø¬</button>
</div>

<form onsubmit="saveTx(event)" id="form">
<div class="input-group"><i class="fa-solid fa-coins"></i>
<input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" required></div>
<div class="input-group"><i class="fa-solid fa-pen-to-square"></i>
<input type="text" id="desc" placeholder="Ø§Ù„ÙˆØµÙ" required></div>
<button class="save-btn" id="submitBtn"><i class="fa-solid fa-check"></i> Ø­ÙØ¸</button>
</form>
</div>

<div id="list"></div>
</div>

<div class="voice-feedback" id="voiceFeedback">
<div id="voiceText">Ø¨ÙŠØ³ØªÙ…Ø¹ Ù„ÙŠÙƒ ÙŠØ§ Ø­Ø§Ø¬â€¦</div>
</div>

<button class="mic-btn" id="mic" onclick="toggleMic()"><i class="fa-solid fa-microphone"></i></button>

<script type="module">
/* ========= Firebase ========= */
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import{getDatabase,ref,push,onValue,remove,update}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app=initializeApp({
apiKey:"AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
authDomain:"nasrapp-7a0fc.firebaseapp.com",
databaseURL:"https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
projectId:"nasrapp-7a0fc",
appId:"1:826970736109:web:c1cc3c3a1008e719b193e4"
});
const db=getDatabase(app);

/* ========= MODE ========= */
let mode="income";
let records=[];
window.setMode=m=>{
mode=m;
document.getElementById("btnInc").className=m==="income"?"tab active inc":"tab";
document.getElementById("btnExp").className=m==="expense"?"tab active exp":"tab";
document.getElementById("submitBtn").style.background=m==="income"?"var(--p)":"var(--d)";
};

/* ========= SAVE ========= */
window.saveTx=async e=>{
if(e)e.preventDefault();
let amount=parseFloat(amount.value),desc=document.getElementById("desc").value.trim();
if(!amount||!desc)return;
await push(ref(db,"transactions"),{
type:mode,amount,description:desc,timestamp:Date.now()
});
form.reset();
Swal.fire({toast:true,icon:'success',title:'ØªÙ… Ø§Ù„Ø­ÙØ¸',position:'top',showConfirmButton:false,timer:1500});
};

/* ========= LOAD ========= */
onValue(ref(db,"transactions"),snap=>{
records=[];
let d=snap.val(); if(d)records=Object.entries(d).map(([id,v])=>({...v,id}));
records.sort((a,b)=>b.timestamp-a.timestamp);
render();
});

/* ========= RENDER ========= */
function render(){
let inc=0,exp=0;
records.forEach(r=>r.type==="income"?inc+=+r.amount:exp+=+r.amount);
totalInc.innerText=inc.toLocaleString();
totalExp.innerText=exp.toLocaleString();
netBal.innerText=(inc-exp).toLocaleString();

list.innerHTML="";
records.slice(0,50).forEach(r=>{
let d=new Date(r.timestamp),
div=document.createElement("div");
div.className="record"; div.onclick=()=>manageRecord(r);
div.innerHTML=`
<div class="rec-icon ${r.type==="income"?"inc":"exp"}">
<i class="fa-solid ${r.type==="income"?"fa-arrow-down":"fa-arrow-up"}"></i></div>
<div class="rec-info">
<h4>${r.description}</h4>
<div class="rec-date"><i class="fa-regular fa-clock"></i>
${d.toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'})} - ${d.toLocaleDateString('ar-EG')}</div>
</div>
<div class="rec-amt" style="color:${r.type==="income"?"var(--s)":"var(--d)"}">
${r.type==="income"?"+":"-"}${(+r.amount).toLocaleString()}</div>`;
list.appendChild(div);
});
}

/* ========= Manage ========= */
window.manageRecord=async r=>{
let x=await Swal.fire({
title:r.description,text:r.amount,icon:r.type==='income'?'success':'error',
showCancelButton:true,showDenyButton:true,
confirmButtonText:'âœï¸ ØªØ¹Ø¯ÙŠÙ„',denyButtonText:'ğŸ—‘ï¸ Ø­Ø°Ù',cancelButtonText:'Ø¥ØºÙ„Ø§Ù‚'
});
if(x.isDenied){
await remove(ref(db,"transactions/"+r.id));
Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù','','success');
}
};

/* ========= EXPORT ========= */
window.exportExcel=()=>{
let wb=XLSX.utils.book_new(),
data=[["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„ÙˆÙ‚Øª","Ø§Ù„Ù†ÙˆØ¹","Ø§Ù„ÙˆØµÙ","Ø§Ù„Ù…Ø¨Ù„Øº"]];
records.forEach(r=>{
let d=new Date(r.timestamp);
data.push([d.toLocaleDateString('ar-EG'),d.toLocaleTimeString('ar-EG'),
r.type==="income"?"ÙˆØ§Ø±Ø¯":"Ù…ØµØ±ÙˆÙ",r.description,+r.amount]);
});
let ws=XLSX.utils.aoa_to_sheet(data);
XLSX.utils.book_append_sheet(wb,ws,"Report");
XLSX.writeFile(wb,"ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø­Ø§Ø¬_Ø§Ø­Ù…Ø¯.xlsx");
};

/* ========= THEME ========= */
window.toggleTheme=()=>document.body.dataset.theme=document.body.dataset.theme==='dark'?'light':'dark';

/* ========= Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙˆØªÙŠ Fuzzy + Auto-learning ========= */
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
const GEMINI_KEY="AIzaSyBx3b5hNfo8yXTJMRSa4F6PoROkYNNMDac";

/* Simple fuzzy */
function fuzzyMatch(a,b){
a=a.toLowerCase();b=b.toLowerCase();
let mis=0,i=0,j=0;
while(i<a.length&&j<b.length){
if(a[i]!==b[j]){mis++;i++;}
else{i++;j++;}
}
mis+=a.length-j;
return 1-mis/Math.max(a.length,b.length);
}

if(SR){
const rec=new SR();
rec.lang="ar-EG";rec.interimResults=true;

rec.onstart=()=>{
mic.classList.add("listening");
voiceFeedback.classList.add("active");
voiceText.innerText="Ø§ØªÙØ¶Ù„ ÙŠØ§ Ø­Ø§Ø¬â€¦";
};
rec.onend=()=>{
mic.classList.remove("listening");
voiceFeedback.classList.remove("active");
};
rec.onresult=async e=>{
let txt="";
for(let i=e.resultIndex;i<e.results.length;i++)
if(e.results[i].isFinal)txt+=e.results[i][0].transcript;
if(txt)processVoice(txt);
};
window.toggleMic=()=>mic.classList.contains("listening")?rec.stop():rec.start();
}

async function processVoice(txt){
voiceText.innerText="Ø¨ÙÙƒØ± ÙÙŠ ÙƒÙ„Ø§Ù…Ùƒâ€¦";

try{
let res=await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`,
{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({
contents:[{role:"user",parts:[{text:`
Ø§Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ÙÙ„Ø§Ø­ Ù…ØµØ±ÙŠ ÙŠÙÙ‡Ù… Ø£ÙŠ ÙƒÙ„Ø§Ù… Ø¹Ø§Ù…ÙŠ Ù…ÙƒØ³Ø±.
Ø­Ù„Ù„ Ø§Ù„Ø¬Ù…Ù„Ø© ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©.
Ø§Ø³ØªØ®Ø¯Ù… fuzzy logic Ù„Ù„ÙƒÙ„Ù…Ø§Øª: Ø¯Ø®Ù„/Ø§Ø¯Ø§Ù†ÙŠ/Ø¬Ø§Ù„ÙŠ â†’ income ØŒ ÙˆØµØ±ÙØª/Ø¯ÙØ¹Øª/Ø·Ù„Ø¹Øª â†’ expense.
Ø§Ø±Ø¬Ø¹ JSON:
{
"ops":[{"type":"income|expense","amount":Ø±Ù‚Ù…,"desc":"Ø§Ù„ÙˆØµÙ"}],
"say":"Ø±Ø¯ ØµÙˆØªÙŠ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ù…ØµØ±ÙŠØ©"
}
Ø§Ù„ÙƒÙ„Ø§Ù…: "${txt}"
`}]}],
generationConfig:{temperature:0.25,responseMimeType:"application/json"}
})});

let data=await res.json();
let out=JSON.parse(data.candidates[0].content.parts[0].text);

for(const o of out.ops||[]){
amount.value=o.amount;
desc.value=o.desc;
setMode(o.type);
await saveTx(null);
}

speak(out.say||"ØªÙ…Ø§Ù… ÙŠØ§ Ø­Ø§Ø¬.");

}catch(err){
console.error(err);speak("Ø§Ù„Ù†Øª ÙˆÙ‚Ø¹ ÙŠØ§ Ø­Ø§Ø¬â€¦ Ù‚ÙˆÙ„Ù‡Ø§ ØªØ§Ù†ÙŠ.");
}

setTimeout(()=>voiceFeedback.classList.remove("active"),2000);
}

function speak(t){
let u=new SpeechSynthesisUtterance(t);
u.lang="ar-EG";u.rate=.85;u.pitch=.9;
speechSynthesis.speak(u);
}

window.onload=()=>setTimeout(()=>speak("Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ Ø­Ø§Ø¬ Ø£Ø­Ù…Ø¯ØŒ Ø§ØªÙØ¶Ù„ ÙƒÙ„Ù…Ù†ÙŠâ€¦"),800);
</script>
</body></html>
