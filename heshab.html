<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }

        body { background: var(--bg); color: var(--text-main); padding: 20px; padding-bottom: 100px; transition: 0.3s ease; min-height: 100vh; }
        
        .container { max-width: 600px; margin: 0 auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: var(--surface); padding: 15px 20px; border-radius: 16px; box-shadow: var(--shadow); }
        .header h1 { font-size: 1.2rem; font-weight: 800; background: linear-gradient(to left, var(--primary), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .action-btn { background: transparent; border: none; font-size: 1.2rem; color: var(--text-sub); cursor: pointer; padding: 8px; transition: 0.3s; border-radius: 8px; }
        .action-btn:hover { background: var(--bg); color: var(--primary); }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        .stat-card { background: var(--surface); padding: 15px; border-radius: 16px; text-align: center; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; }
        .stat-card.inc::after { background: var(--success); }
        .stat-card.exp::after { background: var(--danger); }
        .stat-card.bal::after { background: var(--primary); }
        
        .stat-label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 5px; font-weight: 600; }
        .stat-val { font-size: 1.2rem; font-weight: 800; direction: ltr; }

        /* Input Section */
        .input-box { background: var(--surface); padding: 20px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; background: var(--bg); padding: 5px; border-radius: 12px; }
        .tab { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; background: transparent; color: var(--text-sub); transition: 0.3s; }
        .tab.active { background: var(--surface); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab.active.exp-mode { color: var(--danger); }

        input { width: 100%; padding: 14px; border: 2px solid var(--bg); background: var(--bg); border-radius: 12px; margin-bottom: 12px; font-size: 1rem; color: var(--text-main); transition: 0.3s; }
        input:focus { border-color: var(--primary); background: var(--surface); }

        .save-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); transition: 0.3s; }
        .save-btn:active { transform: scale(0.98); }

        /* List */
        .list-title { font-size: 0.95rem; color: var(--text-sub); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .record { background: var(--surface); padding: 15px; border-radius: 14px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-right: 5px solid transparent; transition: transform 0.2s; cursor: pointer; }
        .record:hover { transform: translateX(-5px); }
        .record.inc { border-right-color: var(--success); }
        .record.exp { border-right-color: var(--danger); }
        
        .rec-info h4 { font-size: 0.95rem; margin-bottom: 4px; }
        .rec-date { font-size: 0.75rem; color: var(--text-sub); }
        .rec-amount { font-weight: 800; font-size: 1.1rem; direction: ltr; }
        .text-inc { color: var(--success); }
        .text-exp { color: var(--danger); }

        /* Mic Button */
        .mic-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(135deg, #f43f5e, #e11d48); border: none; color: white; font-size: 1.6rem; cursor: pointer; box-shadow: 0 10px 25px rgba(225, 29, 72, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; transition: 0.3s; }
        .mic-btn.listening { background: linear-gradient(135deg, #10b981, #059669); animation: pulse 1.5s infinite; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4); }
        
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }
    </style>
</head>
<body>

<div class="container">

    <!-- Header -->
    <div class="header">
        <h1><i class="fa-solid fa-wallet"></i> Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</h1>
        <div style="display:flex; gap:5px;">
            <button class="action-btn" onclick="exportExcel()" title="ØªØµØ¯ÙŠØ± Excel"><i class="fa-solid fa-file-csv" style="color:#10b981"></i></button>
            <button class="action-btn" onclick="toggleTheme()" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"><i class="fa-solid fa-moon"></i></button>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card inc">
            <div class="stat-label">ÙˆØ§Ø±Ø¯</div>
            <div class="stat-val text-inc" id="totalInc">0</div>
        </div>
        <div class="stat-card exp">
            <div class="stat-label">Ù…ØµØ±ÙˆÙ</div>
            <div class="stat-val text-exp" id="totalExp">0</div>
        </div>
        <div class="stat-card bal">
            <div class="stat-label">Ø§Ù„ØµØ§ÙÙŠ</div>
            <div class="stat-val" style="color:var(--primary)" id="netBal">0</div>
        </div>
    </div>

    <!-- Input Form -->
    <div class="input-box">
        <div class="tabs">
            <button id="btnInc" class="tab active" onclick="setMode('income')">ÙˆØ§Ø±Ø¯ (+)</button>
            <button id="btnExp" class="tab" onclick="setMode('expense')">Ù…ØµØ±ÙˆÙ (-)</button>
        </div>

        <form id="form" onsubmit="saveTx(event)">
            <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ù…Ø«Ø§Ù„: 500)" step="0.01" required>
            <input type="text" id="desc" placeholder="Ø§Ù„ÙˆØµÙ (Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© Ù†Øª)" required>
            <button class="save-btn" id="submitBtn"><i class="fa-solid fa-check"></i> Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
        </form>
    </div>

    <!-- List -->
    <div class="list-title">
        <span>ğŸ“ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
        <span style="font-size:0.8rem">Ø§Ø¶ØºØ· Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</span>
    </div>
    <div id="list"></div>

</div>

<button class="mic-btn" id="mic" onclick="toggleMic()"><i class="fa-solid fa-microphone"></i></button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const app = initializeApp({
        apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
        authDomain: "nasrapp-7a0fc.firebaseapp.com",
        databaseURL: "https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
        projectId: "nasrapp-7a0fc",
        appId: "1:826970736109:web:c1cc3c3a1008e719b193e4"
    });
    const db = getDatabase(app);

    // --- Global Variables ---
    let mode = 'income';
    let records = [];

    // --- UI Logic ---
    window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';

    window.setMode = (m) => {
        mode = m;
        document.getElementById('btnInc').className = "tab " + (m === "income" ? "active" : "");
        document.getElementById('btnExp').className = "tab " + (m === "expense" ? "active exp-mode" : "");
        const btn = document.getElementById('submitBtn');
        btn.style.background = m === 'income' ? 'var(--primary)' : 'var(--danger)';
        btn.innerHTML = m === 'income' ? '<i class="fa-solid fa-plus"></i> Ø­ÙØ¸ Ø§Ù„ÙˆØ§Ø±Ø¯' : '<i class="fa-solid fa-minus"></i> Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ';
    };

    // --- Save Transaction ---
    window.saveTx = async (e) => {
        if(e) e.preventDefault();
        const amountIn = document.getElementById('amount');
        const descIn = document.getElementById('desc');
        
        const amount = parseFloat(amountIn.value);
        const desc = descIn.value;

        if(!amount || !desc) return;

        await push(ref(db, mode === "income" ? "income" : "expenses"), {
            amount, description: desc, timestamp: Date.now()
        });

        document.getElementById('form').reset();
        Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 }).fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸' });
    };

    // --- Realtime Listener ---
    onValue(ref(db), (snap) => {
        records = [];
        const d = snap.val();
        if(d) {
            if(d.income) Object.entries(d.income).forEach(([id, v]) => records.push({...v, id, type: "income"}));
            if(d.expenses) Object.entries(d.expenses).forEach(([id, v]) => records.push({...v, id, type: "expense"}));
        }
        records.sort((a, b) => b.timestamp - a.timestamp);
        render();
    });

    function render() {
        const inc = records.filter(r => r.type === "income").reduce((s, r) => s + Number(r.amount), 0);
        const exp = records.filter(r => r.type === "expense").reduce((s, r) => s + Number(r.amount), 0);

        document.getElementById('totalInc').innerText = inc.toLocaleString();
        document.getElementById('totalExp').innerText = exp.toLocaleString();
        document.getElementById('netBal').innerText = (inc - exp).toLocaleString();

        const list = document.getElementById('list');
        list.innerHTML = "";

        records.slice(0, 50).forEach(r => {
            const div = document.createElement("div");
            div.className = "record " + (r.type === 'income' ? 'inc' : 'exp');
            div.onclick = () => deleteOrEdit(r);
            
            const dateObj = new Date(r.timestamp);
            const dateStr = dateObj.toLocaleDateString('ar-EG');
            const timeStr = dateObj.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});

            div.innerHTML = `
                <div class="rec-info">
                    <h4>${r.description}</h4>
                    <div class="rec-date"><i class="fa-regular fa-clock"></i> ${timeStr} | ${dateStr}</div>
                </div>
                <div class="rec-amount ${r.type === 'income' ? 'text-inc' : 'text-exp'}">
                    ${r.type === 'income' ? '+' : '-'}${Number(r.amount).toLocaleString()}
                </div>
            `;
            list.appendChild(div);
        });
    }

    window.deleteOrEdit = (r) => {
        Swal.fire({
            title: 'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø¬Ù„',
            text: `${r.description} (${r.amount})`,
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: 'ØªØ¹Ø¯ÙŠÙ„',
            denyButtonText: 'Ø­Ø°Ù',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
        }).then(async (result) => {
            if (result.isDenied) {
                await remove(ref(db, `${r.type === 'income' ? 'income' : 'expenses'}/${r.id}`));
                Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success');
            } else if (result.isConfirmed) {
                // Edit logic could be added here
                Swal.fire('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©', '', 'info');
            }
        });
    };

    // --- EXCEL EXPORT WITH COLORS & BORDERS ---
    window.exportExcel = () => {
        if(records.length === 0) { Swal.fire('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', '', 'warning'); return; }

        const wb = XLSX.utils.book_new();
        
        // 1. Define Styles
        const styleHeader = {
            font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
            fill: { fgColor: { rgb: "4F46E5" } }, // Indigo
            alignment: { horizontal: "center", vertical: "center" },
            border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} }
        };

        const styleInc = {
            fill: { fgColor: { rgb: "DCFCE7" } }, // Light Green
            font: { color: { rgb: "166534" } }, // Dark Green
            border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} }
        };

        const styleExp = {
            fill: { fgColor: { rgb: "FEE2E2" } }, // Light Red
            font: { color: { rgb: "991B1B" } }, // Dark Red
            border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} }
        };

        // 2. Build Data
        const wsData = [
            [
                {v: "Ø§Ù„ØªØ§Ø±ÙŠØ®", s: styleHeader},
                {v: "Ø§Ù„ÙˆÙ‚Øª", s: styleHeader},
                {v: "Ø§Ù„Ù†ÙˆØ¹", s: styleHeader},
                {v: "Ø§Ù„ÙˆØµÙ", s: styleHeader},
                {v: "Ø§Ù„Ù…Ø¨Ù„Øº", s: styleHeader}
            ]
        ];

        records.forEach(r => {
            const dt = new Date(r.timestamp);
            const rowStyle = r.type === 'income' ? styleInc : styleExp;
            
            wsData.push([
                {v: dt.toLocaleDateString('ar-EG'), s: rowStyle},
                {v: dt.toLocaleTimeString('ar-EG'), s: rowStyle},
                {v: r.type === 'income' ? 'ÙˆØ§Ø±Ø¯' : 'Ù…ØµØ±ÙˆÙ', s: rowStyle},
                {v: r.description, s: rowStyle},
                {v: Number(r.amount), t: 'n', s: rowStyle}
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        // Column Widths
        ws['!cols'] = [{wch:15}, {wch:15}, {wch:10}, {wch:30}, {wch:15}];

        XLSX.utils.book_append_sheet(wb, ws, "ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ");
        XLSX.writeFile(wb, `Financial_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    // --- Voice Logic (Smart) ---
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR) {
        const rec = new SR();
        rec.lang = "ar-EG";
        rec.onstart = () => document.getElementById('mic').classList.add("listening");
        rec.onend = () => document.getElementById('mic').classList.remove("listening");
        
        rec.onresult = async (e) => {
            let txt = e.results[0][0].transcript;
            
            // Normalize digits
            txt = txt.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));

            // Commands
            if(txt.includes("Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„") || txt.includes("Ø­Ø°Ù Ø§Ù„ÙƒÙ„")) {
                const {value:pass} = await Swal.fire({title:'Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù', input:'password'});
                if(pass === '521988') {
                    await remove(ref(db, 'income'));
                    await remove(ref(db, 'expenses'));
                    Swal.fire('ØªÙ… Ø§Ù„ØªØµÙÙŠØ±', '', 'success');
                }
                return;
            }

            // Transaction Parsing
            const amountMatch = txt.match(/(\d+(\.\d+)?)/);
            if(amountMatch) {
                const amount = parseFloat(amountMatch[0]);
                let desc = txt.replace(amount, '').replace(/Ø¬Ù†ÙŠÙ‡|Ø¬Ù†ÙŠØ©/g, '').trim();
                
                // Detect Type
                const expKw = ["ØµØ±ÙØª","Ø§Ø´ØªØ±ÙŠØª","Ø¬Ø¨Øª","Ø¯ÙØ¹Øª","Ù„Ù€","Ù…ØµØ±ÙˆÙ","Ø®Ø±Ø¬Øª"];
                const incKw = ["Ù‚Ø¨Ø¶Øª","Ø¬Ø§Ù„ÙŠ","Ø§Ø®Ø¯Øª","ÙˆØ§Ø±Ø¯","Ø¯Ø®Ù„","Ù…Ù†"];
                
                let type = 'expense'; // Default
                if(incKw.some(k => txt.includes(k))) type = 'income';
                
                // Clean Desc
                [...expKw, ...incKw].forEach(k => desc = desc.replace(k, ''));
                desc = desc.trim() || "Ø¨Ø¯ÙˆÙ† ÙˆØµÙ";

                // Fill & Save
                document.getElementById('amount').value = amount;
                document.getElementById('desc').value = desc;
                setMode(type);
                saveTx(null);
            } else {
                Swal.fire('Ù„Ù… Ø£Ø³Ù…Ø¹ Ù…Ø¨Ù„ØºØ§Ù‹', txt, 'question');
            }
        };

        window.toggleMic = () => {
            const btn = document.getElementById('mic');
            if(btn.classList.contains("listening")) rec.stop(); else rec.start();
        };
    }
</script>

</body>
</html>
