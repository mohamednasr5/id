<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿßŸÑŸä ÿßŸÑÿ∞ŸÉŸä (Voice AI)</title>
    
    <!-- ŸÖŸÉÿ™ÿ®ÿßÿ™ ÿ∂ÿ±Ÿàÿ±Ÿäÿ© -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text-main); padding: 15px; padding-bottom: 100px; transition: 0.3s; min-height: 100vh; }

        .container { max-width: 1000px; margin: 0 auto; }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 15px 20px; border-radius: 16px;
            box-shadow: var(--shadow); margin-bottom: 20px;
        }
        .header h1 { font-size: 1.4rem; font-weight: 800; background: linear-gradient(45deg, var(--primary), var(--success)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .controls { display: flex; gap: 10px; }
        .icon-btn { background: var(--bg); border: none; width: 40px; height: 40px; border-radius: 12px; color: var(--text-main); cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.95); }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); padding: 15px; border-radius: 16px; text-align: center; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .stat-card h3 { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 5px; }
        .stat-val { font-size: 1.3rem; font-weight: 800; }
        .text-inc { color: var(--success); } .text-exp { color: var(--danger); } .text-bal { color: var(--primary); }

        /* Input Box */
        .input-box { background: var(--surface); padding: 20px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid rgba(0,0,0,0.05); }
        
        .tabs { display: flex; background: var(--bg); padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 8px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: 0.3s; }
        .tab.active { background: var(--surface); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab.active.exp { color: var(--danger); }

        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--bg); background: var(--bg); color: var(--text-main); font-size: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: var(--surface); }
        
        .submit-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; color: white; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
        .btn-inc { background: var(--primary); }
        .btn-exp { background: var(--danger); }
        .submit-btn:active { transform: scale(0.98); }

        /* List */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .record { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 15px; border-radius: 14px; margin-bottom: 10px; transition: 0.2s; border-right: 4px solid transparent; }
        .record.inc { border-right-color: var(--success); }
        .record.exp { border-right-color: var(--danger); }
        
        .rec-info h4 { font-size: 0.95rem; margin-bottom: 2px; }
        .rec-info p { font-size: 0.75rem; color: var(--text-sub); }
        .rec-amount { font-weight: 800; font-size: 1.1rem; cursor: pointer; padding: 5px 10px; border-radius: 8px; }
        .rec-amount:hover { background: var(--bg); }

        /* Floating Mic */
        .mic-fab { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(135deg, #F43F5E, #E11D48); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; box-shadow: 0 8px 20px rgba(225, 29, 72, 0.4); border: none; cursor: pointer; z-index: 100; transition: 0.3s; }
        .mic-fab.listening { background: linear-gradient(135deg, #10B981, #059669); animation: pulse 1.5s infinite; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4); }
        
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .form-row { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ∞ŸÉŸä ü§ñ</h1>
            <div class="controls">
                <button class="icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
                <button class="icon-btn" onclick="exportExcel()"><i class="fa-solid fa-file-excel" style="color: #10B981;"></i></button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card"><h3 id="incCount">0 Ÿàÿßÿ±ÿØ</h3><div class="stat-val text-inc" id="totalInc">0</div></div>
            <div class="stat-card"><h3 id="expCount">0 ŸÖÿµÿ±ŸàŸÅ</h3><div class="stat-val text-exp" id="totalExp">0</div></div>
            <div class="stat-card"><h3>ÿßŸÑÿµÿßŸÅŸä</h3><div class="stat-val text-bal" id="netBal">0</div></div>
        </div>

        <!-- Input -->
        <div class="input-box">
            <div class="tabs">
                <button class="tab active" onclick="setMode('income')" id="tabInc">Ÿàÿßÿ±ÿØ (+)</button>
                <button class="tab" onclick="setMode('expense')" id="tabExp">ŸÖÿµÿ±ŸàŸÅ (-)</button>
            </div>
            <form id="appForm" onsubmit="handleSubmit(event)">
                <div class="form-row">
                    <input type="number" id="amount" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ (0.00)" step="0.01" required>
                    <input type="text" id="desc" placeholder="ÿßŸÑŸàÿµŸÅ / ÿßŸÑÿßÿ≥ŸÖ" required>
                </div>
                <button type="submit" class="submit-btn btn-inc" id="mainBtn"><i class="fa-solid fa-check"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÖŸÑŸäÿ©</button>
            </form>
        </div>

        <!-- List -->
        <div class="list-header">
            <h3 style="font-size:1.1rem;">üìù ÿßŸÑÿ≥ÿ¨ŸÑ (ÿ¢ÿÆÿ± 50)</h3>
            <small style="color:var(--text-sub);" id="statusText">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑŸÖÿ®ŸÑÿ∫ ŸÑŸÑÿ™ÿπÿØŸäŸÑ</small>
        </div>
        <div id="listContainer"></div>
        
        <!-- Chart -->
        <div style="height: 250px; margin-top: 30px; background: var(--surface); padding: 15px; border-radius: 16px;">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <!-- Mic Button -->
    <button class="mic-fab" id="micBtn" onclick="toggleMic()">
        <i class="fa-solid fa-microphone"></i>
    </button>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 1. Firebase Init
        const firebaseConfig = {
            apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
            authDomain: "nasrapp-7a0fc.firebaseapp.com",
            databaseURL: "https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
            projectId: "nasrapp-7a0fc",
            storageBucket: "nasrapp-7a0fc.firebasestorage.app",
            messagingSenderId: "826970736109",
            appId: "1:826970736109:web:c1cc3c3a1008e719b193e4"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const incRef = ref(db, 'income');
        const expRef = ref(db, 'expenses');

        // 2. Global Variables
        let currentMode = 'income';
        let allData = [];
        let chartInstance = null;

        // 3. UI Functions
        window.setMode = (mode) => {
            currentMode = mode;
            document.getElementById('tabInc').classList.toggle('active', mode === 'income');
            document.getElementById('tabExp').classList.toggle('active', mode === 'expense');
            document.getElementById('tabExp').classList.toggle('exp', mode === 'expense'); // Color fix
            
            const btn = document.getElementById('mainBtn');
            const descInput = document.getElementById('desc');
            
            if(mode === 'income') {
                btn.className = 'submit-btn btn-inc';
                btn.innerHTML = '<i class="fa-solid fa-plus"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ Ÿàÿßÿ±ÿØ';
                descInput.placeholder = 'ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ / ÿßŸÑŸÖÿµÿØÿ±';
            } else {
                btn.className = 'submit-btn btn-exp';
                btn.innerHTML = '<i class="fa-solid fa-minus"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿµÿ±ŸàŸÅ';
                descInput.placeholder = 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿµÿ±ŸàŸÅ / ÿßŸÑÿ¨Ÿáÿ©';
            }
        }

        window.toggleTheme = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        }

        // 4. Form Handling
        window.handleSubmit = async (e) => {
            if(e) e.preventDefault();
            const amount = parseFloat(document.getElementById('amount').value);
            const desc = document.getElementById('desc').value;
            
            if(!amount || !desc) return;

            const path = currentMode === 'income' ? 'income' : 'expenses';
            
            try {
                await push(ref(db, path), {
                    amount,
                    description: desc,
                    timestamp: Date.now()
                });
                
                playSuccessSound(currentMode);
                document.getElementById('appForm').reset();
                
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                Toast.fire({ icon: 'success', title: `ÿ™ŸÖ ÿ≠ŸÅÿ∏ ${currentMode==='income'?'ÿßŸÑŸàÿßÿ±ÿØ':'ÿßŸÑŸÖÿµÿ±ŸàŸÅ'}` });
            } catch(err) {
                Swal.fire('ÿÆÿ∑ÿ£', 'ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿßŸÜÿ™ÿ±ŸÜÿ™', 'error');
            }
        }

        function playSuccessSound(type) {
            const url = type === 'income' 
                ? 'https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3' 
                : 'https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3';
            new Audio(url).play().catch(()=>{});
        }

        // 5. Data Listener
        onValue(ref(db), (snap) => {
            allData = [];
            const d = snap.val();
            if(d) {
                if(d.income) Object.entries(d.income).forEach(([k,v]) => allData.push({...v, id:k, type:'income'}));
                if(d.expenses) Object.entries(d.expenses).forEach(([k,v]) => allData.push({...v, id:k, type:'expense'}));
            }
            allData.sort((a,b) => b.timestamp - a.timestamp);
            updateUI();
        });

        function updateUI() {
            // Calc
            const inc = allData.filter(x=>x.type=='income').reduce((a,b)=>a+Number(b.amount),0);
            const exp = allData.filter(x=>x.type=='expense').reduce((a,b)=>a+Number(b.amount),0);
            
            document.getElementById('totalInc').innerText = inc.toLocaleString();
            document.getElementById('totalExp').innerText = exp.toLocaleString();
            document.getElementById('netBal').innerText = (inc - exp).toLocaleString();
            document.getElementById('incCount').innerText = allData.filter(x=>x.type=='income').length + ' Ÿàÿßÿ±ÿØ';
            document.getElementById('expCount').innerText = allData.filter(x=>x.type=='expense').length + ' ŸÖÿµÿ±ŸàŸÅ';

            // List
            const list = document.getElementById('listContainer');
            list.innerHTML = '';
            allData.slice(0, 50).forEach(item => {
                const isInc = item.type === 'income';
                const date = new Date(item.timestamp).toLocaleDateString('ar-EG');
                
                const div = document.createElement('div');
                div.className = `record ${isInc ? 'inc' : 'exp'}`;
                div.innerHTML = `
                    <div class="rec-info">
                        <h4>${item.description}</h4>
                        <p>${date}</p>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="rec-amount ${isInc?'text-inc':'text-exp'}" 
                             onclick="editItem('${item.id}', '${item.type}', ${item.amount})">
                            ${Number(item.amount).toLocaleString()}
                        </div>
                        <i class="fa-solid fa-trash" style="color:#cbd5e1; cursor:pointer;" 
                           onclick="deleteItem('${item.id}', '${item.type}')"></i>
                    </div>
                `;
                list.appendChild(div);
            });

            // Chart
            const ctx = document.getElementById('myChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ÿàÿßÿ±ÿØÿßÿ™', 'ŸÖÿµÿ±ŸàŸÅÿßÿ™'],
                    datasets: [{ data: [inc, exp], backgroundColor: ['#10B981', '#EF4444'], borderWidth:0 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'left' } } }
            });
        }

        // 6. Edit & Delete
        window.editItem = async (id, type, oldVal) => {
            const { value: newVal } = await Swal.fire({
                title: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫', input: 'number', inputValue: oldVal, showCancelButton: true, confirmButtonText:'ÿ≠ŸÅÿ∏'
            });
            if(newVal) update(ref(db, `${type === 'income' ? 'income' : 'expenses'}/${id}`), { amount: parseFloat(newVal) });
        }

        window.deleteItem = (id, type) => {
            Swal.fire({
                title: 'ÿ≠ÿ∞ŸÅÿü', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ŸÜÿπŸÖ'
            }).then(r => {
                if(r.isConfirmed) remove(ref(db, `${type === 'income' ? 'income' : 'expenses'}/${id}`));
            });
        }

        window.exportExcel = () => {
            const wb = XLSX.utils.book_new();
            const rows = [['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 'ÿßŸÑŸÜŸàÿπ', 'ÿßŸÑŸàÿµŸÅ', 'ÿßŸÑŸÖÿ®ŸÑÿ∫']];
            allData.forEach(r => rows.push([new Date(r.timestamp).toLocaleDateString(), r.type=='income'?'Ÿàÿßÿ±ÿØ':'ŸÖÿµÿ±ŸàŸÅ', r.description, r.amount]));
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, "Finance_Report.xlsx");
        }

        // ==========================================
        // üß† THE BRAIN: Advanced Voice Logic
        // ==========================================
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ar-EG';
            recognition.continuous = false;

            recognition.onstart = () => {
                document.getElementById('micBtn').classList.add('listening');
                document.getElementById('micBtn').innerHTML = '<i class="fa-solid fa-wave-square"></i>';
            };
            recognition.onend = () => {
                document.getElementById('micBtn').classList.remove('listening');
                document.getElementById('micBtn').innerHTML = '<i class="fa-solid fa-microphone"></i>';
            };

            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                processSpeech(text);
            };

            window.toggleMic = () => {
                if(document.getElementById('micBtn').classList.contains('listening')) recognition.stop();
                else recognition.start();
            }
        } else {
            alert('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿµŸàÿ™');
        }

        function processSpeech(rawText) {
            // 1. Normalize
            let text = rawText.replace(/[Ÿ†-Ÿ©]/g, d => "Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©".indexOf(d)); // Arabic to English digits
            console.log("Heard:", text);

            // 2. Commands Check
            if(text.includes('ŸÑŸäŸÑŸä') || text.includes('ŸÖÿ∏ŸÑŸÖ')) { toggleTheme(); return; }
            if(text.includes('ÿ™ÿµÿØŸäÿ±') || text.includes('ŸÖŸÑŸÅ')) { exportExcel(); return; }

            // 3. Analyze Transaction
            // Regex to find number (integer or decimal)
            const amountMatch = text.match(/(\d+(\.\d+)?)/);
            const amount = amountMatch ? parseFloat(amountMatch[0]) : 0;

            if(amount === 0) {
                Swal.fire('ÿ™ŸÜÿ®ŸäŸá', 'ŸÑŸÖ ÿ£ÿ≥ŸÖÿπ ŸÖÿ®ŸÑÿ∫ÿßŸã ŸÅŸä ŸÉŸÑÿßŸÖŸÉ: ' + text, 'info');
                return;
            }

            // --- THE DICTIONARY (ÿßŸÑŸÇÿßŸÖŸàÿ≥) ---
            // ŸÉŸÑŸÖÿßÿ™ ÿ™ÿØŸÑ ÿπŸÑŸâ ÿßŸÑŸàÿßÿ±ÿØ
            const incKeys = [
                'ŸÖŸÜ', 'ÿ¨ÿßŸÑŸä', 'ÿ¨ÿßŸÜŸä', 'ÿØÿÆŸÑ', 'ŸÇÿ®ÿ∂ÿ™', 'ÿßÿÆÿØÿ™', 'ÿ£ÿÆÿØÿ™', 'ÿßÿ≥ÿ™ŸÑŸÖÿ™', 'Ÿàÿßÿ±ÿØ', 'ÿ•Ÿäÿ±ÿßÿØ',
                'ŸÖŸÉÿ≥ÿ®', 'ÿ™ÿ≠ŸàŸäŸÑ ŸÑŸä', 'ÿ¨ÿßŸä ŸÖŸÜ', 'ŸÖŸÜ ÿ≠ÿ≥ÿßÿ®', 'ÿßÿ∂ÿßŸÅÿ©', 'ÿ≠ÿ∑', 'ŸàÿØŸäÿπÿ©'
            ];
            // ŸÉŸÑŸÖÿßÿ™ ÿ™ÿØŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿµÿ±ŸàŸÅ
            const expKeys = [
                'ŸÑŸÄ', ' ÿßŸÑŸä ', ' ÿ•ŸÑŸâ ', 'ÿπÿ∑Ÿäÿ™', 'ÿßÿØŸäÿ™', 'ÿ•ÿØŸäÿ™', 'ÿµÿ±ŸÅÿ™', 'ÿÆÿ±ÿ¨ÿ™', 'ÿØŸÅÿπÿ™', 'ÿ∑ŸÑÿπÿ™',
                'ÿ¥ÿ±Ÿäÿ™', 'ÿßÿ¥ÿ™ÿ±Ÿäÿ™', 'ÿ¨ÿ®ÿ™', 'ŸÖÿµÿ±ŸàŸÅ', 'ÿ≥ŸÑŸÅ', 'ÿ≥ÿØÿßÿØ', 'ÿÆÿµŸÖ', 'ÿ≥ÿ≠ÿ®ÿ™', 'ÿ≠ŸàŸÑÿ™ ŸÑ',
                'ÿßÿ¥ÿ™ÿ±ÿßŸÉ', 'ÿ™ÿ¨ÿØŸäÿØ', 'ÿ®ŸÜÿ≤ŸäŸÜ', 'ŸÅÿßÿ™Ÿàÿ±ÿ©', 'ÿµŸäÿßŸÜÿ©', 'ŸÖŸàÿßÿµŸÑÿßÿ™', 'ÿ£ŸÉŸÑ', 'ÿ∫ÿØÿß', 'ÿπÿ¥ÿß', 'ŸÅÿ∑ÿßÿ±',
                'ÿßŸäÿ¨ÿßÿ±', 'ŸÉŸáÿ±ÿ®ÿß', 'ŸÖŸäÿßŸá', 'ÿ∫ÿßÿ≤', 'ŸÜÿ™', 'ÿ±ÿµŸäÿØ', 'ÿπŸÑÿßÿ¨', 'ÿØŸàÿßÿ°'
            ];

            let type = null;
            // Check for Expense first (Specific usually overrides General)
            if(expKeys.some(k => text.includes(k))) type = 'expense';
            else if(incKeys.some(k => text.includes(k))) type = 'income';

            // 4. Smart Description Cleaning
            let desc = text;
            
            // Remove the number
            desc = desc.replace(amountMatch[0], '');
            
            // Remove Common Filler Words
            const noiseWords = ['ÿ¨ŸÜŸäŸá', 'ÿ¨ŸÜŸäÿ©', 'ÿ±ŸäÿßŸÑ', 'ÿØŸàŸÑÿßÿ±', 'ÿßŸÑŸÅ', 'ŸÖÿ®ŸÑÿ∫', 'ŸÇÿØÿ±Ÿá', 'ÿ≠ÿ≥ÿßÿ®', 'Ÿäÿß', 'ÿ®ÿßÿ¥ÿß', 'ŸáŸÜÿØÿ≥ÿ©', 'ŸÑŸà ÿ≥ŸÖÿ≠ÿ™', 'ÿ≥ÿ¨ŸÑ', 'ÿßŸÉÿ™ÿ®'];
            noiseWords.forEach(w => desc = desc.replace(w, ''));
            
            // Remove Trigger Keywords (Optional: keeping them sometimes adds context, but let's clean specific prefixes)
            const prefixesToRemove = ['ŸÖŸÜ ', 'ŸÑ ', 'ÿßŸÑŸâ ', 'ÿπÿ∑Ÿäÿ™ ', 'ÿßÿØŸäÿ™ ', 'ÿ¨ÿßŸÑŸä ', 'ÿØŸÅÿπÿ™ ', 'ÿßÿ¥ÿ™ÿ±Ÿäÿ™ ', 'ÿ¨ÿ®ÿ™ '];
            prefixesToRemove.forEach(p => {
                if(desc.trim().startsWith(p.trim())) desc = desc.replace(p, '');
            });

            desc = desc.trim();
            if(desc.length < 2) desc = "ÿπŸÖŸÑŸäÿ© ÿµŸàÿ™Ÿäÿ©"; // Default if description becomes empty

            // 5. Action
            document.getElementById('amount').value = amount;
            document.getElementById('desc').value = desc;
            
            if(type) {
                setMode(type);
                handleSubmit(null); // Auto Submit
            } else {
                // Ambiguous Case
                Swal.fire({
                    title: `ÿßŸÑŸÖÿ®ŸÑÿ∫: ${amount}`,
                    text: `ÿßŸÑŸàÿµŸÅ: ${desc} - ŸáŸÑ Ÿáÿ∞ÿß Ÿàÿßÿ±ÿØ ÿ£ŸÖ ŸÖÿµÿ±ŸàŸÅÿü`,
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'Ÿàÿßÿ±ÿØ (+)',
                    denyButtonText: 'ŸÖÿµÿ±ŸàŸÅ (-)',
                    cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°'
                }).then((res) => {
                    if(res.isConfirmed) { setMode('income'); handleSubmit(null); }
                    else if(res.isDenied) { setMode('expense'); handleSubmit(null); }
                });
            }
        }
    </script>
</body>
</html>
