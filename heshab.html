<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>النظام المالي | AI Free</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #6366f1; --primary-rgb: 99, 102, 241;
            --success: #10b981; --danger: #ef4444;
            --bg: #f8fafc; --surface: #ffffff; --text: #1e293b;
        }
        [data-theme="dark"] { --bg: #0f172a; --surface: #1e293b; --text: #f8fafc; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; padding-bottom: 120px; min-height: 100vh; transition: 0.3s; }
        .container { max-width: 600px; margin: 0 auto; }

        /* الهيدر */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 15px 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .btn-icon { background: transparent; border: none; width: 45px; height: 45px; border-radius: 12px; font-size: 1.3rem; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .btn-icon:hover { background: rgba(var(--primary-rgb), 0.1); transform: translateY(-2px); }

        /* البطاقات */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); padding: 15px 5px; border-radius: 18px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); }
        .stat-icon { font-size: 1.4rem; margin-bottom: 8px; display: inline-block; width: 35px; height: 35px; line-height: 35px; border-radius: 50%; }
        .income .stat-icon { background: rgba(16,185,129,0.1); color: var(--success); }
        .expense .stat-icon { background: rgba(239,68,68,0.1); color: var(--danger); }
        .net .stat-icon { background: rgba(99,102,241,0.1); color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: #64748b; font-weight: 700; }
        .stat-val { font-size: 1.4rem; font-weight: 800; font-family: 'Roboto', sans-serif; }
        .stat-val.income { color: var(--success); } .stat-val.expense { color: var(--danger); } .stat-val.net { color: var(--primary); }

        /* النموذج */
        .toggle-input-btn { width: 100%; background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; padding: 15px; border-radius: 16px; border: none; cursor: pointer; font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(99,102,241,0.3); }
        .input-box { background: var(--surface); padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-box.hidden { display: none; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg); padding: 5px; border-radius: 16px; }
        .tab { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; background: transparent; color: #94a3b8; transition: 0.2s; }
        .tab.active { background: var(--surface); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tab.active.inc { color: var(--success); } .tab.active.exp { color: var(--danger); }
        
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 16px 50px 16px 20px; border: 2px solid var(--bg); border-radius: 16px; font-size: 1.1rem; background: var(--bg); color: var(--text); font-weight: 600; }
        .input-group i { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .save-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .save-btn:hover { transform: translateY(-2px); }

        /* القائمة */
        .filter-btns { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid transparent; background: rgba(148, 163, 184, 0.1); color: var(--text); font-weight: 700; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .filter-btn.active { background: var(--text); color: var(--bg); }
        
        .record { background: var(--surface); padding: 15px; border-radius: 16px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; cursor: pointer; border: 1px solid rgba(0,0,0,0.03); position: relative; overflow: hidden; transition: 0.2s; }
        .record:hover { transform: translateX(-5px); }
        .record::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 6px; }
        .record.inc::before { background: var(--success); } .record.exp::before { background: var(--danger); }
        .rec-info h4 { font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
        .rec-date { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
        .rec-amt { font-weight: 900; font-size: 1.2rem; margin-right: auto; font-family: 'Roboto', sans-serif; }

        /* الذكاء والصوت */
        .ai-status { position: fixed; top: 110px; left: 50%; transform: translateX(-50%); background: rgba(15,23,42,0.95); backdrop-filter: blur(10px); color: white; padding: 12px 25px; border-radius: 50px; display: none; z-index: 999; font-weight: 600; align-items: center; gap: 10px; white-space: nowrap; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .ai-status.active { display: flex; animation: slideDown 0.3s; }
        .spinner { width: 18px; height: 18px; border: 3px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .mic-container { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .mic-btn { pointer-events: auto; width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #f43f5e, #e11d48); color: white; border: none; box-shadow: 0 10px 30px rgba(225, 29, 72, 0.4); font-size: 1.8rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .mic-btn.listening { animation: pulse 1.5s infinite; background: #22c55e; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="width:45px; height:45px; background:rgba(99,102,241,0.1); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                <i class="fa-solid fa-brain" style="color:var(--primary); font-size:1.4rem;"></i>
            </div>
            <div>
                <h2 style="font-weight:900; font-size:1.2rem; margin-bottom:2px;">المالية الذكية</h2>
                <span style="font-size:0.75rem; color:#64748b; font-weight:600;">الحاج أحمد شطا</span>
            </div>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="btn-icon" onclick="exportExcel()" title="تصدير Excel">
                <i class="fa-solid fa-file-excel" style="color:#10b981;"></i>
            </button>
            <button class="btn-icon" onclick="toggleTheme()" title="تبديل المظهر">
                <i class="fa-solid fa-circle-half-stroke" style="color:#6366f1;"></i>
            </button>
            <button class="btn-icon" onclick="deleteAllRecordsPrompt()" title="حذف الكل">
                <i class="fa-solid fa-trash-can" style="color:#ef4444;"></i>
            </button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card income">
            <div class="stat-icon"><i class="fa-solid fa-arrow-down"></i></div>
            <div class="stat-label">الدخل</div>
            <div class="stat-val income" id="totalInc">0</div>
        </div>
        <div class="stat-card expense">
            <div class="stat-icon"><i class="fa-solid fa-arrow-up"></i></div>
            <div class="stat-label">المصروفات</div>
            <div class="stat-val expense" id="totalExp">0</div>
        </div>
        <div class="stat-card net">
            <div class="stat-icon"><i class="fa-solid fa-scale-balanced"></i></div>
            <div class="stat-label">الصافي</div>
            <div class="stat-val net" id="netBal">0</div>
        </div>
    </div>

    <button class="toggle-input-btn" onclick="toggleInputForm()">
        <i class="fa-solid fa-plus-circle"></i> تسجيل عملية يدوية
    </button>

    <div class="input-box hidden" id="inputBox">
        <div class="tabs">
            <button id="btnInc" class="tab active inc" onclick="setMode('income')">دخل</button>
            <button id="btnExp" class="tab" onclick="setMode('expense')">مصروف</button>
        </div>
        <form onsubmit="saveTx(event)">
            <div class="input-group">
                <i class="fa-solid fa-coins"></i>
                <input type="number" id="amount" placeholder="المبلغ" step="any" required>
            </div>
            <div class="input-group">
                <i class="fa-solid fa-pen-nib"></i>
                <input type="text" id="desc" placeholder="وصف العملية" required>
            </div>
            <button type="submit" class="save-btn" id="submitBtn">
                <i class="fa-solid fa-check"></i> حفظ العملية
            </button>
        </form>
    </div>

    <div class="filter-btns">
        <button class="filter-btn active" onclick="setFilter('all')" data-filter="all">الكل</button>
        <button class="filter-btn" onclick="setFilter('income')" data-filter="income">الوارد</button>
        <button class="filter-btn" onclick="setFilter('expense')" data-filter="expense">المصروف</button>
    </div>
    <div id="list"></div>
</div>

<div class="ai-status" id="aiStatus">
    <div class="spinner" id="aiSpinner"></div>
    <span id="aiText">جاري الاستماع...</span>
</div>
<div class="mic-container">
    <button class="mic-btn" id="mic" onclick="toggleMic()"><i class="fa-solid fa-microphone"></i></button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
    apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
    authDomain: "nasrapp-7a0fc.firebaseapp.com",
    databaseURL: "https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
    projectId: "nasrapp-7a0fc",
    appId: "1:826970736109:web:c1cc3c3a1008e719b193e4"
});
const db = getDatabase(app);

// =============================================
// المتغيرات والتهيئة
// =============================================
let mode = "income";
let records = [];
let filter = "all";
let isListening = false;

window.toggleTheme = () => {
    const isDark = document.body.dataset.theme === "dark";
    document.body.dataset.theme = isDark ? "light" : "dark";
    localStorage.setItem("theme", document.body.dataset.theme);
};
if(localStorage.getItem("theme")) document.body.dataset.theme = localStorage.getItem("theme");

window.setMode = (m) => {
    mode = m;
    document.getElementById("btnInc").className = `tab ${m==='income'?'active inc':''}`;
    document.getElementById("btnExp").className = `tab ${m==='expense'?'active exp':''}`;
    document.getElementById("submitBtn").style.background = m === "income" ? "var(--success)" : "var(--danger)";
};

window.setFilter = (f) => {
    filter = f;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.toggle("active", b.dataset.filter === f));
    render();
};

window.toggleInputForm = () => {
    document.getElementById("inputBox").classList.toggle("hidden");
};

// =============================================
// Firebase Data Handling
// =============================================
window.saveTx = async (e, directData = null) => {
    if (e) e.preventDefault();
    let amt, txt, type;
    
    if (directData) {
        amt = directData.amount;
        txt = directData.description;
        type = directData.type;
    } else {
        amt = parseFloat(document.getElementById("amount").value);
        txt = document.getElementById("desc").value.trim();
        type = mode;
    }

    if (!amt || !txt) return;

    await push(ref(db, type === "income" ? "income" : "expenses"), {
        amount: amt, description: txt, timestamp: Date.now()
    });

    if (!directData) {
        document.getElementById("amount").value = "";
        document.getElementById("desc").value = "";
        document.getElementById("inputBox").classList.add("hidden");
    }

    Swal.fire({
        toast: true, icon: "success", 
        title: "تم الحفظ", 
        text: `${txt} : ${Number(amt).toLocaleString()}`,
        position: "top", timer: 2000, showConfirmButton: false
    });
};

onValue(ref(db), (snap) => {
    records = [];
    const d = snap.val();
    if (d) {
        if (d.income) Object.entries(d.income).forEach(([id,v]) => records.push({...v,id,type:"income"}));
        if (d.expenses) Object.entries(d.expenses).forEach(([id,v]) => records.push({...v,id,type:"expense"}));
    }
    records.sort((a,b) => b.timestamp - a.timestamp);
    render();
});

function render() {
    let data = records;
    if (filter !== "all") data = data.filter(r => r.type === filter);

    const inc = records.filter(r => r.type==="income").reduce((s,r)=>s+r.amount,0);
    const exp = records.filter(r => r.type==="expense").reduce((s,r)=>s+r.amount,0);
    const net = inc - exp;

    // عرض الأرقام بدون كسور
    document.getElementById("totalInc").innerText = inc.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    document.getElementById("totalExp").innerText = exp.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    document.getElementById("netBal").innerText = net.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});

    const list = document.getElementById("list");
    list.innerHTML = "";
    
    if (data.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;"><i class="fa-solid fa-box-open" style="font-size:3rem; margin-bottom:10px;"></i><p>لا توجد بيانات</p></div>`;
        return;
    }

    data.forEach(r => {
        const div = document.createElement("div");
        div.className = `record ${r.type === 'income' ? 'inc' : 'exp'}`;
        div.onclick = () => manageRecord(r);
        const date = new Date(r.timestamp);
        
        div.innerHTML = `
            <div class="rec-info">
                <h4>${r.description}</h4>
                <div class="rec-date">${date.toLocaleTimeString('ar-EG', {hour:'2-digit',minute:'2-digit'})} • ${date.toLocaleDateString('ar-EG')}</div>
            </div>
            <div class="rec-amt" style="color:${r.type==='income'?'var(--success)':'var(--danger)'}">
                ${r.type==='income'?'+':'-'}${Number(r.amount).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 2})}
            </div>
        `;
        list.appendChild(div);
    });
}

// =============================================
// AI Function (Pollinations.ai) - Free, No Key
// =============================================
function setAIStatus(msg, isLoading = false) {
    const el = document.getElementById("aiStatus");
    const txt = document.getElementById("aiText");
    const spin = document.getElementById("aiSpinner");
    if (msg) {
        el.classList.add("active");
        txt.innerText = msg;
        spin.style.display = isLoading ? "block" : "none";
    } else {
        el.classList.remove("active");
    }
}

async function analyzeTextWithAI(text) {
    setAIStatus("جاري تحليل الكلام...", true);

    // Prompt مهيأ ليستخرج JSON بدقة
    const prompt = `You are a financial API. Analyze this Arabic text: "${text}".
    Extract: 
    - amount (number only)
    - description (Arabic text, remove numbers)
    - type (either 'income' or 'expense')
    
    Rules:
    - Income: قبضت, خدت, جالي, وارد, مكسب
    - Expense: دفعت, صرفت, اشتريت, جبت, خرج
    
    Return ONLY valid JSON. No markdown. Example: {"amount": 50, "description": "بنزين", "type": "expense"}`;

    try {
        // استخدام خدمة Pollinations المجانية (تعمل كبروكسي لـ GPT)
        const response = await fetch('https://text.pollinations.ai/', {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain',
            },
            body: prompt
        });

        if (!response.ok) throw new Error("Network error");
        
        let aiText = await response.text();
        
        // تنظيف النص المستلم
        aiText = aiText.replace(/```json/g, "").replace(/```/g, "").trim();
        
        const start = aiText.indexOf('{');
        const end = aiText.lastIndexOf('}');
        if (start !== -1 && end !== -1) {
            aiText = aiText.substring(start, end + 1);
        }

        const result = JSON.parse(aiText);
        setAIStatus(null);
        return result;

    } catch (error) {
        console.error("AI Error:", error);
        Swal.fire({
            icon: 'error', 
            title: 'خطأ', 
            text: 'لم أتمكن من تحليل الجملة، حاول مرة أخرى.'
        });
        setAIStatus(null);
        return null;
    }
}

// =============================================
// Voice Logic
// =============================================
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SR) {
    const rec = new SR();
    rec.lang = "ar-EG";
    
    rec.onstart = () => { 
        isListening = true; 
        document.getElementById("mic").classList.add("listening"); 
        setAIStatus("استمع إليك...", false); 
    };
    
    rec.onend = () => { 
        isListening = false; 
        document.getElementById("mic").classList.remove("listening"); 
    };

    rec.onresult = async (e) => {
        const text = e.results[e.results.length-1][0].transcript;
        setAIStatus(`سمعت: "${text}"`, true);
        
        const data = await analyzeTextWithAI(text);
        if (data && data.amount) {
            await saveTx(null, data);
        }
    };

    window.toggleMic = () => {
        isListening ? rec.stop() : rec.start();
    };
} else {
    alert("المتصفح لا يدعم ميزة الصوت");
}

// =============================================
// Tools (Delete, Edit, Excel)
// =============================================
window.manageRecord = async (r) => {
    const { isDenied, isConfirmed } = await Swal.fire({
        title: r.description, text: `${r.amount} جنيه`,
        showDenyButton: true, showCancelButton: true,
        confirmButtonText: "تعديل", denyButtonText: "حذف", cancelButtonText: "غلق",
        confirmButtonColor: "var(--primary)", denyButtonColor: "var(--danger)"
    });
    if (isDenied) { await remove(ref(db, `${r.type}/${r.id}`)); Swal.fire({toast:true, icon:"success", title:"تم الحذف", timer:1000, showConfirmButton:false}); }
    if (isConfirmed) { const { value: val } = await Swal.fire({input:"text", inputValue:r.description}); if(val) await update(ref(db, `${r.type}/${r.id}`), {description:val}); }
};

window.deleteAllRecordsPrompt = async () => {
    const { value: p } = await Swal.fire({title:"أدخل كود الحذف", input:"password"});
    if(p === "521988") { await remove(ref(db, "income")); await remove(ref(db, "expenses")); Swal.fire({icon:"success", title:"تم الحذف"}); }
};

window.exportExcel = () => {
    const wb = XLSX.utils.book_new();
    const createCell = (v, s) => ({v, t: typeof v==='number'?'n':'s', s});
    const border = { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} };
    
    const sheet = (data, title, color, lightColor) => {
        const rows = [[
            createCell("الوصف", {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true}, border}),
            createCell("المبلغ", {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true}, border}),
            createCell("التاريخ", {fill:{fgColor:{rgb:color}}, font:{color:{rgb:"FFFFFF"}, bold:true}, border})
        ]];
        data.forEach(r => {
            rows.push([
                createCell(r.description, {fill:{fgColor:{rgb:lightColor}}, border}),
                createCell(r.amount, {fill:{fgColor:{rgb:lightColor}}, border}),
                createCell(new Date(r.timestamp).toLocaleDateString('ar-EG'), {fill:{fgColor:{rgb:lightColor}}, border})
            ]);
        });
        const ws = XLSX.utils.aoa_to_sheet([]);
        const range = {s:{c:0,r:0}, e:{c:2,r:rows.length-1}};
        ws['!ref'] = XLSX.utils.encode_range(range);
        ws['!cols'] = [{wch:30}, {wch:15}, {wch:15}];
        rows.forEach((row, r) => row.forEach((cell, c) => ws[XLSX.utils.encode_cell({c,r})] = cell));
        XLSX.utils.book_append_sheet(wb, ws, title);
    };

    const inc = records.filter(r=>r.type==="income");
    const exp = records.filter(r=>r.type==="expense");
    sheet(inc, "الوارد", "10B981", "ECFDF5");
    sheet(exp, "المصروف", "EF4444", "FEF2F2");
    
    XLSX.writeFile(wb, "التقرير_المالي.xlsx");
};
</script>
</body>
</html>
