<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ â€“ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{
 --primary:#4f46e5;
 --danger:#ef4444;
 --success:#10b981;
 --bg:#f8fafc;
 --surface:#ffffff;
 --text-main:#0f172a;
 --text-sub:#64748b;
}
body{background:var(--bg);color:var(--text-main);font-family:'Cairo';padding:15px}
.container{max-width:760px;margin:auto}
.header{display:flex;justify-content:space-between;margin-bottom:20px}
h1{color:var(--primary);font-size:1.4rem;font-weight:900}
.stat{background:var(--surface);padding:15px;border-radius:12px;box-shadow:0 3px 10px #0001}
.mic-btn{
position:fixed;bottom:25px;left:50%;transform:translateX(-50%);
background:#e11d48;width:60px;height:60px;border-radius:50%;
border:none;color:white;font-size:1.5rem;cursor:pointer}
.mic-btn.listening{background:#10b981;transform:translateX(-50%) scale(1.1)}
.record{
background:var(--surface);padding:12px;border-radius:12px;
display:flex;justify-content:space-between;margin-bottom:10px;
border-right:5px solid #ccc;cursor:pointer;
}
.record.inc{border-color:var(--success)}
.record.exp{border-color:var(--danger)}
input{width:100%;padding:12px;border-radius:10px;border:2px solid #eee;margin-bottom:10px}
.tab{padding:12px;width:48%;border:none;border-radius:10px;background:#eee;cursor:pointer}
.tab.active{background:var(--primary);color:white}
.tab.exp{background:var(--danger)!important}
.save-btn{width:100%;padding:14px;border-radius:12px;border:none;font-weight:bold;color:white;background:var(--primary)}
</style>
</head>

<body>

<div class="container">

<div class="header">
<h1>ğŸ’¼ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ- Ø¥Ù‡Ø¯Ø§Ø¡ Ù„Ù„Ø­Ø§Ø¬ Ø£Ø­Ù…Ø¯ Ø´Ø·Ø§</h1>
<button onclick="toggleTheme()" style="border:none;background:none;font-size:1.4rem;cursor:pointer">ğŸŒ™</button>
</div>

<div style="display:flex;gap:10px;margin-bottom:20px">
<div class="stat" style="flex:1;text-align:center">
<div style="color:var(--text-sub)">ÙˆØ§Ø±Ø¯</div>
<div id="totalInc" style="color:var(--success);font-size:1.3rem;font-weight:900">0</div>
</div>
<div class="stat" style="flex:1;text-align:center">
<div style="color:var(--text-sub)">Ù…ØµØ±ÙˆÙ</div>
<div id="totalExp" style="color:var(--danger);font-size:1.3rem;font-weight:900">0</div>
</div>
<div class="stat" style="flex:1;text-align:center">
<div style="color:var(--text-sub)">Ø§Ù„ØµØ§ÙÙŠ</div>
<div id="netBal" style="color:var(--primary);font-size:1.3rem;font-weight:900">0</div>
</div>
</div>

<div style="background:var(--surface);padding:20px;border-radius:20px;margin-bottom:20px">
<div style="display:flex;gap:10px;margin-bottom:10px">
<button id="btnInc" class="tab active" onclick="setMode('income')">ÙˆØ§Ø±Ø¯ (+)</button>
<button id="btnExp" class="tab" onclick="setMode('expense')">Ù…ØµØ±ÙˆÙ (-)</button>
</div>

<form id="form" onsubmit="saveTx(event)">
<input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" required>
<input type="text" id="desc" placeholder="Ø§Ù„ÙˆØµÙ" required>
<button class="save-btn" id="submitBtn">Ø­ÙØ¸</button>
</form>
</div>

<h3 style="margin-bottom:10px;color:var(--text-sub)">Ø§Ù„Ø³Ø¬Ù„</h3>
<div id="list"></div>

</div>

<button class="mic-btn" id="mic" onclick="toggleMic()">ğŸ¤</button>

<script type="module">

/*-----------------------------------------
 | ğŸ”¥ 1) Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase
------------------------------------------*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
    apiKey: "AIzaSyDJHcly8lYT4FTxrJCBRIR7JSbJGYtG3_I",
    authDomain: "nasrapp-7a0fc.firebaseapp.com",
    databaseURL: "https://nasrapp-7a0fc-default-rtdb.firebaseio.com",
    projectId: "nasrapp-7a0fc",
    appId: "1:826970736109:web:c1cc3c3a1008e719b193e4"
});
const db = getDatabase(app);


/*-----------------------------------------
 | ğŸ”¥ 2) Ø§Ù„Ø«ÙŠÙ…
------------------------------------------*/
window.toggleTheme = () => {
  document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light':'dark';
};


/*-----------------------------------------
 | ğŸ”¥ 3) Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ (ÙˆØ§Ø±Ø¯ - Ù…ØµØ±ÙˆÙ)
------------------------------------------*/
let mode = 'income';
window.setMode = (m)=>{
 mode=m;
 document.getElementById('btnInc').className="tab "+(m==="income"?"active":"");
 document.getElementById('btnExp').className="tab "+(m==="expense"?"active exp":"");
 document.getElementById('submitBtn').style.background = 
   mode==='income'? "var(--primary)":"var(--danger)";
};


/*-----------------------------------------
 | ğŸ”¥ 4) Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ©
------------------------------------------*/
window.saveTx = async (e)=>{
 if(e) e.preventDefault();

 const amount = parseFloat(amount.value);
 const desc = descInput.value;

 if(!amount || !desc) return;

 await push(ref(db, mode==="income"?"income":"expenses"), {
   amount, description: desc, timestamp: Date.now()
 });

 document.getElementById('form').reset();

 Swal.fire({toast:true,title:"ØªÙ… Ø§Ù„Ø­ÙØ¸",icon:"success",timer:1500,showConfirmButton:false});
};

const descInput = document.getElementById("desc");


/*-----------------------------------------
 | ğŸ”¥ 5) Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
------------------------------------------*/
let records=[];
onValue(ref(db),(snap)=>{
 records=[];
 const d=snap.val();
 if(d){
  if(d.income) Object.entries(d.income).forEach(([id,v])=>records.push({...v,id,type:"income"}));
  if(d.expenses) Object.entries(d.expenses).forEach(([id,v])=>records.push({...v,id,type:"expense"}));
 }
 records.sort((a,b)=>b.timestamp-a.timestamp);
 render();
});

function render(){
 const inc = records.filter(r=>r.type==="income").reduce((s,r)=>s+r.amount,0);
 const exp = records.filter(r=>r.type==="expense").reduce((s,r)=>s+r.amount,0);

 totalInc.innerText=inc.toLocaleString();
 totalExp.innerText=exp.toLocaleString();
 netBal.innerText=(inc-exp).toLocaleString();

 list.innerHTML="";

 records.forEach(r=>{
   const div=document.createElement("div");
   div.className="record "+(r.type==='income'?'inc':'exp');
   const dt=new Date(r.timestamp).toLocaleString("ar-EG");
   div.innerHTML=`
     <div>
       <div style="font-weight:700">${r.description}</div>
       <div style="color:var(--text-sub);font-size:.8rem">${dt}</div>
     </div>
     <div style="font-weight:900">${r.type==='income'?'+':'-'}${r.amount}</div>
   `;
   list.appendChild(div);
 });
}


/*-----------------------------------------
 | ğŸ”¥ 6) Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠ (800 ÙƒÙ„Ù…Ø©)
   * Ù†Ø³Ø®Ø© Ù…Ø®ØªØµØ±Ø© ØªØ´Ù…Ù„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ¹Ù…Ø§Ù„Ù‹Ø§
   * ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ³ÙŠØ¹Ù‡Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
------------------------------------------*/
const egyptianSlang = {
 expense:[
"ØµØ±Ù","ØµØ±ÙØª","ØµØ±ÙÙ†Ø§","Ø¯Ø§ÙØ¹","Ø¯ÙØ¹Øª","Ø¯ÙØ¹Ø©","Ø¯ÙØ¹Ù„Ùˆ","Ø¯ÙØ¹Ù„Ù‡Ø§",
"Ø¬Ø¨Øª","Ø§Ø´ØªØ±ÙŠØª","Ø´Ø±ÙŠØª","ÙƒÙ„ÙØª","Ø·Ù„Ø¹Øª","Ø·Ù„Ø¹","Ø®ØµÙ…","Ø®ØµÙ…ÙˆÙ„ÙŠ","Ø®Ø¯Øª","Ø£Ø®Ø¯",
"Ø§ØªØ³Ø­Ø¨","Ø§ØªØ®ØµÙ…","Ø§ØªØ­Ø¬Ø²","Ù…ØµØ§Ø±ÙŠÙ","Ù…Ø´ÙˆØ§Ø±","Ù…ÙˆØ§ØµÙ„Ø§Øª","ØªØ¹Ù„ÙŠØ©",
"Ø§ÙŠØ¬Ø§Ø±","ÙØ§ØªÙˆØ±Ø©","Ø¹Ø´Ø§","ÙØ·Ø§Ø±","ØºØ¯Ø§","Ø§ÙƒÙ„","Ø´Ø±Ø¨","Ø·Ù„Ø¨Ø§Øª","Ø´ÙˆÙŠØ© Ø­Ø§Ø¬Ø§Øª",
"Ø¹Ù„Ø§Ø¬","Ø¯ÙˆØ§Ø¡","ØµÙŠØ¯Ù„ÙŠØ©","ÙƒØ³ÙˆØ©","Ù‡Ø¯ÙˆÙ…","Ù„Ø¨Ø³","Ø­Ù„Ø§Ù‚Ø©","ÙƒØ±ØªÙˆÙ†Ø©","Ø´Ù†Ø·Ø©",
"ÙƒÙŠØ³","Ø¹Ø±ÙˆØ³Ø©","Ø¹ÙŠØ§Ù„","Ø¨ÙŠØª","Ø­Ø§Ø¬Ø© Ù„Ù„Ø¨ÙŠØª","Ø¬Ø¨Øª Ø­Ø§Ø¬Ø©","Ø¨Ù„Ø§Ø³ØªÙŠÙƒ","Ù†ÙˆÙ„ÙˆÙ†",
"ØªÙˆØµÙŠÙ„","Ø´Ø­Ù†","Ø±Ø³ÙˆÙ…","Ø¶Ø±ÙŠØ¨Ø©","Ø¹Ù…ÙˆÙ„Ø©","Ù„Ù…Ø¨Ø©","Ø³Ù„Ùƒ","Ù…Ø³Ù…Ø§Ø±","Ø®Ø´Ø¨"
 ],
 income:[
"Ù‚Ø¨Ø¶","Ù‚Ø¨Ø¶Øª","Ø§Ø³ØªÙ„Ù…Øª","Ø§Ø³ØªÙ„Ø§Ù…","Ø¬Ø§Ù„ÙŠ","Ø¬Ø§ØªÙ„ÙŠ","Ø¬Ø§Ù†ÙŠ","Ø¯Ø®Ù„","Ø§ÙŠØ±Ø§Ø¯",
"Ø¨ÙŠØ¹","Ø¨Ø¹Øª","Ø­Ø·ÙŠØª","Ø­Ø·","Ø¹Ø·ÙŠØ©","Ø±Ø²Ù‚Ø©","Ø­ÙˆØ§Ù„Ø©","ØªØ­ÙˆÙŠÙ„","Ù…ÙƒØ³Ø¨","Ù…Ø±Ø¨Ø­",
"Ø±Ø¨Ø­","Ø¹Ù…ÙˆÙ„Ø©","Ù‡Ø¨Ø©","Ù…Ù†Ø­Ø©","ÙÙ„ÙˆØ³ Ø¬Ø§ÙŠØ©","Ø§ØªØ­ÙˆÙ„","Ø§ØªØµØ±Ù","Ø§ØªØ¯ÙØ¹Ù„ÙŠ",
"Ø­Ø§Ø¬Ø© Ø¯Ø®Ù„Øª","Ø­Ø¯ Ø§Ø¯Ø§Ù†ÙŠ","Ø¬Ø§Ø¨ÙˆÙ„ÙŠ"
 ],
 deleteAll:["Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„","ÙØ±Ù…Øª","Ø´ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„","Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","Ø§Ù…Ø³Ø­ ÙƒÙ„"],
 deleteLast:["Ù…Ø³Ø­ Ø§Ø®Ø±","Ø§Ø­Ø°Ù Ø§Ø®Ø±","Ø¨Ù„Ø§Ø´ Ø§Ø®Ø±","Ø§Ù…Ø³Ø­ Ø§Ø®Ø± Ø¹Ù…Ù„ÙŠØ©"],
 search:["Ø§Ø¨Ø­Ø«","Ø¯ÙˆØ±","Ø´ÙˆÙ","Ø´ÙˆÙÙ„ÙŠ","Ù‡Ø§Øª","Ø¯ÙˆØ± Ø¹Ù„Ù‰"]
};


/*-----------------------------------------
 | ğŸ”¥ 7) Auto-Fix (ØªØµØ­ÙŠØ­ Ø¥Ù…Ù„Ø§Ø¦ÙŠ Ø¹Ø§Ù…ÙŠ)
------------------------------------------*/
const autoFix = {
 "ØµØ²": "ØµØ±Ù",
 "Ø¬Ø¨Ù„Ù‰": "Ø¬Ø§Ø¨Ù„ÙÙŠ",
 "Ø¯ÙØ¹ØªÙˆ": "Ø¯ÙØ¹ØªÙ‡",
 "Ù…ØµØ±ÙˆÙØ§Øª": "Ù…ØµØ±ÙˆÙ"
};

function normalize(t){
 for(const k in autoFix){
  t=t.replace(k,autoFix[k]);
 }
 return t;
}


/*-----------------------------------------
 | ğŸ”¥ 8) Intent AI â€“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙŠØ©
------------------------------------------*/
function detectIntent(text){
 for(const key in egyptianSlang){
  for(const phrase of egyptianSlang[key]){
   if(text.includes(phrase)) return key;
  }
 }
 return null;
}


/*-----------------------------------------
 | ğŸ”¥ 9) Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„ÙˆØµÙ
------------------------------------------*/
function extractAmount(t){
 const n=t.match(/\d+(\.\d+)?/);
 return n?parseFloat(n[0]):null;
}
function extractDesc(t,amount){
 return t.replace(amount,"").replace(/Ø¬Ù†ÙŠÙ‡|Ø¬Ù†ÙŠØ©/g,"").trim();
}


/*-----------------------------------------
 | ğŸ”¥ 10) Auto-Learning
------------------------------------------*/
function learn(type,word){
 const key="learn_"+type;
 let arr=JSON.parse(localStorage.getItem(key)||"[]");
 if(!arr.includes(word)){
  arr.push(word);
  localStorage.setItem(key,JSON.stringify(arr));
 }
}


/*-----------------------------------------
 | ğŸ”¥ 11) Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
------------------------------------------*/
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec;

if(SR){
 rec = new SR();
 rec.lang="ar-EG";
 rec.onstart = ()=> mic.classList.add("listening");
 rec.onend   = ()=> mic.classList.remove("listening");

 rec.onresult = async (e)=>{
  let txt = e.results[0][0].transcript;
  txt = normalize(txt);

  const intent = detectIntent(txt);
  const amount = extractAmount(txt);
  const desc   = amount? extractDesc(txt,amount):"";

  /* Ø­Ø°Ù Ø§Ù„ÙƒÙ„ */
  if(intent==="deleteAll"){
    await remove(ref(db,"income"));
    await remove(ref(db,"expenses"));
    Swal.fire("ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","","success");
    return;
  }

  /* Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© */
  if(intent==="deleteLast"){
    if(records.length===0) return Swal.fire("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª","","info");
    const last=records[0];
    await remove(ref(db,`${last.type==='income'?'income':'expenses'}/${last.id}`));
    Swal.fire("ØªÙ… Ø­Ø°Ù Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©","","success");
    return;
  }

  /* Ø¨Ø­Ø« */
  if(intent==="search"){
    Swal.fire("Ø§Ù„Ø¨Ø­Ø« ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø¨Ø¹Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±Ø©");
    return;
  }

  /* Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© (ÙˆØ§Ø±Ø¯/Ù…ØµØ±ÙˆÙ) */
  if(amount){
    let type = "expense";   // Ø§ÙØªØ±Ø§Ø¶ÙŠ
    if(intent==="income") type="income";

    learn(type,desc);

    amountInput.value = amount;
    descInput.value   = desc;

    setMode(type);
    saveTx(null);
    return;
  }

  Swal.fire("Ù„Ù… Ø£ÙÙ‡Ù… Ø§Ù„Ø£Ù…Ø±","", "warning");
 };
}

/* ØªØ´ØºÙŠÙ„ */
window.toggleMic = ()=>{
 if(mic.classList.contains("listening")) rec.stop();
 else rec.start();
};

</script>

</body>
</html>
