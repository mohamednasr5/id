<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø³Ø±ÙŠØ¹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap">
  <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>

  <style>
    :root {
      --primary: #0072ff;
      --bg: #f4f7f6;
    }
    body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; align-items: center; }
    
    .card {
      background: white; width: 95%; max-width: 400px; padding: 25px;
      border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
    }

    h2 { color: var(--primary); margin-top: 0; }

    .input-box { position: relative; margin: 20px 0; }
    
    input {
      width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 12px;
      font-size: 18px; text-align: center; font-family: 'Cairo'; font-weight: bold;
      transition: 0.3s;
    }
    input:focus { border-color: var(--primary); outline: none; }

    /* Ø²Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙƒØ¨ÙŠØ± */
    .cam-btn {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: white; border: none; padding: 15px; width: 100%;
      border-radius: 12px; font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,114,255,0.3);
    }
    .cam-btn:active { transform: scale(0.98); }

    .status { font-size: 14px; margin-top: 10px; color: #666; min-height: 20px; }
    .loading { color: var(--primary); font-weight: bold; }
    
    /* Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‚ØµÙˆØµØ© Ù„Ù„ØªØ£ÙƒØ¯ */
    #debugCanvas {
        max-width: 100%; height: auto; border: 1px dashed #ccc; 
        margin-top: 10px; display: none; border-radius: 8px;
    }
    
    .tips {
        background: #e3f2fd; color: #0d47a1; padding: 10px;
        border-radius: 8px; font-size: 13px; margin-bottom: 20px;
        border: 1px solid #bbdefb;
    }
  </style>
</head>
<body>

<div class="card">
  <h2>ØªØ³Ø¬ÙŠÙ„ Ø³Ø±ÙŠØ¹</h2>
  
  <div class="tips">
      ğŸ’¡ <b>Ù†ØµÙŠØ­Ø© Ù„Ù„Ø³Ø±Ø¹Ø©:</b> Ù‚Ù… Ø¨ØªØµÙˆÙŠØ± <u>Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</u> ÙÙ‚Ø·. <br>
      Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
  </div>

  <button class="cam-btn" onclick="document.getElementById('fileInput').click()">
    ğŸ“¸ ØªØµÙˆÙŠØ± Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
  </button>
  <input type="file" id="fileInput" accept="image/*" capture="environment" hidden onchange="processImage(this)">

  <div class="input-box">
    <label style="display:block; margin-bottom:5px; color:#555;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</label>
    <input type="tel" id="natID" maxlength="14" placeholder="----------------">
  </div>

  <div id="status" class="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø­...</div>
  
  <canvas id="canvas" hidden></canvas>
  <img id="debugCanvas" />

</div>

<script>
  // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ù„Ù…Ø´Ø±Ù‚ÙŠØ©) Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
  const toEnglishDigits = (str) => str.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));

  function processImage(input) {
    if (!input.files[0]) return;
    
    const status = document.getElementById('status');
    const file = input.files[0];
    const reader = new FileReader();

    status.innerHTML = '<span class="loading">â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...</span>';

    reader.onload = function(event) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // 1. ØªØ­Ø¯ÙŠØ¯ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø©
        canvas.width = img.width;
        canvas.height = img.height;

        // 2. Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        ctx.drawImage(img, 0, 0);

        // 3. (Ø§Ù„Ø®Ø¯Ø¹Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ©) Ù‚Øµ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙÙ‚Ø· Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
        // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ ÙÙŠ Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙŠÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø¹Ù„ÙˆÙŠ
        // Ø³Ù†Ø£Ø®Ø° Ø´Ø±ÙŠØ­Ø© Ù…Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ø±ØªÙØ§Ø¹ 25% ÙÙ‚Ø·
        const cropX = 0;
        const cropY = 0;
        const cropWidth = img.width;
        const cropHeight = img.height * 0.25; // Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙÙ‚Ø·

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‚ØµÙˆØµØ©
        const imageData = ctx.getImageData(cropX, cropY, cropWidth, cropHeight);
        
        // ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‚ØµÙˆØµ ÙÙ‚Ø· (Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©)
        canvas.width = cropWidth;
        canvas.height = cropHeight;
        ctx.putImageData(imageData, 0, 0);

        // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© (Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ† - Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‚ØµÙˆØµ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„ØªØ£ÙƒØ¯)
        const debugImg = document.getElementById('debugCanvas');
        debugImg.src = canvas.toDataURL();
        debugImg.style.display = 'block';

        status.innerHTML = '<span class="loading">ğŸ” Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…...</span>';

        // 4. ØªØ´ØºÙŠÙ„ Tesseract Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØµØºÙŠØ± ÙÙ‚Ø·
        Tesseract.recognize(
          canvas.toDataURL(),
          'ara', // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ø£Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©
          { logger: m => console.log(m) }
        ).then(({ data: { text } }) => {
          console.log("Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù…:", text);
          
          // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ
          let cleanText = text.replace(/\s/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
          cleanText = toEnglishDigits(cleanText); // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
          
          // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù…Ø· 14 Ø±Ù‚Ù…
          const match = cleanText.match(/\d{14}/);
          
          if (match) {
            document.getElementById('natID').value = match[0];
            document.getElementById('natID').style.borderColor = '#2ecc71';
            document.getElementById('natID').style.backgroundColor = '#e8f5e9';
            status.innerHTML = 'âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­!';
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù†Ø¬Ø§Ø­
            new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg').play().catch(()=>{});
          } else {
            status.innerHTML = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… ÙˆØ§Ø¶Ø­. Ø­Ø§ÙˆÙ„ ØªÙˆØ¶ÙŠØ­ Ø§Ù„ØµÙˆØ±Ø©.';
            status.style.color = 'red';
          }
        }).catch(err => {
          console.error(err);
          status.innerHTML = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.';
        });
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }
</script>

</body>
</html>
