<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ - Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap">
  <style>
    :root {
      --primary-color: #0072ff;
      --secondary-color: #00c6ff;
      --bg-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
      --input-bg: #f0f4f8;
      --text-color: #2d3436;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
    }
    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: "Cairo", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      overflow: hidden;
      color: var(--text-color);
      position: fixed;
      width: 100%;
      height: 100%;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .circles { position: absolute; width: 100%; height: 100%; overflow: hidden; top: 0; left: 0; z-index: -1; }
    .circles li { position: absolute; display: block; list-style-type: none; width: 20px; height: 20px; background: rgba(255,255,255,0.2); animation: animate 25s linear infinite; bottom: -150px; border-radius: 50%; }
    .circles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
    .circles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
    .circles li:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
    .circles li:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
    .circles li:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
    @keyframes animate {
      0%   { transform: translateY(0) rotate(0); opacity: 1; }
      100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
    }
    .container { width: 100%; padding: 10px; display: flex; justify-content: center; position: relative; z-index: 1; }
    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px 25px;
      width: 100%;
      max-width: 420px;
      box-shadow: var(--glass-shadow);
      border: 1px solid rgba(255,255,255,0.18);
      transform: translateY(20px);
      opacity: 0;
      animation: fadeInUp 0.8s forwards;
      transition: all 0.4s ease;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      overflow-x: hidden;
    }
    @keyframes fadeInUp { to { transform: translateY(0); opacity: 1; } }
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.4s forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    h2 { text-align: center; margin-bottom: 20px; color: var(--primary-color); font-size: 22px; font-weight: 700; }
    h3 { font-size: 16px; margin: 12px 0 8px; padding-bottom: 5px; border-bottom: 2px solid #eee; }
    .input-group { position: relative; margin-bottom: 18px; }
    input {
      width: 100%; padding: 12px 15px; background: var(--input-bg);
      border: 2px solid transparent; border-radius: 10px; font-size: 16px; transition: 0.3s ease;
    }
    input:focus {
      background: #fff; border-color: var(--secondary-color);
      box-shadow: 0 0 15px rgba(0,198,255,0.1);
    }
    .input-group label {
      position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
      color: #999; transition: 0.2s ease; pointer-events: none;
    }
    input:focus + label,
    input:not(:placeholder-shown) + label {
      top: 0; transform: translateY(-50%) scale(0.85); background: #fff; padding: 0 5px; color: var(--primary-color);
    }

    .id-card-visual-container { text-align: center; margin: 10px 0; }
    .id-card-img { max-width: 75%; border-radius: 12px; border: 2px solid rgba(255,255,255,0.6); box-shadow: 0 12px 28px rgba(0,114,255,0.2); animation: floatCard 4s ease-in-out infinite; }
    @keyframes floatCard { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    .btn {
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      color: #fff; padding: 12px; width: 100%; border: none; border-radius: 50px;
      font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,114,255,0.3);
    }
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(1px); }
    .btn-secondary { background: linear-gradient(to right, #43cea2, #185a9d); }
    .btn-danger { background: linear-gradient(to right, #ff416c, #ff4b2b); }
    .btn-warning { background: linear-gradient(to right, #f2994a, #f2c94c); color: #333; }
    .msg { text-align: center; font-size: 13px; margin-top: 10px; min-height: 18px; }
    .msg.error { color: var(--error-color); }
    .msg.success { color: var(--success-color); }
    .duplicate-box {
      background: #fff5f5; border: 2px solid #ff0000; padding: 12px;
      text-align: center; border-radius: 10px; animation: pulseRed 0.7s infinite alternate;
    }
    @keyframes pulseRed { from { box-shadow: 0 0 8px rgba(255,0,0,0.3); } to { box-shadow: 0 0 16px rgba(255,0,0,0.6); } }
    .admin-list-container { max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.7); padding: 5px; border-radius: 10px; }
    .rep-item { display: flex; justify-content: space-between; padding: 8px; }
    .rep-name { font-weight: bold; }
    .session-item { background: #fff; border-right: 4px solid var(--primary-color); padding: 8px; margin-bottom: 5px; border-radius: 5px; }
    .session-kick-btn { background: #333; color: #fff; padding: 4px 10px; border-radius: 4px; border: none; cursor: pointer; }
    .counter-box { background: #f0f7ff; color: #0072ff; padding: 10px 20px; font-size: 16px; border-radius: 12px; margin-bottom: 12px; text-align: center; }
  </style>
</head>
<body>
  <audio id="errorSound"
         src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
         preload="auto"></audio>

  <ul class="circles">
    <li></li><li></li><li></li><li></li><li></li>
    <li></li><li></li><li></li><li></li><li></li>
  </ul>

  <div class="container">
    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div class="card" id="auth-card">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h2>
      <div class="input-group">
        <input id="loginCode" type="tel" inputmode="numeric" placeholder=" ">
        <label for="loginCode">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      </div>
      <button class="btn" id="loginBtn" onclick="login()">
        <span>Ø¯Ø®ÙˆÙ„</span>
      </button>
      <div id="login-msg" class="msg"></div>
    </div>
    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="card hidden" id="main-card">
      <h2 id="welcome">Ù…Ø±Ø­Ø¨Ù‹Ø§</h2>
      <div class="counter-box" id="entryCounterBox">
        Ø¹Ø¯Ø¯ Ø¥Ø¯Ø®Ø§Ù„Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…: <span id="entryCounter">0</span>
        <div class="counter-label">
          ÙŠØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 24 Ø³Ø§Ø¹Ø© Ø­Ø³Ø¨ Ø§Ø³Ù…Ùƒ ÙÙ‚Ø·
        </div>
      </div>
      <div class="input-group">
        <input id="repName" type="text" autocomplete="off" list="repNamesHistory" maxlength="30" placeholder=" ">
        <datalist id="repNamesHistory"></datalist>
        <label for="repName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
      </div>
      <div class="input-group">
        <input id="natID" type="tel" maxlength="14" inputmode="numeric" placeholder=" ">
        <label for="natID">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</label>
      </div>
      <div class="id-card-visual-container">
        <img src="https://raw.githubusercontent.com/mohamednasr5/id/e83438329b0f009f6eebf61b2797496d744589f2/5.png"
             class="id-card-img" alt="Ù…Ø«Ø§Ù„ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©">
      </div>
      <button class="btn" onclick="addUser()">Ø¥Ø¶Ø§ÙØ©</button>
      <div id="add-msg" class="msg"></div>
      <button class="btn btn-secondary" onclick="showStatsLogin()">
        Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© / Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      </button>
      <div style="margin-top:5px;text-align:center;">
        <small onclick="logout()" style="cursor:pointer;color:#777;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</small>
      </div>
    </div>
    <!-- ØµÙØ­Ø© ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± -->
    <div class="card hidden" id="stats-auth-card">
      <h2>ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
      <p style="text-align:center;color:#666;margin-bottom:20px;">
        Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      </p>
      <div class="input-group">
        <input id="statsPass" type="password" placeholder=" ">
        <label for="statsPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      </div>
      <button class="btn" onclick="verifyStats()">Ø¯Ø®ÙˆÙ„</button>
      <div id="stats-msg" class="msg"></div>
      <button class="btn btn-danger" onclick="cancelStats()">Ø¥Ù„ØºØ§Ø¡ ÙˆØ¹ÙˆØ¯Ø©</button>
    </div>
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <div class="card hidden" id="admin-panel-card">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <button class="btn btn-warning" onclick="location.href='stats.html'">
        Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© ğŸ“Š
      </button>
      <h3 style="margin-top:15px;">Ø¹Ø¯Ø§Ø¯ Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ… (Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ)</h3>
      <div class="counter-box">
        <span>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="adminEntryCounter">0</span></span>
        <div style="display:flex;justify-content:center;gap:6px;margin:10px 0;">
          <button class="btn btn-secondary" style="width:auto;padding:4px 16px;" onclick="adminIncCounter()">Ø²ÙŠØ§Ø¯Ø©</button>
          <button class="btn btn-secondary" style="width:auto;padding:4px 16px;" onclick="adminDecCounter()">Ù†Ù‚ØµØ§Ù†</button>
          <button class="btn btn-danger" style="width:auto;padding:4px 16px;" onclick="adminResetCounter()">ØªØµÙÙŠØ±</button>
        </div>
      </div>
      <h3>Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© (Users)</h3>
      <p style="font-size:11px;color:#666;text-align:right;">Ø§Ù„Ù…Ø³Ù…ÙˆØ­: 3 Ø£Ø¬Ù‡Ø²Ø© Ù„ÙƒÙ„ ÙƒÙˆØ¯</p>
      <div class="admin-list-container" id="activeSessionsList"></div>
      <h3>Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (Local)</h3>
      <div class="admin-list-container" id="adminRepList"></div>
      <button class="btn btn-danger" onclick="closeAdminPanel()">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø©</button>
    </div>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      child,
      push,
      remove,
      onValue,
      update
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAxnIxtFeAOjYjCIrU5cwYVteuQ18K8Kjc",
      authDomain: "idmanazla.firebaseapp.com",
      databaseURL: "https://idmanazla-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "idmanazla",
      storageBucket: "idmanazla.firebasestorage.app",
      messagingSenderId: "408446131276",
      appId: "1:408446131276:web:976ae54181b5398de5a8e9"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Device ID Ø«Ø§Ø¨Øª
    function getDeviceId() {
      let id = localStorage.getItem("app_device_id");
      if (!id) {
        id = "dev_" + Math.random().toString(36).substring(2, 10) + Date.now();
        localStorage.setItem("app_device_id", id);
      }
      return id;
    }
    const currentDeviceId = getDeviceId();

    let userPlace = null;
    let userPlaceIdx = null;
    let userID = null;

    // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
    window.login = async function () {
      const code = document.getElementById("loginCode").value.trim();
      const msg = document.getElementById("login-msg");
      msg.textContent = "";
      msg.className = "msg";

      if (code.length < 1) {
        msg.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        msg.classList.add("error");
        return;
      }
      try {
        const snapshot = await get(child(ref(db), "login_codes/" + code));
        if (!snapshot.exists()) {
          msg.textContent = "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­";
          msg.classList.add("error");
          return;
        }
        const data = snapshot.val();
        userID = code;
        userPlace = data.place;
        userPlaceIdx = data.placeIdx || 0;

        // Ø­Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© 3 Ø£Ø¬Ù‡Ø²Ø©
        await enforceSessionLimit(code);
        await set(ref(db, `active_sessions/${code}/${currentDeviceId}`), {
          loginTime: Date.now(),
          expiresAt: Date.now() + 30 * 60 * 1000
        });
        document.getElementById("welcome").textContent = "Ù…Ø±Ø­Ø¨Ù‹Ø§ â€” " + userPlace;
        document.getElementById("auth-card").classList.add("hidden");
        document.getElementById("main-card").classList.remove("hidden");
        document.getElementById("main-card").classList.add("fade-in");
      } catch (e) {
        msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
        msg.classList.add("error");
      }
    };

    async function enforceSessionLimit(code) {
      const snap = await get(child(ref(db), "active_sessions/" + code));
      if (!snap.exists()) return;
      const sessions = snap.val();
      const devices = Object.keys(sessions);
      for (let d of devices) {
        if (sessions[d].expiresAt < Date.now()) {
          await remove(ref(db, `active_sessions/${code}/${d}`));
        }
      }
      const updatedSnap = await get(child(ref(db), "active_sessions/" + code));
      if (!updatedSnap.exists()) return;
      const updated = updatedSnap.val();
      const updatedDevices = Object.keys(updated);
      if (updatedDevices.length >= 3 && !updatedDevices.includes(currentDeviceId)) {
        const sorted = updatedDevices.sort((a, b) => updated[a].loginTime - updated[b].loginTime);
        const oldest = sorted[0];
        await remove(ref(db, `active_sessions/${code}/${oldest}`));
      }
    }

    window.logout = async function () {
      if (userID) {
        await remove(ref(db, `active_sessions/${userID}/${currentDeviceId}`));
      }
      location.reload();
    };

    function saveRepName(name) {
      let stored = JSON.parse(localStorage.getItem("saved_rep_names") || "[]");
      if (!stored.includes(name)) {
        stored.push(name);
        localStorage.setItem("saved_rep_names", JSON.stringify(stored));
      }
      loadRepNames();
    }

    function loadRepNames() {
      let stored = JSON.parse(localStorage.getItem("saved_rep_names") || "[]");
      const list = document.getElementById("repNamesHistory");
      if (!list) return;
      list.innerHTML = "";
      stored.forEach(n => {
        let o = document.createElement("option");
        o.value = n;
        list.appendChild(o);
      });
    }
    loadRepNames();

    let lastAddTime = 0;
    window.addUser = async function () {
      const msg = document.getElementById("add-msg");
      msg.textContent = "";
      msg.className = "msg";
      if (Date.now() - lastAddTime < 1200) {
        msg.textContent = "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø© Ø¨ÙŠÙ† ÙƒÙ„ Ø¥Ø¯Ø®Ø§Ù„â€¦";
        msg.classList.add("error");
        return;
      }
      lastAddTime = Date.now();
      const name = document.getElementById("repName").value.trim();
      const natid = document.getElementById("natID").value.trim();
      if (name.length < 2) {
        msg.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨";
        msg.classList.add("error");
        return;
      }
      if (!/^\d{14}$/.test(natid)) {
        msg.textContent = "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù… ØµØ­ÙŠØ­";
        msg.classList.add("error");
        return;
      }
      if (!userPlace) {
        msg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ â€” Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        msg.classList.add("error");
        return;
      }
      try {
        const userRef = ref(db, "users/" + natid);
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          document.getElementById("errorSound").play().catch(() => {});
          msg.className = "duplicate-box";
          msg.innerHTML = `
            âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ ØªÙƒØ±Ø§Ø±<br>
            Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ ÙÙŠ: <b>${data.place}</b><br>
            Ø¨ÙˆØ§Ø³Ø·Ø©: <b>${data.repName}</b>
          `;
          await push(ref(db, "duplicates"), {
            duplicatedID: natid,
            attemptByRep: name,
            attemptPlace: userPlace,
            originalRep: data.repName,
            originalPlace: data.place,
            timestamp: new Date().toISOString()
          });
          saveRepName(name);
          return;
        }
        await set(userRef, {
          natid,
          repName: name,
          place: userPlace,
          placeIdx: userPlaceIdx,
          time: new Date().toISOString(),
          username: userID
        });
        saveRepName(name);
        msg.textContent = "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­";
        msg.classList.add("success");
        document.getElementById("natID").value = "";
        document.getElementById("natID").focus();
        incrementEntryCounter();
      } catch (e) {
        msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
        msg.classList.add("error");
      }
    };

    function getEntryData() {
      return JSON.parse(localStorage.getItem("entry_counter_names") || "{}");
    }
    function setEntryData(d) {
      localStorage.setItem("entry_counter_names", JSON.stringify(d));
    }
    function getActiveRepName() {
      const repNameInput = document.getElementById("repName");
      return repNameInput ? repNameInput.value.trim() : "";
    }
    function loadEntryCounter() {
      const counterEl = document.getElementById("entryCounter");
      const name = getActiveRepName();
      const today = new Date().toISOString().substring(0, 10);
      let entryData = getEntryData();
      if (!name) {
        counterEl.textContent = 0;
        return;
      }
      if (!entryData[name] || entryData[name].date !== today) {
        entryData[name] = { date: today, count: 0 };
        setEntryData(entryData);
      }
      counterEl.textContent = entryData[name].count;
    }
    function incrementEntryCounter() {
      const name = getActiveRepName();
      const today = new Date().toISOString().substring(0, 10);
      let entryData = getEntryData();
      if (!entryData[name] || entryData[name].date !== today) {
        entryData[name] = { date: today, count: 1 };
      } else {
        entryData[name].count++;
      }
      setEntryData(entryData);
      loadEntryCounter();
    }
    document.addEventListener("DOMContentLoaded", () => {
      const repNameInput = document.getElementById("repName");
      if (repNameInput) {
        repNameInput.addEventListener("input", () => {
          loadEntryCounter();
          adminLoadCounter();
        });
      }
    });

    window.adminIncCounter = function () {
      let val = parseInt(document.getElementById("adminEntryCounter").textContent) || 0;
      adminSetCounter(val + 1);
    };
    window.adminDecCounter = function () {
      let val = parseInt(document.getElementById("adminEntryCounter").textContent) || 0;
      adminSetCounter(val - 1);
    };
    window.adminResetCounter = function () {
      adminSetCounter(0);
    };
    function adminSetCounter(val) {
      const name = getActiveRepName();
      if (!name) return;
      const today = new Date().toISOString().substring(0, 10);
      let entryData = getEntryData();
      entryData[name] = { date: today, count: Math.max(0, val) };
      setEntryData(entryData);
      adminLoadCounter();
      loadEntryCounter();
    }
    function adminLoadCounter() {
      const counterEl = document.getElementById("adminEntryCounter");
      const name = getActiveRepName();
      const today = new Date().toISOString().substring(0, 10);
      let entryData = getEntryData();
      if (!name) {
        counterEl.textContent = 0;
        return;
      }
      if (!entryData[name] || entryData[name].date !== today) {
        entryData[name] = { date: today, count: 0 };
        setEntryData(entryData);
      }
      counterEl.textContent = entryData[name].count;
    }
    window.showStatsLogin = function () {
      document.getElementById("main-card").classList.add("hidden");
      const card = document.getElementById("stats-auth-card");
      card.classList.remove("hidden");
      card.classList.add("fade-in");
      document.getElementById("statsPass").value = "";
    };
    window.cancelStats = function () {
      document.getElementById("stats-auth-card").classList.add("hidden");
      document.getElementById("main-card").classList.remove("hidden");
    };
    window.verifyStats = function () {
      const pass = document.getElementById("statsPass").value;
      const msg = document.getElementById("stats-msg");
      if (pass === "521988") {
        msg.textContent = "âœ” ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„";
        msg.classList.add("success");
        setTimeout(() => {
          document.getElementById("stats-auth-card").classList.add("hidden");
          document.getElementById("admin-panel-card").classList.remove("hidden");
          renderAdminRepList();
          fetchActiveSessions();
        }, 500);
      } else {
        msg.textContent = "Ø®Ø·Ø£!";
        msg.classList.add("error");
      }
    };
    function renderAdminRepList() {
      const container = document.getElementById("adminRepList");
      const stored = JSON.parse(localStorage.getItem("saved_rep_names") || "[]");
      container.innerHTML = "";
      if (stored.length === 0) {
        container.innerHTML = `<div class="empty-list">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡ Ù…Ø­ÙÙˆØ¸Ø©</div>`;
        return;
      }
      stored.forEach(name => {
        const div = document.createElement("div");
        div.className = "rep-item";
        div.innerHTML = `
          <span class="rep-name">${name}</span>
          <button class="btn-delete-rep" onclick="deleteRepName('${name}')">Ø­Ø°Ù</button>
        `;
        container.appendChild(div);
      });
    }
    window.deleteRepName = function (name) {
      let stored = JSON.parse(localStorage.getItem("saved_rep_names") || "[]");
      stored = stored.filter(n => n !== name);
      localStorage.setItem("saved_rep_names", JSON.stringify(stored));
      renderAdminRepList();
    };
    function fetchActiveSessions() {
      const container = document.getElementById("activeSessionsList");
      container.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦";
      const sessionsRef = ref(db, "active_sessions");
      onValue(sessionsRef, snap => {
        container.innerHTML = "";
        if (!snap.exists()) {
          container.innerHTML = `<div class="empty-list">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª</div>`;
          return;
        }
        const all = snap.val();
        Object.keys(all).forEach(code => {
          const devices = all[code];
          const header = document.createElement("div");
          header.style.cssText = "background:#eee;padding:5px;margin-top:5px;font-weight:bold;";
          header.textContent = `Ø§Ù„ÙƒÙˆØ¯: ${code} (Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©: ${Object.keys(devices).length})`;
          container.appendChild(header);
          Object.keys(devices).forEach(devID => {
            const d = devices[devID];
            const time = new Date(d.loginTime).toLocaleTimeString("ar-EG");
            const row = document.createElement("div");
            row.className = "session-item";
            row.innerHTML = `
              <div>
                <span style="font-weight:bold;">Ø¬Ù‡Ø§Ø²</span>
                <span class="device-info">${time}</span>
                <span class="device-info">${devID}</span>
              </div>
              <button class="session-kick-btn" onclick="kickUser('${code}','${devID}')">Ø·Ø±Ø¯</button>
            `;
            container.appendChild(row);
          });
        });
      });
    }
    window.kickUser = async function (code, devID) {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
        await remove(ref(db, `active_sessions/${code}/${devID}`));
      }
    };
    window.closeAdminPanel = function () {
      document.getElementById("admin-panel-card").classList.add("hidden");
      document.getElementById("main-card").classList.remove("hidden");
    };
  </script>
</body>
</html>
