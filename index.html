<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ - Ù…Ø§Ø³Ø­ Ø°ÙƒÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap">
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  
  <style>
    :root {
      --primary-color: #0072ff;
      --secondary-color: #00c6ff;
      --bg-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
      --input-bg: #f0f4f8;
      --text-color: #2d3436;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
    }

    * { box-sizing: border-box; outline: none; }

    body {
      font-family: 'Cairo', sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      overflow: hidden; /* Ù„Ù…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù…Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
      color: var(--text-color);
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
    .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; margin: 0; padding: 0; }
    .circles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.2); animation: animate 25s linear infinite; bottom: -150px; border-radius: 50%; }
    .circles li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
    .circles li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
    .circles li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
    .circles li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
    .circles li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
    @keyframes animate { 0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } }

    .container { position: relative; z-index: 1; perspective: 1000px; width: 100%; display: flex; justify-content: center; }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border-radius: 20px; padding: 40px 30px;
      width: 100%; max-width: 400px;
      box-shadow: var(--glass-shadow);
      border: 1px solid rgba(255, 255, 255, 0.18);
      transform: translateY(20px); opacity: 0;
      animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      transition: all 0.5s ease;
    }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

    h2 { text-align: center; margin-bottom: 30px; color: var(--primary-color); font-weight: 700; font-size: 24px; }

    .input-group { position: relative; margin-bottom: 25px; }

    .input-group label {
      position: absolute; top: 50%; right: 15px; transform: translateY(-50%);
      font-size: 16px; color: #999; pointer-events: none;
      transition: 0.3s ease all; padding: 0 5px; background: transparent;
    }

    input, select {
      width: 100%; padding: 12px 15px; font-size: 16px;
      background: var(--input-bg); border: 2px solid transparent;
      border-radius: 10px; font-family: 'Cairo', sans-serif;
      transition: 0.3s ease; color: #333;
    }
    input:focus, input:not(:placeholder-shown) { background: #fff; border-color: var(--secondary-color); box-shadow: 0 0 15px rgba(0, 198, 255, 0.1); }
    input:focus ~ label, input:not(:placeholder-shown) ~ label { top: 0; transform: translateY(-50%) scale(0.85); background: #fff; color: var(--primary-color); font-weight: 600; border-radius: 5px; }

    .btn {
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      color: white; padding: 12px; width: 100%; border: none;
      border-radius: 50px; font-size: 18px; font-weight: 700; cursor: pointer;
      transition: 0.3s ease; box-shadow: 0 5px 15px rgba(0, 114, 255, 0.3);
      position: relative; overflow: hidden;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 114, 255, 0.4); }
    .btn:active { transform: translateY(1px); }
    .btn-secondary { background: linear-gradient(to right, #43cea2, #185a9d); margin-top: 15px; }
    .btn-danger { background: linear-gradient(to right, #ff416c, #ff4b2b); margin-top: 15px; }

    .msg { margin-top: 15px; text-align: center; font-size: 14px; font-weight: 600; min-height: 20px; transition: 0.3s; padding: 10px; border-radius: 8px; }
    .msg.error { color: var(--error-color); animation: shake 0.5s; }
    .msg.success { color: var(--success-color); }

    .duplicate-box {
        background-color: #fff5f5; border: 2px solid #ff0000; color: #c0392b;
        padding: 15px; border-radius: 12px; margin-top: 20px; font-weight: bold;
        box-shadow: 0 4px 15px rgba(255, 0, 0, 0.2); animation: pulseRed 0.8s infinite alternate;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    @keyframes pulseRed { from { border-color: #ff0000; } to { border-color: #ff6b6b; } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(10px); } 75% { transform: translateX(-10px); } }

    /* --- Ø²Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ --- */
    .scan-btn {
        position: absolute; left: 5px; top: 50%; transform: translateY(-50%);
        background: none; border: none; cursor: pointer; font-size: 1.5rem;
        color: var(--primary-color); padding: 5px; transition: 0.3s;
        z-index: 10;
    }
    .scan-btn:hover { transform: translateY(-50%) scale(1.1); color: var(--secondary-color); }

    /* --- Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Overlay) --- */
    #camera-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999; display: none;
        flex-direction: column; align-items: center; justify-content: center;
    }
    #camera-overlay.active { display: flex; }
    
    .camera-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
    video { width: 100%; height: 100%; object-fit: cover; }
    
    .scan-area {
        position: absolute; width: 80%; height: 100px;
        border: 2px solid #00c6ff; border-radius: 12px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
        z-index: 10;
    }
    .scan-line {
        width: 100%; height: 2px; background: #ef4444;
        position: absolute; top: 50%;
        animation: scanMove 2s infinite;
    }
    @keyframes scanMove { 0% { top: 10%; opacity: 0; } 50% { opacity: 1; } 100% { top: 90%; opacity: 0; } }

    .camera-controls {
        position: absolute; bottom: 30px; z-index: 20; width: 100%;
        display: flex; flex-direction: column; align-items: center; gap: 10px;
    }
    .close-camera {
        background: #ef4444; color: white; border: none; padding: 10px 30px;
        border-radius: 30px; font-weight: bold; cursor: pointer;
    }
    .scan-status { color: white; font-weight: bold; text-shadow: 0 2px 4px black; margin-bottom: 10px; direction: ltr; }
    
    canvas { display: none; }
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.5s forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 480px) { .card { padding: 30px 20px; margin: 20px; width: 90%; } }
  </style>
</head>
<body>

  <audio id="errorSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="scanSound" src="https://actions.google.com/sounds/v1/science_fiction/scifi_laser.ogg" preload="auto"></audio>

  <ul class="circles">
    <li></li><li></li><li></li><li></li><li></li>
    <li></li><li></li><li></li><li></li><li></li>
  </ul>

  <div id="camera-overlay">
      <div class="camera-container">
          <video id="video" autoplay playsinline muted></video>
          <div class="scan-area"><div class="scan-line"></div></div>
          <div class="camera-controls">
              <div class="scan-status" id="scan-status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>
              <button class="close-camera" onclick="stopScanner()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ âŒ</button>
          </div>
      </div>
  </div>
  <canvas id="canvas"></canvas>

  <div class="container">
    
    <div class="card" id="auth-card">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h2>
      <div class="input-group">
        <input id="loginCode" type="number" placeholder=" ">
        <label for="loginCode">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      </div>
      <button class="btn" onclick="login()"><span>Ø¯Ø®ÙˆÙ„</span></button>
      <div id="login-msg" class="msg"></div>
    </div>

    <div class="card hidden" id="main-card">
      <h2 id="welcome">Ù…Ø±Ø­Ø¨Ù‹Ø§</h2>
      
      <div class="input-group">
        <input id="repName" type="text" autocomplete="off" maxlength="30" placeholder=" ">
        <label for="repName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
      </div>
      
      <div class="input-group">
        <input id="natID" type="text" autocomplete="off" placeholder=" " style="padding-left: 40px;">
        <label for="natID">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ / Ø±Ù‚Ù… Ø§Ù„Ù…ØµÙ†Ø¹</label>
        <button class="scan-btn" onclick="startScanner()" title="Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ğŸ“·</button>
      </div>
      
      <button class="btn" onclick="addUser()">Ø¥Ø¶Ø§ÙØ©</button>
      <div id="add-msg" class="msg"></div>
      <button class="btn btn-secondary" onclick="showStatsLogin()">ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    </div>

    <div class="card hidden" id="stats-auth-card">
      <h2>ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
      <p style="text-align: center; color: #666; margin-bottom: 20px;">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
      <div class="input-group">
        <input id="statsPass" type="password" placeholder=" ">
        <label for="statsPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      </div>
      <button class="btn" onclick="verifyStats()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
      <div id="stats-msg" class="msg"></div>
      <button class="btn btn-danger" onclick="cancelStats()">Ø¥Ù„ØºØ§Ø¡ ÙˆØ¹ÙˆØ¯Ø©</button>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxnIxtFeAOjYjCIrU5cwYVteuQ18K8Kjc",
      authDomain: "idmanazla.firebaseapp.com",
      databaseURL: "https://idmanazla-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "idmanazla",
      storageBucket: "idmanazla.firebasestorage.app",
      messagingSenderId: "408446131276",
      appId: "1:408446131276:web:976ae54181b5398de5a8e9",
      measurementId: "G-9YSW9HNYTG"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const places = [
      "Ø§Ù„Ù…Ù†Ø²Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 1","Ø§Ù„Ù…Ù†Ø²Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 2","Ø¨Ø­Ø± Ø§Ù„Ø¨Ù„Ø¯ Ø´Ø§Ø±Ø¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†",
      "Ù…Ø¯Ø±Ø³Ø© Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø§Ù„ Ø´Ù„Ø¨ÙŠØ§ÙŠØ©","Ù…ØµÙ†Ø¹ Ø§Ù„Ø¨ØµÙ„","Ø§Ù„ÙƒÙØ± 1","Ø§Ù„ÙƒÙØ± 2 ØªØ­Øª Ø§Ù„Ø³ÙƒØ©",
      "Ø³ÙˆÙ‚ Ø§Ù„Ø¬Ù…Ù„Ø©","Ø§Ù„ÙØ¯Ø§Ø¡","Ù†Ù‚Ø·Ø© Ø­Ù…Ø§Ù… Ø§Ù„ÙƒÙŠØ§Ù„","Ø§Ù„Ø­Ù…Ø²Ø§ÙˆÙŠ","Ø§Ù„Ø¬Ø±Ù† 1","Ø§Ù„Ø¬Ø±Ù† 2",
      "Ø§Ù„Ø¨Ø± Ø§Ù„ØªØ§Ù†ÙŠ Ø­ÙŠ Ø§Ù„Ø³Ù„Ø§Ù…","Ø­ÙŠ Ø§Ù„Ø§Ø¹Ø¬Ø§Ù…","Ø§Ù„Ø¹Ø²Ø¨Ø© Ù…Ù†Ø´ÙŠØ© Ù†Ø§ØµØ±","Ø§Ù„Ø·ÙˆÙŠÙ„",
      "Ø§Ù„Ø¨Ø± Ø§Ù„ØªØ§Ù†ÙŠ 2 Ø§Ù„Ù‡Ø§ÙˆÙŠØ³","Ø§Ù„ÙÙ‚Ø§Ø¹ÙŠ","Ø¨Ø­Ø± Ø§Ù„Ø¨Ù„Ø¯ 2","Ø­ÙŠ Ø§Ù„Ø¬Ø¨Ø§Ù†Ø©",
      "Ø§Ù„ÙƒÙØ± 3 Ø¨Ø¬ÙˆØ§Ø± Ù…Ù„Ø¹Ø¨ Ø¨Ø±Ø´Ù„ÙˆÙ†Ø©","Ù…Ù‚Ù‡ÙŠ Ø£Ø¨Ùˆ Ø³Ù„ÙŠÙ…Ø§Ù†","Ø­ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡"
    ];

    let userPlace = null, userPlaceIdx = null, userID = null;

    // --- Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    window.login = function() {
      const msgDiv = document.getElementById('login-msg');
      msgDiv.textContent = ''; msgDiv.className = 'msg';
      const codeInput = document.getElementById('loginCode').value.trim();
      const code = parseInt(codeInput);

      if (!codeInput || isNaN(code) || code < 225501 || code > 225522) {
        msgDiv.textContent = 'ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.';
        msgDiv.classList.add('error'); return;
      }

      let idx = code - 225501;
      if (idx >= places.length) {
          msgDiv.textContent = 'ÙƒÙˆØ¯ ØµØ­ÙŠØ­ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±Ù Ø¨Ø§Ù„Ù†Ø¸Ø§Ù….';
          msgDiv.classList.add('error'); return;
      }

      userPlace = places[idx];
      userPlaceIdx = idx + 1;
      userID = codeInput;

      const authCard = document.getElementById('auth-card');
      const mainCard = document.getElementById('main-card');

      authCard.style.opacity = '0';
      authCard.style.transform = 'translateY(-20px)';
      
      setTimeout(() => {
        authCard.classList.add('hidden');
        mainCard.classList.remove('hidden');
        mainCard.classList.add('fade-in');
        document.getElementById('welcome').textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙÙŠ ${userPlace}`;
      }, 400);
    }

    // --- Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø­Ø¯Ø«) ---
    window.addUser = async function() {
      const btn = event.target;
      const originalText = btn.innerText;
      
      let name = document.getElementById('repName').value.trim();
      let inputID = document.getElementById('natID').value.trim().toUpperCase(); // ØªØ­ÙˆÙŠÙ„ Ù„Ø­Ø±ÙˆÙ ÙƒØ¨ÙŠØ±Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
      const msg = document.getElementById('add-msg');
      msg.textContent = ''; msg.className = 'msg';

      if (!userPlace) return;
      if (name.length < 2) {
        msg.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨'; msg.className += ' error'; return;
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„: Ø¥Ù…Ø§ 14 Ø±Ù‚Ù… (Ù‚ÙˆÙ…ÙŠ) Ø£Ùˆ 7 Ø®Ø§Ù†Ø§Øª (Ù…ØµÙ†Ø¹)
      const isNatID = /^\d{14}$/.test(inputID);
      const isFactoryCode = /^[A-Z0-9]{7}$/.test(inputID);

      if (!isNatID && !isFactoryCode) {
        msg.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ ØµØ­ÙŠØ­ (14 Ø±Ù‚Ù…) Ø£Ùˆ Ø±Ù‚Ù… Ù…ØµÙ†Ø¹ (7 Ø®Ø§Ù†Ø§Øª).'; 
        msg.className += ' error'; return;
      }

      btn.disabled = true; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';

      try {
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¯Ø®Ù„ (Ø³ÙˆØ§Ø¡ Ù‚ÙˆÙ…ÙŠ Ø£Ùˆ Ù…ØµÙ†Ø¹) ÙƒÙ…ÙØªØ§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ø£Ùˆ Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ù…ØµÙ†Ø¹
        const snapshot = await get(child(ref(db), 'users/' + inputID));
        
        if (snapshot.exists()) {
          // --- Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ ØªÙƒØ±Ø§Ø± ---
          let data = snapshot.val();
          
          document.getElementById('errorSound').play().catch(e => console.log('Audio play blocked'));

          msg.className = 'duplicate-box';
          msg.innerHTML = `
            <span>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ ØªÙƒØ±Ø§Ø±!</span>
            <div style="margin-top:5px; font-size:13px; color:#333;">
             ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ (${isNatID ? 'Ù‚ÙˆÙ…ÙŠ' : 'ÙƒÙˆØ¯ Ù…ØµÙ†Ø¹'}) Ù…Ù† Ù‚Ø¨Ù„ ÙÙŠ <br>
             <b style="color:#d32f2f; font-size:15px;">${data.place}</b> <br>
             Ø¨ÙˆØ§Ø³Ø·Ø© <b style="color:#d32f2f; font-size:15px;">${data.repName}</b>
            </div>
          `;

          const duplicateData = {
             duplicatedID: inputID,
             attemptByRep: name,
             attemptPlace: userPlace,
             originalRep: data.repName,
             originalPlace: data.place,
             timestamp: new Date().toISOString(),
             status: "rejected",
             type: isNatID ? "NationalID" : "FactoryCode"
          };
          await push(ref(db, 'duplicates'), duplicateData);

        } else {
          // --- Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
          const now = new Date();
          let payload = {
            idValue: inputID, // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
            inputType: isNatID ? "NationalID" : "FactoryCode",
            repName: name, 
            place: userPlace, 
            placeIdx: userPlaceIdx,
            time: now.toISOString(), 
            username: userID
          };
          await set(ref(db, 'users/' + inputID), payload);
          msg.className += ' success';
          msg.textContent = "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­.";
          document.getElementById('natID').value = '';
          document.getElementById('natID').focus();
        }
      } catch (error) {
        msg.className = 'msg error';
        msg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.innerText = originalText;
      }
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ---
    window.showStatsLogin = function() {
        document.getElementById('main-card').classList.add('hidden');
        const statsCard = document.getElementById('stats-auth-card');
        statsCard.classList.remove('hidden');
        statsCard.classList.add('fade-in');
        document.getElementById('statsPass').value = '';
        document.getElementById('stats-msg').textContent = '';
        document.getElementById('statsPass').focus();
    }

    window.cancelStats = function() {
        document.getElementById('stats-auth-card').classList.add('hidden');
        const mainCard = document.getElementById('main-card');
        mainCard.classList.remove('hidden');
        mainCard.classList.add('fade-in');
    }

    window.verifyStats = function() {
        const pass = document.getElementById('statsPass').value;
        const msg = document.getElementById('stats-msg');
        if(pass === '251988') {
            msg.className = 'msg success';
            msg.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØµØ­ÙŠØ­Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...';
            setTimeout(() => { location.href = 'stats.html'; }, 1000);
        } else {
            msg.className = 'msg error';
            msg.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!';
        }
    }
  </script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const overlay = document.getElementById('camera-overlay');
    const statusText = document.getElementById('scan-status-text');
    const natIdInput = document.getElementById('natID');
    const scanSound = document.getElementById('scanSound');
    
    let isScanning = false;
    let worker = null;

    async function startScanner() {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ (HTTPS Ø¶Ø±ÙˆØ±ÙŠ)
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            alert('ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ø¨Ø± HTTPS Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
            return;
        }

        overlay.classList.add('active');
        statusText.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...";

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
            });
            video.srcObject = stream;
            
            // ØªÙ‡ÙŠØ¦Ø© Tesseract Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
            if(!worker) {
                statusText.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...";
                worker = await Tesseract.createWorker('eng');
                await worker.setParameters({
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', // Ø­Ø±ÙˆÙ ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
                });
            }

            statusText.textContent = "ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø±Ù‚Ù… (Ù‚ÙˆÙ…ÙŠ Ø£Ùˆ Ù…ØµÙ†Ø¹)";
            isScanning = true;
            requestAnimationFrame(scanLoop);

        } catch (err) {
            console.error(err);
            alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.");
            stopScanner();
        }
    }

    function stopScanner() {
        isScanning = false;
        overlay.classList.remove('active');
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }

    async function scanLoop() {
        if (!isScanning) return;

        const ctx = canvas.getContext('2d');
        canvas.width = 400; 
        canvas.height = 150; 
        
        // Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ù…Ù†ØªØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„Ù…Ø±Ø¨Ø¹)
        const sx = (video.videoWidth - canvas.width) / 2;
        const sy = (video.videoHeight - canvas.height) / 2;
        
        // Ø±Ø³Ù… Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆØ³Ø· ÙÙ‚Ø· Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Ø£Ø³Ø±Ø¹)
        if(video.readyState === video.HAVE_ENOUGH_DATA){
            ctx.drawImage(video, sx, sy, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
            
            try {
                const { data: { text } } = await worker.recognize(canvas);
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ
                const clean = text.replace(/[^A-Z0-9]/g, '');
                
                // 1. Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)
                const natMatch = clean.match(/\d{14}/);
                
                // 2. Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ù…ØµÙ†Ø¹ (7 Ø®Ø§Ù†Ø§Øª Ø­Ø±ÙˆÙ ÙˆØ£Ø±Ù‚Ø§Ù…) - Ù†Ù…Ø· Ø¹Ø§Ù…
                const factoryMatch = clean.match(/[A-Z0-9]{7}/);

                if (natMatch) {
                    foundCode(natMatch[0]);
                } else if (factoryMatch) {
                    foundCode(factoryMatch[0]);
                } else {
                    if(isScanning) requestAnimationFrame(scanLoop);
                }
            } catch (e) {
                if(isScanning) requestAnimationFrame(scanLoop);
            }
        } else {
            requestAnimationFrame(scanLoop);
        }
    }

    function foundCode(code) {
        scanSound.play().catch(e=>{});
        navigator.vibrate(200); // Ø§Ù‡ØªØ²Ø§Ø²
        natIdInput.value = code;
        stopScanner();
        // ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø­Ù‚Ù„ Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        natIdInput.style.backgroundColor = "#e8f5e9";
        setTimeout(() => natIdInput.style.backgroundColor = "", 1000);
    }

    // Ø¥ØªØ§Ø­Ø© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ù€ HTML
    window.startScanner = startScanner;
    window.stopScanner = stopScanner;
  </script>
</body>
</html>
