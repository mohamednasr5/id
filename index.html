<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ - Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap">
  <style>
    :root {
      --primary-color: #0072ff;
      --secondary-color: #00c6ff;
      --bg-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
      --input-bg: #f0f4f8;
      --text-color: #2d3436;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
      --message-color: #9b59b6;
    }
    * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
    body {
      font-family: "Cairo", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      overflow: hidden;
      color: var(--text-color);
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .circles { position: absolute; width: 100%; height: 100%; overflow: hidden; top: 0; left: 0; z-index: 0; }
    .circles li { position: absolute; display: block; list-style-type: none; width: 20px; height: 20px; background: rgba(255,255,255,0.2); animation: animate 25s linear infinite; bottom: -150px; border-radius: 50%; }
    .circles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
    .circles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
    .circles li:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
    .circles li:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
    .circles li:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
    @keyframes animate {
      0%   { transform: translateY(0) rotate(0); opacity: 1; }
      100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
    }
    .container { 
      width: 100%; 
      height: 100vh;
      display: flex; 
      justify-content: center; 
      align-items: center;
      position: relative; 
      z-index: 1; 
      padding: 15px;
    }
    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px 18px;
      width: 100%;
      max-width: 400px;
      max-height: calc(100vh - 30px);
      box-shadow: var(--glass-shadow);
      border: 1px solid rgba(255,255,255,0.18);
      transform: translateY(20px);
      opacity: 0;
      animation: fadeInUp 0.8s forwards;
      transition: all 0.4s ease;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .card::-webkit-scrollbar {
      width: 6px;
    }
    .card::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 10px;
    }
    .card::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }
    
    @keyframes fadeInUp { to { transform: translateY(0); opacity: 1; } }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.4s forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    h2 { text-align: center; margin-bottom: 15px; color: var(--primary-color); font-size: 20px; font-weight: 700; }
    h3 { font-size: 14px; margin: 10px 0 6px; padding-bottom: 4px; border-bottom: 2px solid #eee; }
    .input-group { position: relative; margin-bottom: 14px; }
    input {
      width: 100%; padding: 10px 12px; background: var(--input-bg);
      border: 2px solid transparent; border-radius: 10px; font-size: 15px; transition: 0.3s ease;
      font-family: "Cairo", sans-serif;
    }
    input:focus {
      background: #fff; border-color: var(--secondary-color);
      box-shadow: 0 0 15px rgba(0,198,255,0.1);
    }
    .input-group label {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      color: #999; transition: all 0.2s ease; pointer-events: none; font-size: 14px;
      opacity: 1;
    }
    input:focus + label,
    input:not(:placeholder-shown) + label {
      opacity: 0;
      transform: translateY(-50%) scale(0.9);
    }

    .id-card-visual-container { text-align: center; margin: 8px 0; }
    .id-card-img { 
      max-width: 65%; 
      border-radius: 10px; 
      border: 2px solid rgba(255,255,255,0.6); 
      box-shadow: 0 8px 20px rgba(0,114,255,0.2); 
      animation: floatCard 4s ease-in-out infinite; 
    }
    @keyframes floatCard { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    
    .btn {
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      color: #fff; padding: 10px; width: 100%; border: none; border-radius: 50px;
      font-weight: 700; cursor: pointer; font-size: 15px; transition: 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,114,255,0.3);
      font-family: "Cairo", sans-serif;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(1px); }
    .btn-secondary { background: linear-gradient(to right, #43cea2, #185a9d); margin-top: 8px; }
    .btn-danger { background: linear-gradient(to right, #ff416c, #ff4b2b); margin-top: 8px; }
    .btn-warning { background: linear-gradient(to right, #f2994a, #f2c94c); color: #333; }
    .btn-info { background: linear-gradient(to right, #3498db, #2980b9); margin-top: 8px; }
    .btn-message { background: linear-gradient(to right, #9b59b6, #8e44ad); margin-top: 8px; position: relative; }
    .btn-delete-rep { 
      background: #ff4757; color: white; border: none; padding: 3px 10px; 
      border-radius: 5px; cursor: pointer; font-size: 11px; font-family: "Cairo", sans-serif;
    }
    .msg { text-align: center; font-size: 12px; margin-top: 8px; min-height: 16px; }
    .msg.error { color: var(--error-color); }
    .msg.success { color: var(--success-color); }
    .duplicate-box {
      background: #fff5f5; border: 2px solid #ff0000; padding: 10px;
      text-align: center; border-radius: 10px; animation: pulseRed 0.7s infinite alternate;
      font-size: 13px;
    }
    @keyframes pulseRed { from { box-shadow: 0 0 8px rgba(255,0,0,0.3); } to { box-shadow: 0 0 16px rgba(255,0,0,0.6); } }
    .admin-list-container { 
      max-height: 150px; 
      overflow-y: auto; 
      background: rgba(255,255,255,0.7); 
      padding: 5px; 
      border-radius: 8px; 
      font-size: 13px;
    }
    .admin-list-container::-webkit-scrollbar {
      width: 5px;
    }
    .admin-list-container::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 5px;
    }
    .rep-item { display: flex; justify-content: space-between; padding: 6px; align-items: center; font-size: 13px; }
    .rep-name { font-weight: bold; }
    .session-item { background: #fff; border-right: 3px solid var(--primary-color); padding: 6px; margin-bottom: 4px; border-radius: 5px; font-size: 12px; }
    .session-kick-btn { background: #333; color: #fff; padding: 3px 8px; border-radius: 4px; border: none; cursor: pointer; font-family: "Cairo", sans-serif; font-size: 11px; }
    .counter-box { 
      background: #f0f7ff; 
      color: #0072ff; 
      padding: 8px 15px; 
      font-size: 14px; 
      border-radius: 10px; 
      margin-bottom: 10px; 
      text-align: center; 
    }
    .counter-label { font-size: 10px; color: #666; margin-top: 4px; }
    .empty-list { text-align: center; padding: 15px; color: #999; font-size: 12px; }
    .device-info { font-size: 10px; color: #666; margin: 0 4px; }
    
    .logout-link {
      margin-top: 8px;
      text-align: center;
      font-size: 12px;
    }
    
    .logout-link small {
      cursor: pointer;
      color: #777;
      text-decoration: underline;
    }
    
    .logout-link small:hover {
      color: var(--primary-color);
    }
    
    .stats-desc {
      text-align: center;
      color: #666;
      margin-bottom: 15px;
      font-size: 13px;
    }
    
    .admin-controls {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin: 8px 0;
    }
    
    .admin-controls .btn {
      width: auto;
      padding: 5px 12px;
      font-size: 13px;
    }
    
    .sessions-note {
      font-size: 10px;
      color: #666;
      text-align: right;
      margin-top: 2px;
      margin-bottom: 5px;
    }

    .messages-badge {
      position: absolute;
      top: -8px;
      left: -8px;
      background: #e74c3c;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 800;
      animation: badgePulse 1.5s infinite;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.5);
    }

    @keyframes badgePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    .general-notification {
      background: linear-gradient(135deg, #f5f3ff 0%, #e8e0ff 100%);
      border: 2px solid var(--message-color);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(155, 89, 182, 0.2);
      animation: notificationSlideDown 0.5s ease;
      position: relative;
    }

    .general-notification.unread {
      border-color: #e74c3c;
      background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
      animation: notificationGlow 2s infinite;
    }

    @keyframes notificationSlideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes notificationGlow {
      0%, 100% {
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
      }
      50% {
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
      }
    }

    .notification-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-text {
      color: var(--text-color);
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
      line-height: 1.4;
    }

    .notification-count {
      font-size: 11px;
      color: #666;
    }

    .notification-close {
      background: transparent;
      border: none;
      color: #999;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .notification-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: var(--error-color);
      transform: rotate(90deg);
    }

    .messages-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(5px);
    }

    .messages-modal.active {
      display: flex;
    }

    .messages-modal-content {
      background: white;
      border-radius: 20px;
      padding: 25px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .messages-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .messages-modal-title {
      margin: 0;
      color: var(--primary-color);
      font-size: 20px;
    }

    .modal-close-btn {
      background: var(--error-color);
      color: white;
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .modal-close-btn:hover {
      transform: rotate(90deg);
      background: #c0392b;
    }

    .message-card {
      background: linear-gradient(135deg, #f5f3ff 0%, #e8e0ff 100%);
      border: 2px solid var(--message-color);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(155, 89, 182, 0.2);
      animation: messageSlideIn 0.5s ease;
      transition: all 0.3s ease;
    }

    .message-card.unread {
      border-color: #e74c3c;
      background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .message-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(155, 89, 182, 0.3);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(155, 89, 182, 0.2);
    }

    .message-icon {
      font-size: 20px;
    }

    .message-time {
      font-size: 11px;
      color: #666;
    }

    .message-text {
      color: var(--text-color);
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .message-from {
      font-size: 11px;
      color: var(--message-color);
      font-weight: 600;
      text-align: left;
    }

    .message-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .message-btn {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 8px;
      font-family: "Cairo", sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mark-read-btn {
      background: var(--success-color);
      color: white;
    }

    .mark-read-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .no-messages {
      text-align: center;
      padding: 30px 20px;
      color: #999;
      font-size: 13px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 10px;
      border: 2px dashed #ddd;
    }

    .no-messages-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.3;
    }

    .popup-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      padding: 15px 20px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(155, 89, 182, 0.5);
      z-index: 10001;
      animation: popupSlide 0.5s ease;
      max-width: 300px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    @keyframes popupSlide {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .popup-icon {
      font-size: 32px;
      flex-shrink: 0;
    }

    .popup-content {
      flex: 1;
    }

    .popup-header {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 5px;
    }

    .popup-text {
      font-size: 13px;
      line-height: 1.4;
      opacity: 0.95;
    }

    @media (max-height: 700px) {
      .card { padding: 15px; }
      h2 { font-size: 18px; margin-bottom: 12px; }
      .input-group { margin-bottom: 10px; }
      input { padding: 8px 10px; font-size: 14px; }
      .btn { padding: 8px; font-size: 14px; }
      .id-card-img { max-width: 55%; }
      .counter-box { padding: 6px 12px; font-size: 13px; }
      h3 { font-size: 13px; }
      .general-notification { padding: 10px; }
      .notification-text { font-size: 12px; }
    }
    
    @media (max-width: 480px) {
      .container { padding: 10px; }
      .card { max-width: 100%; padding: 15px; }
      .popup-notification {
        right: 10px;
        left: 10px;
        max-width: none;
      }
      .messages-modal-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <audio id="duplicateAlarm1" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
  </audio>
  <audio id="duplicateAlarm2" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>
  <audio id="duplicateAlarm3" preload="auto">
    <source src="https://actions.google.com/sounds/v1/emergency/siren_1.ogg" type="audio/ogg">
  </audio>
  <audio id="messageSound"
         src="https://actions.google.com/sounds/v1/notifications/notification_simple.ogg"
         preload="auto"></audio>

  <ul class="circles">
    <li></li><li></li><li></li><li></li><li></li>
    <li></li><li></li><li></li><li></li><li></li>
  </ul>

  <div class="container">
    <div class="card" id="auth-card">
      <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h2>
      <div class="input-group">
        <input id="loginCode" type="tel" inputmode="numeric" placeholder=" ">
        <label for="loginCode">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      </div>
      <button class="btn" id="loginBtn" onclick="login()">
        <span>Ø¯Ø®ÙˆÙ„</span>
      </button>
      <div id="login-msg" class="msg"></div>
    </div>
    
    <div class="card hidden" id="main-card">
      <h2 id="welcome">Ù…Ø±Ø­Ø¨Ù‹Ø§</h2>
      
      <div id="generalNotification"></div>
      
      <div class="counter-box" id="entryCounterBox">
        Ø¹Ø¯Ø¯ Ø¥Ø¯Ø®Ø§Ù„Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…: <span id="entryCounter">0</span>
        <div class="counter-label">
          Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ 
        </div>
      </div>
      <div class="input-group">
        <input id="repName" type="text" autocomplete="off" list="repNamesHistory" maxlength="30" placeholder=" ">
        <datalist id="repNamesHistory"></datalist>
        <label for="repName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
      </div>
      <div class="input-group">
        <input id="natID" type="tel" maxlength="14" inputmode="numeric" placeholder=" ">
        <label for="natID">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</label>
      </div>
      <div class="id-card-visual-container">
        <img src="https://raw.githubusercontent.com/mohamednasr5/id/e83438329b0f009f6eebf61b2797496d744589f2/5.png"
             class="id-card-img" alt="Ù…Ø«Ø§Ù„ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©">
      </div>
      <button class="btn" onclick="addUser()">Ø¥Ø¶Ø§ÙØ©</button>
      <div id="add-msg" class="msg"></div>
      <button class="btn btn-message" onclick="showMessagesModal()" style="position: relative;">
        <span id="messagesBtnText">ğŸ“¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
        <span class="messages-badge hidden" id="messagesBadge">0</span>
      </button>
      <button class="btn btn-secondary" onclick="showStatsLogin()">
        ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      </button>
      <div class="logout-link">
        <small onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</small>
      </div>
    </div>
    
    <div class="card hidden" id="stats-auth-card">
      <h2>ğŸ”’ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
      <p class="stats-desc">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
      <div class="input-group">
        <input id="statsPass" type="password" placeholder=" ">
        <label for="statsPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      </div>
      <button class="btn" onclick="verifyStats()">Ø¯Ø®ÙˆÙ„</button>
      <div id="stats-msg" class="msg"></div>
      <button class="btn btn-danger" onclick="cancelStats()">Ø¥Ù„ØºØ§Ø¡ ÙˆØ¹ÙˆØ¯Ø©</button>
    </div>
    
    <div class="card hidden" id="admin-panel-card">
      <h2>âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <button class="btn btn-warning" onclick="location.href='stats.html'">
        ğŸ“Š ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      </button>
      
      <h3>ğŸ“¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
      <div class="admin-controls">
        <button class="btn btn-info" onclick="viewAllMessages()">Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
        <button class="btn btn-danger" onclick="deleteAllMessages()">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
      </div>
      <div class="admin-list-container" id="adminMessagesList"></div>
      
      <h3>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="counter-box">
        <span>Ø§Ù„Ø¹Ø¯Ø¯: <span id="adminEntryCounter">0</span></span>
        <div class="admin-controls">
          <button class="btn btn-secondary" onclick="adminIncCounter()">+</button>
          <button class="btn btn-secondary" onclick="adminDecCounter()">-</button>
          <button class="btn btn-danger" onclick="adminResetCounter()">ØªØµÙÙŠØ±</button>
        </div>
      </div>
      <h3>Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
      <p class="sessions-note">Ø§Ù„Ù…Ø³Ù…ÙˆØ­: 3 Ø£Ø¬Ù‡Ø²Ø© Ù„ÙƒÙ„ ÙƒÙˆØ¯</p>
      <div class="admin-list-container" id="activeSessionsList"></div>
      <h3>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
      <div class="admin-list-container" id="adminRepList"></div>
      <button class="btn btn-danger" onclick="closeAdminPanel()">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø©</button>
    </div>
  </div>

  <div class="messages-modal" id="messagesModal">
    <div class="messages-modal-content">
      <div class="messages-modal-header">
        <h2 class="messages-modal-title">ğŸ“¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>
        <button class="modal-close-btn" onclick="closeMessagesModal()">Ã—</button>
      </div>
      <div id="messagesModalContent"></div>
    </div>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      child,
      push,
      remove,
      onValue,
      update
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyAxnIxtFeAOjYjCIrU5cwYVteuQ18K8Kjc",
      authDomain: "idmanazla.firebaseapp.com",
      databaseURL: "https://idmanazla-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "idmanazla",
      storageBucket: "idmanazla.firebasestorage.app",
      messagingSenderId: "408446131276",
      appId: "1:408446131276:web:976ae54181b5398de5a8e9"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getDeviceId() {
      let id = localStorage.getItem("app_device_id");
      if (!id) {
        id = "dev_" + Math.random().toString(36).substring(2, 10) + Date.now();
        localStorage.setItem("app_device_id", id);
      }
      return id;
    }
    const currentDeviceId = getDeviceId();

    let userPlace = null;
    let userPlaceIdx = null;
    let userID = null;
    let messagesListener = null;
    let lastMessageCount = 0;
    let alarmInterval = null;

    function playDuplicateAlarm() {
      stopDuplicateAlarm();

      const alarm1 = document.getElementById('duplicateAlarm1');
      const alarm2 = document.getElementById('duplicateAlarm2');
      const alarm3 = document.getElementById('duplicateAlarm3');

      alarm1.volume = 1.0;
      alarm2.volume = 1.0;
      alarm3.volume = 1.0;

      alarm1.play().catch(() => {});
      
      setTimeout(() => {
        alarm2.play().catch(() => {});
      }, 300);

      setTimeout(() => {
        alarm3.play().catch(() => {});
      }, 600);

      let count = 0;
      alarmInterval = setInterval(() => {
        count++;
        if (count > 5) {
          stopDuplicateAlarm();
          return;
        }

        alarm1.currentTime = 0;
        alarm2.currentTime = 0;
        alarm3.currentTime = 0;
        
        alarm1.play().catch(() => {});
        setTimeout(() => alarm2.play().catch(() => {}), 300);
        setTimeout(() => alarm3.play().catch(() => {}), 600);
      }, 2000);

      if ('vibrate' in navigator) {
        navigator.vibrate([200, 100, 200, 100, 200, 100, 400, 100, 400]);
      }
    }

    function stopDuplicateAlarm() {
      if (alarmInterval) {
        clearInterval(alarmInterval);
        alarmInterval = null;
      }

      const alarm1 = document.getElementById('duplicateAlarm1');
      const alarm2 = document.getElementById('duplicateAlarm2');
      const alarm3 = document.getElementById('duplicateAlarm3');

      alarm1.pause();
      alarm2.pause();
      alarm3.pause();
      
      alarm1.currentTime = 0;
      alarm2.currentTime = 0;
      alarm3.currentTime = 0;
    }

    window.login = async function () {
      const code = document.getElementById("loginCode").value.trim();
      const msg = document.getElementById("login-msg");
      msg.textContent = "";
      msg.className = "msg";

      if (code.length < 1) {
        msg.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        msg.classList.add("error");
        return;
      }
      try {
        const snapshot = await get(child(ref(db), "login_codes/" + code));
        if (!snapshot.exists()) {
          msg.textContent = "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­";
          msg.classList.add("error");
          return;
        }
        const data = snapshot.val();
        userID = code;
        userPlace = data.place;
        userPlaceIdx = data.placeIdx || 0;

        await enforceSessionLimit(code);
        await set(ref(db, `active_sessions/${code}/${currentDeviceId}`), {
          loginTime: Date.now(),
          expiresAt: Date.now() + 30 * 60 * 1000
        });
        
        document.getElementById("welcome").textContent = "Ù…Ø±Ø­Ø¨Ù‹Ø§ â€” " + userPlace;
        document.getElementById("auth-card").classList.add("hidden");
        document.getElementById("main-card").classList.remove("hidden");
        document.getElementById("main-card").classList.add("fade-in");
        
        loadEntryCounter();
        startMessagesListener();
        
      } catch (e) {
        msg.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + e.message;
        msg.classList.add("error");
      }
    };

    async function enforceSessionLimit(code) {
      const snap = await get(child(ref(db), "active_sessions/" + code));
      if (!snap.exists()) return;
      const sessions = snap.val();
      const devices = Object.keys(sessions);
      
      for (let d of devices) {
        if (sessions[d].expiresAt < Date.now()) {
          await remove(ref(db, `active_sessions/${code}/${d}`));
        }
      }
      
      const updatedSnap = await get(child(ref(db), "active_sessions/" + code));
      if (!updatedSnap.exists()) return;
      const updated = updatedSnap.val();
      const updatedDevices = Object.keys(updated);
      
      if (updatedDevices.length >= 3 && !updatedDevices.includes(currentDeviceId)) {
        const sorted = updatedDevices.sort((a, b) => updated[a].loginTime - updated[b].loginTime);
        const oldest = sorted[0];
        await remove(ref(db, `active_sessions/${code}/${oldest}`));
      }
    }

    window.logout = async function () {
      stopDuplicateAlarm();
      if (userID) {
        await remove(ref(db, `active_sessions/${userID}/${currentDeviceId}`));
      }
      if (messagesListener) {
        messagesListener();
      }
      location.reload();
    };

    function startMessagesListener() {
      if (!userID || !userPlace) return;
      
      const messagesRef = ref(db, 'messages');
      messagesListener = onValue(messagesRef, (snapshot) => {
        if (!snapshot.exists()) {
          updateGeneralNotification([]);
          return;
        }

        const allMessages = snapshot.val();
        const relevantMessages = [];

        Object.keys(allMessages).forEach(msgId => {
          const msg = allMessages[msgId];
          
          if (msg.target === 'all' || msg.target === userPlace) {
            relevantMessages.push({
              id: msgId,
              ...msg
            });
          }
        });

        relevantMessages.sort((a, b) => 
          new Date(b.timestamp) - new Date(a.timestamp)
        );

        const unreadCount = relevantMessages.filter(m => !isMessageRead(m.id)).length;
        if (unreadCount > lastMessageCount && lastMessageCount > 0) {
          showPopupNotification(relevantMessages[0]);
        }
        lastMessageCount = unreadCount;

        updateGeneralNotification(relevantMessages);
        updateBadge(unreadCount);
      });
    }

    function updateGeneralNotification(messages) {
      const container = document.getElementById('generalNotification');
      const unreadMessages = messages.filter(m => !isMessageRead(m.id));
      
      if (unreadMessages.length === 0) {
        container.innerHTML = '';
        return;
      }

      const unreadCount = unreadMessages.length;
      const latestMessage = unreadMessages[0];
      const shortText = latestMessage.text.length > 50 
        ? latestMessage.text.substring(0, 50) + '...' 
        : latestMessage.text;

      container.innerHTML = `
        <div class="general-notification unread" onclick="showMessagesModal()">
          <div class="notification-icon">ğŸ“¬</div>
          <div class="notification-content">
            <div class="notification-text">${shortText}</div>
            <div class="notification-count">
              ${unreadCount === 1 ? 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©' : `${unreadCount} Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©`}
            </div>
          </div>
          <button class="notification-close" onclick="event.stopPropagation(); hideNotification()">Ã—</button>
        </div>
      `;
    }

    window.hideNotification = function() {
      document.getElementById('generalNotification').innerHTML = '';
    };

    function updateBadge(count) {
      const badge = document.getElementById('messagesBadge');
      
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function showPopupNotification(msg) {
      document.getElementById('messageSound').play().catch(() => {});

      const notification = document.createElement('div');
      notification.className = 'popup-notification';
      notification.innerHTML = `
        <div class="popup-icon">ğŸ“¨</div>
        <div class="popup-content">
          <div class="popup-header">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
          <div class="popup-text">${msg.text.substring(0, 50)}${msg.text.length > 50 ? '...' : ''}</div>
        </div>
      `;

      document.body.appendChild(notification);

      notification.onclick = () => {
        notification.remove();
        showMessagesModal();
      };

      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    window.showMessagesModal = async function() {
      if (!userID || !userPlace) return;
      
      const messagesRef = ref(db, 'messages');
      const snapshot = await get(messagesRef);
      
      if (!snapshot.exists()) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹');
        return;
      }

      const allMessages = snapshot.val();
      const relevantMessages = [];

      Object.keys(allMessages).forEach(msgId => {
        const msg = allMessages[msgId];
        
        if (msg.target === 'all' || msg.target === userPlace) {
          relevantMessages.push({
            id: msgId,
            ...msg
          });
        }
      });

      relevantMessages.sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );

      displayMessagesInModal(relevantMessages);
      document.getElementById('messagesModal').classList.add('active');
    };

    window.closeMessagesModal = function() {
      document.getElementById('messagesModal').classList.remove('active');
    };

    function displayMessagesInModal(messages) {
      const container = document.getElementById('messagesModalContent');
      
      if (messages.length === 0) {
        container.innerHTML = `
          <div class="no-messages">
            <div class="no-messages-icon">ğŸ“­</div>
            <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>
          </div>
        `;
        return;
      }

      container.innerHTML = '';
      
      messages.forEach(msg => {
        const msgCard = createMessageCard(msg);
        container.appendChild(msgCard);
      });
    }

    function createMessageCard(msg) {
      const div = document.createElement('div');
      div.className = 'message-card';
      if (!isMessageRead(msg.id)) {
        div.classList.add('unread');
      }

      const date = new Date(msg.timestamp);
      const formattedTime = date.toLocaleDateString('ar-EG') + ' ' + 
                           date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

      const targetText = msg.target === 'all' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨' : msg.target;

      div.innerHTML = `
        <div class="message-header">
          <span class="message-icon">ğŸ“¬</span>
          <span class="message-time">${formattedTime}</span>
        </div>
        <div class="message-text">${msg.text}</div>
        <div class="message-from">Ø¥Ù„Ù‰: ${targetText}</div>
        ${!isMessageRead(msg.id) ? `
          <div class="message-actions">
            <button class="message-btn mark-read-btn" onclick="markMessageAsRead('${msg.id}')">
              âœ“ ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
            </button>
          </div>
        ` : `
          <div style="text-align: center; color: var(--success-color); font-size: 12px; margin-top: 8px; padding: 5px; background: rgba(46, 204, 113, 0.1); border-radius: 8px;">
            âœ“ ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
          </div>
        `}
      `;

      return div;
    }

    function isMessageRead(msgId) {
      const readMessages = JSON.parse(localStorage.getItem('read_messages') || '[]');
      return readMessages.includes(msgId);
    }

    window.markMessageAsRead = function(msgId) {
      const readMessages = JSON.parse(localStorage.getItem('read_messages') || '[]');
      if (!readMessages.includes(msgId)) {
        readMessages.push(msgId);
        localStorage.setItem('read_messages', JSON.stringify(readMessages));
      }
      
      showMessagesModal();
    };

    document.addEventListener('click', (e) => {
      const modal = document.getElementById('messagesModal');
      if (e.target === modal) {
        closeMessagesModal();
      }
    });

    function saveRepName(name) {
      let stored = JSON.parse(localStorage.getItem("saved_rep_names") || "[]");
      if (!stored.includes(name)) {
        stored.push(name);
        localStorage.setItem("saved_rep_names", JSON.stringify(stored));
      }
      loadRepNames();
    }

    function loadRepNames() {
      let stored = JSON.parse(localStorage.getItem("saved_rep_names") || "[]");
      const list = document.getElementById("repNamesHistory");
      if (!list) return;
      list.innerHTML = "";
      stored.forEach(n => {
        let o = document.createElement("option");
        o.value = n;
        list.appendChild(o);
      });
    }
    loadRepNames();

    let lastAddTime = 0;
    window.addUser = async function () {
      const msg = document.getElementById("add-msg");
      msg.textContent = "";
      msg.className = "msg";
      
      if (Date.now() - lastAddTime < 1200) {
        msg.textContent = "Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø©...";
        msg.classList.add("error");
        return;
      }
      lastAddTime = Date.now();
      
      const name = document.getElementById("repName").value.trim();
      const natid = document.getElementById("natID").value.trim();
      
      if (name.length < 2) {
        msg.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨";
        msg.classList.add("error");
        return;
      }
      if (!/^\d{14}$/.test(natid)) {
        msg.textContent = "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 14 Ø±Ù‚Ù…";
        msg.classList.add("error");
        return;
      }
      if (!userPlace) {
        msg.textContent = "Ø®Ø·Ø£ â€” Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        msg.classList.add("error");
        return;
      }
      
      try {
        const userRef = ref(db, "users/" + natid);
        const snapshot = await get(userRef);
        
        if (snapshot.exists()) {
          const data = snapshot.val();
          
          playDuplicateAlarm();
          
          msg.className = "duplicate-box";
          msg.innerHTML = `
            âš ï¸ ØªÙƒØ±Ø§Ø±<br>
            Ù…Ø³Ø¬Ù„ ÙÙŠ: <b>${data.place}</b><br>
            Ø¨ÙˆØ§Ø³Ø·Ø©: <b>${data.repName}</b>
          `;
          await push(ref(db, "duplicates"), {
            duplicatedID: natid,
            attemptByRep: name,
            attemptPlace: userPlace,
            originalRep: data.repName,
            originalPlace: data.place,
            timestamp: new Date().toISOString()
          });
          saveRepName(name);
          
          setTimeout(() => {
            stopDuplicateAlarm();
          }, 10000);
          
          return;
        }
        
        await set(userRef, {
          natid,
          repName: name,
          place: userPlace,
          placeIdx: userPlaceIdx,
          time: new Date().toISOString(),
          username: userID
        });
        
        saveRepName(name);
        msg.textContent = "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­ âœ“";
        msg.classList.add("success");
        document.getElementById("natID").value = "";
        document.getElementById("natID").focus();
        incrementEntryCounter();
        
      } catch (e) {
        msg.textContent = "Ø®Ø·Ø£: " + e.message;
        msg.classList.add("error");
      }
    };

    document.addEventListener('click', () => {
      if (alarmInterval) {
        stopDuplicateAlarm();
      }
    });

    function getEntryData() {
      return JSON.parse(localStorage.getItem("entry_counter_names") || "{}");
    }
    
    function setEntryData(d) {
      localStorage.setItem("entry_counter_names", JSON.stringify(d));
    }
    
    function getActiveRepName() {
      const repNameInput = document.getElementById("repName");
      return repNameInput ? repNameInput.value.trim() : "";
    }
    
    function loadEntryCounter() {
      const counterEl = document.getElementById("entryCounter");
      if (!counterEl) return;
      
      const name = getActiveRepName();
      const today = new Date().toISOString().substring(0, 10);
      let entryData = getEntryData();
      
      if (!name) {
        counterEl.textContent = 0;
        return;
      }
      
      if (!entryData[name] || entryData[name].date !== today) {
        entryData[name] = { date: today, count: 0 };
        setEntryData(entryData);
      }
      
      counterEl.textContent = entryData[name].count;
    }
    
    function incrementEntryCounter() {
      const name = getActiveRepName();
      if (!name) return;
      
      const today = new Date().toISOString().substring(0, 10);
      let entryData = getEntryData();
      
      if (!entryData[name] || entryData[name].date !== today) {
        entryData[name] = { date: today, count: 1 };
      } else {
        entryData[name].count++;
      }
      
      setEntryData(entryData);
      loadEntryCounter();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const repNameInput = document.getElementById("repName");
      if (repNameInput) {
        repNameInput.addEventListener("input", () => {
          loadEntryCounter();
          adminLoadCounter();
        });
        repNameInput.addEventListener("change", () => {
          loadEntryCounter();
          adminLoadCounter();
        });
      }
    });

    window.adminIncCounter = function () {
      let val = parseInt(document.getElementById("adminEntryCounter").textContent) || 0;
      adminSetCounter(val + 1);
    };
    
    window.adminDecCounter = function () {
      let val = parseInt(document.getElementById("adminEntryCounter").textContent) || 0;
      if (val > 0) {
        adminSetCounter(val - 1);
      }
    };
    
    window.adminResetCounter = function () {
      if (confirm("ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ")) {
        adminSetCounter(0);
      }
    };
    
    function adminSetCounter(val) {
      const name = getActiveRepName();
      if (!name) {
        alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }
      
      const today = new Date().toISOString().substring(0, 10);
      let entryData = getEntryData();
      entryData[name] = { date: today, count: Math.max(0, val) };
      setEntryData(entryData);
      adminLoadCounter();
      loadEntryCounter();
    }
    
    function adminLoadCounter() {
      const counterEl = document.getElementById("adminEntryCounter");
      if (!counterEl) return;
      
      const name = getActiveRepName();
      const today = new Date().toISOString().substring(0, 10);
      let entryData = getEntryData();
      
      if (!name) {
        counterEl.textContent = 0;
        return;
      }
      
      if (!entryData[name] || entryData[name].date !== today) {
        entryData[name] = { date: today, count: 0 };
        setEntryData(entryData);
      }
      
      counterEl.textContent = entryData[name].count;
    }

    window.showStatsLogin = function () {
      document.getElementById("main-card").classList.add("hidden");
      const card = document.getElementById("stats-auth-card");
      card.classList.remove("hidden");
      card.classList.add("fade-in");
      document.getElementById("statsPass").value = "";
      document.getElementById("stats-msg").textContent = "";
      document.getElementById("stats-msg").className = "msg";
    };
    
    window.cancelStats = function () {
      document.getElementById("stats-auth-card").classList.add("hidden");
      document.getElementById("main-card").classList.remove("hidden");
    };
    
    window.verifyStats = function () {
      const pass = document.getElementById("statsPass").value;
      const msg = document.getElementById("stats-msg");
      
      if (pass === "521988") {
        msg.textContent = "âœ” ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„";
        msg.className = "msg success";
        setTimeout(() => {
          document.getElementById("stats-auth-card").classList.add("hidden");
          document.getElementById("admin-panel-card").classList.remove("hidden");
          document.getElementById("admin-panel-card").classList.add("fade-in");
          renderAdminRepList();
          fetchActiveSessions();
          adminLoadCounter();
          viewAllMessages();
        }, 500);
      } else {
        msg.textContent = "Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!";
        msg.className = "msg error";
      }
    };

    window.viewAllMessages = async function() {
      const container = document.getElementById('adminMessagesList');
      container.innerHTML = '<div style="text-align:center;padding:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
      
      try {
        const messagesRef = ref(db, 'messages');
        const snapshot = await get(messagesRef);
        
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="empty-list">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>';
          return;
        }
        
        const allMessages = snapshot.val();
        const messagesArray = Object.entries(allMessages).map(([id, msg]) => ({
          id,
          ...msg
        })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        container.innerHTML = '';
        
        messagesArray.forEach(msg => {
          const date = new Date(msg.timestamp);
          const formattedDate = date.toLocaleDateString('ar-EG');
          const formattedTime = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
          const targetText = msg.target === 'all' ? 'Ø§Ù„ÙƒÙ„' : msg.target;
          
          const msgDiv = document.createElement('div');
          msgDiv.style.cssText = 'background:#f8f9fa;padding:10px;margin-bottom:8px;border-radius:8px;border-right:3px solid #9b59b6;';
          msgDiv.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
              <span style="font-weight:600;color:#9b59b6;">Ø¥Ù„Ù‰: ${targetText}</span>
              <span style="font-size:10px;color:#666;">${formattedDate} ${formattedTime}</span>
            </div>
            <div style="color:#2c3e50;font-size:13px;margin-bottom:8px;">${msg.text}</div>
            <button class="btn-delete-rep" onclick="deleteSingleMessage('${msg.id}')" style="width:100%;margin-top:5px;">
              ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            </button>
          `;
          container.appendChild(msgDiv);
        });
        
      } catch (error) {
        container.innerHTML = `<div class="empty-list" style="color:red;">Ø®Ø·Ø£: ${error.message}</div>`;
      }
    };

    window.deleteAllMessages = async function() {
      console.log('deleteAllMessages called');
      
      if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„ÙƒØ§ÙØ© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) {
        console.log('User cancelled first confirmation');
        return;
      }
      
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ!\n\nØ§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹')) {
        console.log('User cancelled second confirmation');
        return;
      }
      
      console.log('Starting delete operation...');
      
      try {
        const messagesRef = ref(db, 'messages');
        const sentMessagesRef = ref(db, 'sentMessages');
        
        console.log('Deleting messages...');
        await remove(messagesRef);
        
        console.log('Deleting sentMessages...');
        await remove(sentMessagesRef);
        
        console.log('Clearing localStorage...');
        localStorage.removeItem('read_messages');
        
        console.log('Delete operation completed successfully');
        
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­\n\nğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        
        const container = document.getElementById('adminMessagesList');
        if (container) {
          container.innerHTML = '<div class="empty-list">ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>';
        }
        
        updateGeneralNotification([]);
        updateBadge(0);
        
      } catch (error) {
        console.error('Error details:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message + '\n\nØªØ­Ù‚Ù‚ Ù…Ù† Console Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„');
      }
    };

    window.deleteSingleMessage = async function(msgId) {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
        return;
      }
      
      try {
        await remove(ref(db, `messages/${msgId}`));
        
        const sentMessagesRef = ref(db, 'sentMessages');
        const snapshot = await get(sentMessagesRef);
        
        if (snapshot.exists()) {
          const allSent = snapshot.val();
          for (let [key, msg] of Object.entries(allSent)) {
            const msgSnapshot = await get(ref(db, `messages/${msgId}`));
            if (msg.timestamp === msgSnapshot?.val()?.timestamp) {
              await remove(ref(db, `sentMessages/${key}`));
            }
          }
        }
        
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
        viewAllMessages();
        
      } catch (error) {
        console.error('Error deleting message:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
      }
    };
    
    function renderAdminRepList() {
      const container = document.getElementById("adminRepList");
      const stored = JSON.parse(localStorage.getItem("saved_rep_names") || "[]");
      container.innerHTML = "";
      
      if (stored.length === 0) {
        container.innerHTML = `<div class="empty-list">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡</div>`;
        return;
      }
      
      stored.forEach(name => {
        const div = document.createElement("div");
        div.className = "rep-item";
        const escapedName = name.replace(/'/g, "\\'");
        div.innerHTML = `
          <span class="rep-name">${name}</span>
          <button class="btn-delete-rep" onclick="deleteRepName('${escapedName}')">Ø­Ø°Ù</button>
        `;
        container.appendChild(div);
      });
    }
    
    window.deleteRepName = function (name) {
      if (!confirm(`Ø­Ø°Ù "${name}"ØŸ`)) return;
      
      let stored = JSON.parse(localStorage.getItem("saved_rep_names") || "[]");
      stored = stored.filter(n => n !== name);
      localStorage.setItem("saved_rep_names", JSON.stringify(stored));
      renderAdminRepList();
      loadRepNames();
    };
    
    function fetchActiveSessions() {
      const container = document.getElementById("activeSessionsList");
      container.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦";
      
      const sessionsRef = ref(db, "active_sessions");
      onValue(sessionsRef, snap => {
        container.innerHTML = "";
        
        if (!snap.exists()) {
          container.innerHTML = `<div class="empty-list">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª</div>`;
          return;
        }
        
        const all = snap.val();
        Object.keys(all).forEach(code => {
          const devices = all[code];
          const header = document.createElement("div");
          header.style.cssText = "background:#eee;padding:4px;margin-top:4px;font-weight:bold;border-radius:5px;font-size:12px;";
          header.textContent = `${code} (${Object.keys(devices).length})`;
          container.appendChild(header);
          
          Object.keys(devices).forEach(devID => {
            const d = devices[devID];
            const time = new Date(d.loginTime).toLocaleTimeString("ar-EG");
            const row = document.createElement("div");
            row.className = "session-item";
            row.innerHTML = `
              <div>
                <span style="font-weight:bold;">Ø¬Ù‡Ø§Ø²</span>
                <span class="device-info">${time}</span>
              </div>
              <button class="session-kick-btn" onclick="kickUser('${code}','${devID}')">Ø·Ø±Ø¯</button>
            `;
            container.appendChild(row);
          });
        });
      }, (error) => {
        container.innerHTML = `<div class="empty-list" style="color:red;">${error.message}</div>`;
      });
    }
    
    window.kickUser = async function (code, devID) {
      if (confirm("Ø·Ø±Ø¯ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ")) {
        try {
          await remove(ref(db, `active_sessions/${code}/${devID}`));
          alert("ØªÙ… Ø§Ù„Ø·Ø±Ø¯");
        } catch (e) {
          alert("Ø®Ø·Ø£: " + e.message);
        }
      }
    };
    
    window.closeAdminPanel = function () {
      document.getElementById("admin-panel-card").classList.add("hidden");
      document.getElementById("main-card").classList.remove("hidden");
    };
  </script>
</body>
</html>
