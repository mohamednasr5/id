<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-storage-compat.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js'></script>
  <style>
    :root {
      --primary-color: #0072ff;
      --secondary-color: #00c6ff;
      --bg-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
      --input-bg: #f0f4f8;
      --text-color: #2d3436;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
    }
    * { box-sizing: border-box; outline: none; }
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      overflow-x: hidden;
      color: var(--text-color);
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
    .circles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.2); animation: animate 25s linear infinite; bottom: -150px; border-radius: 50%; }
    .circles li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
    .circles li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
    .circles li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
    .circles li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
    .circles li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
    @keyframes animate { 0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } }
    .container { position: relative; z-index: 1; perspective: 1000px; width: 100%; max-width: 500px; padding: 0 10px; }
    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border-radius: 20px; padding: 40px 30px;
      width: 100%;
      box-shadow: var(--glass-shadow);
      border: 1px solid rgba(255, 255, 255, 0.18);
      transform: translateY(20px); opacity: 0;
      animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      transition: all 0.5s ease;
      max-height: 90vh;
      overflow-y: auto;
    }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    h2 { text-align: center; margin-bottom: 30px; color: var(--primary-color); font-weight: 700; font-size: 24px; }
    h3 { text-align: right; color: #333; margin: 15px 0 10px; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
    .input-group { position: relative; margin-bottom: 25px; }
    .fixed-input-box {
      display: flex; align-items: center; background: var(--input-bg);
      border-radius: 10px; padding: 0 15px; border: 2px solid transparent;
      transition: 0.3s ease; direction: ltr;
    }
    .fixed-input-box:focus-within { background: #fff; border-color: var(--secondary-color); box-shadow: 0 0 15px rgba(0, 198, 255, 0.1); }
    .static-x { color: #aaa; font-weight: bold; font-size: 18px; letter-spacing: 2px; margin-right: 5px; pointer-events: none; user-select: none; }
    
    input, select {
      width: 100%; padding: 12px 15px; font-size: 16px;
      background: var(--input-bg); border: 2px solid transparent;
      border-radius: 10px; font-family: 'Cairo', sans-serif;
      transition: 0.3s ease; color: #333;
    }
    .fixed-input-box input { background: transparent; border: none; padding: 12px 0; width: auto; flex-grow: 1; font-weight: bold; letter-spacing: 2px; }
    .fixed-input-box input:focus { box-shadow: none; background: transparent; }
    .input-group label {
      position: absolute; top: 50%; right: 15px; transform: translateY(-50%);
      font-size: 16px; color: #999; pointer-events: none;
      transition: 0.3s ease all; padding: 0 5px; background: transparent; z-index: 10;
    }
    input:focus ~ label, input:not(:placeholder-shown) ~ label, 
    .fixed-input-box:focus-within ~ label, 
    .fixed-input-box input:not(:placeholder-shown) ~ label {
      top: 0; transform: translateY(-50%) scale(0.85);
      background: #fff; color: var(--primary-color); font-weight: 600; border-radius: 5px;
    }
    
    /* Camera Styles */
    .camera-section {
      margin: 20px 0;
      text-align: center;
    }
    video, canvas, #capturedImage {
      width: 100%;
      max-width: 100%;
      border-radius: 10px;
      border: 3px solid var(--secondary-color);
      display: none;
      margin: 10px 0;
    }
    video.active, canvas.active, #capturedImage.active {
      display: block;
    }
    
    .camera-controls {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .btn {
      background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
      color: white; padding: 12px 20px; border: none;
      border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer;
      transition: 0.3s ease; box-shadow: 0 5px 15px rgba(0, 114, 255, 0.3);
      position: relative; overflow: hidden;
      flex: 1;
      min-width: 120px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 114, 255, 0.4); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: linear-gradient(to right, #43cea2, #185a9d); }
    .btn-danger { background: linear-gradient(to right, #ff416c, #ff4b2b); }
    .btn-warning { background: linear-gradient(to right, #f2994a, #f2c94c); color: #333; }
    .btn-success { background: linear-gradient(to right, #11998e, #38ef7d); }
    
    .msg { margin-top: 15px; text-align: center; font-size: 14px; font-weight: 600; min-height: 20px; transition: 0.3s; padding: 10px; border-radius: 8px; }
    .msg.error { color: var(--error-color); animation: shake 0.5s; }
    .msg.success { color: var(--success-color); }
    .msg.processing { background: #fff3cd; color: #856404; }
    
    .duplicate-box {
        background-color: #fff5f5; border: 2px solid #ff0000; color: #c0392b;
        padding: 15px; border-radius: 12px; margin-top: 20px; font-weight: bold;
        box-shadow: 0 4px 15px rgba(255, 0, 0, 0.2);
        animation: pulseRed 0.8s infinite alternate;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    @keyframes pulseRed { from { border-color: #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); } to { border-color: #ff6b6b; box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(10px); } 75% { transform: translateX(-10px); } }
    
    .admin-list-container {
        max-height: 250px;
        overflow-y: auto;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: rgba(255,255,255,0.5);
    }
    .rep-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        transition: 0.2s;
    }
    .rep-item:last-child { border-bottom: none; }
    .rep-item:hover { background: rgba(255,255,255,0.8); }
    .rep-name { font-weight: 600; color: #333; }
    .btn-delete-rep {
        background: #ff4b2b;
        color: white;
        border: none;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        cursor: pointer;
    }
    .btn-delete-rep:hover { background: #d32f2f; }
    .empty-list { text-align: center; padding: 20px; color: #888; font-size: 14px; }
    
    .comparison-section {
      margin-top: 20px;
      padding: 20px;
      background: #e3f2fd;
      border-radius: 10px;
      display: none;
    }
    .comparison-section.active { display: block; }
    .image-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    .comparison-item {
      text-align: center;
    }
    .comparison-item img {
      width: 100%;
      border-radius: 8px;
      border: 2px solid var(--primary-color);
    }
    .comparison-item h4 {
      margin-top: 10px;
      color: #333;
      font-size: 14px;
    }
    
    @media (max-width: 600px) {
      .image-comparison {
        grid-template-columns: 1fr;
      }
      .camera-controls {
        flex-direction: column;
      }
      .btn {
        width: 100%;
      }
    }
    
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.5s forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <audio id="errorSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <ul class="circles"><li></li><li></li><li></li><li></li><li></li></ul>
  
  <div class="container">
    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div class="card" id="auth-card">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</h2>
      <div class="input-group">
        <input id="loginCode" type="number" placeholder=" ">
        <label for="loginCode">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      </div>
      <button class="btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
      <div id="login-msg" class="msg"></div>
    </div>

    <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="card hidden" id="main-card">
      <h2 id="welcome">Ù…Ø±Ø­Ø¨Ù‹Ø§</h2>
      
      <div class="input-group">
        <input id="repName" type="text" autocomplete="off" list="repNamesHistory" maxlength="30" placeholder=" ">
        <datalist id="repNamesHistory"></datalist>
        <label for="repName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
      </div>
      
      <!-- Ù‚Ø³Ù… Ø§Ù„ØªØµÙˆÙŠØ± -->
      <div class="camera-section">
        <h3 style="text-align: center; font-size: 16px; color: #666;">ğŸ“¸ ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <img id="capturedImage" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„ØªÙ‚Ø·Ø©">
        
        <div class="camera-controls">
          <button class="btn btn-secondary" id="startCamera" onclick="startCamera()">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button class="btn btn-success" id="capture" onclick="capturePhoto()" disabled>Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
          <button class="btn btn-danger" id="resetCamera" onclick="resetCamera()" style="display:none;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØ±</button>
        </div>
        
        <div style="text-align: center; margin: 10px 0;">
          <label for="fileInput" class="btn btn-warning" style="display: inline-block; cursor: pointer;">
            ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
          </label>
          <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
        </div>
      </div>
      
      <button class="btn" id="addBtn" onclick="processAndAdd()" disabled>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¶Ø§ÙØ©</button>
      
      <div id="add-msg" class="msg"></div>
      
      <div class="comparison-section" id="comparisonSection">
        <h4 style="text-align: center; color: #d32f2f;">âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹</h4>
        <div class="image-comparison">
          <div class="comparison-item">
            <img id="currentImage" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
            <h4>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
          </div>
          <div class="comparison-item">
            <img id="databaseImage" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³Ø¬Ù„Ø©">
            <h4>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹</h4>
          </div>
        </div>
      </div>
      
      <button class="btn btn-secondary" onclick="showStatsLogin()" style="margin-top: 15px;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© / Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± -->
    <div class="card hidden" id="stats-auth-card">
      <h2>ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
      <p style="text-align: center; color: #666; margin-bottom: 20px;">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
      <div class="input-group">
        <input id="statsPass" type="password" placeholder=" ">
        <label for="statsPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      </div>
      <button class="btn" onclick="verifyStats()">Ø¯Ø®ÙˆÙ„</button>
      <div id="stats-msg" class="msg"></div>
      <button class="btn btn-danger" onclick="cancelStats()">Ø¥Ù„ØºØ§Ø¡ ÙˆØ¹ÙˆØ¯Ø©</button>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="card hidden" id="admin-panel-card">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <button class="btn btn-warning" onclick="location.href='stats.html'">Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© ğŸ“Š</button>
      <h3>Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
      <p style="font-size:12px; color:#666; text-align:right; margin-bottom:10px;">
        ØªÙ†Ø¨ÙŠÙ‡: Ø­Ø°Ù Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ù‡Ù†Ø§ ÙŠØ²ÙŠÙ„Ù‡ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙÙ‚Ø·.
      </p>
      <div class="admin-list-container" id="adminRepList"></div>
      <button class="btn btn-danger" onclick="closeAdminPanel()">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø©</button>
    </div>
  </div>

  <script>
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAxnIxtFeAOjYjCIrU5cwYVteuQ18K8Kjc",
      authDomain: "idmanazla.firebaseapp.com",
      databaseURL: "https://idmanazla-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "idmanazla",
      storageBucket: "idmanazla.firebasestorage.app",
      messagingSenderId: "408446131276",
      appId: "1:408446131276:web:976ae54181b5398de5a8e9",
      measurementId: "G-9YSW9HNYTG"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const places = [
      "Ø§Ù„Ù…Ù†Ø²Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 1","Ø§Ù„Ù…Ù†Ø²Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 2","Ø¨Ø­Ø± Ø§Ù„Ø¨Ù„Ø¯ Ø´Ø§Ø±Ø¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†",
      "Ù…Ø¯Ø±Ø³Ø© Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø§Ù„ Ø´Ù„Ø¨ÙŠØ§ÙŠØ©","Ù…ØµÙ†Ø¹ Ø§Ù„Ø¨ØµÙ„","Ø§Ù„ÙƒÙØ± 1","Ø§Ù„ÙƒÙØ± 2 ØªØ­Øª Ø§Ù„Ø³ÙƒØ©",
      "Ø³ÙˆÙ‚ Ø§Ù„Ø¬Ù…Ù„Ø©","Ø§Ù„ÙØ¯Ø§Ø¡","Ù†Ù‚Ø·Ø© Ø­Ù…Ø§Ù… Ø§Ù„ÙƒÙŠØ§Ù„","Ø§Ù„Ø­Ù…Ø²Ø§ÙˆÙŠ","Ø§Ù„Ø¬Ø±Ù† 1","Ø§Ù„Ø¬Ø±Ù† 2",
      "Ø§Ù„Ø¨Ø± Ø§Ù„ØªØ§Ù†ÙŠ Ø­ÙŠ Ø§Ù„Ø³Ù„Ø§Ù…","Ø­ÙŠ Ø§Ù„Ø§Ø¹Ø¬Ø§Ù…","Ø§Ù„Ø¹Ø²Ø¨Ø© Ù…Ù†Ø´ÙŠØ© Ù†Ø§ØµØ±","Ø§Ù„Ø·ÙˆÙŠÙ„",
      "Ø§Ù„Ø¨Ø± Ø§Ù„ØªØ§Ù†ÙŠ 2 Ø§Ù„Ù‡Ø§ÙˆÙŠØ³","Ø§Ù„ÙÙ‚Ø§Ø¹ÙŠ","Ø¨Ø­Ø± Ø§Ù„Ø¨Ù„Ø¯ 2","Ø­ÙŠ Ø§Ù„Ø¬Ø¨Ø§Ù†Ø©",
      "Ø§Ù„ÙƒÙØ± 3 Ø¨Ø¬ÙˆØ§Ø± Ù…Ù„Ø¹Ø¨ Ø¨Ø±Ø´Ù„ÙˆÙ†Ø©","Ù…Ù‚Ù‡ÙŠ Ø£Ø¨Ùˆ Ø³Ù„ÙŠÙ…Ø§Ù†","Ø­ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡"
    ];
    
    let userPlace = null, userPlaceIdx = null, userID = null;
    let stream = null;
    let capturedImageData = null;
    let extractedNationalId = null;

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
    function loadRepNames() {
      const stored = JSON.parse(localStorage.getItem('saved_rep_names') || '[]');
      const datalist = document.getElementById('repNamesHistory');
      datalist.innerHTML = '';
      stored.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        datalist.appendChild(opt);
      });
    }
    
    function saveRepName(name) {
      if(!name) return;
      let stored = JSON.parse(localStorage.getItem('saved_rep_names') || '[]');
      if (!stored.includes(name)) {
        stored.push(name);
        localStorage.setItem('saved_rep_names', JSON.stringify(stored));
        loadRepNames();
      }
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function login() {
      const msgDiv = document.getElementById('login-msg');
      msgDiv.textContent = ''; msgDiv.className = 'msg';
      const codeInput = document.getElementById('loginCode').value.trim();
      const code = parseInt(codeInput);
      
      if (!codeInput || isNaN(code) || code < 225501 || code > 225522) {
        msgDiv.textContent = 'ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.';
        msgDiv.classList.add('error');
        return;
      }
      
      let idx = code - 225501;
      if (idx >= places.length) {
        msgDiv.textContent = 'ÙƒÙˆØ¯ ØµØ­ÙŠØ­ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±Ù Ø¨Ø§Ù„Ù†Ø¸Ø§Ù….';
        msgDiv.classList.add('error');
        return;
      }
      
      userPlace = places[idx];
      userPlaceIdx = idx + 1;
      userID = codeInput;
      
      const authCard = document.getElementById('auth-card');
      const mainCard = document.getElementById('main-card');
      authCard.style.opacity = '0';
      authCard.style.transform = 'translateY(-20px)';
      
      setTimeout(() => {
        authCard.classList.add('hidden');
        mainCard.classList.remove('hidden');
        mainCard.classList.add('fade-in');
        document.getElementById('welcome').textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙÙŠ ${userPlace}`;
        loadRepNames();
      }, 400);
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        video.classList.add('active');
        
        document.getElementById('canvas').classList.remove('active');
        document.getElementById('capturedImage').classList.remove('active');
        document.getElementById('startCamera').disabled = true;
        document.getElementById('capture').disabled = false;
        document.getElementById('resetCamera').style.display = 'none';
        
        showMsg('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø© - ØµÙˆØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙˆØ¶ÙˆØ­', 'success');
      } catch (err) {
        showMsg('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message, 'error');
      }
    }

    function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const capturedImage = document.getElementById('capturedImage');
      const ctx = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      
      capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
      capturedImage.src = capturedImageData;
      
      video.classList.remove('active');
      capturedImage.classList.add('active');
      
      document.getElementById('capture').disabled = true;
      document.getElementById('resetCamera').style.display = 'inline-block';
      document.getElementById('addBtn').disabled = false;
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      showMsg('ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©! Ø§Ø¶ØºØ· "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"', 'success');
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.getElementById('canvas');
          const capturedImage = document.getElementById('capturedImage');
          const ctx = canvas.getContext('2d');
          
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          
          capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
          capturedImage.src = capturedImageData;
          capturedImage.classList.add('active');
          
          document.getElementById('video').classList.remove('active');
          document.getElementById('resetCamera').style.display = 'inline-block';
          document.getElementById('addBtn').disabled = false;
          
          showMsg('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©! Ø§Ø¶ØºØ· "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"', 'success');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function resetCamera() {
      document.getElementById('video').classList.remove('active');
      document.getElementById('canvas').classList.remove('active');
      document.getElementById('capturedImage').classList.remove('active');
      document.getElementById('comparisonSection').classList.remove('active');
      
      document.getElementById('startCamera').disabled = false;
      document.getElementById('capture').disabled = true;
      document.getElementById('resetCamera').style.display = 'none';
      document.getElementById('addBtn').disabled = true;
      
      capturedImageData = null;
      extractedNationalId = null;
      
      showMsg('', '');
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ
    function extractNationalId(text) {
      const cleanText = text.replace(/\s+/g, '');
      const patterns = [
        /\b(\d{14})\b/,
        /(\d{3}\s*\d{11})/,
        /(\d{3}[-\/]\d{11})/
      ];
      
      for (let pattern of patterns) {
        const match = cleanText.match(pattern);
        if (match) {
          const id = match[1].replace(/\D/g, '');
          if (id.length === 14) {
            return id.substring(10); // Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…
          }
        }
      }
      
      const allNumbers = cleanText.match(/\d+/g);
      if (allNumbers) {
        for (let num of allNumbers) {
          if (num.length === 14) {
            return num.substring(10);
          }
        }
      }
      
      return null;
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¥Ø¶Ø§ÙØ©
    async function processAndAdd() {
      if (!capturedImageData) {
        showMsg('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }
      
      const repName = document.getElementById('repName').value.trim();
      if (repName.length < 2) {
        showMsg('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨', 'error');
        return;
      }
      
      showMsg('Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©...', 'processing');
      document.getElementById('addBtn').disabled = true;
      
      try {
        const { data: { text } } = await Tesseract.recognize(
          capturedImageData,
          'eng',
          {
            logger: m => {
              if (m.status === 'recognizing text') {
                showMsg(`Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${Math.round(m.progress * 100)}%`, 'processing');
              }
            }
          }
        );
        
        const natid = extractNationalId(text);
        
        if (!natid || natid.length !== 4) {
          showMsg('ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
          document.getElementById('addBtn').disabled = false;
          return;
        }
        
        extractedNationalId = natid;
        showMsg('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù…: ' + natid + ' - Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...', 'processing');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const snapshot = await db.ref('users/' + natid).once('value');
        
        if (snapshot.exists()) {
          // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ - ØªØ­Ø°ÙŠØ±
          const data = snapshot.val();
          document.getElementById('errorSound').play().catch(e => console.log('Audio blocked'));
          
          // Ø¹Ø±Ø¶ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØµÙˆØ±
          document.getElementById('comparisonSection').classList.add('active');
          document.getElementById('currentImage').src = capturedImageData;
          
          // Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
          if (data.imageUrl) {
            try {
              const oldImageUrl = await storage.refFromURL(data.imageUrl).getDownloadURL();
              document.getElementById('databaseImage').src = oldImageUrl;
            } catch (err) {
              document.getElementById('databaseImage').src = capturedImageData;
            }
          } else {
            document.getElementById('databaseImage').src = capturedImageData;
          }
          
          const msg = document.getElementById('add-msg');
          msg.className = 'duplicate-box';
          msg.innerHTML = `
            <span>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ ØªÙƒØ±Ø§Ø±!</span>
            <div style="margin-top:5px; font-size:13px; color:#333;">
             Ø§Ù„ÙƒÙˆØ¯ (${natid}) Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ <br>
             <b style="color:#d32f2f; font-size:15px;">${data.place}</b> <br>
             Ø¨ÙˆØ§Ø³Ø·Ø© <b style="color:#d32f2f; font-size:15px;">${data.repName}</b>
            </div>
          `;
          
          // Ø­ÙØ¸ Ø§Ù„ØªÙƒØ±Ø§Ø±
          const duplicateData = {
            duplicatedID: natid,
            attemptByRep: repName,
            attemptPlace: userPlace,
            originalRep: data.repName,
            originalPlace: data.place,
            timestamp: new Date().toISOString(),
            status: "rejected"
          };
          await db.ref('duplicates').push(duplicateData);
          
          saveRepName(repName);
          document.getElementById('addBtn').disabled = false;
          
        } else {
          // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
          showMsg('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'processing');
          
          // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Storage
          const storageRef = storage.ref('id-cards/' + natid + '_' + Date.now() + '.jpg');
          const uploadTask = await storageRef.putString(capturedImageData, 'data_url');
          const imageUrl = await uploadTask.ref.getDownloadURL();
          
          // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          const now = new Date();
          const payload = {
            natid,
            repName,
            place: userPlace,
            placeIdx: userPlaceIdx,
            time: now.toISOString(),
            username: userID,
            imageUrl: imageUrl
          };
          
          await db.ref('users/' + natid).set(payload);
          
          saveRepName(repName);
          showMsg('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
          setTimeout(() => {
            resetCamera();
            document.getElementById('repName').value = '';
          }, 2000);
        }
        
      } catch (error) {
        showMsg('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
        console.error(error);
        document.getElementById('addBtn').disabled = false;
      }
    }

    function showMsg(text, type) {
      const msg = document.getElementById('add-msg');
      msg.textContent = text;
      msg.className = 'msg ' + type;
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©
    function showStatsLogin() {
      document.getElementById('main-card').classList.add('hidden');
      const statsCard = document.getElementById('stats-auth-card');
      statsCard.classList.remove('hidden');
      statsCard.classList.add('fade-in');
      document.getElementById('statsPass').value = '';
      document.getElementById('stats-msg').textContent = '';
      document.getElementById('statsPass').focus();
    }

    function cancelStats() {
      document.getElementById('stats-auth-card').classList.add('hidden');
      const mainCard = document.getElementById('main-card');
      mainCard.classList.remove('hidden');
      mainCard.classList.add('fade-in');
    }

    function verifyStats() {
      const pass = document.getElementById('statsPass').value;
      const msg = document.getElementById('stats-msg');
      
      if(pass === '251988') {
        msg.className = 'msg success';
        msg.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØµØ­ÙŠØ­Ø©.';
        
        setTimeout(() => {
          document.getElementById('stats-auth-card').classList.add('hidden');
          const adminPanel = document.getElementById('admin-panel-card');
          adminPanel.classList.remove('hidden');
          adminPanel.classList.add('fade-in');
          renderAdminRepList();
        }, 500);
      } else {
        msg.className = 'msg error';
        msg.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!';
      }
    }

    function renderAdminRepList() {
      const container = document.getElementById('adminRepList');
      const stored = JSON.parse(localStorage.getItem('saved_rep_names') || '[]');
      container.innerHTML = '';
      
      if (stored.length === 0) {
        container.innerHTML = '<div class="empty-list">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡ Ù…Ø­ÙÙˆØ¸Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
        return;
      }
      
      stored.forEach(name => {
        const div = document.createElement('div');
        div.className = 'rep-item';
        div.innerHTML = `
          <span class="rep-name">${name}</span>
          <button class="btn-delete-rep" onclick="deleteRepName('${name}')">Ø­Ø°Ù</button>
        `;
        container.appendChild(div);
      });
    }

    function deleteRepName(nameToDelete) {
      if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ "${nameToDelete}" Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§ØªØŸ`)) {
        let stored = JSON.parse(localStorage.getItem('saved_rep_names') || '[]');
        stored = stored.filter(n => n !== nameToDelete);
        localStorage.setItem('saved_rep_names', JSON.stringify(stored));
        renderAdminRepList();
        loadRepNames();
      }
    }

    function closeAdminPanel() {
      document.getElementById('admin-panel-card').classList.add('hidden');
      document.getElementById('main-card').classList.remove('hidden');
    }
  </script>
</body>
</html>
