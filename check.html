<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ماسح البطاقة القومية</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js"></script>

<style>
    body {
        margin: 0;
        font-family: "Cairo", sans-serif;
        background: #f3f4f6;
    }

    .scanner-box {
        max-width: 650px;
        margin: auto;
        margin-top: 15px;
        background: white;
        border-radius: 22px;
        box-shadow: 0 10px 35px rgba(0,0,0,0.12);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(90deg,#059669,#2563eb,#7c3aed);
        color: white;
        padding: 20px;
        text-align: center;
    }

    #video {
        width: 100%;
        border-radius: 18px;
    }

    .frame-box {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 80%;
        height: 55%;
        transform: translate(-50%, -50%);
        border: 4px solid #10b981;
        border-radius: 25px;
        box-shadow: 0 0 30px rgba(0,255,150,0.4);
        pointer-events: none;
    }

    .wrapper {
        position: relative;
        padding: 0;
        margin: 0;
    }

    .scan-btn {
        width: 90%;
        margin: 20px auto;
        display: block;
        background: #059669;
        color: white;
        padding: 18px;
        font-size: 22px;
        font-weight: bold;
        border: none;
        border-radius: 18px;
        cursor: pointer;
    }

    .result {
        padding: 20px;
        background: #ecfdf5;
        border-top: 2px solid #6ee7b7;
        display: none;
    }

    .nid {
        font-size: 32px;
        font-weight: bold;
        color: #065f46;
        text-align: center;
        padding: 10px 0;
    }

    .numbers span {
        background: #dbeafe;
        padding: 6px 10px;
        margin: 5px;
        display: inline-block;
        border-radius: 8px;
        font-weight: bold;
    }
</style>
</head>

<body>

<div class="scanner-box">

    <div class="header">
        <h2>ماسح البطاقة القومية المصرية</h2>
        <p>الكاميرا تعمل تلقائيًا</p>
    </div>

    <div class="wrapper">
        <video id="video" autoplay playsinline muted></video>
        <div class="frame-box"></div>
    </div>

    <button class="scan-btn" onclick="scanImage()">مسح الآن</button>

    <div class="result" id="result-box">
        <h3 style="color:#065f46;">✔ الرقم القومي</h3>
        <div id="nid" class="nid"></div>
        <h4>الأرقام المستخرجة:</h4>
        <div id="numbers" class="numbers"></div>
    </div>

</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");

async function openCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });
        video.srcObject = stream;
    } catch (e) {
        alert("❌ لا يمكن فتح الكاميرا – تأكد من الإذن");
    }
}

// فتح الكاميرا عند تحميل الصفحة مباشرة
window.onload = openCamera;

function preprocess(ctx, canvas) {
    let img = ctx.getImageData(0,0,canvas.width,canvas.height);
    let data = img.data;

    for (let i=0;i<data.length;i+=4) {
        let g=(data[i]*0.3+data[i+1]*0.59+data[i+2]*0.11);
        g=((g-128)*1.7)+128;
        g=Math.min(255,Math.max(0,g));
        data[i]=data[i+1]=data[i+2]=g;
    }

    ctx.putImageData(img,0,0);
}

async function scanImage() {
    let ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // Mirror fix
    ctx.save();
    ctx.scale(-1,1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
    ctx.restore();

    preprocess(ctx, canvas);

    const worker = await Tesseract.createWorker("ara");

    await worker.setParameters({
        tessedit_char_whitelist: "0123456789٠١٢٣٤٥٦٧٨٩ "
    });

    const { data: { text } } = await worker.recognize(canvas);
    await worker.terminate();

    processText(text);
}

function processText(text) {
    const arab = "٠١٢٣٤٥٦٧٨٩";
    const eng  = "0123456789";

    const convertArabic = s => 
        s.split("").map(c => arab.includes(c) ? eng[arab.indexOf(c)] : c).join("");

    let a = text.match(/[٠-٩]+/g) || [];
    let e = text.match(/\d+/g) || [];

    let all = [...a.map(convertArabic), ...e];

    let nid = all.find(n => n.length === 14) || "لم يتم العثور عليه";

    showResult(nid, all);
}

function showResult(nid, nums) {
    document.getElementById("result-box").style.display = "block";
    document.getElementById("nid").innerText = nid;
    document.getElementById("numbers").innerHTML =
        nums.map(n => `<span>${n}</span>`).join("");
}
</script>

</body>
</html>
