<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ماسح البطاقة القومية المصرية</title>

<!-- Tesseract -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.344.0/font/lucide.css"/>

<style>
    body {
        font-family: "Cairo", sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #e8fff1, #e9f4ff, #f3eaff);
        min-height: 100vh;
    }
    .container {
        max-width: 650px;
        margin: auto;
        background: white;
        margin-top: 20px;
        margin-bottom: 40px;
        border-radius: 25px;
        box-shadow: 0 15px 50px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    header {
        background: linear-gradient(90deg, #059669, #2563eb, #7c3aed);
        padding: 20px;
        color: white;
        text-align: center;
    }
    header h1 {
        margin: 10px 0 0;
        font-size: 28px;
    }
    video {
        width: 100%;
        border-radius: 15px;
    }
    button {
        width: 100%;
        padding: 18px;
        border: none;
        margin-top: 10px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 15px;
        cursor: pointer;
        color: white;
    }
    .start-btn { background: linear-gradient(90deg,#059669,#2563eb); }
    .scan-btn  { background: #059669; }
    .cancel-btn{ background: #dc2626; }
    .result-box {
        background: #f0fdf4;
        border: 2px solid #86efac;
        padding: 15px;
        margin: 20px 10px;
        border-radius: 15px;
    }
    .number {
        background: #dbeafe;
        padding: 6px 12px;
        border-radius: 10px;
        font-weight: bold;
        display: inline-block;
        margin: 4px;
    }
</style>
</head>

<body>

<div class="container">

    <header>
        <i class="lucide lucide-scan" style="font-size:40px;"></i>
        <h1>ماسح البطاقة القومية</h1>
        <p>يدعم الأرقام العربية والإنجليزية</p>
    </header>

    <!-- CAMERA -->
    <div id="camera-box" style="padding:20px; display:none;">
        <video id="video" autoplay playsinline muted></video>

        <button class="scan-btn" onclick="captureAndProcess()">
            <i class="lucide lucide-square"></i> مسح الآن
        </button>
        <button class="cancel-btn" onclick="stopCamera()">إلغاء</button>

        <p style="text-align:center; color:#555; margin-top:10px;">
            ضع البطاقة داخل الكادر بوضوح
        </p>
    </div>

    <!-- START SCREEN -->
    <div id="start-box" style="padding:20px; text-align:center;">
        <i class="lucide lucide-camera" style="font-size:70px; color:#059669;"></i>
        <h2>ابدأ المسح</h2>
        <p>اضغط على الزر لتشغيل الكاميرا</p>
        <button class="start-btn" onclick="startCamera()">
            <i class="lucide lucide-camera"></i> تشغيل الكاميرا
        </button>
    </div>

    <!-- RESULT -->
    <div id="result-box" style="display:none; padding:20px;">
        <h3 style="color:#065f46;">✔ تم استخراج الرقم القومي</h3>

        <div id="national-id-box" class="result-box" style="display:none;">
            <p style="margin:0; font-size:18px;">الرقم القومي:</p>
            <p id="nid" style="font-size:30px; font-weight:bold; color:#065f46;"></p>
        </div>

        <div id="numbers-box" class="result-box" style="display:none;">
            <p style="margin:0; font-size:16px;">الأرقام المستخرجة:</p>
            <div id="all-nums"></div>
        </div>

        <button class="start-btn" onclick="resetScanner()">
            <i class="lucide lucide-refresh-ccw"></i> مسح بطاقة جديدة
        </button>
    </div>

</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let stream = null;

function $(id) { return document.getElementById(id); }

function startCamera() {
    $("#start-box").style.display = "none";
    $("#camera-box").style.display = "block";

    navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } }
    }).then(s => {
        stream = s;
        video.srcObject = s;
    }).catch(() => alert("لا يمكن فتح الكاميرا"));
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
    $("#camera-box").style.display = "none";
    $("#start-box").style.display = "block";
}

function preprocess(ctx, canvas) {
    let img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let data = img.data;

    for (let i = 0; i < data.length; i += 4) {
        let g = (data[i] * 0.3 + data[i+1] * 0.59 + data[i+2] * 0.11);
        g = ((g - 128) * 1.6) + 128;
        g = Math.min(255, Math.max(0, g));
        data[i] = data[i+1] = data[i+2] = g;
    }

    ctx.putImageData(img, 0, 0);
}

async function captureAndProcess() {
    let ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.save();
    ctx.scale(-1, 1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
    ctx.restore();

    preprocess(ctx, canvas);

    const worker = await Tesseract.createWorker("ara");

    await worker.setParameters({
        tessedit_char_whitelist: "0123456789٠١٢٣٤٥٦٧٨٩ "
    });

    const { data: { text } } = await worker.recognize(canvas);
    await worker.terminate();

    processText(text);
}

function processText(text) {
    const arab = "٠١٢٣٤٥٦٧٨٩";
    const eng =  "0123456789";

    const convertArabic = (str) =>
        str.split("").map(c => {
            let i = arab.indexOf(c);
            return i !== -1 ? eng[i] : c;
        }).join("");

    let arabNums = text.match(/[٠-٩]+/g) || [];
    let engNums  = text.match(/\d+/g) || [];

    let all = [...arabNums.map(convertArabic), ...engNums];

    let nationalID = all.find(n => n.length === 14) || null;

    showResult(nationalID, all);
}

function showResult(nid, numbers) {
    stopCamera();

    $("#camera-box").style.display = "none";
    $("#result-box").style.display = "block";

    if (nid) {
        $("#nid").innerText = nid;
        $("#national-id-box").style.display = "block";
    }

    if (numbers.length) {
        $("#numbers-box").style.display = "block";
        $("#all-nums").innerHTML = numbers
            .map(n => `<span class='number'>${n}</span>`)
            .join("");
    }
}

function resetScanner() {
    $("#result-box").style.display = "none";
    $("#start-box").style.display = "block";
}

</script>

</body>
</html>
