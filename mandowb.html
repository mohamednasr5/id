<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù„Ø¬Ø§Ù† â€“ Ø¨Ø­Ø« ØµÙˆØªÙŠ</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{font-family:Cairo;background:#f5f6fa}
.committee-card{background:#fff;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
.delegate{background:#f1f2f6;border-radius:8px;padding:10px;margin-bottom:8px}
.phone{direction:ltr;font-weight:bold}
.actions a{margin-inline-end:5px}
.delete-btn{margin-top:6px}
</style>
</head>

<body class="container py-4">

<h3 class="mb-3"><i class="fa fa-users"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù„Ø¬Ø§Ù†</h3>

<!-- ğŸ” Ø§Ù„Ø¨Ø­Ø« -->
<div class="input-group mb-4">
  <input id="searchInput" class="form-control form-control-lg"
         placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø©ØŒ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ØŒ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <button class="btn btn-secondary" onclick="startVoiceSearch()">
    <i class="fa fa-microphone"></i>
  </button>
  <button class="btn btn-danger" onclick="clearSearch()">
    <i class="fa fa-times"></i>
  </button>
</div>

<div id="committeesContainer" class="row"></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

/* Firebase Config */
const firebaseConfig = {
 apiKey: "AIzaSyDSeCdQEQ_GlPh2bHN_g1zY0uT5itZHjxg",
 authDomain: "mandowb-9ce4d.firebaseapp.com",
 projectId: "mandowb-9ce4d",
 storageBucket: "mandowb-9ce4d.firebasestorage.app",
 messagingSenderId: "19347263922",
 appId: "1:19347263922:web:970047c58c5c250f7194ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allData = {};
const container = document.getElementById("committeesContainer");

/* Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¬Ø§Ù† */
for(let i=1;i<=60;i++){
  set(ref(db,'committees/'+i+'/id'),i);
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
onValue(ref(db,'committees'), snap=>{
 allData = snap.val() || {};
 render(allData);
});

/* Ø¹Ø±Ø¶ */
function render(data){
 container.innerHTML='';
 Object.entries(data).forEach(([id,comm])=>{
   const delegates = comm.delegates || {};
   let delegatesHTML = '';

   Object.entries(delegates).forEach(([key,d])=>{
     delegatesHTML += `
     <div class="delegate">
       <div><b>${d.name}</b></div>
       <div class="phone">${d.phone}</div>

       <div class="actions mt-2">
         <a class="btn btn-sm btn-primary" href="tel:${d.phone}">
           <i class="fa fa-phone"></i>
         </a>
         <a class="btn btn-sm btn-success" target="_blank"
            href="https://wa.me/2${d.phone}">
           <i class="fab fa-whatsapp"></i>
         </a>
       </div>

       <!-- Ø²Ø± Ø­Ø°Ù Ù…Ù†ÙØµÙ„ -->
       <button class="btn btn-sm btn-danger w-100 delete-btn"
         onclick="removeDelegate(${id},'${key}')">
         <i class="fa fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
       </button>
     </div>`;
   });

   container.innerHTML += `
   <div class="col-md-4">
     <div class="committee-card">
       <h5>Ù„Ø¬Ù†Ø© Ø±Ù‚Ù… ${id}</h5>
       ${delegatesHTML || '<span class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</span>'}
       <button class="btn btn-success btn-sm w-100 mt-2"
         onclick="addDelegate(${id})">
         <i class="fa fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨
       </button>
     </div>
   </div>`;
 });
}

/* Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ */
window.addDelegate = function(id){
 const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨");
 if(!name) return;
 const phone = prompt("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
 if(!phone) return;
 push(ref(db,'committees/'+id+'/delegates'),{name,phone});
}

/* Ø­Ø°Ù Ù…Ù†Ø¯ÙˆØ¨ */
window.removeDelegate = function(id,key){
 if(confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ØŸ")){
   remove(ref(db,'committees/'+id+'/delegates/'+key));
 }
}

/* Ø§Ù„Ø¨Ø­Ø« */
document.getElementById("searchInput").addEventListener("input",()=>{
 const q = searchInput.value.trim();
 if(!q){ render(allData); return; }

 let filtered = {};
 Object.entries(allData).forEach(([id,c])=>{
   let hit = id.includes(q);
   const dels = c.delegates || {};
   Object.values(dels).forEach(d=>{
     if(d.name.includes(q) || d.phone.includes(q)) hit = true;
   });
   if(hit) filtered[id]=c;
 });
 render(filtered);
});

window.clearSearch = ()=>{ searchInput.value=''; render(allData); };

/* ğŸ™ï¸ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ */
let recognition;
if('webkitSpeechRecognition' in window){
 recognition = new webkitSpeechRecognition();
 recognition.lang='ar-EG';
 recognition.onresult=e=>{
   searchInput.value=e.results[0][0].transcript;
   searchInput.dispatchEvent(new Event('input'));
 };
}
window.startVoiceSearch = ()=> recognition?.start();

</script>
</body>
</html>
