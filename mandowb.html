<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة اللجان والمندوبين</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
body{background:#f4f6f9;font-family:Cairo,Arial}
.committee-card{background:#fff;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
.committee-number{font-size:22px;font-weight:bold;color:#0d6efd}
.delegate{background:#f8f9fa;padding:10px;border-radius:8px;margin-top:8px}
</style>
</head>

<body>
<div class="container mt-4">

<div class="d-flex justify-content-between align-items-center mb-3">
<h3><i class="fa fa-users"></i> إدارة اللجان</h3>
<button class="btn btn-success" onclick="openAddCommittee()">
<i class="fa fa-plus"></i> إضافة لجنة
</button>
</div>

<div id="committees"></div>

</div>

<!-- مودال إضافة لجنة -->
<div class="modal fade" id="committeeModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header bg-primary text-white">
<h5>إضافة لجنة جديدة</h5>
<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="number" id="newCommitteeId" class="form-control" placeholder="رقم اللجنة">
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
<button class="btn btn-primary" onclick="addCommittee()">حفظ</button>
</div>
</div>
</div>
</div>

<!-- مودال المندوب -->
<div class="modal fade" id="delegateModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header bg-success text-white">
<h5>إضافة مندوب</h5>
<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="hidden" id="currentCommittee">
<input class="form-control mb-2" id="delegateName" placeholder="اسم المندوب">
<input class="form-control" id="delegatePhone" placeholder="رقم الهاتف">
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
<button class="btn btn-success" onclick="saveDelegate()">حفظ</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Firebase Config
firebase.initializeApp({
apiKey: "AIzaSyDSeCdQEQ_GlPh2bHN_g1zY0uT5itZHjxg",
authDomain: "mandowb-9ce4d.firebaseapp.com",
projectId: "mandowb-9ce4d"
});
const db = firebase.firestore();

let committeesData = [];

// تحميل البيانات
async function loadData(){
const snap = await db.collection("committees").get();
committeesData = [];
snap.forEach(d=>committeesData.push(d.data()));
committeesData.sort((a,b)=>a.id-b.id);
render();
}

// رسم اللجان
function render(){
const box=document.getElementById("committees");
box.innerHTML="";
committeesData.forEach(c=>{
box.innerHTML+=`
<div class="committee-card">
<div class="committee-number">لجنة ${c.id}</div>
${c.delegates.map(d=>`
<div class="delegate">
<b>${d.name}</b><br>
${d.phone||"بدون رقم"}
</div>`).join("")}
<button class="btn btn-sm btn-outline-success mt-2" onclick="openDelegate(${c.id})">
<i class="fa fa-user-plus"></i> إضافة مندوب
</button>
</div>`;
});
}

// إضافة لجنة
function openAddCommittee(){
new bootstrap.Modal(document.getElementById("committeeModal")).show();
}

async function addCommittee(){
const id=parseInt(document.getElementById("newCommitteeId").value);
if(!id) return alert("أدخل رقم اللجنة");
await db.collection("committees").doc(id.toString()).set({
id,delegates:[]
});
bootstrap.Modal.getInstance(document.getElementById("committeeModal")).hide();
loadData();
}

// إضافة مندوب
function openDelegate(id){
document.getElementById("currentCommittee").value=id;
document.getElementById("delegateName").value="";
document.getElementById("delegatePhone").value="";
new bootstrap.Modal(document.getElementById("delegateModal")).show();
}

async function saveDelegate(){
const id=document.getElementById("currentCommittee").value;
const name=document.getElementById("delegateName").value.trim();
const phone=document.getElementById("delegatePhone").value.trim();
if(!name) return alert("الاسم مطلوب");

const ref=db.collection("committees").doc(id.toString());
const doc=await ref.get();
const data=doc.data();
data.delegates.push({name,phone});
await ref.set(data);

bootstrap.Modal.getInstance(document.getElementById("delegateModal")).hide();
loadData();
}

loadData();
</script>
</body>
</html>
