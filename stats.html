<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم والإحصائيات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap">
  <style>
    :root {
      --primary-color: #0072ff;
      --secondary-color: #00c6ff;
      --bg-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
      --text-color: #2d3436;
      --danger-color: #ff4757;
      --success-color: #2ecc71;
      --warning-color: #ffa502;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: var(--text-color);
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* كرات الخلفية */
    .circles {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    .circles li {
      position: absolute;
      display: block;
      list-style: none;
      width: 20px; height: 20px;
      background: rgba(255, 255, 255, 0.2);
      animation: animate 25s linear infinite;
      bottom: -150px;
      border-radius: 50%;
    }
    .circles li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
    .circles li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
    .circles li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
    .circles li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
    .circles li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
    @keyframes animate {
      0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; }
      100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; }
    }

    /* شاشة تسجيل الدخول */
    #loginScreen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(15px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }
    .login-box input {
      width: 100%;
      padding: 15px;
      margin: 20px 0;
      border: 2px solid #eee;
      border-radius: 10px;
      font-size: 18px;
      font-family: 'Cairo', sans-serif;
      text-align: center;
      transition: 0.3s;
    }
    .login-box input:focus {
      border-color: var(--primary-color);
      outline: none;
    }
    .login-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 40px;
      border-radius: 50px;
      font-size: 18px;
      font-family: 'Cairo', sans-serif;
      cursor: pointer;
      transition: 0.3s;
    }
    .login-btn:hover { transform: scale(1.05); }

    /* الحاوية الرئيسية */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: var(--glass-shadow);
      padding: 30px;
      opacity: 0;
      transform: translateY(20px);
      transition: 0.8s ease;
      display: none;
    }

    .container.visible {
      opacity: 1;
      transform: translateY(0);
      display: block;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    h2 { margin: 0; color: var(--primary-color); font-weight: 700; font-size: 1.5rem; }

    /* أزرار التحكم */
    .btn {
      padding: 8px 20px;
      border-radius: 50px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: 0.3s;
      color: white;
      font-family: 'Cairo', sans-serif;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      text-decoration: none;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    
    .btn-back { background: #7f8c8d; }
    .btn-print { background: var(--primary-color); }
    .btn-excel { background: var(--success-color); }
    .btn-reset { background: var(--danger-color); }

    /* تنسيق الجدول */
    .table-wrapper {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      min-width: 800px;
    }

    th, td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: rgba(0, 114, 255, 0.1);
      color: var(--primary-color);
      font-weight: 700;
      white-space: nowrap;
      position: sticky;
      top: 0;
      border-bottom: 2px solid var(--primary-color);
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(0, 114, 255, 0.05); }

    /* تنسيق المندوب */
    .rep-tag {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 8px;
        transition: 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        border: 1px solid transparent;
    }
    .rep-tag:hover {
        background: rgba(0, 114, 255, 0.1);
        border-color: var(--secondary-color);
    }

    .statok {
      color: #2ecc71;
      font-weight: bold;
      background: rgba(46, 204, 113, 0.1);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.9em;
    }
    .statdupl { color: #e74c3c; font-weight: bold; }

    /* Modal */
    #repModal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(8px);
    }
    .rep-modal-content {
        background: white;
        padding: 40px;
        border-radius: 25px;
        text-align: center;
        position: relative;
        animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        width: 90%;
        max-width: 450px;
    }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .close-modal {
        position: absolute;
        top: 15px; left: 15px; font-size: 24px; cursor: pointer;
        color: #aaa; width: 30px; height: 30px; line-height: 30px;
        background: #eee; border-radius: 50%;
    }
    .rep-name-title { color: var(--primary-color); margin-bottom: 10px; font-size: 1.5rem; }
    .rep-subtitle { color: #666; font-size: 1.2rem; margin: 0; }
    .big-number {
        font-size: 6rem; font-weight: 800;
        background: -webkit-linear-gradient(var(--secondary-color), var(--primary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 10px 0; line-height: 1;
    }

    /* Spinner */
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin: 50px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* تنسيق الطباعة */
    @media print {
        body {
            background: white;
            animation: none;
            padding: 0;
            color: black;
        }
        .circles, .controls, .btn_back, #loginScreen, .btn { display: none !important; }
        .container {
            box-shadow: none;
            margin: 0;
            width: 100%;
            max-width: 100%;
            padding: 10px;
            backdrop-filter: none;
            animation: none;
            opacity: 1;
            transform: none;
        }
        .table-wrapper { overflow: visible; box-shadow: none; }
        table { min-width: 100%; border: 1px solid #000; }
        th { background-color: #eee !important; color: #000 !important; border: 1px solid #000; }
        td { border: 1px solid #000; color: #000; }
        h2 { text-align: center; color: #000; text-decoration: underline; margin-bottom: 20px; }
    }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div class="login-box">
      <h2 style="margin-bottom:20px;">محمية بكلمة مرور</h2>
      <p>الرجاء إدخال الرمز للمتابعة</p>
      <input type="password" id="passwordInput" placeholder="أدخل الكود هنا">
      <button class="login-btn" onclick="checkPassword()">دخول</button>
      <p id="errorMsg" style="color:red; display:none; margin-top:10px;">كلمة المرور خاطئة</p>
    </div>
  </div>

  <div id="repModal">
      <div class="rep-modal-content">
          <div class="close-modal" onclick="closeRepModal()">&times;</div>
          <h3 class="rep-name-title" id="modalRepName">اسم المندوب</h3>
          <p class="rep-subtitle">هذا المندوب أدخل</p>
          <div class="big-number" id="modalRepCount">0</div>
          <p style="color:#888; margin:0;">ناخب</p>
      </div>
  </div>

  <ul class="circles">
    <li></li><li></li><li></li><li></li><li></li>
    <li></li><li></li><li></li><li></li><li></li>
  </ul>

  <div class="container">
    <div class="header-row">
      <h2>إحصائيات الدخول</h2>
      <div class="controls">
        <button class="btn btn-print" onclick="window.print()">طباعة A4</button>
        <button class="btn btn-excel" onclick="exportToExcel()">تصدير Excel</button>
        <button class="btn btn-reset" onclick="resetData()">تصفير الإحصائيات</button>
        <button class="btn btn-back" onclick="location='DelegateApp_Pro.html'">عودة</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table id="statTable">
        <thead>
          <tr>
            <th>المكان</th>
            <th>العدد الكلي</th>
            <th>مكرر</th>
            <th>تفاصيل المناديب</th>
            <th>أول إدخال</th>
            <th>آخر إدخال</th>
            <th>المدة</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7"><div class="loader"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, child, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxnIxtFeAOjYjCIrU5cwYVteuQ18K8Kjc",
      authDomain: "idmanazla.firebaseapp.com",
      databaseURL: "https://idmanazla-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "idmanazla",
      storageBucket: "idmanazla.firebasestorage.app",
      messagingSenderId: "408446131276",
      appId: "1:408446131276:web:976ae54181b5398de5a8e9",
      measurementId: "G-9YSW9HNYTG"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const places = [
      "المنزلة الجديدة 1","المنزلة الجديدة 2","بحر البلد شارع الكابتن",
      "مدرسة عبد العال شلبياية","مصنع البصل","الكفر 1","الكفر 2 تحت السكة",
      "سوق الجملة","الفداء","نقطة حمام الكيال","الحمزاوي","الجرن 1","الجرن 2",
      "البر التاني حي السلام","حي الاعجام","العزبة منشية ناصر","الطويل",
      "البر التاني 2 الهاويس","الفقاعي","بحر البلد 2","حي الجبانة",
      "الكفر 3 بجوار ملعب برشلونة","مقهي أبو سليمان","حي الزهراء"
    ];

    // تحميل البيانات
    window.loadData = async function(){
      try {
        const snapshot = await get(child(ref(db), 'users'));
        let users = snapshot.exists() ? snapshot.val() : {};
        let perPlace = {};
        
        for (let id in users) {
          let u = users[id];
          const key = u.place;
          if (!perPlace[key]) {
            perPlace[key] = {count:0, duplicates:0, reps:{}, times:[]};
          }
          perPlace[key].count++;
          if (!perPlace[key].reps[u.repName]) perPlace[key].reps[u.repName]=[];
          perPlace[key].reps[u.repName].push(u.time);
          perPlace[key].times.push(u.time);
        }

        let tbody = '';
        places.forEach((place, i) => {
          let p = perPlace[place] || {count:0, duplicates:0, reps:{}, times:[]};
          let minTime = p.times.length ? new Date(Math.min(...p.times.map(t=>new Date(t)))) : '-';
          let maxTime = p.times.length ? new Date(Math.max(...p.times.map(t=>new Date(t)))) : '-';
          let diff = (minTime!='-' && maxTime!='-') ? ((maxTime-minTime)/60000) : null;
          let duration = (diff!==null)? `${Math.floor(diff/60)} س و ${Math.floor(diff%60).toString().padStart(2,'0')} د`:'-';
          
          let repDetails = Object.entries(p.reps)
            .map(([k,v]) => `
                <div class="rep-tag" onclick="showRepStat('${k}', ${v.length})">
                    <span>${k}</span>
                    <span class="statok">${v.length}</span>
                </div>
            `)
            .join("");

          tbody += `<tr>
            <td style="font-weight:bold; color:var(--primary-color)">${place}</td>
            <td><span style="font-size:1.1em; font-weight:bold;">${p.count}</span></td>
            <td><span class="statdupl">${p.duplicates||0}</span></td>
            <td style="text-align:right; direction:rtl;">${repDetails||'-'}</td>
            <td dir="ltr">${minTime!='-' ? minTime.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}) : '-'}</td>
            <td dir="ltr">${maxTime!='-' ? maxTime.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}) : '-'}</td>
            <td>${duration}</td>
          </tr>`;
        });
        document.getElementById('tbody').innerHTML = tbody;
      } catch (e) {
        document.getElementById('tbody').innerHTML = `<tr><td colspan="7" style="color:red">حدث خطأ أثناء تحميل البيانات</td></tr>`;
        console.error(e);
      }
    };

    // دالة التصفير (الحذف)
    window.resetData = async function() {
        if(confirm("تحذير هام:\nهل أنت متأكد من رغبتك في تصفير العدادات وحذف جميع البيانات؟\nلا يمكن التراجع عن هذا الإجراء!")) {
            const userPass = prompt("للتأكيد، أدخل كلمة المرور مرة أخرى (251988):");
            if(userPass === "251988"){
                try {
                    await remove(ref(db, 'users'));
                    alert("تم حذف البيانات وتصفير العدادات بنجاح.");
                    location.reload();
                } catch(e) {
                    alert("حدث خطأ أثناء الحذف: " + e.message);
                }
            } else {
                alert("كلمة المرور خاطئة، تم إلغاء العملية.");
            }
        }
    };
  </script>

  <script>
    // Password Logic
    function checkPassword() {
        const pass = document.getElementById('passwordInput').value;
        if (pass === '251988') {
            document.getElementById('loginScreen').style.display = 'none';
            const container = document.querySelector('.container');
            container.classList.add('visible');
            if(window.loadData) window.loadData();
        } else {
            document.getElementById('errorMsg').style.display = 'block';
        }
    }

    // Modal Logic
    function showRepStat(name, count) {
        document.getElementById('modalRepName').innerText = name;
        document.getElementById('modalRepCount').innerText = count;
        document.getElementById('repModal').style.display = 'flex';
    }
    function closeRepModal() { document.getElementById('repModal').style.display = 'none'; }
    window.onclick = function(event) { if (event.target == document.getElementById('repModal')) closeRepModal(); }

    // Excel Export Logic
    function exportToExcel() {
        // نجهز الجدول للتصدير
        var table = document.getElementById("statTable");
        var rows = [];
        
        // إضافة العناوين مع تلوين الخلفية
        var header = [];
        var ths = table.querySelectorAll("thead th");
        for (var i = 0; i < ths.length; i++) {
            header.push(`<th style="background-color:#4a90e2; color:#ffffff; border:1px solid #000; padding:10px;">${ths[i].innerText}</th>`);
        }
        rows.push(`<tr>${header.join("")}</tr>`);

        // إضافة البيانات مع تلوين الصفوف
        var trs = table.querySelectorAll("tbody tr");
        for (var i = 0; i < trs.length; i++) {
            var cols = [];
            var tds = trs[i].querySelectorAll("td");
            var bgColor = (i % 2 === 0) ? "#ffffff" : "#f2f2f2"; // Zebra striping
            
            for (var j = 0; j < tds.length; j++) {
                // تنظيف النص من HTML tags الزائدة للمناديب
                let text = tds[j].innerText;
                cols.push(`<td style="background-color:${bgColor}; border:1px solid #000; text-align:center; vertical-align:middle;">${text}</td>`);
            }
            rows.push(`<tr>${cols.join("")}</tr>`);
        }

        // بناء ملف الـ Excel كـ HTML Table
        var excelFile = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta charset="UTF-8">
                <style>
                    table { border-collapse: collapse; width: 100%; }
                    td, th { border: 1px solid #000000; }
                </style>
            </head>
            <body dir="rtl">
                <table>${rows.join("")}</table>
            </body>
            </html>
        `;

        // تحميل الملف
        var blob = new Blob([excelFile], { type: 'application/vnd.ms-excel' });
        var link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Statistics_Report.xls";
        link.click();
    }
  </script>
</body>
</html>
