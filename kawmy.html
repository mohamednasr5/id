<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ماسح بطاقة الرقم القومي المصري</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@10.3.0/dist/dbr.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    background: #eef2f5;
    font-family: 'Cairo', sans-serif;
    text-align: center;
    padding: 25px;
}

#scanner {
    width: 350px;
    height: 350px;
    margin: 0 auto;
    border: 3px solid #0f3c67;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
}

input {
    width: 350px;
    padding: 12px;
    margin-top: 15px;
    font-size: 22px;
    text-align: center;
    border-radius: 10px;
    border: 2px solid #0f3c67;
    background: #fff;
}

#success {
    display: none;
    background: #0f3c67;
    color: #fff;
    padding: 12px;
    margin-top: 15px;
    border-radius: 10px;
}

#error {
    display: none;
    background: #d32f2f;
    color: #fff;
    padding: 12px;
    margin-top: 15px;
    border-radius: 10px;
}

button {
    margin-top: 15px;
    background: #0f3c67;
    padding: 10px 16px;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    cursor: pointer;
}

button:hover {
    background: #1a5490;
}

#status {
    margin-top: 15px;
    font-size: 16px;
    color: #666;
}
</style>
</head>

<body>

<h2>قارئ بطاقة الرقم القومي المصري (DataMatrix)</h2>

<div id="status">جاري تحميل الماسح...</div>

<div id="scanner"></div>

<input id="nid" type="text" placeholder="الرقم القومي يظهر تلقائيًا" readonly>

<div id="success">✔️ تمت قراءة الرقم القومي بنجاح</div>

<div id="error"></div>

<button onclick="restart()">إعادة تشغيل الماسح</button>

<script>
function toArabic(n){
    return n.replace(/[0-9]/g, d=>"٠١٢٣٤٥٦٧٨٩"[d]);
}

let scanner;

async function start() {
    try {
        document.getElementById("status").textContent = "جاري تشغيل الكاميرا...";
        document.getElementById("error").style.display = "none";

        // استخدام DBR.BarcodeScanner للإصدار 10.x
        scanner = await Dynamsoft.DBR.BarcodeScanner.createInstance();
        
        // تعيين الترخيص
        await Dynamsoft.DBR.BarcodeReader.initLicense("DLS2eyJoYW5kc2hha2VDb2RlIjoiMTA0ODY2MTM2LU1UQTBPRFkyTVRNMkxYZGxZaTFVY21saGJGQnliMm8iLCJtYWluU2VydmVyVVJMIjoiaHR0cHM6Ly9tZGxzLmR5bmFtc29mdG9ubGluZS5jb20iLCJvcmdhbml6YXRpb25JRCI6IjEwNDg2NjEzNiIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbSIsImNoZWNrQ29kZSI6LTE3MDIzNzIyNzh9");

        // إعدادات الكاميرا
        let settings = await scanner.getRuntimeSettings();
        settings.barcodeFormatIds = Dynamsoft.DBR.EnumBarcodeFormat.BF_DATAMATRIX;
        await scanner.updateRuntimeSettings(settings);

        scanner.onFrameRead = results => {
            if (results.length === 0) return;

            let raw = results[0].barcodeText;
            raw = raw.replace(/\D/g, "").substring(0, 14);

            if (raw.length === 14) {
                document.getElementById("nid").value = toArabic(raw);
                document.getElementById("success").style.display = "block";
                document.getElementById("status").textContent = "✔️ تم المسح بنجاح";
                scanner.stop();
            }
        };

        await scanner.setUIElement(document.getElementById("scanner"));
        await scanner.open();
        
        document.getElementById("status").textContent = "جاهز للمسح - وجّه الكاميرا نحو الباركود";
    } 
    catch (err) {
        console.error("تفاصيل الخطأ:", err);
        
        let errorMsg = "";
        
        if (err.name === "NotAllowedError" || err.message.includes("permission")) {
            errorMsg = "⚠️ تم رفض إذن الكاميرا. يرجى السماح بالوصول للكاميرا من إعدادات المتصفح ثم إعادة تحميل الصفحة.";
        } else if (err.name === "NotFoundError") {
            errorMsg = "⚠️ لم يتم العثور على كاميرا متصلة بالجهاز.";
        } else if (err.name === "NotReadableError") {
            errorMsg = "⚠️ الكاميرا قيد الاستخدام من تطبيق آخر. يرجى إغلاق التطبيقات الأخرى والمحاولة مرة أخرى.";
        } else if (err.name === "SecurityError") {
            errorMsg = "⚠️ خطأ أمني: يجب فتح الصفحة عبر HTTPS أو localhost للوصول للكاميرا.";
        } else {
            errorMsg = "⚠️ خطأ في تشغيل الماسح: " + err.message;
        }
        
        document.getElementById("error").textContent = errorMsg;
        document.getElementById("error").style.display = "block";
        document.getElementById("status").textContent = "فشل التشغيل";
        
        alert(errorMsg);
    }
}

async function restart() {
    try {
        document.getElementById("success").style.display = "none";
        document.getElementById("error").style.display = "none";
        document.getElementById("nid").value = "";
        document.getElementById("status").textContent = "جاري إعادة التشغيل...";
        
        if (scanner) {
            await scanner.open();
            document.getElementById("status").textContent = "جاهز للمسح - وجّه الكاميرا نحو الباركود";
        } else {
            await start();
        }
    } catch (err) {
        console.error(err);
        document.getElementById("error").textContent = "⚠️ فشلت إعادة التشغيل: " + err.message;
        document.getElementById("error").style.display = "block";
    }
}

// بدء التشغيل عند تحميل الصفحة
start();
</script>

</body>
</html>
