<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ماسح بطاقة الرقم القومي المصري</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@11.2.4000/dist/dbr.bundle.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    background: #eef2f5;
    font-family: 'Cairo', sans-serif;
    text-align: center;
    padding: 25px;
    margin: 0;
}

h2 {
    color: #0f3c67;
    margin-bottom: 20px;
}

#camera-view-container {
    width: 100%;
    max-width: 500px;
    height: 400px;
    margin: 0 auto;
    border: 3px solid #0f3c67;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
}

input {
    width: 100%;
    max-width: 500px;
    padding: 12px;
    margin-top: 15px;
    font-size: 22px;
    text-align: center;
    border-radius: 10px;
    border: 2px solid #0f3c67;
    background: #fff;
    box-sizing: border-box;
}

#success {
    display: none;
    background: #4caf50;
    color: #fff;
    padding: 12px;
    margin: 15px auto;
    max-width: 500px;
    border-radius: 10px;
    font-size: 18px;
}

#error {
    display: none;
    background: #d32f2f;
    color: #fff;
    padding: 12px;
    margin: 15px auto;
    max-width: 500px;
    border-radius: 10px;
    font-size: 16px;
}

#status {
    margin-top: 15px;
    font-size: 16px;
    color: #666;
}

button {
    margin-top: 15px;
    background: #0f3c67;
    padding: 12px 20px;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
}

button:hover {
    background: #1a5490;
}
</style>
</head>

<body>

<h2>قارئ بطاقة الرقم القومي المصري (DataMatrix)</h2>

<div id="status">جاري تحميل الماسح...</div>

<div id="camera-view-container"></div>

<input id="nid" type="text" placeholder="الرقم القومي يظهر تلقائيًا" readonly>

<div id="success">✔️ تمت قراءة الرقم القومي بنجاح</div>

<div id="error"></div>

<button onclick="restart()">إعادة تشغيل الماسح</button>

<script>
function toArabic(n){
    return n.replace(/[0-9]/g, d=>"٠١٢٣٤٥٦٧٨٩"[d]);
}

let cvRouter;
let cameraEnhancer;

async function start() {
    try {
        document.getElementById("status").textContent = "جاري تهيئة المكتبة...";
        document.getElementById("error").style.display = "none";
        document.getElementById("success").style.display = "none";

        // تهيئة الترخيص
        Dynamsoft.License.LicenseManager.initLicense("DLS2eyJoYW5kc2hha2VDb2RlIjoiMTA0ODY2MTM2LU1UQTBPRFkyTVRNMkxYZGxZaTFVY21saGJGQnliMm8iLCJtYWluU2VydmVyVVJMIjoiaHR0cHM6Ly9tZGxzLmR5bmFtc29mdG9ubGluZS5jb20iLCJvcmdhbml6YXRpb25JRCI6IjEwNDg2NjEzNiIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbSIsImNoZWNrQ29kZSI6LTE3MDIzNzIyNzh9");

        // تحميل مكتبات WASM مسبقاً
        await Dynamsoft.Core.CoreModule.loadWasm();

        document.getElementById("status").textContent = "جاري تشغيل الكاميرا...";

        // إنشاء CaptureVisionRouter
        cvRouter = await Dynamsoft.CVR.CaptureVisionRouter.createInstance();

        // إنشاء CameraView و CameraEnhancer
        let cameraView = await Dynamsoft.DCE.CameraView.createInstance();
        cameraEnhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance(cameraView);
        
        // إضافة الكاميرا للصفحة
        document.querySelector("#camera-view-container").append(cameraView.getUIElement());

        // ربط الكاميرا بـ router
        cvRouter.setInput(cameraEnhancer);

        // تخصيص الإعدادات للقراءة DataMatrix فقط
        let settings = await cvRouter.getSimplifiedSettings("ReadSingleBarcode");
        settings.barcodeSettings.barcodeFormatIds = Dynamsoft.DBR.EnumBarcodeFormat.BF_DATAMATRIX;
        await cvRouter.updateSettings("ReadSingleBarcode", settings);

        // إضافة مستقبل النتائج
        cvRouter.addResultReceiver({
            onDecodedBarcodesReceived: (result) => {
                if (result.barcodeResultItems?.length) {
                    let raw = result.barcodeResultItems[0].text;
                    raw = raw.replace(/\D/g, "").substring(0, 14);

                    if (raw.length === 14) {
                        document.getElementById("nid").value = toArabic(raw);
                        document.getElementById("success").style.display = "block";
                        document.getElementById("status").textContent = "✔️ تم المسح بنجاح";
                        
                        // إصدار صوت تنبيه
                        try {
                            Dynamsoft.DCE.Feedback.beep();
                        } catch(e) {}
                    }
                }
            }
        });

        // إضافة فلتر لتجنب النتائج المكررة
        let filter = new Dynamsoft.Utility.MultiFrameResultCrossFilter();
        filter.enableResultCrossVerification("barcode", true);
        filter.enableResultDeduplication("barcode", true);
        await cvRouter.addResultFilter(filter);

        // فتح الكاميرا وبدء المسح
        await cameraEnhancer.open();
        await cvRouter.startCapturing("ReadSingleBarcode");
        
        document.getElementById("status").textContent = "جاهز للمسح - وجّه الكاميرا نحو الباركود";
    } 
    catch (err) {
        console.error("تفاصيل الخطأ:", err);
        
        let errorMsg = "";
        
        if (err.name === "NotAllowedError" || err.message.includes("permission")) {
            errorMsg = "⚠️ تم رفض إذن الكاميرا.\n\nيرجى:\n1. السماح بالوصول للكاميرا من إعدادات المتصفح\n2. إعادة تحميل الصفحة\n3. التأكد من عدم استخدام الكاميرا في تطبيق آخر";
        } else if (err.name === "NotFoundError") {
            errorMsg = "⚠️ لم يتم العثور على كاميرا متصلة بالجهاز.";
        } else if (err.name === "NotReadableError") {
            errorMsg = "⚠️ الكاميرا قيد الاستخدام من تطبيق آخر. يرجى إغلاق التطبيقات الأخرى والمحاولة مرة أخرى.";
        } else if (err.name === "SecurityError" || window.location.protocol === "http:") {
            errorMsg = "⚠️ خطأ أمني: يجب فتح الصفحة عبر HTTPS أو localhost للوصول للكاميرا.\n\nالرابط الحالي: " + window.location.protocol;
        } else {
            errorMsg = "⚠️ خطأ في تشغيل الماسح:\n" + err.message;
        }
        
        document.getElementById("error").textContent = errorMsg;
        document.getElementById("error").style.display = "block";
        document.getElementById("status").textContent = "فشل التشغيل";
        
        alert(errorMsg);
    }
}

async function restart() {
    try {
        document.getElementById("success").style.display = "none";
        document.getElementById("error").style.display = "none";
        document.getElementById("nid").value = "";
        document.getElementById("status").textContent = "جاري إعادة التشغيل...";
        
        if (cameraEnhancer && cvRouter) {
            await cvRouter.stopCapturing();
            await cameraEnhancer.close();
            await cameraEnhancer.open();
            await cvRouter.startCapturing("ReadSingleBarcode");
            document.getElementById("status").textContent = "جاهز للمسح - وجّه الكاميرا نحو الباركود";
        } else {
            await start();
        }
    } catch (err) {
        console.error(err);
        document.getElementById("error").textContent = "⚠️ فشلت إعادة التشغيل: " + err.message;
        document.getElementById("error").style.display = "block";
        document.getElementById("status").textContent = "حدث خطأ";
    }
}

// بدء التشغيل عند تحميل الصفحة
window.addEventListener('load', start);
</script>

</body>
</html>
