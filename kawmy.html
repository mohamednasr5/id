<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ماسح الرقم القومي</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background-color: #f4f4f4;
display: flex;
flex-direction: column;
align-items: center;
padding: 20px;
margin: 0;
}
.container {
background: white;
padding: 20px;
border-radius: 12px;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
width: 100%;
max-width: 500px;
text-align: center;
}
h2 { margin-bottom: 20px; color: #333; }

#reader {
width: 100%;
border-radius: 8px;
overflow: hidden;
background: #000;
margin-bottom: 15px;
min-height: 300px;
}

input {
width: 90%;
padding: 15px;
font-size: 20px;
text-align: center;
border: 2px solid #ddd;
border-radius: 8px;
margin-bottom: 15px;
letter-spacing: 2px;
font-weight: bold;
}

button {
background-color: #28a745;
color: white;
border: none;
padding: 12px 25px;
font-size: 18px;
border-radius: 8px;
cursor: pointer;
width: 100%;
margin-bottom: 10px;
transition: background-color 0.3s;
}

button:hover {
opacity: 0.9;
}

button#stop-btn { 
background-color: #dc3545; 
display: none; 
}

.hint { 
color: #666; 
font-size: 14px; 
margin-top: 10px; 
line-height: 1.5;
}

.status {
padding: 10px;
margin: 10px 0;
border-radius: 8px;
font-size: 14px;
display: none;
}

.status.success {
background-color: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
display: block;
}

.status.error {
background-color: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
display: block;
}
</style>
</head>
<body>

<div class="container">
<h2>قارئ الرقم القومي</h2>

<div id="reader"></div>

<div id="status" class="status"></div>

<input type="text" id="nationalID" placeholder="الرقم سيظهر هنا" readonly>

<button id="start-btn" onclick="startScanner()">تشغيل الكاميرا</button>
<button id="stop-btn" onclick="stopScanner()">إيقاف الكاميرا</button>

<p class="hint">وجه الكاميرا على الباركود الأسود في <b>ظهر البطاقة</b><br>
تأكد من وضوح الإضاءة واستقرار البطاقة</p>
</div>

<script>
let html5QrcodeScanner;

function showStatus(message, type) {
const statusEl = document.getElementById('status');
statusEl.textContent = message;
statusEl.className = 'status ' + type;
setTimeout(() => {
statusEl.style.display = 'none';
}, 5000);
}

function startScanner() {
document.getElementById('start-btn').style.display = 'none';
document.getElementById('stop-btn').style.display = 'block';
document.getElementById('nationalID').value = '';
showStatus('جاري تشغيل الكاميرا...', 'success');

html5QrcodeScanner = new Html5Qrcode("reader");

const config = {
fps: 10,
qrbox: { width: 300, height: 150 },
aspectRatio: 1.0
};

html5QrcodeScanner.start(
{ facingMode: "environment" },
config,
onScanSuccess,
onScanFailure
).catch(err => {
console.error("فشل تشغيل الكاميرا", err);
showStatus("فشل تشغيل الكاميرا. تأكد من السماح باستخدام الكاميرا", 'error');
stopScanner();
});
}

function onScanSuccess(decodedText, decodedResult) {
console.log(`Scan result: ${decodedText}`);

// استخراج الـ 14 رقم من النص المقروء
const idMatch = decodedText.match(/\d{14}/);

if (idMatch) {
document.getElementById('nationalID').value = idMatch[0];

// تشغيل اهتزاز للموبايل
if (navigator.vibrate) {
navigator.vibrate(200);
}

// تشغيل صوت
playBeep();

// إيقاف المسح
stopScanner();

showStatus("✓ تم التقاط الرقم بنجاح: " + idMatch[0], 'success');
} else {
showStatus("الباركود لا يحتوي على رقم قومي صحيح", 'error');
}
}

function onScanFailure(error) {
// لا نفعل شيئاً هنا لتجنب الإزعاج
}

function stopScanner() {
if (html5QrcodeScanner) {
html5QrcodeScanner.stop().then(() => {
html5QrcodeScanner.clear();
document.getElementById('start-btn').style.display = 'block';
document.getElementById('stop-btn').style.display = 'none';
}).catch(err => {
console.log("Failed to stop", err);
});
}
}

function playBeep() {
try {
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const oscillator = audioCtx.createOscillator();
const gainNode = audioCtx.createGain();
oscillator.connect(gainNode);
gainNode.connect(audioCtx.destination);
oscillator.type = "sine";
oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
oscillator.start();
setTimeout(() => oscillator.stop(), 150);
} catch (e) {
console.log("Audio not supported");
}
}
</script>

</body>
</html>
