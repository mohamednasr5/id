<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø§Ø³Ø­ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
<style>
* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
padding: 20px;
}

.container {
background: white;
padding: 25px;
border-radius: 16px;
box-shadow: 0 10px 40px rgba(0,0,0,0.2);
width: 100%;
max-width: 600px;
text-align: center;
margin-top: 20px;
}

h2 { 
margin-bottom: 20px; 
color: #333;
font-size: 24px;
}

#video-container {
position: relative;
width: 100%;
max-width: 500px;
margin: 0 auto 20px;
border-radius: 12px;
overflow: hidden;
background: #000;
}

#video {
width: 100%;
height: auto;
display: block;
}

#canvas {
display: none;
}

.result-box {
background: #f8f9fa;
border: 2px solid #28a745;
border-radius: 8px;
padding: 15px;
margin: 15px 0;
display: none;
}

.result-box.show {
display: block;
animation: slideIn 0.3s ease;
}

@keyframes slideIn {
from {
opacity: 0;
transform: translateY(-10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.national-id {
font-size: 28px;
font-weight: bold;
color: #28a745;
letter-spacing: 3px;
margin: 10px 0;
font-family: 'Courier New', monospace;
}

button {
background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
color: white;
border: none;
padding: 15px 30px;
font-size: 18px;
border-radius: 10px;
cursor: pointer;
width: 100%;
margin: 8px 0;
font-weight: bold;
transition: all 0.3s;
box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

button:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
}

button:active {
transform: translateY(0);
}

.hint { 
color: #666; 
font-size: 14px; 
margin-top: 15px; 
line-height: 1.6;
background: #fff3cd;
padding: 12px;
border-radius: 8px;
border-right: 4px solid #ffc107;
}

.status {
padding: 12px;
margin: 15px 0;
border-radius: 8px;
font-size: 15px;
animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.status.success {
background-color: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}

.status.error {
background-color: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}

.status.info {
background-color: #d1ecf1;
color: #0c5460;
border: 1px solid #bee5eb;
}

.scanning-line {
position: absolute;
width: 100%;
height: 2px;
background: #28a745;
box-shadow: 0 0 10px #28a745;
animation: scan 2s linear infinite;
}

@keyframes scan {
0% { top: 0; }
50% { top: 100%; }
100% { top: 0; }
}

.copy-btn {
background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
padding: 10px 20px;
font-size: 16px;
margin-top: 10px;
box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
}

.loading {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid rgba(255,255,255,.3);
border-radius: 50%;
border-top-color: #fff;
animation: spin 1s ease-in-out infinite;
margin-left: 10px;
}

@keyframes spin {
to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="container">
<h2>ğŸ“± Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ø§Ù„Ù…ØµØ±ÙŠ</h2>

<div id="video-container">
<video id="video" playsinline autoplay></video>
<div class="scanning-line" id="scanning-line"></div>
</div>
<canvas id="canvas"></canvas>

<div id="status" class="status info">
<span id="status-text">ğŸ“¸ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</span>
<span class="loading"></span>
</div>

<div class="result-box" id="result-box">
<div style="color: #28a745; font-size: 18px; margin-bottom: 8px;">âœ“ ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</div>
<div class="national-id" id="nationalID"></div>
<button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…</button>
</div>

<button id="stop-btn" onclick="stopAndRestart()">ğŸ”„ Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø£Ø®Ø±Ù‰</button>

<div class="hint">
<strong>ğŸ“Œ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong><br>
â€¢ ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ <strong>Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</strong><br>
â€¢ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ÙˆØ§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©<br>
â€¢ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠÙ…Ù„Ø£ Ø§Ù„Ø¥Ø·Ø§Ø± Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†<br>
â€¢ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
</div>
</div>

<script>
let stream = null;
let isScanning = false;
let codeReader = null;

function showStatus(message, type) {
const statusEl = document.getElementById('status');
const statusText = document.getElementById('status-text');
statusText.textContent = message;
statusEl.className = 'status ' + type;
}

async function startScanner() {
try {
showStatus('â³ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...', 'info');
document.getElementById('result-box').classList.remove('show');

const video = document.getElementById('video');
stream = await navigator.mediaDevices.getUserMedia({
video: { 
facingMode: 'environment',
width: { ideal: 1280 },
height: { ideal: 720 }
}
});

video.srcObject = stream;
await video.play();

showStatus('ğŸ“¸ ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©', 'info');
isScanning = true;
codeReader = new ZXing.BrowserPDF417Reader();
scanBarcode();

} catch (err) {
console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", err);
showStatus("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­", 'error');

// Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
setTimeout(() => {
startScanner();
}, 3000);
}
}

async function scanBarcode() {
if (!isScanning) return;

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');

canvas.width = video.videoWidth;
canvas.height = video.videoHeight;
context.drawImage(video, 0, 0, canvas.width, canvas.height);

try {
const result = await codeReader.decodeFromCanvas(canvas);
if (result) {
handleScanResult(result.text);
return;
}
} catch (err) {
// Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¥Ø·Ø§Ø±ØŒ Ù†Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
}

// Ù†Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø³Ø­
if (isScanning) {
requestAnimationFrame(scanBarcode);
}
}

function handleScanResult(decodedText) {
console.log("Barcode detected:", decodedText);

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù… Ù…ØªØªØ§Ù„ÙŠ)
const idMatch = decodedText.match(/\d{14}/);

if (idMatch) {
const nationalId = idMatch[0];
document.getElementById('nationalID').textContent = nationalId;
document.getElementById('result-box').classList.add('show');

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­
isScanning = false;

// Ø§Ù‡ØªØ²Ø§Ø²
if (navigator.vibrate) {
navigator.vibrate([200, 100, 200]);
}

// ØµÙˆØª
playBeep();

showStatus("âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ø¨Ù†Ø¬Ø§Ø­!", 'success');

} else {
showStatus("âš ï¸ ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆÙ„ÙƒÙ† Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ ØµØ­ÙŠØ­. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰...", 'error');
setTimeout(() => {
if (!isScanning) {
isScanning = true;
scanBarcode();
}
}, 2000);
}
}

function stopAndRestart() {
document.getElementById('result-box').classList.remove('show');
isScanning = true;
showStatus('ğŸ“¸ Ø¬Ø§Ù‡Ø² Ù„Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©...', 'info');
scanBarcode();
}

function copyToClipboard() {
const text = document.getElementById('nationalID').textContent;
navigator.clipboard.writeText(text).then(() => {
showStatus("ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ", 'success');
if (navigator.vibrate) navigator.vibrate(100);
}).catch(err => {
showStatus("âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®", 'error');
});
}

function playBeep() {
try {
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const oscillator = audioCtx.createOscillator();
const gainNode = audioCtx.createGain();
oscillator.connect(gainNode);
gainNode.connect(audioCtx.destination);
oscillator.type = "sine";
oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
oscillator.start();
setTimeout(() => oscillator.stop(), 200);
} catch (e) {
console.log("Audio not supported");
}
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', () => {
startScanner();
});

// Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø©
document.addEventListener('visibilitychange', () => {
if (!document.hidden && !isScanning) {
startScanner();
}
});
</script>

</body>
</html>
